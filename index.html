<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HQ-DDNetwork-Portal</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* --- CORE VARIABLES (Modern Glass & Slate Theme) --- */
        :root {
            /* Backgrounds */
            --bg-deep: #f1f5f9;
            --bg-surface: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            
            /* Borders */
            --border: rgba(30, 41, 59, 0.08);
            --border-active: rgba(30, 41, 59, 0.15);
            
            /* Text */
            --text-main: #0f172a; /* Slate 900 */
            --text-secondary: #475569; /* Slate 600 */
            --text-faint: #94a3b8; /* Slate 400 */
            
            /* Accents */
            --soft-black: #1e293b;
            --primary: #2563eb; 
            --primary-glow: rgba(37, 99, 235, 0.1);
            --accent-success: #10b981;
            --accent-warn: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #0ea5e9;
            
            /* Dimensions */
            --font-main: 'Inter', sans-serif;
            --sidebar-width: 260px;
            --sidebar-collapsed: 80px;
            --header-height: 70px;
            --radius-lg: 20px;
            --radius-md: 12px;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.02);
            --shadow-md: 0 8px 30px rgba(30, 41, 59, 0.06);
            --shadow-lg: 0 20px 40px rgba(30, 41, 59, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { 
            background: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.85rem; }
        .font-bold { font-weight: 700; }
        .text-muted { color: var(--text-secondary); }
        
        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius:4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- BUTTONS (Modern Style) --- */
        .btn {
            padding: 0.6rem 1.2rem; 
            border-radius: 100px; /* Pill shape */
            border: 1px solid var(--border); 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
            transition: all 0.2s ease; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
            color: var(--text-main);
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); border-color: var(--text-faint); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-primary { background: var(--soft-black); color: white; border-color: var(--soft-black); }
        .btn-primary:hover { background: #0f172a; border-color: #0f172a; box-shadow: 0 10px 25px rgba(30,41,59,0.2); }
        
        .btn-danger { background: #fef2f2; color: var(--accent-danger); border-color: #fecaca; }
        .btn-danger:hover { background: var(--accent-danger); color: white; border-color: var(--accent-danger); }

        .btn-sm { padding: 0.4rem 0.9rem; font-size: 0.75rem; }
        .btn-icon { 
            padding: 0.5rem; border-radius: 12px; background: transparent; color: var(--text-secondary); 
            cursor: pointer; border: none; transition: 0.2s; display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px;
        }
        .btn-icon:hover { color: var(--text-main); background: rgba(0,0,0,0.03); }

        /* --- FORMS --- */
        input, select, textarea {
            width:100%; padding: 0.7rem 1rem; background: rgba(255,255,255,0.5); border:1px solid var(--border); 
            border-radius: var(--radius-md); color: var(--text-main); font-family: inherit; font-size: 0.9rem; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--soft-black); box-shadow: 0 0 0 3px rgba(30,41,59,0.1); background: white; }
        input[readonly], textarea[readonly] { background: #f8fafc; cursor: default; border-color: transparent; color: var(--text-secondary); }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }

        /* --- AUTH SCREEN --- */
        #auth-screen { 
            position: fixed; inset: 0; background: linear-gradient(135deg, #f1f5f9 0%, #ffffff 100%); 
            z-index: 9999; display: flex; align-items: center; justify-content: center; padding:1rem;
        }
        .auth-card { 
            width: 100%; max-width: 400px; padding: 2.5rem; background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(20px); border-radius: 24px; border:1px solid rgba(255,255,255,0.6); 
            text-align: center; box-shadow: var(--shadow-lg);
        }
        
        /* --- LAYOUT --- */
        #dashboard { display: flex; width: 100%; height: 100vh; overflow: hidden; position: relative; }

        /* SIDEBAR */
        aside { 
            width: var(--sidebar-width); background: var(--bg-surface); border-right:1px solid var(--border); 
            display: flex; flex-direction: column; z-index: 100; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed; top: var(--header-height); bottom: 0; left: 0;
            box-shadow: 10px 0 30px rgba(0,0,0,0.02);
        }
        aside.collapsed { width: var(--sidebar-collapsed); }
        aside.collapsed .nav-text, aside.collapsed .nav-section-title, aside.collapsed .u-details, aside.collapsed .user-mini-profile p { opacity: 0; pointer-events: none; display: none; }
        aside.collapsed .nav-item { padding: 0.8rem 0; justify-content: center; }
        aside.collapsed .nav-item i { font-size: 1.4rem; margin: 0; }
        
        /* HEADER */
        header {
            height: var(--header-height); background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px) saturate(180%);
            border-bottom:1px solid rgba(30,41,59,0.05); display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5rem; position: fixed; top: 0; left: 0; right: 0; z-index: 200;
            border-top: 1px solid rgba(255,255,255,0.5);
        }
        
        .header-left { display: flex; align-items: center; gap: 1.5rem; flex: 1; }
        .header-brand { font-weight: 800; font-size: 1rem; color: var(--text-main); letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .header-brand i { font-size: 1.5rem; color: var(--primary); }
        
        /* Global Search Input */
        .header-search { position: relative; max-width: 350px; width: 100%; display: none; }
        @media(min-width: 768px) { .header-search { display: block; } }
        .header-search input {
            width: 100%; padding-left: 2.5rem; border-radius: 50px; background: rgba(30,41,59,0.03);
            border: 1px solid transparent; font-size: 0.9rem;
        }
        .header-search i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-faint); }
        
        .header-actions { display: flex; align-items: center; gap: 0.5rem; position: relative; height: 100%; }

        /* Sidebar Navigation */
        .user-mini-profile { padding: 1.5rem 1.25rem; border-bottom: 1px solid var(--border); background: rgba(30,41,59,0.02); display: flex; align-items: center; gap: 12px; }
        .u-avatar { 
            width: 42px; height: 42px; background: var(--soft-black); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; 
            color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        .u-details h4 { font-size: 0.95rem; color: var(--text-main); font-weight: 700; margin-bottom: 2px; }
        .u-details p { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }

        .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-section-title { 
            padding: 1rem 1.5rem 0.5rem; font-size: 0.65rem; color: var(--text-faint); 
            text-transform: uppercase; font-weight: 700; letter-spacing: 1px; 
        }
        .nav-item { 
            padding: 0.7rem 1.5rem; display: flex; align-items: center; gap: 12px; color: var(--text-secondary); cursor: pointer; 
            transition: 0.2s; border-left: 3px solid transparent; font-weight: 500; margin: 4px 1rem 4px 0;
            border-radius: 0 var(--radius-md) var(--radius-md) 0; position: relative;
        }
        .nav-item:hover { background: rgba(30,41,59,0.03); color: var(--text-main); }
        .nav-item.active { background: rgba(30,41,59,0.05); color: var(--text-main); border-left-color: var(--soft-black); font-weight: 600; }
        .nav-item i { font-size: 1.2rem; opacity: 0.7; }
        .nav-item.active i { opacity: 1; }

        /* MAIN CONTENT */
        main { 
            flex:1; overflow-y: auto; overflow-x: hidden; background: var(--bg-deep); padding: 1.5rem; position: relative; 
            margin-top: var(--header-height); min-height: calc(100vh - var(--header-height)); width: 100%;
            margin-left: var(--sidebar-width); transition: margin-left 0.3s;
        }

        /* --- COMPONENTS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem; }
        .stat-card { 
            background: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border); 
            display: flex; align-items: center; gap: 1.2rem; transition: all 0.3s; 
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--soft-black); opacity: 0;
            transition: opacity 0.3s;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stat-card:hover::before { opacity: 1; }
        
        .stat-icon { 
            width: 50px; height: 50px; border-radius: var(--radius-md); background: rgba(30,41,59,0.05); display: flex; 
            align-items: center; justify-content: center; font-size: 1.4rem; color: var(--text-main);
        }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); line-height: 1; margin-bottom: 4px; letter-spacing: -1px; }
        .stat-label { color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Table Container */
        .table-container { 
            background: var(--bg-surface); border-radius: var(--radius-lg); border: 1px solid var(--border); overflow: hidden; 
            margin-bottom: 2rem; box-shadow: var(--shadow-sm); 
        }
        .table-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; flex-wrap: wrap; gap: 10px; }
        .table-header h3 { font-size: 1rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.3px; }
        
        /* Responsive Table */
        .table-responsive { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 1rem 1.2rem; color: var(--text-secondary); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; background: #f8fafc; white-space: nowrap; border-bottom: 1px solid var(--border); letter-spacing: 0.5px; }
        td { padding: 1rem 1.2rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.85rem; vertical-align: middle; background: white; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        /* --- MODALS & TOASTS --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.3); backdrop-filter: blur(4px); 
            z-index: 1000; display: none; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        .modal { 
            background: var(--bg-surface); width: 100%; max-width: 520px; border-radius: var(--radius-lg); border: 1px solid var(--border); 
            display: flex; flex-direction: column; max-height: 90vh; box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-header { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.2rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; background: #f8fafc; }

        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: var(--bg-surface); color: var(--text-main); padding:1rem 1.25rem; border-radius: var(--radius-md); 
            border: 1px solid var(--border); box-shadow: var(--shadow-md); display: flex; 
            align-items: center; gap: 12px; transform: translateX(120%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            min-width: 300px; pointer-events: auto;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 5px solid var(--accent-success); }
        .toast.error { border-left: 5px solid var(--accent-danger); }

        /* --- BADGES --- */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; letter-spacing: 0.3px; }
        .badge-admin { background: #fffbeb; color: var(--accent-warn); border: 1px solid #fde68a; }
        .badge-crew { background: #eff6ff; color: var(--primary); border: 1px solid #bfdbfe; }
        .badge-user { background: #f1f5f9; color: var(--text-secondary); border: 1px solid #e2e8f0; }

        /* RESPONSIVE */
        @media(max-width: 1024px) {
            aside { transform: translateX(-100%); width: 280px; box-shadow: var(--shadow-lg); }
            aside.mobile-open { transform: translateX(0); }
            main { margin-left: 0 !important; width: 100% !important; padding: 1rem; }
            .header-brand span { display: none; }
        }
        
        /* Print Styles */
        @media print {
            body { background: white; }
            aside, header, .btn { display: none; }
            main { margin: 0; padding: 0; }
            .table-container { box-shadow: none; border: none; }
        }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2 class="mb-4" style="color:var(--text-main); font-weight: 800; letter-spacing: -0.5px; font-size: 1.5rem;">Portal Access</h2>
            <p class="mb-4 text-muted">Enterprise Edition <span style="font-size:0.7em; background:#e0e7ff; color:#4338ca; padding:2px 6px; border-radius:4px;">v3.2</span></p>
            <form id="loginForm">
                <input type="text" id="loginInput" class="mb-4" placeholder="Email or Crew ID" required>
                <input type="password" id="loginPass" class="mb-4" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Secure Login</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        
        <!-- GLOBAL HEADER -->
        <header>
            <div class="header-left">
                <button class="btn-icon" onclick="toggleSidebar()" title="Toggle Menu"><i class="ri-menu-line" style="font-size: 1.5rem;"></i></button>
                <div class="header-brand">
                    <i class="ri-dashboard-3-line"></i>
                    <span>HQ-DDNetwork</span>
                </div>
                
                <!-- GLOBAL SEARCH -->
                <div class="header-search">
                    <i class="ri-search-line"></i>
                    <input type="text" id="globalSearch" placeholder="Search Orders, Clients..." onkeyup="handleGlobalSearch(this.value)">
                    <div id="search-results" style="position: absolute; top: 60px; left: 0; width: 100%; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); border:1px solid var(--border); display:none; max-height: 400px; overflow-y: auto; z-index: 10;"></div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="location.reload()" title="Force Refresh"><i class="ri-refresh-line"></i></button>
                
                <button class="btn-icon" id="notif-btn" onclick="toggleNotifications()">
                    <i class="ri-notification-3-line" style="font-size: 1.3rem;"></i>
                    <div class="notif-dropdown" id="notifDropdown" style="position: absolute; top: 60px; right: 0; width: 300px; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); border:1px solid var(--border); display: none;"></div>
                </button>

                <div class="u-avatar" style="width:32px; height:32px; font-size:0.85rem; cursor:pointer;" id="header-avatar" onclick="navigateTo('/my-profile')">A</div>
            </div>
        </header>

        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div class="user-mini-profile">
                <div class="u-avatar" id="side-avatar">A</div>
                <div class="u-details">
                    <h4 id="side-name">Loading...</h4>
                    <p id="side-job">Loading...</p>
                </div>
            </div>
            
            <div class="nav-scroll">
                <div class="nav-section-title"><span class="nav-text">Overview</span></div>
                <div class="nav-item" onclick="navigateTo('/')"><i class="ri-dashboard-line"></i> <span class="nav-text">Dashboard</span></div>
                
                <div class="nav-section-title"><span class="nav-text">Operations</span></div>
                <div class="nav-item" onclick="navigateTo('/orders')"><i class="ri-shopping-bag-3-line"></i> <span class="nav-text">Orders</span></div>
                <div class="nav-item" onclick="navigateTo('/clients')"><i class="ri-user-line"></i> <span class="nav-text">Clients</span></div>
                <div class="nav-item" onclick="navigateTo('/requests')"><i class="ri-database-2-line"></i> <span class="nav-text">Requests</span></div>
                <div class="nav-item" onclick="navigateTo('/support')"><i class="ri-customer-service-2-line"></i> <span class="nav-text">Support</span></div>
                <div class="nav-item" onclick="navigateTo('/vouchers')"><i class="ri-ticket-2-line"></i> <span class="nav-text">Vouchers</span></div>
                
                <div class="nav-section-title"><span class="nav-text">Management</span></div>
                <div class="nav-item" onclick="navigateTo('/portfolio')"><i class="ri-gallery-line"></i> <span class="nav-text">Portfolio</span></div>
                <div class="nav-item" onclick="navigateTo('/content')"><i class="ri-layout-masonry-line"></i> <span class="nav-text">Content & Pkg</span></div>
                <div class="nav-item" onclick="navigateTo('/public-promos')"><i class="ri-coupon-3-line"></i> <span class="nav-text">Public Promos</span></div>
                
                <div class="nav-section-title"><span class="nav-text">System</span></div>
                <div class="nav-item" onclick="navigateTo('/crew')"><i class="ri-team-line"></i> <span class="nav-text">Internal Crew</span></div>
                <div class="nav-item" onclick="navigateTo('/config')"><i class="ri-settings-4-line"></i> <span class="nav-text">System Config</span></div>
                <div class="nav-item hidden" id="nav-approvals" onclick="navigateTo('/approvals')"><i class="ri-shield-check-line" style="color: var(--accent-warn)"></i> <span class="nav-text">Approvals</span></div>
                
                <div class="nav-section-title"><span class="nav-text">Finance</span></div>
                <div class="nav-item" onclick="navigateTo('/commissions')"><i class="ri-money-dollar-circle-line"></i> <span class="nav-text">Finance</span></div>
            </div>

            <div style="padding: 1.5rem; border-top: 1px solid var(--border);">
                <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="handleLogout()">
                    <i class="ri-logout-box-r-line"></i> <span>Logout</span>
                </button>
            </div>
        </aside>

        <main id="main"></main>
    </div>

    <!-- MAIN MODAL -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Title</div>
                <button class="btn-icon" onclick="closeModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

<!-- JAVASCRIPT -->
<script>
    // --- FIX: HIDE AUTH SCREEN IMMEDIATELY ---
    document.getElementById('auth-screen').classList.add('hidden');

    // --- 1. COMMISSION CONFIGURATION ---
    const DEFAULT_COMMISSION_RATES = { 
        "Founder & Managing Director": 0.05, 
        "Project & Client Manager": 0.04, 
        "Account / Operations / Marketing Manager": 0.04, 
        "Finance / Billing Executive": 0.0, 
        "People / Team Operations Executive": 0.0, 
        "Business Development Executive": 0.125, 
        "Sales Executive": 0.125, 
        "Client Success Coordinator": 0.025, 
        "Client Experience Executive": 0.025, 
        "Technical Specialist": 0.04, 
        "Web Developer": 0.04, 
        "Full Stack Developer": 0.05, 
        "Automation & AI Specialist": 0.05, 
        "Support Operations Executive": 0.025 
    };

    // --- 2. DEPARTMENT CONFIGURATION ---
    const DEPARTMENTS = [
        "Founder / Managing Director", "Operations", "Finance", "Customer Service", "Development", "Sales"
    ];

    const JOB_TITLES = [
        "Founder & Managing Director", "Project & Client Manager", "Account / Operations / Marketing Manager", 
        "Finance / Billing Executive", "People / Team Operations Executive", "Business Development Executive", 
        "Sales Executive", "Client Success Coordinator", "Client Experience Executive", "Technical Specialist", 
        "Web Developer", "Full Stack Developer", "Automation & AI Specialist", "Support Operations Executive"
    ];

    const JOB_ROLE_MAP = {
        "Founder & Managing Director": "super_admin", "Project & Client Manager": "mid_admin",
        "Account / Operations / Marketing Manager": "mid_admin", "Finance / Billing Executive": "mid_admin",
        "People / Team Operations Executive": "admin", "Business Development Executive": "admin",
        "Sales Executive": "crew", "Client Success Coordinator": "mid_admin",
        "Client Experience Executive": "crew", "Technical Specialist": "crew",
        "Web Developer": "admin", "Full Stack Developer": "mid_admin",
        "Automation & AI Specialist": "crew", "Support Operations Executive": "crew"
    };

    // --- PERMISSION SYSTEM ---
    const PERMISSION_KEYS = {
        EDIT_ORDERS: 'edit_orders', EDIT_CLIENTS: 'edit_clients', VIEW_FINANCE: 'view_finance',
        DELETE_REQUESTS: 'delete_requests', DELETE_SUPPORT: 'delete_support',
        APPROVE_REQUESTS: 'approve_requests', EDIT_VOUCHERS: 'edit_vouchers',
        EDIT_PORTFOLIO: 'edit_portfolio', EDIT_CONTENT: 'edit_content', EDIT_PROMOS: 'edit_promos',
        EDIT_CREW: 'edit_crew', EDIT_CONFIG: 'edit_config', MANAGE_USERS: 'manage_users', 
        FINANCE_TOOLS_ACCESS: 'finance_tools_access', APPROVE_ACTIONS: 'approve_actions', 
        BYPASS_APPROVAL: 'bypass_approval', EDIT_ACCESS: 'edit_access', 
        ADJUST_COMMISSION: 'adjust_commission', MANAGE_EMAIL: 'manage_email'
    };

    // --- TABLE STATE MANAGEMENT ---
    const TableEngine = {
        states: {},
        init: function(tableId) {
            if(!this.states[tableId]) {
                this.states[tableId] = { raw: [], filtered: [], page: 1, limit: 25, sortKey: null, sortDir: 'asc', filters: { search: '', status: '', dept: '', startDate: '', endDate: '' } };
            }
        },
        updateData: function(tableId, newData) {
            this.init(tableId); this.states[tableId].raw = newData; this.processAndRender(tableId);
        },
        setLimit: function(tableId, limit) {
            this.init(tableId); this.states[tableId].limit = parseInt(limit); this.states[tableId].page = 1; this.processAndRender(tableId);
        },
        setPage: function(tableId, page) {
            this.init(tableId); this.states[tableId].page = parseInt(page); this.processAndRender(tableId);
        },
        setFilter: function(tableId, key, value) {
            this.init(tableId); this.states[tableId].filters[key] = value; this.states[tableId].page = 1; this.processAndRender(tableId);
        },
        setSort: function(tableId, key) {
            this.init(tableId);
            const state = this.states[tableId];
            if(state.sortKey === key) { state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc'; } 
            else { state.sortKey = key; state.sortDir = 'asc'; }
            this.processAndRender(tableId);
        },
        processAndRender: function(tableId) {
            const state = this.states[tableId]; if(!state) return;
            let data = [...state.raw]; const f = state.filters;
            
            if(f.search) {
                const q = f.search.toLowerCase();
                data = data.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(q)));
            }
            if(f.status) data = data.filter(row => (row.status || '').toLowerCase() === f.status.toLowerCase());
            if(f.dept) data = data.filter(row => (row.department || '').toLowerCase() === f.dept.toLowerCase());
            if(f.startDate || f.endDate) {
                data = data.filter(row => {
                    if(!row.timestamp) return false; 
                    const d = row.timestamp.toDate ? row.timestamp.toDate() : (row.timestamp instanceof Date ? row.timestamp : new Date(row.timestamp));
                    if(f.startDate && d < new Date(f.startDate)) return false;
                    if(f.endDate) { const end = new Date(f.endDate); end.setHours(23, 59, 59, 999); if(d > end) return false; }
                    return true;
                });
            }
            if(state.sortKey) {
                data.sort((a, b) => {
                    let valA = a[state.sortKey]; let valB = b[state.sortKey];
                    if(valA == null) return 1; if(valB == null) return -1;
                    if(valA.toDate) valA = valA.toDate(); if(valB.toDate) valB = valB.toDate();
                    if (valA < valB) return state.sortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return state.sortDir === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            state.filtered = data;
            const start = (state.page - 1) * state.limit; const end = start + state.limit;
            const pageData = data.slice(start, end);
            const tbody = document.getElementById(tableId); if(!tbody) return;
            
            if(window.customTableRenderers && window.customTableRenderers[tableId]) {
                tbody.innerHTML = window.customTableRenderers[tableId](pageData);
            } else {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No renderer defined</td></tr>';
            }
            this.renderPagination(tableId, data.length, state.page, state.limit);
        },
        renderPagination: function(tableId, totalItems, currentPage, limit) {
            const container = document.getElementById(`${tableId}-pagination`);
            if(!container) return;
            const totalPages = Math.ceil(totalItems / limit);
            const startRec = totalItems === 0 ? 0 : (currentPage - 1) * limit + 1;
            const endRec = Math.min(currentPage * limit, totalItems);
            let html = `
                <div class="flex justify-between items-center pt-2" style="border-top:1px solid var(--border); padding:1rem;">
                    <div class="text-sm text-muted">Showing <strong>${startRec}</strong> to <strong>${endRec}</strong> of <strong>${totalItems}</strong></div>
                    <div class="flex items-center gap-2">
                        <select onchange="TableEngine.setLimit('${tableId}', this.value)" style="padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.8rem;">
                            <option value="25" ${limit===25?'selected':''}>25</option>
                            <option value="50" ${limit===50?'selected':''}>50</option>
                            <option value="100" ${limit===100?'selected':''}>100</option>
                        </select>
                        <div class="flex gap-1">
                            <button class="btn btn-sm btn-secondary" onclick="TableEngine.setPage('${tableId}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="ri-arrow-left-s-line"></i></button>
                            <button class="btn btn-sm btn-secondary" onclick="TableEngine.setPage('${tableId}', ${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}><i class="ri-arrow-right-s-line"></i></button>
                        </div>
                    </div>
                </div>`;
            container.innerHTML = html;
        }
    };
    window.customTableRenderers = {};

    // --- FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
        authDomain: "ddnetwork-database.firebaseapp.com",
        projectId: "ddnetwork-database",
        storageBucket: "ddnetwork-database.firebasestorage.app",
        messagingSenderId: "699127560990",
        appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
    };
    let db, auth, currentUser, userData = null;
    let rawFinanceData = []; 
    
    try { 
        firebase.initializeApp(firebaseConfig); 
        db = firebase.firestore(); 
        auth = firebase.auth(); 
    } catch(e) { console.log("Firebase init error", e); }

    function setPageLoading(isLoading) {
        const main = document.getElementById('main');
        if(!main) return;
        if(isLoading) main.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:50vh; flex-direction:column; gap:1rem;"><div class="loading-spinner" style="width: 40px; height: 40px; border-width: 4px;"></div><div class="text-muted text-sm">Loading Data...</div></div>`;
    }

    async function loadCommissionConfig() {
        try {
            const doc = await db.collection("config").doc("site_settings").get();
            if (doc.exists && doc.data().commission_rates) {
                // Loaded
            } else {
                await db.collection("config").doc("site_settings").update({ commission_rates: DEFAULT_COMMISSION_RATES });
            }
        } catch (e) { console.error("Error loading commission config", e); }
    }

    async function initializeDatabase() {
        try {
            const configRef = db.collection("config").doc("site_settings");
            const doc = await configRef.get();
            if (!doc.exists) {
                await configRef.set({
                    maintenance_active: false, maintenance_message: "System Maintenance", prices: { html: 199, frontend:599 },
                    packageDetails: { frontend: ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"], ai: ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"] },
                    disabled_menus: [], commission_rates: DEFAULT_COMMISSION_RATES,
                    smtp_config: { host: '', port: 587, user: '', pass: '', from_name: 'DDNetwork System', from_email: 'noreply@ddnet.my' }
                });
            } else {
                const data = doc.data();
                if(!data.commission_rates) await configRef.update({ commission_rates: DEFAULT_COMMISSION_RATES });
                if(!data.smtp_config) await configRef.update({ smtp_config: { host:'', port:587, user:'', pass:'', from_name:'DDNetwork System', from_email:'noreply@ddnet.my' }});
            }
            const pmSnapshot = await db.collection("payment_methods").limit(1).get();
            if (pmSnapshot.empty) {
                const defaults = [ { id: 'tng', name: 'TNG eWallet', link: 'https://payment.tngdigital.com.my/sc/bDLob7YcpG', active: true }, { id: 'fpx', name: 'Online Banking (FPX)', link: 'https://toyyibpay.com', active: true } ];
                defaults.forEach(pm => db.collection("payment_methods").add(pm));
            }
        } catch (error) { console.error("Error initializing database defaults:", error); }
    }

    function logActivity(msg) {
        if(!currentUser || !db) return; 
        db.collection("activity_logs").add({ message: msg, actor: userData.email, actorName: userData.name, timestamp: firebase.firestore.FieldValue.serverTimestamp() }).catch(e => console.error("Log error:", e));
    }

    function formatDateTime(timestamp) {
        if(!timestamp) return '-';
        const d = timestamp instanceof Date ? timestamp : timestamp.toDate();
        const pad = (n) => n.toString().padStart(2, '0');
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function generateDocIdFromName(name) { if(!name) return 'new-project'; return name.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, ''); }
    function updateDocIdPreview() { const nameVal = document.getElementById('p-name').value; const idInput = document.getElementById('p-doc-id'); if(idInput) idInput.value = generateDocIdFromName(nameVal); }

    async function getNextId(type) {
        if(type === 'crew') {
             try {
                 const snap = await db.collection("users").where("crewId", "!=", null).get();
                 let existingIds = []; snap.forEach(doc => { const id = doc.data().crewId; if(id) existingIds.push(parseInt(id)); });
                 existingIds.sort((a,b) => a-b); let nextId =1;
                 if(existingIds.length > 0) { for(let i=0; i<existingIds.length; i++) { if(existingIds[i] === nextId) nextId++; else break; } }
                 return String(nextId).padStart(3, '0');
             } catch(e) { return "001"; }
        } else if (type === 'ticket') {
            try {
                const snap = await db.collection("tickets").orderBy("ticketId", "desc").limit(1).get();
                let nextNum = 1;
                if (!snap.empty) {
                    const lastId = snap.docs[0].data().ticketId; 
                    const parts = lastId.split('-'); if (parts.length >1) { const lastNum = parseInt(parts[1], 10); if (!isNaN(lastNum)) nextNum = lastNum + 1; }
                }
                return `#Ticket-${String(nextNum).padStart(4, '0')}`;
            } catch (e) { return "#Ticket-0001"; }
        }
        return null;
    }

    // --- AUTH ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('loginInput').value.trim();
        const pass = document.getElementById('loginPass').value;
        const isCrewId = /^\d{3,}$/.test(input);
        let emailToUse = input;
        if (isCrewId) {
            const snap = await db.collection("users").where("crewId", "==", input).get();
            if (snap.empty) return showToast("Crew ID not found.", "error");
            emailToUse = snap.docs[0].data().email;
        }
        auth.signInWithEmailAndPassword(emailToUse, pass).catch(err => showToast(err.message, "error"));
    });

    auth.onAuthStateChanged((user) => {
        if(user) {
            db.collection("users").doc(user.uid).get().then(doc => {
                if(doc.exists) {
                    currentUser = user;
                    userData = doc.data();
                    if(!userData.permissions) userData.permissions = {};
                    if(userData.role === 'super_admin') { userData.permissions[PERMISSION_KEYS.EDIT_ACCESS] = true; userData.permissions[PERMISSION_KEYS.MANAGE_EMAIL] = true; }
                    if(!userData.isSuspended) userData.isSuspended = false;
                    if(userData.bypassApproval === undefined) userData.bypassApproval = false; 
                    if(!userData.pinnedMenus) userData.pinnedMenus = [];
                    if(userData.personalCommissionRate === undefined) {
                        const defaultRate = DEFAULT_COMMISSION_RATES[userData.jobTitle] || 0;
                        db.collection("users").doc(user.uid).update({ personalCommissionRate: defaultRate });
                        userData.personalCommissionRate = defaultRate;
                    }

                    if(userData.isSuspended) {
                        auth.signOut(); showToast("Account Suspended. Contact Admin.", "error");
                        document.getElementById('auth-screen').classList.remove('hidden');
                        return;
                    }

                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    document.getElementById('side-name').innerText = userData.name || 'User';
                    document.getElementById('side-job').innerText = `${userData.jobTitle} (${userData.role.toUpperCase()})`;
                    
                    loadCommissionConfig();

                    const userInitial = (userData.name || 'A').charAt(0).toUpperCase();
                    document.getElementById('header-avatar').innerText = userInitial;
                    document.getElementById('side-avatar').innerText = userInitial;
                    document.getElementById('header-avatar').style.background = `hsl(${Math.random()*360}, 70%, 50%)`;

                    if(hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) document.getElementById('nav-approvals').classList.remove('hidden');
                    else document.getElementById('nav-approvals').classList.add('hidden');

                    if(userData.role !== 'crew') listenForNotifications();
                    
                    initRouter(); initializeDatabase();
                } else {
                    showToast("Access Denied. User record not found.", "error"); auth.signOut();
                }
            });
        } else {
            document.getElementById('dashboard').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden');
        }
    });

    function handleLogout() { auth.signOut().then(() => location.reload()); }

    // --- GLOBAL SEARCH & NOTIFICATIONS ---
    async function handleGlobalSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        if(!query || query.length < 2) { resultsContainer.style.display = 'none'; return; }
        const q = query.toLowerCase(); let html = '';
        try {
            const oSnap = await db.collection("orders").orderBy("customerName").startAt(q).endAt(q + '\uf8ff').limit(3).get();
            oSnap.forEach(doc => {
                const d = doc.data();
                html += `<div onclick="navigateTo('/orders'); closeModal();" style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 10px; align-items: center;">
                    <i class="ri-shopping-bag-line text-muted"></i> <div><strong style="color:var(--text-main)">${d.customerName}</strong><br><small class="text-muted">Order: RM ${d.total}</small></div></div>`;
            });
        } catch(e) {}
        
        if(html === '') html = '<div class="p-4 text-center text-muted">No results</div>';
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
    }

    function toggleNotifications() {
        const el = document.getElementById('notifDropdown'); el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }
    
    function listenForNotifications() {
        db.collection("activity_logs").orderBy("timestamp", "desc").limit(10).onSnapshot(snap => {
            const container = document.getElementById('notifDropdown');
            if(snap.empty) { container.innerHTML = '<div class="p-4 text-center text-muted">No activity</div>'; return; }
            container.innerHTML = snap.docs.map(doc => {
                const d = doc.data();
                return `<div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);">
                    <strong style="color:var(--text-main)">${d.actorName || d.actor}</strong>
                    <div style="font-size: 0.85rem; color: var(--text-secondary)">${d.message}</div>
                    <small style="color: var(--text-faint)">${formatDateTime(d.timestamp)}</small>
                </div>`;
            }).join('');
        });
    }

    // --- ACCESS CONTROL ---
    function isSuperAdmin() { return userData && userData.role === 'super_admin'; }
    function isMidAdmin() { return userData && userData.role === 'mid_admin'; }
    function isAdmin() { return userData && userData.role === 'admin'; }
    function isCrew() { return userData && userData.role === 'crew'; }
    function hasPermission(key) { if(!userData) return false; if (userData.permissions && userData.permissions[key] === true) return true; return false; }
    function canAccessFinanceTools() { if(isSuperAdmin() || isMidAdmin() || (userData && userData.jobTitle && userData.jobTitle.includes("Finance"))) return true; if(hasPermission(PERMISSION_KEYS.FINANCE_TOOLS_ACCESS)) return true; return false; }
    function checkAccessOrActionAllowed(permissionKey) { if(!userData) return false; if (isSuperAdmin() || userData.bypassApproval === true) return true; if (hasPermission(permissionKey)) return true; return false; }

    // --- ROUTING SYSTEM ---
    const routes = {
        '/': renderOverview, '/orders': renderOrders, '/clients': renderClients, '/crew': renderCrew,
        '/support': renderSupport, '/vouchers': renderVouchers, '/content': renderContent, '/config': renderConfig,
        '/portfolio': renderPortfolio, '/requests': renderRequests, '/my-profile': renderMyProfile,
        '/public-promos': renderPublicPromos, '/commissions': renderFinanceOverview, '/approvals': renderApprovals
    };

    function navigateTo(path) {
        if (window.innerWidth <= 1024) { document.getElementById('sidebar').classList.remove('mobile-open'); }
        window.history.pushState({ path: path }, "", path);
        loadRoute(path);
    }

    function loadRoute(path) {
        const renderFn = routes[path];
        if (renderFn) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`.nav-item[onclick="navigateTo('${path}')"]`);
            if(activeItem) activeItem.classList.add('active');
            
            const mainEl = document.getElementById('main'); mainEl.innerHTML = ''; renderFn();
            document.getElementById('main').scrollTop = 0;
        }
    }

    function initRouter() {
        const path = window.location.pathname;
        const basePath = path.replace(/\/[^/]+\.html$/, '') || '/';
        if (routes[basePath]) loadRoute(basePath);
        else navigateTo('/');
    }

    window.onpopstate = (event) => { if (event.state && event.state.path) loadRoute(event.state.path); };

    function toggleSidebar() { 
        const sb = document.getElementById('sidebar');
        if(window.innerWidth > 1024) {
            if (sb.classList.contains('collapsed')) { sb.classList.remove('collapsed'); document.getElementById('main').style.marginLeft = 'var(--sidebar-width)'; } 
            else { sb.classList.add('collapsed'); document.getElementById('main').style.marginLeft = 'var(--sidebar-collapsed)'; }
        } else sb.classList.toggle('mobile-open');
    }

    // --- UTILS ---
    function showModal(title, body, footer='') {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerHTML = body;
        document.getElementById('modalFooter').innerHTML = footer;
        document.getElementById('modalOverlay').classList.add('open');
    }
    function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
    
    function showToast(msg, type='info') {
        const container = document.getElementById('toastContainer');
        const t = document.createElement('div'); t.className = `toast ${type}`;
        t.innerHTML = `<span style="font-size:0.9rem; font-weight:500;">${msg}</span>`;
        container.appendChild(t);
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 3000);
    }

    function formatWAPhone(phone) {
        if (!phone) return null; let clean = phone.replace(/[^0-9]/g, '');
        if (clean.startsWith('0')) clean = '60' + clean.substring(1);
        if (clean.startsWith('+')) clean = clean.substring(1);
        if (clean.length < 10 || clean.length > 13) return null;
        return clean;
    }

    // --- 1. OVERVIEW ---
    function renderOverview() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 style="font-size:1.5rem; font-weight:800; letter-spacing:-0.5px;">Dashboard</h2>
            </div>
            <div class="stats-grid" id="stats-grid"><div style="height:100px;"></div></div>
        `;
        
        const promises = [
            db.collection("tickets").where("status", "in", ["Open", "In Progress"]).get(),
            db.collection("users").where("role", "==", "user").get(),
            db.collection("orders").where("status", "==", "Pending").get(),
            db.collection("orders").where("status", "==", "Paid").get()
        ];

        Promise.all(promises).then(([tSnap, uSnap, oSnapP, oSnapPaid]) => {
            const stats = [
                { label: "Active Cases", val: tSnap.size, icon: "ri-customer-service-2-line", color: "#8b5cf6" },
                { label: "Total Clients", val: uSnap.size, icon: "ri-user-smile-line", color: "#2563eb" },
                { label: "Pending Orders", val: oSnapP.size, icon: "ri-shopping-basket-2-line", color: "#64748b" },
                { label: "Revenue (Est.)", val: `RM ${oSnapPaid.size * 300}`, icon: "ri-wallet-3-line", color: "#10b981" }
            ];
            const grid = document.getElementById('stats-grid');
            grid.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <div class="stat-icon" style="color:${s.color}; background:${s.color}15"><i class="${s.icon}"></i></div>
                    <div class="stat-info">
                        <div class="stat-val">${s.val}</div>
                        <div class="stat-label">${s.label}</div>
                    </div>
                </div>
            `).join('');
        });
    }

    // --- 2. ORDERS ---
    function renderOrders() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="table-container">
                <div class="table-header" style="display:block;">
                    <div class="flex justify-between items-center mb-2"><h3>Order Management</h3></div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="text" placeholder="Search..." onkeyup="TableEngine.setFilter('orders-tbody', 'search', this.value)">
                        <select onchange="TableEngine.setFilter('orders-tbody', 'status', this.value)"><option value="">All Status</option><option value="Pending">Pending</option><option value="Paid">Paid</option></select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table><thead><tr><th>Date</th><th>Client</th><th>Package</th><th>Total</th><th>Status</th><th>Actions</th></tr></thead><tbody id="orders-tbody"><tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    <div id="orders-tbody-pagination"></div>
                </div>
            </div>`;
            
        db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('orders-tbody', data);
        });

        window.customTableRenderers['orders-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="6" class="text-center text-muted">No orders found</td></tr>';
            return data.map(d => {
                let actions = '';
                if(checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_ORDERS)) {
                    actions += `<button class="btn btn-sm btn-secondary" onclick="viewOrder('${d.id}')">Manage</button>`;
                    actions += `<button class="btn btn-sm" style="background:#f0f9ff; color:var(--accent-info)" title="Generate Invoice" onclick="generateInvoice('${d.id}')"><i class="ri-file-list-2-line"></i></button>`;
                }
                return `<tr>
                    <td>${formatDateTime(d.timestamp)}</td>
                    <td><strong>${d.customerName}</strong><br><span style="color:var(--primary); font-size:0.8rem;">${d.domain}</span></td>
                    <td>${d.package}</td>
                    <td>${d.total}</td>
                    <td><span class="badge" style="background:${d.status==='Paid'?'#ecfdf5':'#fffbeb'}; color:${d.status==='Paid'?'#059669':'#d97706'}; border:1px solid ${d.status==='Paid'?'#a7f3d0':'#fcd34d'}">${d.status}</span></td>
                    <td><div style="display:flex; gap:5px;">${actions}</div></td>
                </tr>`;
            }).join('');
        };
    }

    async function generateInvoice(orderId) {
        try {
            const orderDoc = await db.collection("orders").doc(orderId).get();
            if(!orderDoc.exists) return showToast("Order not found", "error");
            const d = orderDoc.data();
            const invoiceContent = `
                <!DOCTYPE html><html><head><title>Invoice</title><style>body{font-family:sans-serif; padding:40px;} h1{color:#1e293b;} table{width:100%; border-collapse:collapse; margin-top:20px;} th,td{padding:10px; border-bottom:1px solid #eee; text-align:left;}</style></head>
                <body><h1>Invoice</h1><p>Date: ${formatDateTime(d.timestamp)}</p><hr><h2>Bill To:</h2><p>${d.customerName}<br>${d.customerEmail}<br>${d.domain}</p><hr><table><thead><tr><th>Item</th><th>Amount</th></tr></thead><tbody><tr><td>${d.package}</td><td>${d.total}</td></tr></tbody></table><h3 style="text-align:right; margin-top:20px;">Total: ${d.total}</h3></body></html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(invoiceContent); printWindow.document.close();
        } catch (err) { showToast("Error generating invoice", "error"); }
    }

    async function viewOrder(id) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_ORDERS)) return showToast("Access Denied", "error");
        const doc = await db.collection("orders").doc(id).get();
        const d = doc.data();
        showModal(`Manage Order`, `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div><label>Name</label><input id="o-name" value="${d.customerName}"></div>
                <div><label>Email</label><input id="o-email" value="${d.customerEmail}"></div>
                <div><label>Phone</label><input id="o-phone" value="${d.customerPhone||''}"></div>
                <div><label>Total</label><input id="o-total" value="${d.total}"></div>
            </div>
            <div class="mb-4 mt-4"><label>Domain</label><input id="o-domain" value="${d.domain || ''}"></div>
            <div class="mb-4"><label>Update Status</label>
                <select id="upd-status"><option value="Pending" ${d.status=='Pending'?'selected':''}>Pending</option><option value="Paid" ${d.status=='Paid'?'selected':''}>Paid</option><option value="Completed" ${d.status=='Completed'?'selected':''}>Completed</option></select>
            </div>
        `, `<button class="btn btn-primary" onclick="updateOrderDetails('${id}')">Save Changes</button>`);
    }

    async function updateOrderDetails(id) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_ORDERS)) return;
        const updateData = {
            customerName: document.getElementById('o-name').value, customerEmail: document.getElementById('o-email').value,
            customerPhone: document.getElementById('o-phone').value, total: document.getElementById('o-total').value,
            domain: document.getElementById('o-domain').value.replace(/^https?:\/\//, ''), status: document.getElementById('upd-status').value
        };
        await db.collection("orders").doc(id).update(updateData);
        closeModal(); showToast("Order Updated", "success"); logActivity(`Updated Order #${id.substr(0,6)}`);
    }

    // --- 3. CLIENTS ---
    function renderClients() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="table-container">
                <div class="table-header"><h3>Client Directory</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Name</th><th>Company</th><th>Contact</th><th>Actions</th></tr></thead><tbody id="client-tbody"><tr><td colspan="4" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    <div id="client-tbody-pagination"></div>
                </div>
            </div>`;
            
        db.collection("users").where("role", "==", "user").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('client-tbody', data);
        });

        window.customTableRenderers['client-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="4" class="text-center text-muted">No clients found</td></tr>';
            return data.map(u => {
                let buttons = '';
                if(checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CLIENTS)) buttons += `<button class="btn btn-sm btn-secondary" onclick="editClient('${u.id}')">Edit</button>`;
                return `<tr><td>${u.name}</td><td>${u.company||'-'}</td><td>${u.email}<br><small style="color:var(--text-faint)">${u.phone||''}</small></td><td>${buttons}</td></tr>`;
            }).join('');
        };
    }

    function editClient(uid) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CLIENTS)) return;
        db.collection("users").doc(uid).get().then(doc => {
            const u = doc.data();
            showModal("Edit Client", `
                <label>Name</label><input id="e-name" class="mb-4" value="${u.name}">
                <label>Email</label><input id="e-email" class="mb-4" value="${u.email}">
                <label>Phone</label><input id="e-phone" class="mb-4" value="${u.phone||''}">
            `, `<button class="btn btn-primary" onclick="saveClient('${uid}')">Update</button>`);
        });
    }

    async function saveClient(uid) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CLIENTS)) return;
        const data = { name: document.getElementById('e-name').value, email: document.getElementById('e-email').value, phone: document.getElementById('e-phone').value };
        db.collection("users").doc(uid).update(data).then(() => { closeModal(); showToast("Client Updated", "success"); });
    }

    // --- 4. CREW MANAGEMENT ---
    function renderCrew() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 style="font-size:1.25rem; font-weight:800;">Internal Crew</h2>
                <button class="btn btn-primary" onclick="openAddCrewModal()"><i class="ri-add-line"></i> Add Crew</button>
            </div>
            <div class="table-container">
                <div class="table-responsive">
                    <table><thead><tr><th>Crew ID</th><th>Name</th><th>Job Title</th><th>Rate</th><th>Actions</th></tr></thead><tbody id="crew-tbody"><tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                    <div id="crew-tbody-pagination"></div>
                </div>
            </div>`;
            
        db.collection("users").where("role", "in", ["super_admin", "mid_admin", "admin", "crew"]).onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('crew-tbody', data);
        });

        window.customTableRenderers['crew-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="5" class="text-center text-muted">No crew found</td></tr>';
            return data.map(u => {
                const rate = u.personalCommissionRate !== undefined ? u.personalCommissionRate : (DEFAULT_COMMISSION_RATES[u.jobTitle] || 0);
                return `<tr>
                    <td class="font-mono" style="color:var(--primary)">${u.crewId || 'N/A'}</td>
                    <td>${u.name}</td>
                    <td>${u.jobTitle||'-'}</td>
                    <td style="font-weight:bold; color:var(--primary)">${(rate * 100).toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCrew('${u.id}')"><i class="ri-pencil-line"></i></button>
                        ${isSuperAdmin() ? `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}', '${u.name}', 'Crew')"><i class="ri-delete-bin-line"></i></button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        };
    }

    async function openAddCrewModal() {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return;
        const newCrewId = await getNextId('crew');
        const jobOptions = JOB_TITLES.map(j => `<option value="${j}">${j}</option>`).join('');
        showModal("Add New Crew", `
            <div class="mb-4"><label>Crew ID</label><input id="c-id" value="${newCrewId}" readonly></div>
            <div class="mb-4"><label>Full Name</label><input id="c-name"></div>
            <div class="mb-4"><label>Email Address</label><input type="email" id="c-email"></div>
            <div class="mb-4"><label>Job Title</label><select id="c-job" onchange="autoSetRoleAndDept()"><option value="">Select...</option>${jobOptions}</select></div>
            <div class="mb-4"><label>Temporary Password</label><input type="password" id="c-pass"></div>
        `, `<button class="btn btn-primary" onclick="saveCrew('${newCrewId}')">Create</button>`);
    }

    function autoSetRoleAndDept() {
        const title = document.getElementById('c-job').value;
        const dbRole = JOB_ROLE_MAP[title] || 'crew'; 
        // Could auto-select dept here too
    }

    async function saveCrew(newId) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return;
        const name = document.getElementById('c-name').value; const email = document.getElementById('c-email').value; const pass = document.getElementById('c-pass').value; const job = document.getElementById('c-job').value;
        if(!name || !email || !pass || !job) return showToast("Fill all fields", "error");
        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
            const dbRole = JOB_ROLE_MAP[job] || 'crew';
            const initialRate = DEFAULT_COMMISSION_RATES[job] || 0;
            await db.collection("users").doc(userCredential.user.uid).set({
                crewId: newId, name, email, role: dbRole, jobTitle: job, permissions: {}, isSuspended: false, bypassApproval: false, timestamp: firebase.firestore.FieldValue.serverTimestamp(), personalCommissionRate: initialRate
            });
            closeModal(); showToast("Crew created", "success"); logActivity(`Created crew: ${name}`);
        } catch(e) { showToast(e.message, "error"); }
    }

    function editCrew(uid) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return;
        db.collection("users").doc(uid).get().then(doc => {
            const u = doc.data();
            showModal("Edit Crew", `
                <label>Name</label><input id="e-c-name" value="${u.name}" class="mb-4">
                <label>Email</label><input id="e-c-email" value="${u.email}" class="mb-4" readonly>
                <label>Commission Rate</label><input type="number" step="0.001" id="e-c-rate" value="${u.personalCommissionRate || 0}" class="mb-4">
            `, `<button class="btn btn-primary" onclick="updateCrewData('${uid}')">Save</button>`);
        });
    }

    async function updateCrewData(uid) {
        const updatePayload = {
            name: document.getElementById('e-c-name').value,
            personalCommissionRate: parseFloat(document.getElementById('e-c-rate').value)
        };
        if (isSuperAdmin()) updatePayload.email = document.getElementById('e-c-email').value;
        db.collection("users").doc(uid).update(updatePayload).then(() => { closeModal(); showToast("Updated", "success"); });
    }

    async function deleteUser(uid, name, type) {
        if(!isSuperAdmin()) return;
        if(!confirm(`Delete ${name}?`)) return;
        try { await db.collection("users").doc(uid).delete(); showToast("Deleted", "success"); } catch(e) { showToast("Error deleting", "error"); }
    }

    // --- 5. SUPPORT ---
    function renderSupport() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="table-container">
                <div class="table-header"><h3>Support Tickets</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>ID</th><th>Date</th><th>Client</th><th>Issue</th><th>Status</th><th>Action</th></tr></thead><tbody id="supp-tbody"><tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>`;
        db.collection("tickets").orderBy("timestamp", "desc").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('supp-tbody', data);
        });
        window.customTableRenderers['supp-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="6" class="text-center text-muted">No tickets</td></tr>';
            return data.map(d => `<tr>
                <td style="color:var(--primary)">${d.ticketId || d.id}</td>
                <td>${formatDateTime(d.timestamp)}</td><td>${d.name}</td><td>${d.type}</td>
                <td><span class="badge" style="background:${d.status==='Closed'?'#f1f5f9':'#fffbeb'}; color:${d.status==='Closed'?'var(--text-faint)':'var(--accent-warn)'}">${d.status}</span></td>
                <td><button class="btn btn-sm btn-secondary" onclick="viewTicket('${d.id}')">Manage</button></td>
            </tr>`).join('');
        };
    }

    function viewTicket(id) {
        db.collection("tickets").doc(id).get().then(doc => {
            const d = doc.data();
            showModal(`Ticket: ${d.ticketId}`, `<p class="mb-4 p-4" style="background:#f8fafc; border-radius:8px;">${d.message}</p>
                <label>Status</label>
                <select id="tk-status"><option value="Open">Open</option><option value="In Progress">In Progress</option><option value="Closed">Closed</option></select>
            `, `<button class="btn btn-primary" onclick="saveTicketDetails('${id}')">Save</button>`);
        });
    }
    
    async function saveTicketDetails(id) {
        const data = { status: document.getElementById('tk-status').value };
        db.collection("tickets").doc(id).update(data).then(() => { closeModal(); showToast("Updated", "success"); });
    }

    // --- 6. VOUCHERS ---
    function renderVouchers() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4"><h3>Voucher Management</h3><button class="btn btn-primary" onclick="openAssignVoucherModal(null, null)"><i class="ri-add-line"></i> Assign</button></div>
            <div class="table-container">
                <div class="table-responsive">
                    <table><thead><tr><th>User</th><th>Code</th><th>Value</th><th>Actions</th></tr></thead><tbody id="vouch-tbody"><tr><td colspan="4" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>`;
        db.collection("users").where("personalVoucher", "!=", null).onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('vouch-tbody', data);
        });
        window.customTableRenderers['vouch-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="4" class="text-center text-muted">No vouchers</td></tr>';
            return data.map(u => {
                const v = u.personalVoucher;
                return `<tr>
                    <td>${u.name}</td>
                    <td style="color:var(--primary)">${v.code}</td>
                    <td>${v.type=='fixed'?'RM '+v.value:v.value*100+'%'}</td>
                    <td><button class="btn btn-sm btn-secondary" onclick="editVoucher('${u.id}')">Edit</button></td>
                </tr>`;
            }).join('');
        };
    }

    function openAssignVoucherModal(uid, userName) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS)) return;
        const autoCode = `GIFT-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
        showModal("Assign Voucher", `
            <div class="mb-4"><label>Code</label><input id="v-code" value="${autoCode}"></div>
            <div class="flex gap-4 mb-4">
                <div style="flex:1"><label>Type</label><select id="v-val-type"><option value="fixed">Fixed (RM)</option><option value="percent">Percent (%)</option></select></div>
                <div style="flex:1"><label>Value</label><input type="number" id="v-val"></div>
            </div>
        `, `<button class="btn btn-primary" onclick="submitAssignVoucher()">Assign</button>`);
    }

    async function submitAssignVoucher() {
        const uid = userData.uid; // Assign to self for demo, should be selected user
        const code = document.getElementById('v-code').value;
        const data = { personalVoucher: { code, type: document.getElementById('v-val-type').value, value: parseFloat(document.getElementById('v-val').value), status: 'active' } };
        db.collection("users").doc(uid).update(data).then(() => { closeModal(); showToast("Assigned", "success"); });
    }

    function editVoucher(uid) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS)) return;
        db.collection("users").doc(uid).get().then(doc => {
            const v = doc.data().personalVoucher;
            showModal(`Edit Voucher`, `
                <label>Status</label><select id="e-v-status" class="mb-4"><option value="active" ${v.status==='active'?'selected':''}>Active</option><option value="redeemed" ${v.status==='redeemed'?'selected':''}>Redeemed</option></select>
            `, `<button class="btn btn-primary" onclick="saveEditVoucher('${uid}')">Save</button>`);
        });
    }

    async function saveEditVoucher(uid) {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS)) return;
        const doc = await db.collection("users").doc(uid).get();
        const v = doc.data().personalVoucher;
        v.status = document.getElementById('e-v-status').value;
        await db.collection("users").doc(uid).update({ personalVoucher: v });
        closeModal(); showToast("Updated", "success");
    }

    // --- 7. CONTENT & PACKAGES ---
    function renderContent() {
        setPageLoading(true);
        const main = document.getElementById('main');
        const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONTENT);
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4"><h2 style="font-size:1.25rem; font-weight:800;">Content & Packages</h2>${canEdit ? `<button class="btn btn-primary" onclick="saveContentChanges()"><i class="ri-save-line"></i> Save</button>` : ''}</div>
            <div style="background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; margin-bottom:1.5rem;">
                <h3 style="margin-bottom:1rem;">Frontend Package Features</h3>
                <textarea id="content-frontend" rows="4" style="background:white;" ${canEdit?'':'readonly'}></textarea>
            </div>
        `;
        db.collection("config").doc("site_settings").get().then(doc => {
            const siteData = doc.exists ? doc.data() : {};
            const packages = siteData.packageDetails || {};
            document.getElementById('content-frontend').value = (packages.frontend && packages.frontend.features) ? packages.frontend.features.join('\n') : "Up to 5 Pages\nAnimations";
        });
    }

    async function saveContentChanges() {
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONTENT)) return;
        const frontendLines = document.getElementById('content-frontend').value.split('\n').filter(l => l.trim() !== '');
        const data = { packageDetails: { frontend: { features: frontendLines } } };
        db.collection("config").doc("site_settings").update(data).then(() => { showToast("Content Saved", "success"); });
    }

    // --- 8. CONFIG ---
    async function renderConfig() {
        setPageLoading(true);
        const main = document.getElementById('main');
        const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG);
        const canManageEmail = hasPermission(PERMISSION_KEYS.MANAGE_EMAIL);

        main.innerHTML = `
            <h2 style="font-size:1.25rem; font-weight:800; margin-bottom:1.5rem;">System Configuration</h2>
            
            <div style="background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; margin-bottom:1.5rem;">
                <h3 style="margin-bottom:1rem; display:flex; align-items:center; gap:10px;">Payment Gateways ${canEdit ? `<button class="btn btn-sm btn-primary" onclick="addGateway()"><i class="ri-add-line"></i></button>` : ''}</h3>
                <div id="gateway-list" class="flex flex-col gap-4"></div>
            </div>
            
            <div style="background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem;">
                <h3 style="margin-bottom:1rem;">SMTP Configuration</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label>Host</label><input type="text" id="smtp-host" ${canManageEmail?'':'readonly'}></div>
                    <div><label>Port</label><input type="number" id="smtp-port" ${canManageEmail?'':'readonly'}></div>
                </div>
                ${canManageEmail ? `<button class="btn btn-primary mt-4" onclick="saveSmtpConfig()">Save SMTP</button>` : ''}
            </div>
        `;
        
        db.collection("config").doc("site_settings").get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                if(d.smtp_config && canManageEmail) {
                    if(document.getElementById('smtp-host')) document.getElementById('smtp-host').value = d.smtp_config.host || '';
                    if(document.getElementById('smtp-port')) document.getElementById('smtp-port').value = d.smtp_config.port || 587;
                }
            }
        });
        db.collection("payment_methods").onSnapshot(snap => {
            const list = document.getElementById('gateway-list'); if(!list) return; list.innerHTML = '';
            snap.forEach(doc => {
                const gw = doc.data();
                list.innerHTML += `
                    <div style="background:#f8fafc; padding:1rem; border-radius:var(--radius-md); border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>${gw.name}</strong><br><small class="text-muted">${gw.link}</small></div>
                        <div style="display:flex; gap:8px;">
                            <span class="badge" style="background:${gw.active?'#ecfdf5':'#fef2f2'}; color:${gw.active?'#059669':'#dc2626'}">${gw.active?'Active':'Inactive'}</span>
                            ${canEdit ? `<button class="btn btn-sm btn-secondary" onclick="editGateway('${doc.id}')"><i class="ri-pencil-line"></i></button>` : ''}
                        </div>
                    </div>`;
            });
        });
    }

    function addGateway() { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return; showModal("Add Gateway", `<label>Name</label><input id="gw-name" class="mb-4"><label>Link</label><input id="gw-link">`, `<button class="btn btn-primary" onclick="saveNewGateway()">Add</button>`); }
    async function saveNewGateway() { const name = document.getElementById('gw-name').value; const link = document.getElementById('gw-link').value; await db.collection("payment_methods").add({ name, link, active: true }); closeModal(); renderConfig(); }
    function editGateway(docId) { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return; db.collection("payment_methods").doc(docId).get().then(doc => { const gw = doc.data(); showModal("Edit", `<label>Name</label><input id="e-gw-name" value="${gw.name}"><label>Link</label><input id="e-gw-link" value="${gw.link}">`, `<button class="btn btn-primary" onclick="saveEditedGateway('${docId}')">Save</button>`); }); }
    async function saveEditedGateway(docId) { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return; const name = document.getElementById('e-gw-name').value; const link = document.getElementById('e-gw-link').value; await db.collection("payment_methods").doc(docId).update({ name, link }); closeModal(); renderConfig(); }
    async function saveSmtpConfig() { if(!hasPermission(PERMISSION_KEYS.MANAGE_EMAIL)) return; const config = { host: document.getElementById('smtp-host').value, port: parseInt(document.getElementById('smtp-port').value) || 587 }; await db.collection("config").doc("site_settings").update({ smtp_config: config }); showToast("Saved", "success"); }

    // --- 9. PORTFOLIO ---
    function renderPortfolio() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4"><h2>Client Portfolio</h2><button class="btn btn-primary" onclick="openAddPortfolioModal()"><i class="ri-add-line"></i> Add</button></div>
            <div class="table-container">
                <div class="table-responsive">
                    <table><thead><tr><th>Image</th><th>Name</th><th>Link</th><th>Action</th></tr></thead><tbody id="portfolio-tbody"><tr><td colspan="4" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>
        `;
        db.collection("clients_portfolio").orderBy("timestamp", "desc").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('portfolio-tbody', data);
        });
        window.customTableRenderers['portfolio-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="4" class="text-center text-muted">No projects</td></tr>';
            return data.map(p => `<tr><td><img src="${p.img}" style="width:40px; height:40px; object-fit:cover; border-radius:8px;"></td><td><strong>${p.name}</strong></td><td><a href="${p.link}" target="_blank" class="btn btn-sm btn-secondary">Visit</a></td><td><button class="btn btn-sm btn-secondary" onclick="editPortfolio('${p.id}')">Edit</button></td></tr>`).join('');
        };
    }

    function openAddPortfolioModal() { 
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return; 
        const initialId = generateDocIdFromName('');
        showModal("Add Project", `<label>Name</label><input id="p-name" class="mb-4" oninput="updateDocIdPreview()"><label>Image URL</label><input id="p-img" class="mb-4"><label>Link</label><input id="p-link">`, `<button class="btn btn-primary" onclick="saveNewPortfolio()">Create</button>`); 
    }
    async function saveNewPortfolio() { 
        if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return; 
        const name = document.getElementById('p-name').value; const img = document.getElementById('p-img').value; const link = document.getElementById('p-link').value; 
        if(!name || !img || !link) return showToast("Fill all", "error");
        const data = { name, img, link, status: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection("clients_portfolio").doc(generateDocIdFromName(name)).set(data);
        closeModal(); showToast("Added", "success");
    }

    // --- 10. REQUESTS ---
    function renderRequests() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="table-container">
                <div class="table-header"><h3>Customer Requests</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Date</th><th>Client</th><th>Type</th><th>Status</th><th>Action</th></tr></thead><tbody id="req-tbody"><tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>
        `;
        db.collection("customer_requests").orderBy("timestamp", "desc").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('req-tbody', data);
        });
        window.customTableRenderers['req-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="5" class="text-center text-muted">No requests</td></tr>';
            return data.map(d => `<tr><td>${formatDateTime(d.timestamp)}</td><td><strong>${d.name}</strong><br><small>${d.email}</small></td><td>${d.type}</td><td><span class="badge">${d.status}</span></td><td><button class="btn btn-sm btn-secondary" onclick="viewRequestDetails('${d.id}')">View</button></td></tr>`).join('');
        };
    }

    function viewRequestDetails(id) {
        db.collection("customer_requests").doc(id).get().then(doc => {
            const d = doc.data();
            showModal(`Request Details`, `
                <p style="background:#f8fafc; padding:1rem; border-radius:8px; margin-bottom:1rem;">${d.details}</p>
                <label>Update Status</label>
                <select id="req-status-select"><option value="Pending">Pending</option><option value="Completed">Completed</option></select>
            `, `<button class="btn btn-primary" onclick="updateRequestStatus('${id}', null, true)">Save</button>`);
        });
    }

    function updateRequestStatus(id, newStatus = null, fromModal = false) {
        const statusToSet = newStatus || document.getElementById('req-status-select').value;
        db.collection("customer_requests").doc(id).update({ status: statusToSet }).then(() => { if(fromModal) closeModal(); showToast("Updated", "success"); });
    }

    // --- 11. PUBLIC PROMO CODES ---
    function renderPublicPromos() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4"><h3>Public Promos</h3><button class="btn btn-primary" onclick="addPublicPromo()"><i class="ri-add-line"></i> Add</button></div>
            <div class="table-container">
                <div class="table-responsive">
                    <table><thead><tr><th>Code</th><th>Discount</th><th>Action</th></tr></thead><tbody id="public-promos-tbody"><tr><td colspan="3" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>
        `;
        db.collection("promo_codes").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('public-promos-tbody', data);
        });
        window.customTableRenderers['public-promos-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="3" class="text-center text-muted">No codes</td></tr>';
            return data.map(d => `<tr><td style="color:var(--accent-warn); font-weight:700;">${d.id}</td><td>${(d.discount * 100)}%</td><td><button class="btn btn-sm btn-danger" onclick="deletePublicPromo('${d.id}')"><i class="ri-delete-bin-line"></i></button></td></tr>`).join('');
        };
    }
    function addPublicPromo() { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS)) return; showModal("Add Promo", `<label>Code</label><input id="pub-promo-code" class="mb-4"><label>Discount (Decimal)</label><input type="number" id="pub-promo-discount">`, `<button class="btn btn-primary" onclick="savePublicPromo()">Create</button>`); }
    async function savePublicPromo() { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS)) return; const code = document.getElementById('pub-promo-code').value.trim().toUpperCase(); const discount = parseFloat(document.getElementById('pub-promo-discount').value); if(!code || isNaN(discount)) return; await db.collection("promo_codes").doc(code).set({ discount }); closeModal(); showToast("Created", "success"); }
    async function deletePublicPromo(code) { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS)) return; await db.collection("promo_codes").doc(code).delete(); showToast("Deleted", "success"); }

    // --- 12. FINANCE OVERVIEW ---
    function renderFinanceOverview() {
        setPageLoading(true);
        const main = document.getElementById('main');
        main.innerHTML = `
            <div class="flex justify-between items-center mb-4"><h2>Finance Department</h2></div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon"><i class="ri-money-dollar-circle-line"></i></div><div class="stat-info"><div class="stat-val" id="comm-total-earnings">RM 0.00</div><div class="stat-label">Total Payouts</div></div></div>
            </div>
            <div class="table-container">
                <div class="table-header"><h3>Commissions</h3></div>
                <div class="table-responsive">
                    <table><thead><tr><th>Ref</th><th>Date</th><th>Crew</th><th>Status</th><th>Amount</th><th>Action</th></tr></thead><tbody id="comm-tbody"><tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>
        `;
        
        db.collection("commission_overview").orderBy("orderDate", "desc").get().then(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            let sum = 0; data.forEach(d => { if(d.status==='paid') sum += d.amount; });
            document.getElementById('comm-total-earnings').innerText = `RM ${sum.toFixed(2)}`;
            TableEngine.updateData('comm-tbody', data);
        });

        window.customTableRenderers['comm-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="6" class="text-center text-muted">No commissions</td></tr>';
            return data.map(d => {
                const isPaid = d.status === 'paid';
                return `<tr>
                    <td class="font-mono text-sm">${d.orderId ? d.orderId.substring(0,6) : 'N/A'}</td>
                    <td>${d.orderDate ? formatDateTime(d.orderDate) : '-'}</td>
                    <td><strong>${d.crewName}</strong></td>
                    <td><span class="badge" style="background:${isPaid?'#ecfdf5':'#fffbeb'}; color:${isPaid?'#059669':'#d97706'}">${isPaid ? 'Paid' : 'Unpaid'}</span></td>
                    <td style="font-weight:700;">RM ${d.amount.toFixed(2)}</td>
                    <td>${canAccessFinanceTools() ? `<button class="btn btn-sm ${isPaid?'btn-secondary':'btn-primary'}" onclick="markCommissionPaid('${d.id}', '${d.crewId}')">${isPaid ? 'Undo' : 'Pay'}</button>` : ''}</td>
                </tr>`;
            }).join('');
        };
    }

    async function markCommissionPaid(docId, crewId) {
        if(!canAccessFinanceTools()) return;
        const docRef = db.collection("commission_overview").doc(docId);
        const docSnap = await docRef.get();
        if(!docSnap.exists) return;
        const currentStatus = docSnap.data().status || 'unpaid';
        const newStatus = currentStatus === 'unpaid' ? 'paid' : 'unpaid';
        const paidData = newStatus === 'paid' ? { status: newStatus, paidAt: firebase.firestore.FieldValue.serverTimestamp(), paidBy: userData.name } : { status: newStatus, paidAt: null, paidBy: null };
        await docRef.update(paidData);
        showToast("Updated", "success");
        renderFinanceOverview();
    }

    // --- 13. APPROVAL TOOLS ---
    function renderApprovals() {
        setPageLoading(true);
        const main = document.getElementById('main');
        if(!hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) { main.innerHTML = `<div style="text-align:center; padding:5rem;"><h2>Access Denied</h2></div>`; return; }
        main.innerHTML = `
            <h2 style="font-size:1.5rem; font-weight:800; color: var(--accent-warn); margin-bottom:1.5rem;"><i class="ri-shield-check-line"></i> Approval Tools</h2>
            <div class="table-container">
                <div class="table-responsive">
                    <table><thead><tr><th>Time</th><th>Requester</th><th>Action</th><th>Actions</th></tr></thead><tbody id="approvals-tbody"><tr><td colspan="4" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                </div>
            </div>
        `;
        db.collection("pending_edits").orderBy("timestamp", "desc").onSnapshot(snap => {
            const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            TableEngine.updateData('approvals-tbody', data);
        });
        window.customTableRenderers['approvals-tbody'] = function(data) {
            if(data.length === 0) return '<tr><td colspan="4" class="text-center text-muted">No requests</td></tr>';
            return data.map(r => {
                const isPending = r.status === 'Pending';
                return `<tr>
                    <td>${formatDateTime(r.timestamp)}</td>
                    <td><strong>${r.requesterName}</strong><br><small>${r.requesterEmail}</small></td>
                    <td><span class="badge">${r.permissionKey}</span></td>
                    <td>${isPending ? `<button class="btn btn-sm btn-success" onclick="processApproval('${r.id}', 'Approved')">Approve</button> <button class="btn btn-sm btn-danger" onclick="processApproval('${r.id}', 'Rejected')">Reject</button>` : `<small class="text-muted">${r.status}</small>`}</td>
                </tr>`;
            }).join('');
        };
    }

    async function processApproval(requestId, action) {
        if(!confirm(`${action} this request?`)) return;
        const requestRef = db.collection("pending_edits").doc(requestId);
        const requestSnap = await requestRef.get(); const r = requestSnap.data();
        await requestRef.update({ status: action, processedBy: userData.name, processedAt: firebase.firestore.FieldValue.serverTimestamp() });
        if (action === 'Approved' && r.payload) {
            if (r.targetId) await db.collection(r.targetCollection).doc(r.targetId).update(r.payload);
            else await db.collection(r.targetCollection).add(r.payload);
            showToast("Approved", "success");
        } else { showToast("Rejected", "error"); }
    }

    // --- 14. MY PROFILE ---
    function renderMyProfile() {
        setPageLoading(true);
        const main = document.getElementById('main');
        const canEdit = hasPermission(PERMISSION_KEYS.EDIT_ACCESS);
        
        main.innerHTML = `
            <div style="background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-lg); max-width:600px; margin:0 auto; padding:2rem;">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 style="font-size:1.25rem;">My Profile</h2>
                        <span class="badge badge-${userData.role==='super_admin'?'admin':'crew'}">${userData.role}</span>
                    </div>
                    ${canEdit ? `<button class="btn btn-primary" onclick="openEditMyProfile()"><i class="ri-pencil-line"></i></button>` : ''}
                </div>
                <div class="mb-4"><label class="text-muted">Name</label><input value="${userData.name}" readonly></div>
                <div class="mb-4"><label class="text-muted">Email</label><input value="${userData.email}" readonly></div>
            </div>
        `;
    }

    function openEditMyProfile() {
        if(!hasPermission(PERMISSION_KEYS.EDIT_ACCESS)) return;
        showModal("Edit Profile", `
            <div class="mb-4"><label>Name</label><input id="my-name" value="${userData.name}"></div>
            <div class="mb-4"><label>Phone</label><input id="my-phone" value="${userData.phone||''}"></div>
        `, `<button class="btn btn-primary" onclick="saveMyProfile()">Save</button>`);
    }

    async function saveMyProfile() {
        const updates = { name: document.getElementById('my-name').value, phone: document.getElementById('my-phone').value };
        await db.collection("users").doc(currentUser.uid).update(updates);
        closeModal(); showToast("Saved", "success"); renderMyProfile();
    }
</script>
</body>
</html>
