<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HQ-DDNetwork-Portal</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/ddnetwork-one/ddnetwork-store/refs/heads/main/crop_ddnlogo.png">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* --- CSS VARIABLES (SYNCED WITH MAIN SITE) --- */
        :root {
            /* Backgrounds */
            --bg-deep: #f1f5f9; 
            --bg-surface: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --bg-glass-dark: rgba(30, 41, 59, 0.05);
            
            /* Borders & Effects */
            --border-glass: rgba(30, 41, 59, 0.08);
            --border-highlight: rgba(255, 255, 255, 0.5);
            --shadow-glass: 0 8px 32px rgba(30, 41, 59, 0.08);
            --shadow-card-hover: 0 20px 40px rgba(30, 41, 59, 0.12);
            
            /* Text */
            --text-main: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            
            /* Accents */
            --soft-black: #1e293b;
            --soft-black-hover: #0f172a;
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --ticket: #7c3aed; 
            --info: #0284c7;
            
            /* Dimensions */
            --font-main: 'Inter', sans-serif;
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 80px;
            --header-height: 70px;
            --maintenance-bar-height: 40px;

            /* Z-Index */
            --z-base: 1;
            --z-sidebar: 100;
            --z-header: 200;
            --z-dropdown: 300;
            --z-modal-overlay: 1000;
            --z-modal-content: 1010;
            --z-toast: 2000;
            --z-maintenance: 5000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-deep); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            /* Noise Texture like Main Site */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mt-2 { margin-top: 0.5rem; } .mt-4 { margin-top: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.85rem; }
        .font-bold { font-weight: 700; }
        .text-muted { color: var(--text-secondary); }
        .block { display: block; }
        .font-mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }

        /* --- SCROLLBAR (Premium) --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius:4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- BUTTONS (Main Site Style) --- */
        .btn {
            padding: 0.65rem 1.3rem; 
            border-radius: 100px; /* Pill shape like main site */
            border: 1px solid transparent; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85rem; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            white-space: nowrap;
            color: white;
            background: var(--soft-black);
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.15);
        }
        .btn:hover { background: var(--soft-black-hover); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(30, 41, 59, 0.2); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--text-tertiary); transform: none; box-shadow: none; }

        /* Secondary/Ghost Buttons */
        .btn-secondary { background: rgba(255,255,255,0.6); color: var(--text-main); border: 1px solid var(--border-glass); box-shadow: none; }
        .btn-secondary:hover { background: white; border-color: var(--text-tertiary); box-shadow: var(--shadow-glass); }
        
        .btn-glass { background: rgba(255,255,255,0.5); color: var(--soft-black); border: 1px solid var(--border-glass); backdrop-filter: blur(5px); box-shadow: none; }
        .btn-glass:hover { background: white; }

        /* Functional Colors */
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #059669; }
        .btn-info { background: var(--info); }
        .btn-info:hover { background: #0369a1; }
        
        .btn-sm { padding: 0.4rem 0.9rem; font-size: 0.75rem; }
        
        .btn-icon { 
            padding: 0.5rem; border-radius: 12px; background: transparent; color: var(--text-secondary); 
            cursor: pointer; border: none; transition: 0.2s; display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px;
        }
        .btn-icon:hover { color: var(--text-main); background: rgba(0,0,0,0.05); }

        /* --- FORMS (Main Site Style) --- */
        input, select, textarea {
            width:100%; padding: 0.75rem 1rem; background: rgba(255,255,255,0.6); border:1px solid var(--border-glass); 
            border-radius: 12px; color: var(--text-main); font-family: inherit; font-size: 0.9rem; transition: 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        input:focus, select:focus, textarea:focus { border-color: var(--soft-black); background: white; box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.1); }
        input[readonly], textarea[readonly] { background: #f8fafc; cursor: default; border-color: transparent; color: var(--text-secondary); box-shadow: none; }
        label { display: block; margin-bottom: 0.4rem; color: var(--text-secondary); font-size: 0.75rem; font-weight: 700; letter-spacing: 0.3px; text-transform: uppercase; }

        /* --- AUTH SCREEN (Glass Card) --- */
        #auth-screen { 
            position: fixed; inset: 0; background: var(--bg-deep); 
            z-index: 9999; display: flex; align-items: center; justify-content: center; padding:1rem;
        }
        .auth-card { 
            width: 100%; max-width: 420px; padding: 2.5rem; 
            background: var(--bg-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-glass);
            border-top: 1px solid var(--border-highlight);
            border-radius: 24px; 
            box-shadow: var(--shadow-card-hover);
            text-align: center; 
        }
        .auth-logo { width: 60px; height: auto; margin-bottom: 1.5rem; }

        /* --- MAINTENANCE TICKER --- */
        #maintenance-bar {
            height: var(--maintenance-bar-height); background: var(--danger); color: white; font-size: 0.85rem; 
            font-weight: 600; display: none; align-items: center; overflow: hidden; white-space: nowrap; 
            position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-maintenance);
        }
        #maintenance-bar.active { display: block; }
        .ticker-content { display: inline-block; padding-left: 100%; animation: ticker-loop 20s linear infinite; }
        @keyframes ticker-loop { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- LAYOUT --- */
        #dashboard { display: flex; width: 100%; height: 100vh; overflow: hidden; position: relative; padding-top: var(--maintenance-bar-height); transition: padding-top 0.3s; }
        #dashboard.no-maintenance { padding-top: 0; }
        
        .sidebar-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px);
            z-index: var(--z-sidebar); opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* SIDEBAR (Glass Effect) */
        aside { 
            width: var(--sidebar-width); 
            background: var(--bg-glass);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-right: 1px solid var(--border-glass);
            display: flex; flex-direction: column; z-index: var(--z-sidebar); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed; top: var(--header-height); bottom: 0; left: 0;
        }
        aside.collapsed { width: var(--sidebar-width-collapsed); }
        aside.collapsed .nav-text, aside.collapsed .nav-section-title, aside.collapsed .u-details, aside.collapsed .user-mini-profile p { opacity: 0; pointer-events: none; display: none; }
        aside.collapsed .nav-item { padding: 0.8rem 0; justify-content: center; }
        aside.collapsed .nav-item i { font-size: 1.4rem; margin: 0; }
        aside.collapsed .header-brand span { display: none; }
        aside.collapsed .btn-danger span { display: none; }
        aside.collapsed .user-mini-profile { padding: 1rem 0; justify-content: center; }

        /* HEADER (Sticky Glass) */
        header {
            height: var(--header-height); background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-glass);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5rem; position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-header);
        }
        .has-maintenance header { top: var(--maintenance-bar-height); }
        
        .header-left { display: flex; align-items: center; gap: 1.5rem; flex: 1; }
        .header-brand { font-weight: 800; font-size: 1.1rem; color: var(--text-main); letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        .header-brand img { height: 35px; }
        
        .header-search { position: relative; max-width: 400px; width: 100%; display: none; }
        @media(min-width: 768px) { .header-search { display: block; } }
        
        .header-search input {
            width: 100%; padding-left: 2.5rem; border-radius: 20px; background: rgba(255,255,255,0.5); border: 1px solid var(--border-glass);
        }
        .header-search i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); }

        .header-actions { display: flex; align-items: center; gap: 0.5rem; position: relative; height: 100%; }
        .notification-dot { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 2px solid white; pointer-events: none; z-index: 10; }
        
        /* Search & Notif Dropdowns */
        #search-results, .notif-dropdown {
            position: absolute; top: 80px; right: 0; width: 320px; background: var(--bg-surface);
            border: 1px solid var(--border-glass); border-radius: 16px; box-shadow: var(--shadow-card-hover);
            display: none; flex-direction: column; max-height: 400px; overflow-y: auto; z-index: var(--z-dropdown);
        }
        #search-results { right: auto; left: 0; width: 100%; max-width: 400px; }
        #search-results.active, .notif-dropdown.show { display: flex; }
        
        .search-item, .notif-item { padding: 0.9rem 1.2rem; border-bottom: 1px solid var(--border-glass); cursor: pointer; transition: 0.2s; }
        .search-item:hover, .notif-item:hover { background: #f8fafc; }
        .notif-item strong { color: var(--text-main); display: block; margin-bottom: 2px; font-size: 0.85rem; }
        .notif-item div { color: var(--text-secondary); font-size: 0.8rem; line-height: 1.4; }
        .notif-time { font-size: 0.7rem; color: var(--text-tertiary); margin-top: 4px; display: block; }

        /* Sidebar Navigation */
        .user-mini-profile { padding: 1.5rem; border-bottom: 1px solid var(--border-glass); background: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 12px; }
        .u-info { display: flex; align-items: center; gap: 12px; width: 100%; }
        .u-avatar { 
            width: 40px; height: 40px; background: var(--soft-black); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; 
            color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-shrink: 0;
        }
        .u-details h4 { font-size: 0.9rem; color: var(--text-main); font-weight: 700; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .u-details p { font-size: 0.75rem; color: var(--text-secondary); font-weight: 500; }

        .nav-scroll { flex: 1; overflow-y: auto; padding: 1rem 0; }
        .nav-section-title { 
            padding: 1rem 1.5rem 0.5rem; font-size: 0.65rem; color: var(--text-tertiary); 
            text-transform: uppercase; font-weight: 700; letter-spacing: 1px; 
        }
        .nav-item { 
            padding: 0.7rem 1.5rem; display: flex; align-items: center; gap: 12px; color: var(--text-secondary); cursor: pointer; 
            transition: 0.2s; border-left: 3px solid transparent; font-weight: 500; margin-right: 0.5rem;
            border-radius: 0 8px 8px 0; position: relative; user-select: none;
        }
        .nav-item:hover { background: rgba(0,0,0,0.03); color: var(--text-main); }
        .nav-item.active { background: rgba(30, 41, 59, 0.05); color: var(--soft-black); border-left-color: var(--soft-black); font-weight: 600; }
        .nav-item.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .nav-item i { font-size: 1.15rem; }
        .nav-item.pinned { color: var(--primary); }
        .nav-item.pinned::after {
            content: '\eb4a'; font-family: 'remixicon';
            position: absolute; right: 15px; font-size: 0.8rem; opacity: 0.7;
        }

        /* MAIN CONTENT AREA */
        main { 
            flex:1; overflow-y: auto; overflow-x: hidden; background: transparent; padding: 2rem; position: relative; 
            margin-top: var(--header-height); min-height: calc(100vh - var(--header-height)); width: 100%;
            margin-left: var(--sidebar-width); transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- COMPONENTS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.25rem; margin-bottom: 2.5rem; }
        
        /* Glass Card for Stats */
        .stat-card { 
            background: var(--bg-glass); padding: 1.5rem; border-radius: 20px; border: 1px solid var(--border-glass);
            border-top: 1px solid var(--border-highlight);
            display: flex; align-items: center; gap: 1.2rem; transition: all 0.3s; box-shadow: var(--shadow-glass);
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-card-hover); border-color: var(--soft-black); }
        .stat-icon { 
            width: 48px; height: 48px; border-radius: 14px; background: white; display: flex; 
            align-items: center; justify-content: center; font-size: 1.4rem; color: var(--soft-black);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .stat-info { display: flex; flex-direction: column; }
        .stat-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); line-height: 1.1; margin-bottom: 4px; letter-spacing: -1px; }
        .stat-label { color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Quick Actions */
        .quick-actions-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 2rem;
        }
        .quick-action-card {
            background: white; border: 1px solid var(--border-glass); border-radius: 16px; padding: 1.5rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;
            cursor: pointer; transition: 0.3s; text-align: center;
        }
        .quick-action-card:hover { border-color: var(--soft-black); transform: translateY(-3px); box-shadow: var(--shadow-glass); }
        .quick-action-card i { font-size: 1.5rem; color: var(--soft-black); }

        /* Responsive Table Container */
        .table-container { 
            background: var(--bg-glass); border-radius: 20px; border: 1px solid var(--border-glass); overflow: hidden; 
            margin-bottom: 2rem; box-shadow: var(--shadow-glass); 
            backdrop-filter: blur(12px);
        }
        .table-header { padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border-glass); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.4); flex-wrap: wrap; gap: 10px; }
        .table-header h3 { font-size: 1rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.3px; }
        .table-responsive { 
            overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; 
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 0.9rem 1.2rem; color: var(--text-secondary); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; background: rgba(241, 245, 249, 0.5); white-space: nowrap; border-bottom: 1px solid var(--border-glass); letter-spacing: 0.5px; }
        td { padding: 1rem 1.2rem; border-bottom: 1px solid var(--border-glass); color: var(--text-main); font-size: 0.85rem; vertical-align: middle; transition: 0.1s; background: rgba(255,255,255,0.3); white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.6); }

        /* --- MODALS & TOASTS --- */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(6px); 
            z-index: var(--z-modal-overlay); display: none; justify-content: center; align-items: center; padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        .modal { 
            background: var(--bg-surface); width: 100%; max-width: 520px; border-radius: 24px; border: 1px solid var(--border-glass); 
            display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-header { padding: 1.5rem 1.5rem 1rem; border-bottom: 1px solid var(--border-glass); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 24px 24px 0 0; flex-shrink: 0; }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1.2rem 1.5rem; border-top: 1px solid var(--border-glass); display: flex; justify-content: flex-end; gap: 0.75rem; border-radius: 0 0 24px 24px; background: #f8fafc; flex-shrink: 0; }

        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: var(--z-toast); display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: var(--bg-surface); color: var(--text-main); padding:1rem 1.25rem; border-radius: 12px; 
            border: 1px solid var(--border-glass); box-shadow: var(--shadow-card-hover); display: flex; 
            align-items: center; gap: 12px; transform: translateX(120%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            min-width: 300px; pointer-events: auto;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }

        /* --- MISCELLANEOUS --- */
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; display: inline-block; letter-spacing: 0.3px; border: 1px solid transparent; }
        .badge-admin { background: #fffbeb; color: var(--warning); border-color: #fde68a; }
        .badge-crew { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; }
        .badge-user { background: #f3f4f6; color: var(--text-main); border-color: #e5e7eb; }
        .badge-content { background: #f0f9ff; color: var(--info); border-color: #bae6fd; }
        .badge-upgrade { background: #ecfdf5; color: var(--success); border-color: #a7f3d0; }
        .badge-renew { background: #f5f3ff; color: var(--ticket); border-color: #ddd6fe; }
        .badge-remove { background: #fef2f2; color: var(--danger); border-color: #fecaca; }
        .badge-website { background: #e0f2fe; color: #0284c7; border-color: #bae6fd; }

        .diff-viewer { background: #f8fafc; border: 1px solid var(--border-glass); border-radius: 12px; padding: 12px; font-family: var(--font-mono); font-size: 0.8rem; margin-top: 5px; }
        .diff-line { display: flex; border-bottom:1px solid #e2e8f0; padding: 4px 0; }
        .diff-line:last-child { border-bottom: none; }
        .diff-label { width: 80px; font-weight: 600; color: var(--text-secondary); flex-shrink: 0; }
        .diff-val { flex: 1; word-break: break-all; }
        .diff-val.old { color: var(--danger); text-decoration: line-through; opacity: 0.7; margin-right: 8px; }
        .diff-val.new { color: var(--success); font-weight: 600; }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e7eb; transition: .4s; border-radius: 34px; border: 1px solid #d1d5db; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--soft-black); border-color: var(--soft-black); }
        input:checked + .slider:before { transform: translateX(20px); }

        .loading-spinner { border: 3px solid rgba(0,0,0,0.05); border-left-color: var(--soft-black); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .page-loader { display: flex; justify-content: center; align-items: center; height: 300px; width: 100%; }

        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fffbeb; color: var(--warning); border: 1px solid #fcd34d; }
        .status-approved { background: #ecfdf5; color: var(--success); border: 1px solid #6ee7b7; }
        .status-rejected { background: #fef2f2; color: var(--danger); border: 1px solid #fca5a5; }
        .status-paid { background: #ecfdf5; color: var(--success); border: 1px solid #6ee7b7; }
        .status-unpaid { background: #fffbeb; color: var(--warning); border: 1px solid #fcd34d; }

        /* --- TABS & FORMS --- */
        .tabs-nav { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-glass); padding-bottom: 0.5rem; }
        .tab-btn {
            padding: 0.75rem 1rem; background: transparent; border: none; border-bottom: 2px solid transparent;
            color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
            border-radius: 8px 8px 0 0;
        }
        .tab-btn:hover { color: var(--soft-black); }
        .tab-btn.active { color: var(--soft-black); border-bottom-color: var(--soft-black); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .multi-select-container { border: 1px solid var(--border-glass); border-radius: 8px; background: rgba(255,255,255,0.5); max-height: 150px; overflow-y: auto; padding: 0.5rem; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; padding: 0.5rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        .checkbox-item:hover { background: #f8fafc; }
        .checkbox-item input { width: auto; margin: 0; }
        .checkbox-item span { font-size: 0.9rem; color: var(--text-main); }

        .config-section { background: var(--bg-glass); border: 1px solid var(--border-glass); border-radius: 20px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); }
        .config-header { font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-glass); color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .gateway-card { background: #f8fafc; padding: 1rem; border-radius: 16px; border: 1px solid var(--border-glass); display: flex; flex-direction: column; gap: 0.5rem; }

        /* ACCESS DENIED */
        .access-denied-container { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary); padding: 2rem; }
        .access-denied-icon { font-size: 4rem; color: var(--danger); margin-bottom: 1rem; opacity: 0.8; }
        .access-denied-title { font-size: 1.5rem; color: var(--text-main); margin-bottom: 0.5rem; font-weight: 800; }
        .access-denied-desc { font-size: 1rem; max-width: 400px; line-height: 1.5; margin-bottom: 2rem; }

        /* Request Grid */
        .req-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .req-col { display: flex; flex-direction: column; gap: 0.5rem; }
        .req-field { display: flex; flex-direction: column; }
        .req-field label { font-size: 0.7rem; color: var(--text-tertiary); margin-bottom: 2px; text-transform: uppercase; font-weight: 700; }
        .req-value { font-size: 0.9rem; color: var(--text-main); }
        .req-full-width { grid-column: 1 / -1; }

        /* RESPONSIVE */
        @media(max-width: 1024px) {
            aside { transform: translateX(-100%); width: 280px; box-shadow: 20px 0 40px rgba(0,0,0,0.1); }
            aside.mobile-open { transform: translateX(0); }
            main { margin-left: 0 !important; width: 100% !important; padding: 1rem; padding-top: 5rem; }
            .header-brand span { display: none; }
            .notif-dropdown { right: 0; width: 90vw; }
            .req-grid { grid-template-columns: 1fr; }
            .header-search { max-width: 150px; }
        }
        @media(min-width: 1025px) and (max-width: 1440px) { .invoice-paper { transform: scale(0.85); } }
        
        /* Invoice Print Styles */
        .invoice-box { max-width: 850px; margin: auto; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); font-family: "Segoe UI", Arial, sans-serif; color: #333; }
        .invoice-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .invoice-company h2 { margin: 0; color: #4f46e5; }
        .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .invoice-table thead { background: #f0f2ff; }
        .invoice-table th, .invoice-table td { padding: 14px; text-align: left; font-size: 14px; border-bottom: 1px solid #eee; }
        
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-one/ddnetwork-store/refs/heads/main/crop_ddnlogo.png" alt="Logo" class="auth-logo">
            <h2 class="mb-4" style="color:var(--text-main); font-weight: 800; letter-spacing: -0.5px;">HQ Portal v3.1</h2>
            <p class="mb-4 text-muted">Enterprise Edition <span style="font-size:0.7em; background:#e0e7ff; color:#4338ca; padding:2px 6px; border-radius:4px;">SECURE</span></p>
            <form id="loginForm">
                <input type="text" id="loginInput" class="mb-4" placeholder="Email or Crew ID" required>
                <input type="password" id="loginPass" class="mb-4" placeholder="Password" required>
                <button type="submit" class="btn" style="width: 100%;">Secure Login</button>
            </form>
        </div>
    </div>

    <!-- MAINTENANCE TICKER BAR -->
    <div id="maintenance-bar">
        <div class="ticker-content" id="maintenance-text">System Maintenance in Progress. Please Stand By.</div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- GLOBAL HEADER -->
        <header>
            <div class="header-left">
                <button class="btn-icon" onclick="toggleSidebar()" title="Toggle Menu"><i class="ri-menu-line" style="font-size: 1.4rem;"></i></button>
                <div class="header-brand">
                    <img src="https://raw.githubusercontent.com/ddnetwork-one/ddnetwork-store/refs/heads/main/crop_ddnlogo.png" alt="DDNetwork">
                    <span>HQ-DDNetwork</span>
                </div>
                
                <!-- GLOBAL SEARCH -->
                <div class="header-search">
                    <i class="ri-search-line"></i>
                    <input type="text" id="globalSearch" placeholder="Search Orders, Clients..." onkeyup="handleGlobalSearch(this.value)">
                    <div id="search-results">
                        <!-- Results injected here -->
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="location.reload()" title="Force Refresh"><i class="ri-refresh-line"></i></button>
                
                <button class="btn-icon" id="notif-btn" onclick="toggleNotifications()">
                    <i class="ri-notification-3-line" style="font-size: 1.3rem;"></i>
                    <span class="notification-dot" id="notifDot"></span>
                    <div class="notif-dropdown" id="notifDropdown">
                        <div class="p-4 text-center" style="color:var(--text-muted)">Loading activity logs...</div>
                    </div>
                </button>

                <div class="u-avatar" style="width:32px; height:32px; font-size:0.85rem;" id="header-avatar">A</div>
            </div>
        </header>

        <!-- SIDEBAR -->
        <aside id="sidebar">
            <div class="user-mini-profile">
                <div class="u-info">
                    <div class="u-avatar" id="side-avatar">A</div>
                    <div class="u-details">
                        <h4 id="side-name">Loading...</h4>
                        <p id="side-job">Loading...</p>
                    </div>
                </div>
            </div>
            
            <!-- Pinned Section (Dynamic) -->
            <div id="pinned-section" class="hidden">
                <div class="nav-section-title"><span class="nav-text">Pinned</span></div>
                <div id="pinned-list"></div>
            </div>

            <div class="nav-scroll">
                <div class="nav-section-title"><span class="nav-text">Overview</span></div>
                <div class="nav-item" onclick="navigateTo('/')"><i class="ri-dashboard-line"></i> <span class="nav-text">Dashboard</span></div>
                
                <div class="nav-section-title"><span class="nav-text">Operations</span></div>
                <div class="nav-item" onclick="navigateTo('/orders')" id="nav-orders" oncontextmenu="handleContextMenu(event, '/orders', 'Orders')"><i class="ri-shopping-bag-3-line"></i> <span class="nav-text">Orders</span></div>
                <div class="nav-item" onclick="navigateTo('/clients')" id="nav-clients" oncontextmenu="handleContextMenu(event, '/clients', 'Clients')"><i class="ri-user-line"></i> <span class="nav-text">Clients</span></div>
                <div class="nav-item" onclick="navigateTo('/requests')" id="nav-requests" oncontextmenu="handleContextMenu(event, '/requests', 'Requests')"><i class="ri-database-2-line"></i> <span class="nav-text">Requests</span></div>
                <div class="nav-item" onclick="navigateTo('/support')" id="nav-support" oncontextmenu="handleContextMenu(event, '/support', 'Support')"><i class="ri-customer-service-2-line"></i> <span class="nav-text">Support</span></div>
                <div class="nav-item" onclick="navigateTo('/vouchers')" id="nav-vouchers"><i class="ri-ticket-2-line"></i> <span class="nav-text">Vouchers</span></div>
                
                <div class="nav-section-title"><span class="nav-text">Management</span></div>
                <div class="nav-item" onclick="navigateTo('/portfolio')" id="nav-portfolio"><i class="ri-gallery-line"></i> <span class="nav-text">Portfolio</span></div>
                <div class="nav-item" onclick="navigateTo('/content')" id="nav-content"><i class="ri-layout-masonry-line"></i> <span class="nav-text">Content & Pkg</span></div>
                <div class="nav-item" onclick="navigateTo('/public-promos')" id="nav-public-promos"><i class="ri-coupon-3-line"></i> <span class="nav-text">Public Promos</span></div>
                
                <div class="nav-section-title"><span class="nav-text">System</span></div>
                <div class="nav-item" onclick="navigateTo('/crew')" id="nav-crew"><i class="ri-team-line"></i> <span class="nav-text">Internal Crew</span></div>
                <div class="nav-item" onclick="navigateTo('/config')" id="nav-config"><i class="ri-settings-4-line"></i> <span class="nav-text">System Config</span></div>
                <div class="nav-item hidden" id="nav-approvals" onclick="navigateTo('/approvals')"><i class="ri-shield-check-line" style="color: var(--warning)"></i> <span class="nav-text">Approval Tools</span></div>
                
                <!-- FINANCE -->
                <div class="nav-section-title"><span class="nav-text">Finance</span></div>
                <div class="nav-item" onclick="navigateTo('/commissions')" id="nav-commissions"><i class="ri-money-dollar-circle-line"></i> <span class="nav-text">Finance & Comm.</span></div>
                
                <div class="nav-section-title"><span class="nav-text">Personal</span></div>
                <div class="nav-item" onclick="navigateTo('/my-profile')"><i class="ri-user-settings-line"></i> <span class="nav-text">My Profile</span></div>
            </div>

            <div style="padding: 1.5rem; border-top: 1px solid var(--border-glass);">
                <button class="btn btn-danger" style="width: 100%; justify-content: center;" onclick="handleLogout()">
                    <i class="ri-logout-box-r-line"></i> <span>Logout</span>
                </button>
            </div>
        </aside>

        <main id="main"></main>
    </div>

    <!-- MAIN MODAL -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Title</div>
                <button class="btn-icon" onclick="closeModal()"><i class="ri-close-line"></i></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

<!-- JAVASCRIPT -->
<script>
        // --- FIX: HIDE AUTH SCREEN IMMEDIATELY TO PREVENT REFRESH FLASH ---
        document.getElementById('auth-screen').classList.add('hidden');

        // --- 1. COMMISSION CONFIGURATION (By Job Title) ---
        const DEFAULT_COMMISSION_RATES = { 
            "Founder & Managing Director": 0.05, 
            "Project & Client Manager": 0.04, 
            "Account / Operations / Marketing Manager": 0.04, 
            "Finance / Billing Executive": 0.0, 
            "People / Team Operations Executive": 0.0, 
            "Business Development Executive": 0.125, 
            "Sales Executive": 0.125, 
            "Client Success Coordinator": 0.025, 
            "Client Experience Executive": 0.025, 
            "Technical Specialist": 0.04, 
            "Web Developer": 0.04, 
            "Full Stack Developer": 0.05, 
            "Automation & AI Specialist": 0.05, 
            "Support Operations Executive": 0.025 
        };

        // --- 2. DEPARTMENT CONFIGURATION ---
        const DEPARTMENTS = [
            "Founder / Managing Director", 
            "Operations", 
            "Finance", 
            "Customer Service", 
            "Development", 
            "Sales"
        ];

        const JOB_TITLES = [
            "Founder & Managing Director", 
            "Project & Client Manager", 
            "Account / Operations / Marketing Manager", 
            "Finance / Billing Executive", 
            "People / Team Operations Executive", 
            "Business Development Executive", 
            "Sales Executive", 
            "Client Success Coordinator", 
            "Client Experience Executive", 
            "Technical Specialist", 
            "Web Developer", 
            "Full Stack Developer", 
            "Automation & AI Specialist", 
            "Support Operations Executive"
        ];

        const JOB_ROLE_MAP = {
            "Founder & Managing Director": "super_admin",
            "Project & Client Manager": "mid_admin",
            "Account / Operations / Marketing Manager": "mid_admin",
            "Finance / Billing Executive": "mid_admin",
            "People / Team Operations Executive": "admin",
            "Business Development Executive": "admin",
            "Sales Executive": "crew",
            "Client Success Coordinator": "mid_admin",
            "Client Experience Executive": "crew",
            "Technical Specialist": "crew",
            "Web Developer": "admin",
            "Full Stack Developer": "mid_admin",
            "Automation & AI Specialist": "crew",
            "Support Operations Executive": "crew"
        };

        // --- PERMISSION SYSTEM ---
        const PERMISSION_KEYS = {
            EDIT_ORDERS: 'edit_orders',
            EDIT_CLIENTS: 'edit_clients',
            VIEW_FINANCE: 'view_finance',
            DELETE_REQUESTS: 'delete_requests',
            DELETE_SUPPORT: 'delete_support',
            APPROVE_REQUESTS: 'approve_requests', 
            EDIT_VOUCHERS: 'edit_vouchers',
            EDIT_PORTFOLIO: 'edit_portfolio',
            EDIT_CONTENT: 'edit_content',
            EDIT_PROMOS: 'edit_promos',
            EDIT_CREW: 'edit_crew',
            EDIT_CONFIG: 'edit_config',
            MANAGE_USERS: 'manage_users', 
            FINANCE_TOOLS_ACCESS: 'finance_tools_access',
            APPROVE_ACTIONS: 'approve_actions', 
            BYPASS_APPROVAL: 'bypass_approval',
            EDIT_ACCESS: 'edit_access', 
            ADJUST_COMMISSION: 'adjust_commission',
            MANAGE_EMAIL: 'manage_email'
        };

        // --- TABLE STATE MANAGEMENT ---
        const TableEngine = {
            states: {},
            init: function(tableId) {
                if(!this.states[tableId]) {
                    this.states[tableId] = {
                        raw: [],
                        filtered: [],
                        page: 1,
                        limit: 25,
                        sortKey: null,
                        sortDir: 'asc',
                        filters: { search: '', status: '', dept: '', startDate: '', endDate: '' }
                    };
                }
            },
            updateData: function(tableId, newData) {
                this.init(tableId);
                this.states[tableId].raw = newData;
                this.processAndRender(tableId);
            },
            setLimit: function(tableId, limit) {
                this.init(tableId);
                this.states[tableId].limit = parseInt(limit);
                this.states[tableId].page = 1;
                this.processAndRender(tableId);
            },
            setPage: function(tableId, page) {
                this.init(tableId);
                this.states[tableId].page = parseInt(page);
                this.processAndRender(tableId);
            },
            setFilter: function(tableId, key, value) {
                this.init(tableId);
                this.states[tableId].filters[key] = value;
                this.states[tableId].page = 1;
                this.processAndRender(tableId);
            },
            setSort: function(tableId, key) {
                this.init(tableId);
                const state = this.states[tableId];
                if(state.sortKey === key) {
                    state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    state.sortKey = key;
                    state.sortDir = 'asc';
                }
                this.processAndRender(tableId);
            },
            processAndRender: function(tableId) {
                const state = this.states[tableId];
                if(!state) return;
                let data = [...state.raw];
                const f = state.filters;
                
                if(f.search) {
                    const q = f.search.toLowerCase();
                    data = data.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(q)));
                }
                if(f.status) {
                    data = data.filter(row => (row.status || '').toLowerCase() === f.status.toLowerCase());
                }
                if(f.dept) {
                    data = data.filter(row => (row.department || '').toLowerCase() === f.dept.toLowerCase());
                }
                if(f.startDate || f.endDate) {
                    data = data.filter(row => {
                        if(!row.timestamp) return false; 
                        const d = row.timestamp.toDate ? row.timestamp.toDate() : (row.timestamp instanceof Date ? row.timestamp : new Date(row.timestamp));
                        if(f.startDate && d < new Date(f.startDate)) return false;
                        if(f.endDate) {
                            const end = new Date(f.endDate);
                            end.setHours(23, 59, 59, 999);
                            if(d > end) return false;
                        }
                        return true;
                    });
                }
                if(state.sortKey) {
                    data.sort((a, b) => {
                        let valA = a[state.sortKey];
                        let valB = b[state.sortKey];
                        if(valA == null) return 1;
                        if(valB == null) return -1;
                        if(valA.toDate) valA = valA.toDate();
                        if(valB.toDate) valB = valB.toDate();
                        if (valA < valB) return state.sortDir === 'asc' ? -1 : 1;
                        if (valA > valB) return state.sortDir === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                state.filtered = data;
                const start = (state.page - 1) * state.limit;
                const end = start + state.limit;
                const pageData = data.slice(start, end);
                const tbody = document.getElementById(tableId);
                if(!tbody) return;
                if(window.customTableRenderers && window.customTableRenderers[tableId]) {
                    tbody.innerHTML = window.customTableRenderers[tableId](pageData);
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No renderer defined</td></tr>';
                }
                this.renderPagination(tableId, data.length, state.page, state.limit);
            },
            renderPagination: function(tableId, totalItems, currentPage, limit) {
                const container = document.getElementById(`${tableId}-pagination`);
                if(!container) return;
                const totalPages = Math.ceil(totalItems / limit);
                const startRec = totalItems === 0 ? 0 : (currentPage - 1) * limit + 1;
                const endRec = Math.min(currentPage * limit, totalItems);
                let html = `
                    <div class="flex justify-between items-center pt-2" style="border-top:1px solid var(--border-glass);">
                        <div class="text-sm text-muted">Showing <strong>${startRec}</strong> to <strong>${endRec}</strong> of <strong>${totalItems}</strong></div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-muted">Rows:</span>
                            <select onchange="TableEngine.setLimit('${tableId}', this.value)" style="padding: 4px; border-radius: 6px; border: 1px solid var(--border-glass); font-size: 0.8rem;">
                                <option value="25" ${limit===25?'selected':''}>25</option>
                                <option value="50" ${limit===50?'selected':''}>50</option>
                                <option value="100" ${limit===100?'selected':''}>100</option>
                            </select>
                            <div class="flex gap-1">
                                <button class="btn btn-sm btn-secondary" onclick="TableEngine.setPage('${tableId}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}><i class="ri-arrow-left-s-line"></i></button>
                                <button class="btn btn-sm btn-secondary" onclick="TableEngine.setPage('${tableId}', ${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}><i class="ri-arrow-right-s-line"></i></button>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML = html;
            }
        };
        window.customTableRenderers = {};

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwf31b-wpYQwPbd-3DxnqGVRw8g3xq938",
            authDomain: "ddnetwork-database.firebaseapp.com",
            projectId: "ddnetwork-database",
            storageBucket: "ddnetwork-database.firebasestorage.app",
            messagingSenderId: "699127560990",
            appId: "1:699127560990:web:50cfd61ff620bc85fb670f"
        };
        let db, auth, currentUser, userData = null;
        let rawFinanceData = []; 
        let userPinnedMenus = [];
        
        try { 
            firebase.initializeApp(firebaseConfig); 
            db = firebase.firestore(); 
            auth = firebase.auth(); 
        } catch(e) { console.log("Firebase init error", e); }

        // --- UI LOADING HELPER ---
        function setPageLoading(isLoading) {
            const main = document.getElementById('main');
            if(!main) return;
            if(isLoading) {
                main.innerHTML = `<div class="page-loader"><div class="loading-spinner"></div><div class="mt-2 text-muted text-sm">Loading Data...</div></div>`;
            }
        }

        // --- HELPER: LOAD COMMISSION CONFIG ---
        async function loadCommissionConfig() {
            try {
                const doc = await db.collection("config").doc("site_settings").get();
                if (doc.exists && doc.data().commission_rates) {
                    // We load the global defaults
                } else {
                    await db.collection("config").doc("site_settings").update({ commission_rates: DEFAULT_COMMISSION_RATES });
                }
            } catch (e) {
                console.error("Error loading commission config", e);
            }
        }

        // --- AUTO CREATE CONFIG ---
        async function initializeDatabase() {
            try {
                const configRef = db.collection("config").doc("site_settings");
                const doc = await configRef.get();
                if (!doc.exists) {
                    console.log("Creating default config...");
                    await configRef.set({
                        maintenance_active: false,
                        maintenance_message: "System Maintenance in Progress",
                        prices: { html: 199, frontend:599 },
                        packageDetails: {
                            frontend: ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"],
                            ai: ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"]
                        },
                        disabled_menus: [],
                        commission_rates: DEFAULT_COMMISSION_RATES,
                        smtp_config: {
                            host: '',
                            port: 587,
                            user: '',
                            pass: '',
                            from_name: 'DDNetwork System',
                            from_email: 'noreply@ddnet.my'
                        }
                    });
                } else {
                    const data = doc.data();
                    if(!data.commission_rates) {
                         await configRef.update({ commission_rates: DEFAULT_COMMISSION_RATES });
                    }
                    if(!data.smtp_config) {
                        await configRef.update({ smtp_config: { host:'', port:587, user:'', pass:'', from_name:'DDNetwork System', from_email:'noreply@ddnet.my' }});
                    }
                }
                const pmSnapshot = await db.collection("payment_methods").limit(1).get();
                if (pmSnapshot.empty) {
                    const defaults = [
                        { id: 'tng', name: 'TNG eWallet', link: 'https://payment.tngdigital.com.my/sc/bDLob7YcpG', active: true },
                        { id: 'fpx', name: 'Online Banking (FPX)', link: 'https://toyyibpay.com', active: true }
                    ];
                    defaults.forEach(pm => db.collection("payment_methods").add(pm));
                }
            } catch (error) { console.error("Error initializing database defaults:", error); }
        }

        function logActivity(msg) {
            if(!currentUser || !db) return; 
            db.collection("activity_logs").add({
                message: msg,
                actor: userData.email,
                actorName: userData.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => console.error("Log error:", e));
        }

        function formatDateTime(timestamp) {
            if(!timestamp) return '-';
            const d = timestamp instanceof Date ? timestamp : timestamp.toDate();
            const pad = (n) => n.toString().padStart(2, '0');
            return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function generateDocIdFromName(name) {
            if(!name) return 'new-project';
            return name.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, ''); 
        }

        function updateDocIdPreview() {
            const nameVal = document.getElementById('p-name').value;
            const idVal = generateDocIdFromName(nameVal);
            const idInput = document.getElementById('p-doc-id');
            if(idInput) idInput.value = idVal;
        }

        async function getNextId(type) {
            if(type === 'crew') {
                 try {
                     const snap = await db.collection("users").where("crewId", "!=", null).get();
                     let existingIds = [];
                     snap.forEach(doc => { const id = doc.data().crewId; if(id) existingIds.push(parseInt(id)); });
                     existingIds.sort((a,b) => a-b);
                     let nextId =1;
                     if(existingIds.length > 0) { for(let i=0; i<existingIds.length; i++) { if(existingIds[i] === nextId) nextId++; else break; } }
                     return String(nextId).padStart(3, '0');
                 } catch(e) { return "001"; }
            } else if (type === 'ticket') {
                try {
                    const snap = await db.collection("tickets").orderBy("ticketId", "desc").limit(1).get();
                    let nextNum = 1;
                    if (!snap.empty) {
                        const lastId = snap.docs[0].data().ticketId; 
                        const parts = lastId.split('-');
                        if (parts.length >1) {
                            const lastNum = parseInt(parts[1], 10);
                            if (!isNaN(lastNum)) nextNum = lastNum + 1;
                        }
                    }
                    const paddedNum = String(nextNum).padStart(4, '0');
                    return `#Ticket-${paddedNum}`;
                } catch (e) { return "#Ticket-0001"; }
            }
            return null;
        }

        // --- AUTH ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('loginInput').value.trim();
            const pass = document.getElementById('loginPass').value;
            const isCrewId = /^\d{3,}$/.test(input);
            let emailToUse = input;
            if (isCrewId) {
                const snap = await db.collection("users").where("crewId", "==", input).get();
                if (snap.empty) return showToast("Crew ID not found.", "error");
                emailToUse = snap.docs[0].data().email;
            }
            auth.signInWithEmailAndPassword(emailToUse, pass).catch(err => showToast(err.message, "error"));
        });

        auth.onAuthStateChanged((user) => {
            if(user) {
                db.collection("users").doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        currentUser = user;
                        userData = doc.data();
                        
                        if(!userData.permissions) userData.permissions = {};
                        
                        if(userData.role === 'super_admin') {
                            userData.permissions[PERMISSION_KEYS.EDIT_ACCESS] = true;
                            userData.permissions[PERMISSION_KEYS.MANAGE_EMAIL] = true;
                        }

                        if(!userData.isSuspended) userData.isSuspended = false;
                        if(userData.bypassApproval === undefined) userData.bypassApproval = false; 
                        if(!userData.pinnedMenus) userData.pinnedMenus = [];
                        
                        if(userData.personalCommissionRate === undefined) {
                            const defaultRate = DEFAULT_COMMISSION_RATES[userData.jobTitle] || 0;
                            db.collection("users").doc(user.uid).update({ personalCommissionRate: defaultRate });
                            userData.personalCommissionRate = defaultRate;
                        }

                        if(userData.isSuspended) {
                            auth.signOut();
                            showToast("Account Suspended. Contact Admin.", "error");
                            document.getElementById('auth-screen').classList.remove('hidden');
                            return;
                        }

                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        
                        document.getElementById('side-name').innerText = userData.name || 'User';
                        document.getElementById('side-job').innerText = `${userData.jobTitle} (${userData.role.toUpperCase()})`;
                        
                        userPinnedMenus = userData.pinnedMenus || [];
                        renderPinnedMenus();

                        loadCommissionConfig();

                        const userInitial = (userData.name || 'A').charAt(0).toUpperCase();
                        const workLoc = userData.workLocation || 'HQ';
                        const headerActions = document.querySelector('.header-actions');
                        
                        const profileHTML = `
                            <div class="flex items-center gap-2" onclick="navigateTo('/my-profile')" style="cursor:pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
                                <div style="text-align:right; line-height:1.2;">
                                    <div style="font-weight:700; font-size:0.85rem; color:var(--text-main);">${userData.name}</div>
                                    <div style="font-size:0.7rem; color:var(--text-muted); font-weight:500; text-transform:uppercase;">${workLoc}</div>
                                </div>
                                <div class="u-avatar" style="width:32px; height:32px; font-size:0.85rem;">${userInitial}</div>
                            </div>
                        `;
                        const oldAvatar = headerActions.querySelector('#header-avatar');
                        if(oldAvatar) {
                            const container = document.createElement('div');
                            container.innerHTML = profileHTML;
                            headerActions.insertBefore(container, oldAvatar);
                            oldAvatar.remove();
                        }

                        document.getElementById('side-avatar').innerText = userInitial;

                        if(hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) {
                            document.getElementById('nav-approvals').classList.remove('hidden');
                        } else {
                            document.getElementById('nav-approvals').classList.add('hidden');
                        }

                        if(userData.role === 'crew') {
                            document.getElementById('notif-btn').style.display = 'none';
                        } else {
                            document.getElementById('notif-btn').style.display = 'flex'; 
                            listenForNotifications(); 
                        }

                        initRouter(); 
                        initializeDatabase();
                        listenForMaintenanceChanges(); 
                    } else {
                        showToast("Access Denied. User record not found.", "error");
                        auth.signOut();
                    }
                });
            } else {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        function handleLogout() { auth.signOut().then(() => location.reload()); }

        // --- GLOBAL SEARCH & PINNING ---
        function handleContextMenu(e, path, name) {
            e.preventDefault();
            if(!currentUser) return;
            const isPinned = userPinnedMenus.includes(path);
            if(isPinned) {
                if(confirm(`Unpin "${name}" from sidebar?`)) {
                    userPinnedMenus = userPinnedMenus.filter(p => p !== path);
                    savePinnedMenus();
                    showToast("Unpinned", "success");
                }
            } else {
                if(confirm(`Pin "${name}" to sidebar?`)) {
                    userPinnedMenus.push(path);
                    savePinnedMenus();
                    showToast("Pinned to Sidebar", "success");
                }
            }
        }

        function savePinnedMenus() {
            if(!currentUser) return;
            db.collection("users").doc(currentUser.uid).update({ pinnedMenus: userPinnedMenus });
            renderPinnedMenus();
        }

        function renderPinnedMenus() {
            const container = document.getElementById('pinned-list');
            const section = document.getElementById('pinned-section');
            if(!container) return;
            container.innerHTML = '';
            if(userPinnedMenus.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');
            const labels = {
                '/orders': 'Orders', '/clients': 'Clients', '/support': 'Support', '/requests': 'Requests',
                '/commissions': 'Finance', '/crew': 'Crew', '/portfolio': 'Portfolio'
            };
            userPinnedMenus.forEach(path => {
                const label = labels[path] || path.substring(1);
                const div = document.createElement('div');
                div.className = 'nav-item pinned';
                div.innerHTML = `<i class="ri-pushpin-line"></i> <span class="nav-text">${label}</span>`;
                div.onclick = () => navigateTo(path);
                div.oncontextmenu = (e) => handleContextMenu(e, path, label);
                container.appendChild(div);
            });
        }

        async function handleGlobalSearch(query) {
            const resultsContainer = document.getElementById('search-results');
            if(!query || query.length < 2) {
                resultsContainer.classList.remove('active');
                return;
            }
            const q = query.toLowerCase();
            let html = '';
            try {
                const oSnap = await db.collection("orders").orderBy("customerName").startAt(q).endAt(q + '\uf8ff').limit(3).get();
                oSnap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="search-item" onclick="navigateTo('/orders'); closeModal();">
                        <div class="search-item-icon"><i class="ri-shopping-bag-line"></i></div>
                        <div><strong>${d.customerName}</strong><span>Order: RM ${d.total}</span></div>
                    </div>`;
                });
            } catch(e) {}
            try {
                const cSnap = await db.collection("users").where("role", "==", "user").orderBy("name").startAt(q).endAt(q + '\uf8ff').limit(3).get();
                cSnap.forEach(doc => {
                    const u = doc.data();
                    html += `<div class="search-item" onclick="viewClientTimeline('${doc.id}', '${u.name}'); closeModal();">
                        <div class="search-item-icon"><i class="ri-user-line"></i></div>
                        <div><strong>${u.name}</strong><span>Client</span></div>
                    </div>`;
                });
            } catch(e) {}
            try {
                const tSnap = await db.collection("tickets").orderBy("ticketId").startAt(q).endAt(q + '\uf8ff').limit(3).get();
                tSnap.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="search-item" onclick="navigateTo('/support'); closeModal();">
                        <div class="search-item-icon"><i class="ri-customer-service-2-line"></i></div>
                        <div><strong>${d.ticketId}</strong><span>${d.type}</span></div>
                    </div>`;
                });
            } catch(e) {}
            if(html === '') html = '<div class="p-4 text-center text-muted">No results found</div>';
            resultsContainer.innerHTML = html;
            resultsContainer.classList.add('active');
        }

        document.addEventListener('click', (e) => {
            const container = document.querySelector('.header-search');
            if(container && !container.contains(e.target)) document.getElementById('search-results').classList.remove('active');
        });

        // --- MAINTENANCE MODE LOGIC ---
        let currentMaintenanceConfig = { active: false, disabledMenus: [], message: "" };
        function listenForMaintenanceChanges() {
            db.collection("config").doc("site_settings").onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    currentMaintenanceConfig = {
                        active: data.maintenance_active || false,
                        disabledMenus: data.disabled_menus || [],
                        message: data.maintenance_message || "System Maintenance"
                    };
                    
                    const bar = document.getElementById('maintenance-bar');
                    const dash = document.getElementById('dashboard');
                    if(currentMaintenanceConfig.active) {
                        bar.classList.add('active');
                        document.getElementById('maintenance-text').innerText = currentMaintenanceConfig.message;
                        dash.classList.add('has-maintenance');
                    } else {
                        bar.classList.remove('active');
                        dash.classList.remove('has-maintenance');
                    }
                    const currentPath = window.location.pathname.replace(/\/[^/]+\.html$/, '') || '/';
                    loadRoute(currentPath);
                }
            });
        }

        function isMaintenanceBlockingPath(path) {
            if(!currentMaintenanceConfig.active) return false;
            if(isSuperAdmin()) return false; 
            return currentMaintenanceConfig.disabledMenus.includes(path);
        }

        // --- NOTIFICATIONS ---
        function toggleNotifications() {
            const el = document.getElementById('notifDropdown');
            el.classList.toggle('show');
        }
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('notifDropdown');
            const btn = document.getElementById('notif-btn');
            if (!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('show');
        });

        function listenForNotifications() {
            db.collection("activity_logs").orderBy("timestamp", "desc").limit(10).onSnapshot(snap => {
                const container = document.getElementById('notifDropdown');
                if(snap.empty) {
                    container.innerHTML = '<div class="p-4 text-center" style="color:var(--text-muted)">No recent activity</div>';
                    document.getElementById('notifDot').style.display = 'none';
                    return;
                }
                document.getElementById('notifDot').style.display = 'block';
                container.innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    return `<div class="notif-item">
                        <strong>${d.actorName || d.actor}</strong>
                        <div>${d.message}</div>
                        <span class="notif-time">${formatDateTime(d.timestamp)}</span>
                    </div>`;
                }).join('');
            });
        }

        // --- ACCESS CONTROL ---
        function isSuperAdmin() { return userData && userData.role === 'super_admin'; }
        function isMidAdmin() { return userData && userData.role === 'mid_admin'; }
        function isAdmin() { return userData && userData.role === 'admin'; }
        function isCrew() { return userData && userData.role === 'crew'; }
        function isFounder() { return userData && userData.jobTitle && userData.jobTitle.includes("Founder"); }
        function isFinanceManager() { return userData && (userData.jobTitle && userData.jobTitle.includes("Finance")); }

        function hasPermission(key) {
            if(!userData) return false;
            if (userData.permissions && userData.permissions[key] === true) return true;
            return false;
        }
        function canAccessFinanceTools() {
            if(isSuperAdmin() || isMidAdmin() || isFinanceManager()) return true;
            if(hasPermission(PERMISSION_KEYS.FINANCE_TOOLS_ACCESS)) return true;
            return false;
        }
        function checkAccessOrActionAllowed(permissionKey) {
            if(!userData) return false; 
            if (isSuperAdmin() || userData.bypassApproval === true) return true;
            if (hasPermission(permissionKey)) return true;
            return false; 
        }

        // --- ROUTING SYSTEM ---
        const routes = {
            '/': renderOverview,
            '/orders': renderOrders,
            '/clients': renderClients,
            '/crew': renderCrew,
            '/support': renderSupport,
            '/vouchers': renderVouchers,
            '/content': renderContent,
            '/config': renderConfig,
            '/portfolio': renderPortfolio,
            '/requests': renderRequests,
            '/my-profile': renderMyProfile,
            '/public-promos': renderPublicPromos,
            '/commissions': renderFinanceOverview, 
            '/approvals': renderApprovals
        };

        function navigateTo(path) {
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('mobile-open');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
            if(isMaintenanceBlockingPath(path)) {
                showToast("Access Denied: Feature under maintenance.", "error");
                return;
            }
            window.history.pushState({ path: path }, "", path);
            loadRoute(path);
        }

        function loadRoute(path) {
            const renderFn = routes[path];
            if (renderFn) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const activeItem = document.querySelector(`.nav-item[onclick="navigateTo('${path}')"]`);
                if(activeItem) activeItem.classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('disabled'));
                if(currentMaintenanceConfig.active && !isSuperAdmin()) {
                    currentMaintenanceConfig.disabledMenus.forEach(disabledPath => {
                        const disabledItem = document.querySelector(`.nav-item[onclick="navigateTo('${disabledPath}')"]`);
                        if(disabledItem) disabledItem.classList.add('disabled');
                    });
                }

                const mainEl = document.getElementById('main');
                if(mainEl) {
                    mainEl.innerHTML = ''; 
                    renderFn();
                }
                document.getElementById('main').scrollTop = 0;
            }
        }

        function initRouter() {
            const mainEl = document.getElementById('main');
            if(!mainEl) return;
            const path = window.location.pathname;
            const basePath = path.replace(/\/[^/]+\.html$/, '') || '/';
            if (routes[basePath]) {
                loadRoute(basePath);
            } else {
                navigateTo('/');
            }
            if(window.innerWidth > 1024) {
                 const sb = document.getElementById('sidebar');
                 const mn = document.getElementById('main');
                 sb.style.width = '';
                 mn.style.marginLeft = '';
            }
        }

        window.onpopstate = (event) => {
            if (event.state && event.state.path) loadRoute(event.state.path);
        };

        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const mn = document.getElementById('main');
            const ov = document.getElementById('sidebarOverlay');
            if(window.innerWidth > 1024) {
                if (sb.classList.contains('collapsed')) {
                    sb.classList.remove('collapsed');
                    mn.style.marginLeft = 'var(--sidebar-width)';
                } else {
                    sb.classList.add('collapsed');
                    mn.style.marginLeft = 'var(--sidebar-width-collapsed)';
                }
            } else {
                sb.classList.toggle('mobile-open');
                ov.classList.toggle('active');
            }
        }

        // --- UTILS ---
        function showModal(title, body, footer='') {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalFooter').innerHTML = footer;
            document.getElementById('modalOverlay').classList.add('open');
            document.getElementById('modalBody').scrollTop = 0;
        }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
        
        function showToast(msg, type='info') {
            const container = document.getElementById('toastContainer');
            if(container.children.length > 4) container.removeChild(container.firstChild);
            const t = document.createElement('div'); 
            t.className = `toast ${type}`;
            const icon = type=='success'?'ri-checkbox-circle-fill':(type=='error'?'ri-error-warning-fill':(type=='warning'?'ri-alert-fill':'ri-information-fill'));
            const color = type=='success'?'var(--success)':(type=='error'?'var(--danger)':(type=='warning'?'var(--warning)':'var(--text-main)'));
            t.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="${icon}" style="font-size:1.2rem; color: ${color}"></i> 
                    <span style="font-size:0.9rem; font-weight:500;">${msg}</span>
                </div>
            `;
            container.appendChild(t);
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(()=>{ 
                t.classList.remove('show'); 
                setTimeout(()=>t.remove(), 300); 
            }, 3000);
        }

        // --- WHATSAPP HELPER ---
        function formatWAPhone(phone) {
            if (!phone) return null;
            let clean = phone.replace(/[^0-9]/g, '');
            if (clean.startsWith('0')) clean = '60' + clean.substring(1);
            if (clean.startsWith('+')) clean = clean.substring(1);
            if (clean.length < 10 || clean.length > 13) return null;
            return clean;
        }

        async function deleteUser(uid, name, type) {
            if(!isSuperAdmin()) return showToast("Access Denied", "error");
            if(!confirm(`Are you sure you want to PERMANENTLY DELETE ${name}?`)) return;
            try {
                await db.collection("users").doc(uid).delete();
                logActivity(`Deleted user: ${name} (${type})`);
                showToast("User deleted successfully", "success");
            } catch (error) {
                console.error("Delete error:", error);
                showToast("Error deleting user: " + error.message, "error");
            }
        }

        // --- 1. OVERVIEW ---
        function renderOverview() {
            setPageLoading(true);
            const main = document.getElementById('main');
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4" style="flex-wrap: wrap; gap:10px;">
                    <h2 style="font-size:1.5rem; font-weight:800; letter-spacing:-0.5px;">Dashboard Overview</h2>
                </div>
                <div class="quick-actions-grid">
                    <div class="quick-action-card" onclick="navigateTo('/orders')"><i class="ri-shopping-cart-2-line"></i><span>New Order</span></div>
                    <div class="quick-action-card" onclick="navigateTo('/clients')"><i class="ri-user-add-line"></i><span>Add Client</span></div>
                    <div class="quick-action-card" onclick="navigateTo('/support')"><i class="ri-ticket-line"></i><span>New Ticket</span></div>
                    <div class="quick-action-card" onclick="navigateTo('/vouchers')"><i class="ri-coupon-line"></i><span>Create Voucher</span></div>
                </div>
                <div class="stats-grid" id="stats-grid">
                    <div class="page-loader" style="height:100px;"><div class="loading-spinner"></div></div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <div class="list-group">
                        <h3><i class="ri-pulse-line" style="color:var(--success)"></i> Recent Activity</h3>
                        <div id="activity-feed"><div class="text-center p-4 text-muted">Loading...</div></div>
                    </div>
                </div>
            `;
            
            db.collection("activity_logs").orderBy("timestamp", "desc").limit(5).onSnapshot(snap => {
                const feed = document.getElementById('activity-feed');
                if(feed) {
                    if(snap.empty) feed.innerHTML = '<div class="text-muted text-sm text-center mt-2">No recent activity</div>';
                    else feed.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        return `<div class="activity-item">
                            <div class="activity-icon"><i class="ri-shield-flash-line" style="color:var(--primary)"></i></div>
                            <div class="activity-content">
                                <h5>${d.message}</h5>
                                <p>${d.actorName || d.actor}</p>
                            </div>
                            <div class="activity-time">${formatDateTime(d.timestamp)}</div>
                        </div>`;
                    }).join('');
                }
            });

            const promises = [
                db.collection("tickets").where("status", "in", ["Open", "In Progress"]).get(),
                db.collection("users").where("role", "==", "user").get(),
                db.collection("orders").where("status", "==", "Pending").get(),
                db.collection("orders").where("status", "==", "Paid").get(),
                db.collection("customer_requests").where("status", "==", "Pending").get()
            ];

            Promise.all(promises).then(([tSnap, uSnap, oSnapP, oSnapPaid, rSnapP]) => {
                const stats = [
                    { label: "Active Cases", val: tSnap.size, icon: "ri-customer-service-2-line", color: "var(--ticket)" },
                    { label: "Total Clients", val: uSnap.size, icon: "ri-user-smile-line", color: "var(--primary)" },
                    { label: "Pending Orders", val: oSnapP.size, icon: "ri-shopping-basket-2-line", color: "var(--text-muted)" },
                    { label: "Revenue (Est.)", val: `RM ${oSnapPaid.size * 300}`, icon: "ri-wallet-3-line", color: "var(--success)" }
                ];
                const grid = document.getElementById('stats-grid');
                if(grid) {
                    grid.innerHTML = stats.map(s => `
                        <div class="stat-card">
                            <div class="stat-icon" style="color:${s.color}; background:${s.color}15"><i class="${s.icon}"></i></div>
                            <div class="stat-info">
                                <div class="stat-val">${s.val}</div>
                                <div class="stat-label">${s.label}</div>
                            </div>
                        </div>
                    `).join('');
                }
            });
        }

        // --- 2. ORDERS ---
        function renderOrders() {
            setPageLoading(true);
            const main = document.getElementById('main');
            main.innerHTML = `
                <div class="table-container">
                    <div class="table-header" style="display:block;">
                        <div class="flex justify-between items-center mb-2">
                            <h3>Order Management</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #f8fafc; padding: 10px; border-radius: 12px; border: 1px solid var(--border-glass);">
                            <input type="text" id="filter-orders-search" placeholder="Search ID, Name..." onkeyup="TableEngine.setFilter('orders-tbody', 'search', this.value)">
                            <input type="date" id="filter-orders-start" title="Start Date" onchange="TableEngine.setFilter('orders-tbody', 'startDate', this.value)">
                            <input type="date" id="filter-orders-end" title="End Date" onchange="TableEngine.setFilter('orders-tbody', 'endDate', this.value)">
                            <select id="filter-orders-status" onchange="TableEngine.setFilter('orders-tbody', 'status', this.value)">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th onclick="TableEngine.setSort('orders-tbody', 'timestamp')" style="cursor:pointer">Date <i class="ri-arrow-up-down-line"></i></th>
                                    <th onclick="TableEngine.setSort('orders-tbody', 'customerName')" style="cursor:pointer">Client <i class="ri-arrow-up-down-line"></i></th>
                                    <th>Package</th>
                                    <th>Cycle</th>
                                    <th onclick="TableEngine.setSort('orders-tbody', 'total')" style="cursor:pointer">Total <i class="ri-arrow-up-down-line"></i></th>
                                    <th onclick="TableEngine.setSort('orders-tbody', 'status')" style="cursor:pointer">Status <i class="ri-arrow-up-down-line"></i></th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                                <tr><td colspan="7" class="text-center"><div class="loading-spinner"></div></td></tr>
                            </tbody>
                        </table>
                        <div id="orders-tbody-pagination"></div>
                    </div>
                </div>`;
            
            db.collection("orders").orderBy("timestamp", "desc").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('orders-tbody', data);
            });

            window.customTableRenderers['orders-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="7" class="text-center text-muted">No orders found</td></tr>';
                return data.map(d => {
                    const domainDisplay = d.domain ? `<span class="font-mono" style="color:var(--primary)">${d.domain}</span>` : `<span style="color:var(--text-faint)">N/A</span>`;
                    let voucherBadge = '<span style="color:var(--text-faint)">None</span>';
                    if (d.voucherCode) {
                        voucherBadge = `<span class="badge badge-voucher" style="background:#fffbeb; color:var(--warning); border:1px solid #fde68a"><i class="ri-coupon-line"></i> ${d.voucherCode}</span>`;
                    }
                    let statusColor = '#9ca3af';
                    if(d.status === 'Completed') statusColor = 'var(--success)';
                    if(d.status === 'Paid') statusColor = 'var(--primary)';
                    if(d.status === 'Cancelled') statusColor = 'var(--danger)';
                    
                    let actions = '';
                    if(checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_ORDERS)) {
                        actions += `<button class="btn btn-sm btn-secondary" onclick="viewOrder('${d.id}')">Manage</button>`;
                        actions += `<button class="btn btn-sm btn-info" title="Generate Invoice" onclick="generateInvoice('${d.id}')"><i class="ri-file-list-2-line"></i></button>`;
                        actions += `<button class="btn btn-sm btn-success" title="Send WhatsApp" onclick="sendPaymentReminder('${d.id}')"><i class="ri-whatsapp-line"></i></button>`;
                    }
                    if(isSuperAdmin()) {
                        actions += `<button class="btn btn-sm btn-danger" onclick="deleteOrder('${d.id}')"><i class="ri-delete-bin-line"></i></button>`;
                    }

                    return `<tr>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td><strong>${d.customerName}</strong><br>${domainDisplay}</td>
                        <td>${d.package}</td>
                        <td><span class="badge badge-user">${d.billingCycle || 'One-time'}</span></td>
                        <td>${d.total}</td>
                        <td><span class="badge" style="background:${statusColor}15; color:${statusColor}; border:1px solid ${statusColor}25">${d.status}</span></td>
                        <td>
                            <div style="display:flex; gap:5px; flex-wrap:wrap;">${actions}</div>
                        </td>
                    </tr>`;
                }).join('');
            };
        }

        // --- NEW INVOICE GENERATION LOGIC (POPUPS ALLOWED) ---
        async function generateInvoice(orderId) {
            try {
                const orderDoc = await db.collection("orders").doc(orderId).get();
                if(!orderDoc.exists) return showToast("Order not found", "error");
                const d = orderDoc.data();
                
                const dateStr = formatDateTime(d.timestamp).split(' ')[0];
                const orderRef = orderId.substring(0,8).toUpperCase();
                const total = parseFloat(d.total.replace('RM ', '')).toFixed(2);
                
                // INVOICE TEMPLATE
                const invoiceContent = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                    <meta charset="UTF-8">
                    <title>Invoice | DD Cloud Network</title>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                    <style>
                      * { box-sizing: border-box; }
                      body {
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                        background: #f2f2f2;
                        padding: 20px;
                        color: #1d1d1f;
                        margin: 0;
                        -webkit-print-color-adjust: exact;
                      }
                      .receipt {
                        max-width: 720px;
                        margin: auto;
                        background: #ffffff;
                        padding: 40px;
                        border-radius: 16px;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.08);
                      }
                      .header {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 30px;
                      }
                      .brand {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                      }
                      .brand img { width: 36px; height: auto; }
                      .brand strong { font-size: 18px; font-weight: 600; }
                      .invoice-meta {
                        text-align: right;
                        font-size: 13px;
                        color: #6e6e73;
                      }
                      .invoice-meta span { display: block; margin-bottom: 2px; }
                      .section { margin-bottom: 25px; }
                      .section h4 {
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.08em;
                        color: #6e6e73;
                        margin-bottom: 8px;
                      }
                      .section p { margin: 0; font-size: 14px; line-height: 1.5; }
                      table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                      }
                      table th {
                        text-align: left;
                        font-size: 12px;
                        color: #6e6e73;
                        font-weight: 500;
                        padding-bottom: 8px;
                        border-bottom: 1px solid #e5e5ea;
                      }
                      table td {
                        padding: 12px 0;
                        font-size: 13px;
                        border-bottom: 1px solid #f0f0f0;
                        vertical-align: top;
                      }
                      .amount {
                        text-align: right;
                        white-space: nowrap;
                        font-variant-numeric: tabular-nums;
                      }
                      .summary {
                        margin-top: 25px;
                        max-width: 100%;
                        margin-left: auto;
                      }
                      .summary div {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 8px;
                        font-size: 14px;
                      }
                      .summary .total {
                        font-size: 16px;
                        font-weight: 600;
                        padding-top: 10px;
                        border-top: 1px solid #e5e5ea;
                      }
                      .footer {
                        margin-top: 40px;
                        text-align: center;
                        font-size: 12px;
                        color: #6e6e73;
                      }
                      @media screen and (max-width: 600px) {
                        body { padding: 0; background: #ffffff; }
                        .receipt {
                          max-width: 100%;
                          padding: 24px;
                          border-radius: 0;
                          box-shadow: none;
                        }
                        .header { flex-direction: column; align-items: flex-start; gap: 10px; }
                        .invoice-meta { text-align: left; }
                        table td { font-size: 12px; padding: 10px 0; }
                      }
                      @media print {
                        body { background: none; padding: 0; -webkit-print-color-adjust: exact; }
                        .receipt { box-shadow: none; border-radius: 0; padding: 0; margin: 0; max-width: 100%; }
                        @page { margin: 20px; }
                      }
                    </style>
                    </head>
                    <body>

                    <div class="receipt">

                      <!-- Header -->
                      <div class="header">
                        <div class="brand">
                          <img src="https://raw.githubusercontent.com/ddnetwork-one/ddnetwork-store/refs/heads/main/crop_ddnlogo.png" alt="DDNetwork Logo">
                          <strong>DD CLOUD NETWORK</strong>
                        </div>

                        <div class="invoice-meta">
                          <span><strong>Invoice</strong></span>
                          <span>INV-${orderRef}</span>
                          <span>${dateStr}</span>
                        </div>
                      </div>

                      <!-- Billing -->
                      <div class="section">
                        <h4>Bill To</h4>
                        <p>
                          <strong>${d.customerName}</strong><br>
                          ${d.domain ? d.domain : 'N/A'}<br>
                          ${d.customerEmail}
                        </p>
                      </div>

                      <!-- Items -->
                      <table>
                        <thead>
                          <tr>
                            <th>Description</th>
                            <th class="amount">Amount (RM)</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>${d.package} ${d.billingCycle ? `(${d.billingCycle})` : ''}</td>
                            <td class="amount">${total}</td>
                          </tr>
                        </tbody>
                      </table>

                      <!-- Summary -->
                      <div class="summary">
                        <div>
                          <span>Subtotal</span>
                          <span>RM ${total}</span>
                        </div>
                        <div>
                          <span>Tax</span>
                          <span>RM 0.00</span>
                        </div>
                        <div class="total">
                          <span>Total</span>
                          <span>RM ${total}</span>
                        </div>
                      </div>

                      <!-- Footer -->
                      <div class="footer">
                        Thank you for choosing DDNetwork. Wishing great success and growth for your brand.<br>
                         DDNetworkOne by DD CLOUD NETWORK.
                      </div>

                    </div>

                    <script>window.onload = function() { setTimeout(() => window.print(), 500); }<\/script>
                    </body>
                    </html>
                `;

                // Open and write directly
                const printWindow = window.open('', '_blank');
                printWindow.document.write(invoiceContent);
                printWindow.document.close();

            } catch (err) {
                console.error(err);
                showToast("Error generating invoice", "error");
            }
        }

        async function sendPaymentReminder(id) {
            try {
                const doc = await db.collection("orders").doc(id).get();
                if(!doc.exists) return;
                const d = doc.data();
                let payLink = "https://ddnet.my"; 
                try {
                    const pmSnap = await db.collection("payment_methods").where("active", "==", true).limit(1).get();
                    if(!pmSnap.empty) payLink = pmSnap.docs[0].data().link;
                } catch(e) {}
                const orderRef = id.substring(0,6).toUpperCase();

                let msg = "";
                if (d.status === "Pending" || d.status === "Cancelled" || !d.status) {
                    msg = `Hi ${d.customerName},\n\nThis is a friendly reminder that we are still awaiting payment for your recent order with DDNetwork.\n\nOrder ID: #${orderRef}\nAmount: ${d.total}\n\nPlease proceed with payment at your convenience so we can continue processing your order. If youve already made payment, kindly ignore this message.\n\nThank you for your support.\n\n[Auto-generated from DDNet System]`;
                } 
                else { 
                    msg = `Hi ${d.customerName},\n\nWe noticed that payment for your recent order with DDNetwork was not completed successfully.\n\nOrder ID: #${orderRef}\nOutstanding Amount: ${d.total}\n\nTo avoid any delay or cancellation, please complete the payment as soon as possible. If you encountered any issues during payment, let us know and we will assist you.\n\nThank you for your understanding.\n\n[Auto-generated from DDNet System]`;
                }

                const cleanPhone = formatWAPhone(d.customerPhone);
                if(!cleanPhone) { showToast("Invalid Phone Number", "error"); return; }
                const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
                const win = window.open(url, '_blank');
                if (!win || win.closed || typeof win.closed == 'undefined') { window.location.href = url; }
                showToast("Opening WhatsApp...", "success");
                logActivity(`Sent payment reminder for Order #${orderRef}`);
            } catch(err) {
                console.error(err);
                showToast("Error sending reminder", "error");
            }
        }

        async function viewOrder(id) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_ORDERS)) return showToast("Access Denied: You do not have Edit Orders permission.", "error");
            const doc = await db.collection("orders").doc(id).get();
            const d = doc.data();
            
            let salesRepHTML = '<div class="multi-select-container">';
            const currentReps = d.salesRepIds || []; 
            
            try {
                const crewSnap = await db.collection("users").where("role", "in", ["super_admin", "admin", "mid_admin", "crew"]).get();
                if(crewSnap.empty) salesRepHTML = '<div class="p-4 text-muted">No staff found</div>';
                else {
                    crewSnap.forEach(c => {
                        const cData = c.data();
                        const isChecked = currentReps.includes(c.id) ? 'checked' : '';
                        salesRepHTML += `<label class="checkbox-item"><input type="checkbox" class="rep-checkbox" value="${c.id}" ${isChecked}><span>${cData.name} (${cData.jobTitle || cData.role})</span></label>`;
                    });
                }
            } catch(e) { console.error(e); }
            salesRepHTML += '</div>';

            const voucherDisplay = d.voucherCode ? `<div class="mb-4"><label>Voucher Used</label><input readonly value="${d.voucherCode}" style="color:var(--warning); border-color:var(--warning)"></div>` : '';
            showModal(`Manage Order`, `
                ${voucherDisplay}
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label class="text-muted text-sm">Name</label><input id="o-name" value="${d.customerName}"></div>
                    <div><label class="text-muted text-sm">Email</label><input id="o-email" value="${d.customerEmail}"></div>
                    <div><label class="text-muted text-sm">Phone</label><input id="o-phone" value="${d.customerPhone||''}"></div>
                    <div><label class="text-muted text-sm">Total</label><input id="o-total" value="${d.total}"></div>
                </div>
                <div class="mb-4 p-2" style="background:#f3f4f6; border-radius:8px; border:1px solid var(--border-glass);">
                    <div class="flex justify-between items-center">
                        <span style="font-size:0.8rem; color:var(--text-muted);">Billing Cycle (Affects Commission)</span>
                        <span class="font-bold" style="color:var(--primary);">${d.billingCycle || '-'}</span>
                    </div>
                </div>
                <div class="mb-4"><label>Internal Notes (Staff Only)</label><textarea id="o-notes" rows="3" placeholder="Add notes about this order...">${d.internalNotes || ''}</textarea><small class="text-muted">These notes are NOT visible to the client.</small></div>
                <div class="mb-4"><label>Sales Representatives (Commission will be calculated individually based on Job Titles)</label>${salesRepHTML}<small class="text-muted">Select all employees entitled to commission.</small></div>
                <div class="mt-4"><label>Client Domain</label><div style="display:flex; gap:10px;"><span style="padding:0.6rem; background:var(--bg-input); border:1px solid var(--border-glass); border-radius:6px 0 0 6px; color:var(--text-muted);">https://</span><input id="o-domain" value="${d.domain || ''}" placeholder="example.com" style="border-radius:0 6px 6px 0;"></div><small class="text-muted">Leave empty if no domain yet.</small></div>
                <label class="mt-4 mb-2 block">Update Status</label>
                <select id="upd-status"><option value="Pending" ${d.status=='Pending'?'selected':''}>Pending</option><option value="Paid" ${d.status=='Paid'?'selected':''}>Paid</option><option value="Completed" ${d.status=='Completed'?'selected':''}>Completed</option><option value="Cancelled" ${d.status=='Cancelled'?'selected':''}>Cancelled</option></select>
            `, `<button class="btn btn-primary" onclick="updateOrderDetails('${id}')">Save Changes</button>`);
        }

        // --- UPDATED COMMISSION LOGIC (INDIVIDUAL JOB TITLE BASED) ---
        async function generateCommissionsForOrder(orderId, orderData) {
            const existingCommSnap = await db.collection("commission_overview").where("orderId", "==", orderId).get();
            const batch = db.batch();
            existingCommSnap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            if(orderData.salesRepIds && orderData.salesRepIds.length > 0) {
                const commBatch = db.batch();
                const repIds = orderData.salesRepIds;
                const usersSnap = await db.collection("users").where(firebase.firestore.FieldPath.documentId(), "in", repIds).get();
                const usersMap = {};
                usersSnap.forEach(u => usersMap[u.id] = u.data());

                const orderTotal = parseFloat(orderData.total.replace('RM ', '')) || 0;
                const orderDate = orderData.timestamp || firebase.firestore.FieldValue.serverTimestamp();
                
                const cycle = (orderData.billingCycle || 'one-time').toLowerCase();
                let teamPercentage = 0.0;
                if(cycle.includes('month')) teamPercentage = 0.10;
                else if(cycle.includes('year')) teamPercentage = 0.12;
                else teamPercentage = 0.20;

                const totalTeamCommission = orderTotal * teamPercentage;
                
                repIds.forEach(repId => {
                    const rep = usersMap[repId];
                    if(rep) {
                        let rate = rep.personalCommissionRate;
                        if(rate === undefined || rate === null) {
                            rate = DEFAULT_COMMISSION_RATES[rep.jobTitle] || 0.0;
                        }
                        if (rate > 0) {
                            const finalAmount = orderTotal * rate;
                            if (finalAmount > 0) {
                                const newCommRef = db.collection("commission_overview").doc();
                                commBatch.set(newCommRef, {
                                    orderId: orderId,
                                    crewId: repId,
                                    crewName: rep.name,
                                    amount: parseFloat(finalAmount.toFixed(2)),
                                    orderDate: orderDate,
                                    status: 'unpaid', 
                                    paidAt: null,
                                    paidBy: null,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }
                    }
                });

                await commBatch.commit();
                console.log(`Generated commission records for order ${orderId}`);
                showToast(`Commissions calculated based on individual Job Title rates.`, "success");
            }
        }

        async function updateOrderDetails(id) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_ORDERS)) return showToast("Access Denied. You cannot edit orders.", "error");

            const updateData = {
                customerName: document.getElementById('o-name').value,
                customerEmail: document.getElementById('o-email').value,
                customerPhone: document.getElementById('o-phone').value,
                total: document.getElementById('o-total').value,
                domain: document.getElementById('o-domain').value.replace(/^https?:\/\//, ''), 
                status: document.getElementById('upd-status').value,
                internalNotes: document.getElementById('o-notes').value 
            };
            const checkboxes = document.querySelectorAll('.rep-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            updateData.salesRepIds = selectedIds;

            await db.collection("orders").doc(id).update(updateData);
            const freshDoc = await db.collection("orders").doc(id).get();
            const freshData = freshDoc.data();
            if(freshData.status === 'Paid') {
                await generateCommissionsForOrder(id, freshData);
            }
            closeModal(); 
            showToast("Order Updated Successfully", "success"); 
            logActivity(`Updated Order #${id.substr(0,6)}`);
        }

        function deleteOrder(id) {
            if(!isSuperAdmin()) return;
            if(!confirm("Delete this order?")) return;
            db.collection("orders").doc(id).delete().then(() => {
                showToast("Order Deleted", "success");
                logActivity(`Deleted Order #${id.substr(0,6)}`);
            });
        }

        // --- 3. CLIENTS ---
        function renderClients() {
            setPageLoading(true);
            const main = document.getElementById('main');
            main.innerHTML = `
                <div class="table-container">
                    <div class="table-header" style="display:block;">
                        <div class="flex justify-between items-center mb-2">
                            <h3>Client Directory</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid var(--border-glass);">
                            <input type="text" id="filter-clients-search" placeholder="Search Name, Email..." onkeyup="TableEngine.setFilter('client-tbody', 'search', this.value)">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table><thead><tr><th onclick="TableEngine.setSort('client-tbody', 'name')" style="cursor:pointer">Name <i class="ri-arrow-up-down-line"></i></th><th>Company</th><th>Contact</th><th>Voucher</th><th>Actions</th></tr></thead><tbody id="client-tbody"><tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="client-tbody-pagination"></div>
                    </div>
                </div>`;
            
            db.collection("users").where("role", "==", "user").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('client-tbody', data);
            });

            window.customTableRenderers['client-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="5" class="text-center text-muted">No clients found</td></tr>';
                return data.map(u => {
                    const vStatus = u.personalVoucher ? u.personalVoucher.status : 'None';
                    const vCode = u.personalVoucher ? u.personalVoucher.code : '-';
                    let buttons = '';
                    if(checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CLIENTS)) {
                        buttons += `<button class="btn btn-sm btn-secondary" onclick="editClient('${u.id}')">Edit</button>`;
                        buttons += `<button class="btn btn-sm btn-primary" onclick="openAssignVoucherModal('${u.id}', '${u.name}')">Assign Voucher</button>`;
                    }
                    buttons += `<button class="btn btn-sm btn-info" onclick="viewClientTimeline('${u.id}', '${u.name}')"><i class="ri-history-line"></i> Timeline</button>`;
                    // EMAIL ACTIONS
                    buttons += `<button class="btn btn-sm btn-info" title="Reset Password" onclick="sendPasswordReset('${u.email}', '${u.name}')"><i class="ri-lock-password-line"></i></button>`;
                    
                    if (isSuperAdmin()) buttons += `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}', '${u.name}', 'Client')"><i class="ri-delete-bin-line"></i></button>`;
                    return `<tr><td>${u.name}</td><td>${u.company||'-'}</td><td>${u.email}<br><small style="color:var(--text-faint)">${u.phone||''}</small></td><td>${vStatus !== 'None' ? `<span class="badge" style="background:${vStatus==='active'?'#ecfdf5':'#f3f4f6'}">${vCode}</span>` : '-'}</td><td><div style="display:flex; gap:5px;">${buttons}</div></td></tr>`;
                }).join('');
            };
        }

        async function sendPasswordReset(email, name) {
            if(!confirm(`Send password reset email to ${name} (${email})?`)) return;
            try {
                await auth.sendPasswordResetEmail(email);
                showToast("Password reset email sent", "success");
                logActivity(`Sent password reset email to ${email}`);
            } catch(e) {
                showToast("Error sending reset: " + e.message, "error");
            }
        }
        
        async function viewClientTimeline(uid, name) {
            showModal(`Client Timeline: ${name}`, `<div class="loading-spinner"></div>`, `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`);
            let timelineHTML = `<div class="timeline-container">`;
            try {
                const oSnap = await db.collection("orders").where("customerEmail", "==", (await db.collection("users").doc(uid).get()).data().email).orderBy("timestamp", "desc").get();
                oSnap.forEach(doc => {
                    const d = doc.data();
                    timelineHTML += `<div class="timeline-item"><div class="timeline-date">${formatDateTime(d.timestamp)}</div><div class="timeline-title">New Order: ${d.package}</div><div class="timeline-desc">Amount: ${d.total} | Status: <span style="color:${d.status==='Paid'?'var(--success)':'var(--warning)'}">${d.status}</span></div></div>`;
                });
                const tSnap = await db.collection("tickets").where("email", "==", (await db.collection("users").doc(uid).get()).data().email).orderBy("timestamp", "desc").get();
                tSnap.forEach(doc => {
                    const d = doc.data();
                    timelineHTML += `<div class="timeline-item"><div class="timeline-date">${formatDateTime(d.timestamp)}</div><div class="timeline-title">Support Ticket: ${d.type}</div><div class="timeline-desc">ID: ${d.ticketId} | Status: ${d.status}</div></div>`;
                });
                const rSnap = await db.collection("customer_requests").where("email", "==", (await db.collection("users").doc(uid).get()).data().email).orderBy("timestamp", "desc").get();
                rSnap.forEach(doc => {
                    const d = doc.data();
                    timelineHTML += `<div class="timeline-item"><div class="timeline-date">${formatDateTime(d.timestamp)}</div><div class="timeline-title">Request: ${d.type}</div><div class="timeline-desc">Company: ${d.company || '-'} | Status: ${d.status}</div></div>`;
                });

                if(timelineHTML === `<div class="timeline-container">`) timelineHTML += `<p class="text-muted text-center mt-4">No history found for this client.</p>`;
                else timelineHTML += `</div>`;
                document.getElementById('modalBody').innerHTML = timelineHTML;
            } catch(e) {
                document.getElementById('modalBody').innerHTML = `<p class="text-danger text-center">Error loading timeline: ${e.message}</p>`;
            }
        }

        function editClient(uid) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CLIENTS)) return showToast("Access Denied", "error");
            db.collection("users").doc(uid).get().then(doc => {
                const u = doc.data();
                showModal("Edit Client", `
                    <label>Name</label><input id="e-name" class="mb-4" value="${u.name}">
                    <label>Email</label><input id="e-email" class="mb-4" value="${u.email}">
                    <div class="flex gap-2 mb-4">
                        <button class="btn btn-sm btn-secondary w-full" onclick="sendVerifyEmail('${u.email}')">Send Verification</button>
                        <button class="btn btn-sm btn-secondary w-full" onclick="sendPasswordReset('${u.email}', '${u.name}')">Reset Password</button>
                    </div>
                    <label>Phone</label><input id="e-phone" class="mb-4" value="${u.phone||''}">
                    <label>Company</label><input id="e-comp" class="mb-4" value="${u.company||''}">
                `, `<button class="btn btn-primary" onclick="saveClient('${uid}')">Update</button>`);
            });
        }

        async function sendVerifyEmail(email) {
             showToast("To verify another user's email, please use the Admin Console or ask the user to request a new verification link.", "warning");
        }
        async function saveClient(uid) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CLIENTS)) return showToast("Access Denied", "error");
            const data = { name: document.getElementById('e-name').value, email: document.getElementById('e-email').value, phone: document.getElementById('e-phone').value, company: document.getElementById('e-comp').value };
            const oldDoc = await db.collection("users").doc(uid).get();
            if(oldDoc.exists && oldDoc.data().email !== data.email) {
                logActivity(`Changed email for client from ${oldDoc.data().email} to ${data.email}`);
            }
            db.collection("users").doc(uid).update(data).then(() => { closeModal(); showToast("Client Updated", "success"); logActivity("Updated client details"); });
        }

        // --- 4. CREW MANAGEMENT (WITH EMAIL ACTIONS) ---
        function renderCrew() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:800;">Internal Crew</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="openAddCrewModal()"><i class="ri-add-line"></i> Add Crew</button>` : ''}
                </div>
                <div class="table-container">
                    <div class="table-header" style="display:block;">
                         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; background: #f8fafb; padding: 10px; border-radius: 8px; border: 1px solid var(--border-glass);">
                            <input type="text" id="filter-crew-search" placeholder="Search Name, ID..." onkeyup="TableEngine.setFilter('crew-tbody', 'search', this.value)">
                            <select id="filter-crew-dept" onchange="TableEngine.setFilter('crew-tbody', 'dept', this.value)">
                                <option value="">All Departments</option>
                                ${DEPARTMENTS.map(d => `<option value="${d}">${d}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table><thead><tr><th onclick="TableEngine.setSort('crew-tbody', 'crewId')" style="cursor:pointer">Crew ID <i class="ri-arrow-up-down-line"></i></th><th onclick="TableEngine.setSort('crew-tbody', 'name')" style="cursor:pointer">Name <i class="ri-arrow-up-down-line"></i></th><th>Email</th><th>Phone</th><th>Work Loc</th><th>Department</th><th>Job Title</th><th>Comm Rate</th><th>Status</th><th>Actions</th></tr></thead><tbody id="crew-tbody"><tr><td colspan="10" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="crew-tbody-pagination"></div>
                    </div>
                </div>`;
            
            db.collection("users").where("role", "in", ["super_admin", "mid_admin", "admin", "crew"]).onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('crew-tbody', data);
            });

            window.customTableRenderers['crew-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="10" class="text-center text-muted">No crew found</td></tr>';
                return data.map(u => {
                    const workLoc = u.workLocation || '-';
                    const isSuspended = u.isSuspended || false;
                    const statusBadge = isSuspended ? `<span class="badge" style="background:#fef2f2; color:var(--danger); border:1px solid #fecaca">Suspended</span>` : `<span class="badge" style="background:#ecfdf5; color:var(--success); border:1px solid #a7f3d0">Active</span>`;
                    
                    let rate = u.personalCommissionRate !== undefined ? u.personalCommissionRate : (DEFAULT_COMMISSION_RATES[u.jobTitle] || 0);
                    const ratePct = (rate * 100).toFixed(1) + '%';
                    const rateColor = rate === 0 ? 'var(--text-faint)' : 'var(--primary)';

                    let buttons = '';
                    if (canEdit) buttons = `<button class="btn btn-sm btn-secondary" onclick="editCrew('${u.id}')"><i class="ri-pencil-line"></i></button>`;
                    
                    // EMAIL ACTIONS FOR CREW
                    if (hasPermission(PERMISSION_KEYS.MANAGE_EMAIL)) {
                         buttons += `<button class="btn btn-sm btn-info" title="Email Actions" onclick="openEmailActionsModal('${u.id}', '${u.email}', '${u.name}')"><i class="ri-mail-send-line"></i></button>`;
                    }

                    if (isSuperAdmin()) {
                        if(isSuspended) buttons += `<button class="btn btn-sm btn-success" onclick="toggleSuspension('${u.id}', false)" title="Reactivate"><i class="ri-user-follow-line"></i></button>`;
                        else buttons += `<button class="btn btn-sm btn-warning" onclick="toggleSuspension('${u.id}', true)" title="Suspend"><i class="ri-user-unfollow-line"></i></button>`;
                        buttons += `<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}', '${u.name}', 'Crew')"><i class="ri-delete-bin-line"></i></button>`;
                    }
                    return `<tr>
                        <td class="font-mono" style="color:var(--primary)">${u.crewId || 'N/A'}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || '-'}</td>
                        <td><span class="badge badge-${u.workLocation === 'HQ' ? 'admin' : 'crew'}">${workLoc}</span></td>
                        <td><span class="badge badge-user" style="background:#f0fdf4; color:var(--success)">${u.department || '-'}</span></td>
                        <td>${u.jobTitle||'-'}</td>
                        <td style="font-weight:bold; color:${rateColor}">${ratePct}</td>
                        <td>${statusBadge}</td>
                        <td>${buttons}</td>
                    </tr>`;
                }).join('');
            };
        }
        
        function openEmailActionsModal(uid, email, name) {
             showModal(`Email Actions: ${name}`, `
                <div class="mb-4"><label>Target Email</label><input value="${email}" readonly></div>
                <div class="flex flex-col gap-2">
                    <button class="btn btn-secondary" onclick="sendPasswordReset('${email}', '${name}'); closeModal();"><i class="ri-lock-password-line"></i> Send Password Reset</button>
                    <button class="btn btn-secondary" onclick="sendMFANotification('${email}', '${name}'); closeModal();"><i class="ri-shield-keyhole-line"></i> Send MFA Enrolment Notification</button>
                    <div style="border-top:1px solid var(--border-glass); margin: 10px 0;"></div>
                    <p class="text-sm text-muted">Note: Changing a user's email address requires updating their database record. Firebase Auth email changes usually require the user to re-authenticate.</p>
                </div>
             `, `<button class="btn btn-primary" onclick="closeModal()">Close</button>`);
        }

        async function sendMFANotification(email, name) {
            logActivity(`Sent MFA Enrolment Notification to ${email}`);
            showToast(`MFA Notification simulated for ${name}`, "success");
        }

        async function openAddCrewModal() {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return showToast("Access Denied", "error");
            const newCrewId = await getNextId('crew');
            const jobOptions = JOB_TITLES.map(j => `<option value="${j}">${j}</option>`).join('');
            
            showModal("Add New Crew", `
                <div class="mb-4"><label>Crew ID</label><input id="c-id" value="${newCrewId}" readonly></div>
                <div class="mb-4"><label>Full Name</label><input id="c-name"></div>
                <div class="mb-4"><label>Email Address</label><input type="email" id="c-email"></div>
                <div class="mb-4"><label>Phone Number (Optional)</label><input type="tel" id="c-phone" placeholder="01XXXXXXXXX"></div>
                <div class="mb-4">
                    <label>Job Title (Auto-Sets Role & Default Rate)</label>
                    <select id="c-job" onchange="autoSetRoleAndDept()">
                        <option value="">Select Job Title...</option>
                        ${jobOptions}
                    </select>
                </div>
                <div class="flex gap-4 mb-4">
                    <div style="flex:1"><label>Role</label><input type="text" id="c-role" readonly style="background:#f9fafb"></div>
                    <div style="flex:1"><label>Department</label><select id="c-dept">${DEPARTMENTS.map(d=>`<option value="${d}">${d}</option>`)}</select></div>
                </div>
                <div class="mb-4"><label>Work Location</label><select id="c-work-loc"><option value="HQ">HQ (Office)</option><option value="WFH">Work From Home (WFH)</option></select></div>
                <div class="mb-4"><label>Temporary Password</label><input type="password" id="c-pass" placeholder="Set password"></div>
            `, `<button class="btn btn-primary" onclick="saveCrew('${newCrewId}')">Create Crew</button>`);
        }
        
        function autoSetRoleAndDept() {
            const title = document.getElementById('c-job').value;
            const roleInput = document.getElementById('c-role');
            const dbRole = JOB_ROLE_MAP[title] || 'crew'; 
            roleInput.value = dbRole.toUpperCase();
        }

        async function saveCrew(newId) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return showToast("Access Denied", "error");
            const name = document.getElementById('c-name').value;
            const email = document.getElementById('c-email').value;
            const phone = document.getElementById('c-phone').value; 
            const pass = document.getElementById('c-pass').value;
            const job = document.getElementById('c-job').value;
            const workLoc = document.getElementById('c-work-loc').value;
            const dept = document.getElementById('c-dept').value;

            if(!name || !email || !pass || !job) return showToast("Please fill all required fields", "error");
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
                const dbRole = JOB_ROLE_MAP[job] || 'crew';
                const bankDetails = { bankName: '', accountHolder: '', accountNumber: '' };
                const bypass = false; 
                const initialRate = DEFAULT_COMMISSION_RATES[job] || 0;
                
                await db.collection("users").doc(userCredential.user.uid).set({
                    crewId: newId, name: name, email: email, phone: phone, role: dbRole, jobTitle: job, workLocation: workLoc, department: dept, permissions: {}, bankDetails: bankDetails, isSuspended: false, bypassApproval: bypass, timestamp: firebase.firestore.FieldValue.serverTimestamp(), personalCommissionRate: initialRate
                });
                closeModal();
                showToast("Crew created successfully", "success");
                logActivity(`Created new crew member: ${name} (${newId})`);
            } catch(e) {
                showToast(e.message, "error");
            }
        }

        async function toggleSuspension(uid, suspend) {
            if(!isSuperAdmin()) return;
            const action = suspend ? "Suspend" : "Reactivate";
            if(!confirm(`Are you sure you want to ${action} this user?`)) return;
            try {
                await db.collection("users").doc(uid).update({ isSuspended: suspend });
                showToast(`User ${suspend ? 'Suspended' : 'Reactivated'}`, "success");
                logActivity(`${action} user account: ${uid}`);
            } catch(e) {
                showToast("Error updating status: " + e.message, "error");
            }
        }

        function editCrew(uid) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return showToast("Access Denied", "error");
            db.collection("users").doc(uid).get().then(doc => {
                const u = doc.data();
                const jobOptions = JOB_TITLES.map(j => `<option value="${j}" ${u.jobTitle===j?'selected':''}>${j}</option>`).join('');
                const currentWorkLoc = u.workLocation || 'HQ';
                
                let permsHTML = '<div style="margin-top:1rem; border-top:1px solid var(--border-glass); padding-top:1rem;"><label style="margin-bottom:0.5rem; display:block;">Access Permissions</label><div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;">';
                const userPerms = u.permissions || {};
                for (const [key, label] of Object.entries({
                    [PERMISSION_KEYS.EDIT_ORDERS]: 'Edit Orders', [PERMISSION_KEYS.EDIT_CLIENTS]: 'Edit Clients', [PERMISSION_KEYS.DELETE_REQUESTS]: 'Delete Requests', [PERMISSION_KEYS.DELETE_SUPPORT]: 'Delete Tickets', [PERMISSION_KEYS.EDIT_VOUCHERS]: 'Edit Vouchers', [PERMISSION_KEYS.EDIT_PORTFOLIO]: 'Edit Portfolio', [PERMISSION_KEYS.EDIT_CONTENT]: 'Edit Content', [PERMISSION_KEYS.EDIT_PROMOS]: 'Edit Promos', [PERMISSION_KEYS.EDIT_CONFIG]: 'Edit Config', [PERMISSION_KEYS.APPROVE_REQUESTS]: 'Approve Requests', [PERMISSION_KEYS.ADJUST_COMMISSION]: 'Adjust Commission Rate', [PERMISSION_KEYS.EDIT_ACCESS]: 'Edit Access/Profile', [PERMISSION_KEYS.MANAGE_EMAIL]: 'Manage Email Settings'
                })) {
                    const isChecked = userPerms[key] === true ? 'checked' : '';
                    permsHTML += `<label class="flex items-center gap-2" style="font-size:0.8rem; font-weight:400; color:var(--text-muted); text-transform:none;"><input type="checkbox" class="perm-toggle" value="${key}" ${isChecked} style="width:auto; margin:0;"> ${label}</label>`;
                }
                permsHTML += '</div></div>';

                if(isSuperAdmin()) {
                    permsHTML += `<label class="flex items-center gap-2 mt-2" style="font-size:0.8rem; font-weight:400; color:var(--text-muted); text-transform:none;"><input type="checkbox" class="perm-toggle" value="${PERMISSION_KEYS.APPROVE_ACTIONS}" ${userPerms[PERMISSION_KEYS.APPROVE_ACTIONS]===true?'checked':''} style="width:auto; margin:0;"> Approve Actions (Admin Power)</label>`;
                    const isBypass = u.bypassApproval === true;
                    permsHTML += `<div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;" class="flex items-center gap-2"><label class="toggle-switch"><input type="checkbox" id="e-c-bypass" ${isBypass ? 'checked' : ''}><span class="slider"></span></label><span style="font-size:0.8rem; color:var(--danger); font-weight:700;">BYPASS APPROVAL (Auto-Approve Edits)</span></div>`;
                }
                const hasFinanceAccess = userPerms[PERMISSION_KEYS.FINANCE_TOOLS_ACCESS] === true;
                permsHTML += `<div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;" class="flex items-center gap-2"><input type="checkbox" id="e-c-finance-access" ${hasFinanceAccess ? 'checked' : ''} style="width:auto; margin:0;"><span style="font-size:0.8rem; color:var(--success); font-weight:700;">Finance Tools Access</span></div>`;
                
                const bd = u.bankDetails || {};
                const bankHTML = `<div style="margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border-glass);"><h4 style="font-size:0.9rem; margin-bottom:0.5rem; color:var(--primary);">Bank Details (Finance)</h4><div class="mb-2"><label>Bank Name</label><input id="c-bank-name" value="${bd.bankName||''}"></div><div class="mb-2"><label>Account Holder Name</label><input id="c-bank-holder" value="${bd.accountHolder||''}"></div><div class="mb-2"><label>Account Number</label><input id="c-bank-num" value="${bd.accountNumber||''}"></div></div>`;

                const canEditRole = isSuperAdmin();
                
                const globalRate = DEFAULT_COMMISSION_RATES[u.jobTitle] || 0;
                const currentRate = u.personalCommissionRate !== undefined ? u.personalCommissionRate : globalRate;
                const canEditRate = isSuperAdmin() || hasPermission(PERMISSION_KEYS.ADJUST_COMMISSION);
                
                const rateHTML = `
                    <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #eee;">
                        <h4 style="font-size:0.9rem; margin-bottom:0.5rem; color:var(--primary);">Commission Rate</h4>
                        <div class="flex items-center gap-4 mb-2">
                            <div style="font-size:0.8rem; color:var(--text-muted);">Global Default for ${u.jobTitle}: ${(globalRate*100).toFixed(1)}%</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" step="0.001" min="0" max="1" id="e-c-comm-rate" value="${currentRate}" ${!canEditRate ? 'disabled' : ''} style="width: 100px;">
                            <span style="font-size:0.8rem;">(Decimal, e.g. 0.05 = 5%)</span>
                            ${canEditRate ? '' : '<small class="text-danger text-sm">Locked: Requires Edit Access</small>'}
                        </div>
                    </div>
                `;

                showModal("Edit Crew Member", `
                    <div class="mb-4"><label>Crew ID</label><input id="e-c-id" value="${u.crewId}"></div>
                    <div class="mb-4"><label>Full Name</label><input id="e-c-name" value="${u.name}"></div>
                    <div class="mb-4"><label>Email Address</label><input id="e-c-email" value="${u.email}"></div>
                    <div class="mb-4"><label>Phone Number</label><input id="e-c-phone" value="${u.phone||''}"></div>
                    <div class="mb-4">
                        <label>Job Title</label>
                        <select id="e-c-job" onchange="autoSetEditRoleDept()">
                            <option value="">Select Job Title...</option>
                            ${jobOptions}
                        </select>
                    </div>
                    <div class="flex gap-4 mb-4">
                        <div style="flex:1"><label>System Role</label><select id="e-c-role" ${!canEditRole?'disabled':''} style="${!canEditRole?'background:#f3f4f6; cursor:not-allowed;':''}"><option value="crew" ${u.role==='crew'?'selected':''}>Crew</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option><option value="mid_admin" ${u.role==='mid_admin'?'selected':''}>Mid Admin</option><option value="super_admin" ${u.role==='super_admin'?'selected':''}>Super Admin</option></select>${!canEditRole ? '<small class="text-danger text-sm">Only Super Admins can change roles.</small>' : ''}</div>
                        <div style="flex:1"><label>Department</label><select id="e-c-dept">${DEPARTMENTS.map(d=>`<option value="${d}" ${u.department===d?'selected':''}>${d}</option>`)}</select></div>
                    </div>
                     <div class="mb-4"><label>Work Location</label><select id="e-c-work-loc"><option value="HQ" ${currentWorkLoc === 'HQ' ? 'selected' : ''}>HQ (Office)</option><option value="WFH" ${currentWorkLoc === 'WFH' ? 'selected' : ''}>Work From Home (WFH)</option></select></div>
                     ${permsHTML}
                     ${bankHTML}
                     ${rateHTML}
                `, `<button class="btn btn-primary" onclick="updateCrewData('${uid}')">Save</button>`);
            });
        }

        function autoSetEditRoleDept() {
            const title = document.getElementById('e-c-job').value;
            const roleSelect = document.getElementById('e-c-role');
            const dbRole = JOB_ROLE_MAP[title] || 'crew'; 
            roleSelect.value = dbRole;
        }

        async function updateCrewData(uid) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CREW)) return showToast("Access Denied", "error");
            const newPerms = {};
            document.querySelectorAll('.perm-toggle').forEach(cb => newPerms[cb.value] = cb.checked);
            const bypassEl = document.getElementById('e-c-bypass');
            const bypassVal = bypassEl ? bypassEl.checked : false;
            newPerms[PERMISSION_KEYS.FINANCE_TOOLS_ACCESS] = financeVal;
            const bankData = { bankName: document.getElementById('c-bank-name').value, accountHolder: document.getElementById('c-bank-holder').value, accountNumber: document.getElementById('c-bank-num').value };
            let updatePayload = { crewId: document.getElementById('e-c-id').value, name: document.getElementById('e-c-name').value, email: document.getElementById('e-c-email').value, phone: document.getElementById('e-c-phone').value, jobTitle: document.getElementById('e-c-job').value, permissions: newPerms, bankDetails: bankData, bypassApproval: bypassVal, workLocation: document.getElementById('e-c-work-loc').value, department: document.getElementById('e-c-dept').value };
            
            const canEditRate = isSuperAdmin() || hasPermission(PERMISSION_KEYS.ADJUST_COMMISSION);
            if (canEditRate) {
                const rateInput = document.getElementById('e-c-comm-rate');
                if(rateInput) {
                    const newRate = parseFloat(rateInput.value);
                    if(!isNaN(newRate)) updatePayload.personalCommissionRate = newRate;
                }
            }

            if (isSuperAdmin()) updatePayload.role = document.getElementById('e-c-role').value;
            db.collection("users").doc(uid).update(updatePayload).then(() => { closeModal(); showToast("Crew details updated", "success"); logActivity(`Updated crew member details`); });
        }

        // --- 5. SUPPORT ---
        function renderSupport() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canDelete = checkAccessOrActionAllowed(PERMISSION_KEYS.DELETE_SUPPORT);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button class="btn btn-secondary" onclick="openCreateTicket()"><i class="ri-add-line"></i> Create New Ticket</button>
                    <input type="text" id="filter-support-search" placeholder="Search ID, Client..." style="width:200px;" onkeyup="TableEngine.setFilter('supp-tbody', 'search', this.value)">
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>ID</th><th>Date</th><th>Client</th><th>Issue</th><th>Assigned To</th><th>Status</th><th>Action</th></tr></thead><tbody id="supp-tbody"><tr><td colspan="7" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="supp-tbody-pagination"></div>
                    </div>
                </div>`;
            db.collection("tickets").orderBy("timestamp", "desc").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('supp-tbody', data);
            });
            window.customTableRenderers['supp-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="7" class="text-center text-muted">No tickets found</td></tr>';
                return data.map(d => {
                    let statusBadge = ''; if(d.status === 'Closed') statusBadge = 'var(--text-faint)'; else if(d.status === 'In Progress') statusBadge = 'var(--primary)'; else statusBadge = 'var(--warning)';
                    return `<tr>
                        <td class="font-mono" style="color:var(--ticket)">${d.ticketId || d.id}</td>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td>${d.name}</td><td>${d.type}</td>
                        <td>${d.assignedToName || 'Unassigned'}</td>
                        <td><span class="badge" style="background:${statusBadge}15; color:${statusBadge}">${d.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewTicket('${d.id}')">Manage</button>
                            ${canDelete ? `<button class="btn btn-sm btn-danger" onclick="deleteItem('ticket','${d.id}')"><i class="ri-delete-bin-line"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            };
        }

        async function openCreateTicket() {
            const newId = await getNextId('ticket');
            showModal("Create Support Ticket", `<div class="mb-4"><label>Generated ID</label><input value="${newId}" readonly class="font-mono" style="color:var(--ticket)"></div><div class="mb-4"><label>Client Name</label><input id="tk-name"></div><div class="mb-4"><label>Issue Type</label><select id="tk-type"><option>Technical</option><option>Billing</option><option>Other</option></select></div><div class="mb-4"><label>Details</label><textarea id="tk-msg"></textarea></div>`, `<button class="btn btn-primary" onclick="saveNewTicket('${newId}')">Create</button>`);
        }
        async function saveNewTicket(id) {
             const data = { ticketId: id, name: document.getElementById('tk-name').value, type: document.getElementById('tk-type').value, message: document.getElementById('tk-msg').value, status: 'Open', timestamp: firebase.firestore.FieldValue.serverTimestamp() };
             await db.collection("tickets").add(data);
             closeModal(); showToast("Ticket Created Successfully", "success"); logActivity(`Created new support ticket ${id}`);
        }
        function viewTicket(id) {
            db.collection("tickets").doc(id).get().then(doc => {
                const d = doc.data();
                db.collection("users").where("role", "in", ["super_admin", "mid_admin", "admin", "crew"]).get().then(snap => {
                    const crewOpts = snap.docs.map(c => `<option value="${c.id}" ${d.assignedTo===c.id?'selected':''}>${c.data().name}</option>`).join('');
                    showModal(`Ticket: ${d.ticketId || id}`, `<p class="mb-4 p-4" style="background:#f9fafb; border-radius:8px; border:1px solid var(--border-glass)">${d.message}</p><div class="flex gap-4 mb-4"><div style="flex:1"><label>Status</label><select id="tk-status"><option value="Open" ${d.status=='Open'?'selected':''}>Open</option><option value="In Progress" ${d.status=='In Progress'?'selected':''}>In Progress</option><option value="Closed" ${d.status=='Closed'?'selected':''}>Closed</option></select></div><div style="flex:1"><label>Assign To Crew</label><select id="tk-assign"><option value="">Unassigned</option>${crewOpts}</select></div></div>`, `<button class="btn btn-primary" onclick="saveTicketDetails('${id}')">Save Changes</button>`);
                });
            });
        }
        async function saveTicketDetails(id) {
            const data = { status: document.getElementById('tk-status').value, assignedTo: document.getElementById('tk-assign').value || null, assignedToName: document.getElementById('tk-assign').value ? document.getElementById('tk-assign').options[document.getElementById('tk-assign').selectedIndex].text : "" };
            db.collection("tickets").doc(id).update(data).then(() => { closeModal(); showToast("Ticket Updated", "success"); logActivity(`Updated Ticket #${id}`); });
        }

        // --- 6. VOUCHERS ---
        async function renderVouchers() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 style="font-size:1.25rem; font-weight:800;">Voucher Management</h3>
                    <div class="flex gap-2">${canEdit ? `<button class="btn btn-primary" onclick="openAssignVoucherModal(null, null)"><i class="ri-add-line"></i> Assign New</button>` : ''}<button class="btn btn-secondary" onclick="renderVouchers()"><i class="ri-refresh-line"></i> Sync Data</button></div>
                </div>
                <div class="table-container" style="min-height: 200px; display:flex; justify-content:center; align-items:center;"><div id="voucher-loader" class="loading-spinner"></div></div>
                <div class="table-container hidden" id="active-vouchers-container"><div class="table-header"><h3>Active Vouchers</h3></div><div class="table-responsive"><table><thead><tr><th>User</th><th>Code</th><th>Status</th><th>Value</th><th>Expiry</th><th>Actions</th></tr></thead><tbody id="vouch-active"></tbody></table></div></div>
                <div class="table-container hidden" id="history-vouchers-container"><div class="table-header"><h3>Voucher History</h3></div><div class="table-responsive"><table><thead><tr><th>Code</th><th>User</th><th>Status</th><th>Date Moved</th><th>Actions</th></tr></thead><tbody id="vouch-history"></tbody></table></div></div>
            `;
            await syncVoucherLogic();
            document.getElementById('voucher-loader').parentElement.classList.add('hidden');
            document.getElementById('active-vouchers-container').classList.remove('hidden');
            document.getElementById('history-vouchers-container').classList.remove('hidden');

            db.collection("users").where("personalVoucher", "!=", null).onSnapshot(snap => {
                const tbody = document.getElementById('vouch-active');
                if(!tbody) return;
                tbody.innerHTML = '';
                snap.forEach(doc => {
                    const u = doc.data();
                    const v = u.personalVoucher;
                    const vStatus = v.status ? v.status : 'Active';
                    let statusColor = 'var(--success)';
                    const statusLower = vStatus.toLowerCase();
                    if (statusLower === 'suspended') statusColor = 'var(--danger)';
                    let actions = `<button class="btn btn-sm btn-secondary" onclick="editVoucher('${doc.id}', '${v.code}')">Edit</button>`;
                    if (canEdit) {
                        actions += `<button class="btn btn-sm btn-success" onclick="markRedeem('${doc.id}', '${v.code}')"><i class="ri-checkbox-double-line"></i> Redeem</button>`;
                        actions += `<button class="btn btn-sm btn-danger" onclick="disableVoucher('${doc.id}', '${v.code}')"><i class="ri-delete-bin-line"></i> Disable</button>`;
                    }
                    actions += `<button class="btn btn-sm btn-info" title="Notify Admin Team" onclick="notifyVoucherExpiryAdmin('${v.code}', '${v.expiryDate ? new Date(v.expiryDate.seconds * 1000).toLocaleDateString() : 'N/A'}', '${u.name}')"><i class="ri-whatsapp-line"></i> Admin</button>`;
                    actions += `<button class="btn btn-sm btn-success" title="Notify Client" onclick="notifyVoucherExpiryClient('${u.phone}', '${u.name}', '${v.expiryDate ? new Date(v.expiryDate.seconds * 1000).toLocaleDateString() : 'N/A'}')"><i class="ri-whatsapp-line"></i> Client</button>`;
                    tbody.innerHTML += `<tr><td>${u.name}</td><td class="font-mono" style="color:var(--primary)">${v.code}</td><td><span class="badge" style="background:${statusColor}15; color:${statusColor}; border:1px solid ${statusColor}25">${vStatus}</span></td><td>${v.type=='fixed'?'RM '+v.value:v.value*100+'%'}</td><td>${v.expiryDate ? new Date(v.expiryDate.seconds*1000).toLocaleDateString() : '-'}</td><td>${actions}</td></tr>`;
                });
            });
            const updateHistoryListener = () => {
                db.collection("vouchers_history").orderBy("movedAt", "desc").limit(50).onSnapshot(snap => {
                    const tbody = document.getElementById('vouch-history');
                    if(!tbody) return;
                    tbody.innerHTML = '';
                    snap.forEach(doc => {
                        const v = doc.data();
                        let actionBtn = v.status === 'Redeemed' ? `<small style="color:var(--text-faint)">Locked</small>` : (canEdit ? `<button class="btn btn-sm btn-success" onclick="restoreVoucher('${v.code}', '${v.ownerUid}')">Restore</button>` : '');
                        let statusColor = 'var(--text-faint)';
                        if (v.status === 'Redeemed') statusColor = 'var(--success)';
                        if (v.status === 'Expired') statusColor = 'var(--warning)'; 
                        if (v.status === 'Disabled') statusColor = 'var(--text-faint)';
                        tbody.innerHTML += `<tr><td class="font-mono">${v.code}</td><td>${v.assignedToName || '-'}</td><td><span class="badge" style="background:${statusColor}15; color:${statusColor}">${v.status}</span></td><td>${v.movedAt ? formatDateTime(v.movedAt) : '-'}</td><td>${actionBtn}</td></tr>`;
                    });
                });
            };
            updateHistoryListener();
        }

        async function syncVoucherLogic() {
            const usersSnap = await db.collection("users").where("personalVoucher", "!=", null).get();
            if(usersSnap.empty) return;
            let movedCount = 0;
            for (const userDoc of usersSnap.docs) {
                const uid = userDoc.id;
                const uData = userDoc.data();
                const vouch = uData.personalVoucher;
                const code = vouch.code;
                let moveToHistory = false;
                let statusReason = "";
                if(vouch.expiryDate) {
                    const expDate = vouch.expiryDate.toDate ? vouch.expiryDate.toDate() : new Date(vouch.expiryDate);
                    if(new Date() > expDate) { moveToHistory = true; statusReason = "Expired"; }
                }
                const currentStatus = (vouch.status || '').toLowerCase();
                if (currentStatus === 'redeemed' && !moveToHistory) { moveToHistory = true; statusReason = "Redeemed"; } else if (currentStatus === 'disabled' && !moveToHistory) { moveToHistory = true; statusReason = "Disabled"; }
                if(moveToHistory) {
                    await db.collection("vouchers_history").doc(code).set({ ...vouch, ownerUid: uid, assignedToName: uData.name, status: statusReason, movedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
                    console.log(`Moved ${code} to history as ${statusReason}`);
                    movedCount++;
                }
            }
            if(movedCount > 0) showToast(`Synced ${movedCount} vouchers to history`, "success");
        }
        function editVoucher(uid, code) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS)) return showToast("Access Denied", "error");
            db.collection("users").doc(uid).get().then(doc => {
                const v = doc.data().personalVoucher;
                const exp = v.expiryDate ? new Date(v.expiryDate.seconds*1000).toISOString().split('T')[0] : '';
                const currentStatus = v.status ? v.status : 'Active';
                showModal(`Edit Voucher ${code}`, `<label>Code</label><input id="e-v-code" value="${v.code}" class="mb-4"><label>Status</label><select id="e-v-status" class="mb-4"><option value="Active" ${currentStatus==='Active'?'selected':''}>Active</option><option value="Suspended" ${currentStatus==='Suspended'?'selected':''}>Suspended</option></select><label>Value</label><input type="number" id="e-v-val" value="${v.value}" class="mb-4"><label>Expiry Date</label><input type="date" id="e-v-exp" value="${exp}" class="mb-4">`, `<button class="btn btn-primary" onclick="saveEditVoucher('${uid}')">Save</button>`);
            });
        }
        async function saveEditVoucher(uid) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS)) return showToast("Access Denied", "error");
            const newCode = document.getElementById('e-v-code').value.toUpperCase();
            const newStatus = document.getElementById('e-v-status').value;            
            db.collection("users").doc(uid).get().then(doc => {
                const v = doc.data().personalVoucher;
                const data = { ...v, code: newCode, value: parseFloat(document.getElementById('e-v-val').value), expiryDate: document.getElementById('e-v-exp').value ? new Date(document.getElementById('e-v-exp').value) : null, status: newStatus };
                db.collection("users").doc(uid).update({ personalVoucher: data }).then(() => { closeModal(); showToast("Voucher Updated", "success"); logActivity(`Edited voucher ${newCode}`); });
            });
        }
        async function markRedeem(uid, code) {
            if(!confirm(`Mark voucher ${code} as Redeemed?`)) return;
            const userDoc = await db.collection("users").doc(uid).get();
            const uData = userDoc.data();
            const vouch = uData.personalVoucher;
            await db.collection("vouchers_history").doc(code).set({ ...vouch, ownerUid: uid, assignedToName: uData.name, status: "Redeemed", movedAt: firebase.firestore.FieldValue.serverTimestamp() });
            await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
            showToast("Voucher Redeemed", "success");
            logActivity(`Marked voucher ${code} as Redeemed`);
        }
        async function disableVoucher(uid, code) {
            if(!confirm(`Disable voucher ${code}?`)) return;
            const userDoc = await db.collection("users").doc(uid).get();
            const uData = userDoc.data();
            const vouch = uData.personalVoucher;
            await db.collection("vouchers_history").doc(code).set({ ...vouch, ownerUid: uid, assignedToName: uData.name, status: "Disabled", movedAt: firebase.firestore.FieldValue.serverTimestamp() });
            await db.collection("users").doc(uid).update({ personalVoucher: firebase.firestore.FieldValue.delete() });
            showToast("Voucher Disabled", "info");
            logActivity(`Disabled voucher ${code}`);
        }
        function openAssignVoucherModal(uid, userName) {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_VOUCHERS)) return showToast("Access Denied", "error");
            const promise = uid ? Promise.resolve(null) : db.collection("users").where("role", "==", "user").get();
            promise.then(snap => {
                let userSelect = '';
                if(snap) { userSelect = `<label>Select Client</label><select id="v-user" class="mb-4">${snap.docs.map(d => `<option value="${d.id}">${d.data().name}</option>`).join('')}</select>`; } else { userSelect = `<input type="hidden" id="v-user" value="${uid}">`; }
                const autoCode = `GIFT-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
                showModal("Assign Voucher", `${userSelect}<div class="mb-4"><label>Code</label><input id="v-code" value="${autoCode}"></div><div class="flex gap-4 mb-4"><div style="flex:1"><label>Type</label><select id="v-val-type"><option value="fixed">Fixed (RM)</option><option value="percent">Percent (%)</option></select></div><div style="flex:1"><label>Value</label><input type="number" id="v-val"></input></div></div><label>Expiry Date</label><input type="date" id="v-exp" class="mb-4">`, `<button class="btn btn-primary" onclick="submitAssignVoucher()">Assign</button>`);
            });
        }
        async function submitAssignVoucher() {
            const uid = document.getElementById('v-user').value;
            const code = document.getElementById('v-code').value.toUpperCase();
            const data = { personalVoucher: { code: code, type: document.getElementById('v-val-type').value, value: parseFloat(document.getElementById('v-val').value), expiryDate: document.getElementById('v-exp').value ? new Date(document.getElementById('v-exp').value) : null, status: 'active', auditLog: [{ action: 'Created', by: userData.email, date: new Date().toISOString() }] } };
            db.collection("users").doc(uid).update(data).then(() => { closeModal(); showToast(`Voucher ${code} Assigned!`, "success"); logActivity(`Assigned voucher ${code}`); });
        }
        function restoreVoucher(code, ownerUid) {
            db.collection("vouchers_history").doc(code).get().then(hist => {
                if(!hist.exists) return showToast("Error", "error");
                const v = hist.data();
                db.collection("users").doc(ownerUid).update({ personalVoucher: { ...v, status: 'active' } }).then(() => {
                    db.collection("vouchers_history").doc(code).delete().then(() => { showToast("Voucher Restored", "success"); logActivity(`Restored voucher ${code}`); });
                });
            });
        }

        // --- 7. CONTENT & PACKAGES ---
        function renderContent() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONTENT);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:800;">Content & Packages</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="saveContentChanges()"><i class="ri-save-line"></i> Save Changes</button>` : ''}
                </div>
                <div class="config-section">
                    <h3 style="margin-bottom:1rem;">Frontend Package Features</h3>
                    <p class="mb-4 text-sm text-muted">Edit feature list displayed on main website. (One feature per line)</p>
                    <textarea id="content-frontend" rows="6" ${canEdit?'':'readonly'}></textarea>
                </div>
                <div class="config-section">
                    <h3 style="margin-bottom:1rem;">AI Package Features</h3>
                    <p class="mb-4 text-sm text-muted">Edit feature list displayed on website. (One feature per line)</p>
                    <textarea id="content-ai" rows="6" ${canEdit?'':'readonly'}></textarea>
                </div>
            `;
            db.collection("config").doc("site_settings").get().then(doc => {
                const siteData = doc.exists ? doc.data() : {};
                const packages = siteData.packageDetails || {};
                const frontendFeatures = (packages.frontend && packages.frontend.features) ? packages.frontend.features : ["Up to 5 Pages", "Animations", "Contact Forms", "WhatsApp Integration"];
                const aiFeatures = (packages.ai && packages.ai.features) ? packages.ai.features : ["All Front-End Features", "AI Chatbot Integration", "Lead Auto-Response", "Smart Analytics"];
                document.getElementById('content-frontend').value = frontendFeatures.join('\n');
                document.getElementById('content-ai').value = aiFeatures.join('\n');
            });
        }
        async function saveContentChanges() {
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONTENT)) return showToast("Access Denied", "error");
            const frontendLines = document.getElementById('content-frontend').value.split('\n').filter(l => l.trim() !== '');
            const aiLines = document.getElementById('content-ai').value.split('\n').filter(l => l.trim() !== '');
            const data = { packageDetails: { frontend: { features: frontendLines }, ai: { features: aiLines } } };
            const btn = document.querySelector('button[onclick="saveContentChanges()"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="loading-spinner" style="width:16px; height:16px; border-width:2px;"></div> Saving...`;
            db.collection("config").doc("site_settings").update(data).then(() => {
                showToast("Content updated successfully!", "success");
                logActivity("Updated website content features");
                btn.innerHTML = originalHTML;
            }).catch(err => { showToast("Error updating: " + err.message, "error"); btn.innerHTML = originalHTML; });
        }

        // --- 8. CONFIG (WITH SMTP TAB) ---
        async function renderConfig() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG);
            const isSA = isSuperAdmin(); 
            const canManageEmail = hasPermission(PERMISSION_KEYS.MANAGE_EMAIL);

            main.innerHTML = `
                <h2 style="font-size:1.25rem; font-weight:800; margin-bottom:1.5rem;">System Configuration</h2>
                
                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="switchConfigTab('general')" id="tab-btn-general">General</button>
                    ${canManageEmail ? `<button class="tab-btn" onclick="switchConfigTab('email')" id="tab-btn-email">Email & SMTP</button>` : ''}
                </div>

                <div id="tab-content-general" class="tab-content active">
                    ${isSA ? `<div class="config-section" style="border-color: var(--danger);"><div class="config-header flex justify-between" style="color: var(--danger);"><span><i class="ri-alert-fill"></i> Super Admin Maintenance Mode</span></div><div class="flex gap-4 mb-4"><div class="flex items-center gap-2"><label class="toggle-switch"><input type="checkbox" id="maint-toggle" onchange="toggleMaintenance()"><span class="slider"></span></label><span style="font-weight:600;">Activate Maintenance</span></div></div><div class="mb-4"><label>Marquee Message</label><input id="maint-msg" class="mb-2" value="IT Department currently fix Portal Bugs"><button class="btn btn-sm btn-secondary" onclick="saveMaintMsg()">Update Message</button></div><div class="mb-4"><label>Disable Menu Items</label><div class="flex gap-2 flex-wrap mt-2">${['/orders', '/clients', '/crew', '/support', '/vouchers'].map(path => `<label class="flex items-center gap-2" style="background:#f9fafb; padding:5px 10px; border-radius:4px; border:1px solid var(--border-glass);"><input type="checkbox" class="menu-disable-check" value="${path}"><span style="font-size:0.8rem;">${path.replace('/','').toUpperCase()}</span></label>`).join('')}</div><button class="btn btn-sm btn-primary mt-2" onclick="saveDisabledMenus()">Apply Menu Restrictions</button></div><div class="mt-4 p-3" style="background:#fef2f2; border-radius:8px;"><label style="color:var(--danger);">Crew Alert</label><p class="text-sm text-muted mb-2">Send WhatsApp message to all crew about maintenance.</p><button class="btn btn-sm btn-danger" onclick="sendMaintenanceWA()"><i class="ri-whatsapp-line"></i> Send Alert to Crew</button></div></div>` : ''}
                    <div class="config-section"><div class="config-header flex justify-between"><span>Dynamic Pricing Override</span>${canEdit ? `<span class="badge badge-user">Finance Access</span>` : ''}</div><p class="text-muted text-sm mb-4">Base prices for different modules (Syncs with Main Site).</p><div class="price-grid"><div><label>HTML Package Price</label><div class="flex gap-2"><input id="price-html" type="number" ${canEdit?'':'readonly'}>${canEdit?'<button class="btn btn-primary" onclick="savePrice(\'html\', \'price-html\')">Save</button>':''}</div></div><div><label>Frontend Package Price</label><div class="flex gap-2"><input id="price-fe" type="number" ${canEdit?'':'readonly'}>${canEdit?'<button class="btn btn-primary" onclick="savePrice(\'frontend\', \'price-fe\')">Save</button>':''}</div></div><div><label>AI/Data Price (Base)</label><div class="flex gap-2"><input id="price-ai" type="number" ${canEdit?'':'readonly'}>${canEdit?'<button class="btn btn-primary" onclick="savePrice(\'ai\', \'price-ai\')">Save</button>':''}</div></div></div>
                    <div class="config-section"><div class="config-header flex justify-between"><span>Payment Gateways</span>${canEdit ? `<button class="btn btn-sm btn-primary" onclick="addGateway()"><i class="ri-add-line"></i> Add Gateway</button>` : ''}</div><div id="gateway-list" class="flex flex-col gap-4"></div></div>
                </div>

                <div id="tab-content-email" class="tab-content">
                    <div class="config-section">
                        <div class="config-header flex justify-between">
                            <span>SMTP Configuration</span>
                            <span class="badge badge-admin">Requires Manage Email Permission</span>
                        </div>
                        <p class="text-muted text-sm mb-4">Configure SMTP settings for sending system emails (Notifications, Invoices, Password Resets). If left blank, Firebase default settings may apply.</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div><label>SMTP Host</label><input type="text" id="smtp-host" placeholder="smtp.gmail.com" ${canManageEmail?'':'readonly'}></div>
                            <div><label>Port</label><input type="number" id="smtp-port" placeholder="587" ${canManageEmail?'':'readonly'}></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div><label>Username / Email</label><input type="text" id="smtp-user" placeholder="noreply@ddnet.my" ${canManageEmail?'':'readonly'}></div>
                            <div><label>Password / App Key</label><input type="password" id="smtp-pass" placeholder="****************" ${canManageEmail?'':'readonly'}></div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>From Name</label><input type="text" id="smtp-from-name" value="DDNetwork System" ${canManageEmail?'':'readonly'}>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label>From Email</label><input type="text" id="smtp-from-email" value="noreply@ddnet.my" ${canManageEmail?'':'readonly'}>
                        </div>
                        
                        ${canManageEmail ? `<button class="btn btn-primary" onclick="saveSmtpConfig()"><i class="ri-save-line"></i> Save SMTP Settings</button>` : '<div class="p-2 bg-yellow-50 text-yellow-700 text-sm rounded border border-yellow-200">You do not have permission to modify email settings.</div>'}
                    </div>
                </div>
            `;
            if(isSA) {
                const snap = await db.collection("config").doc("site_settings").get();
                if(snap.exists) {
                    const d = snap.data();
                    if(d.maintenance_active) document.getElementById('maint-toggle').checked = true;
                    if(d.maintenance_message) document.getElementById('maint-msg').value = d.maintenance_message;
                    if(d.disabled_menus) {
                        d.disabled_menus.forEach(path => { const cb = document.querySelector(`.menu-disable-check[value="${path}"]`); if(cb) cb.checked = true; });
                    }
                }
            }
            db.collection("config").doc("site_settings").get().then(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    if(d.prices) {
                        if(d.prices.html) document.getElementById('price-html').value = d.prices.html;
                        if(d.prices.frontend) document.getElementById('price-fe').value = d.prices.frontend;
                        if(d.prices.ai) document.getElementById('price-ai').value = d.prices.ai;
                    }
                    // Load SMTP
                    if(d.smtp_config && canManageEmail) {
                        if(document.getElementById('smtp-host')) document.getElementById('smtp-host').value = d.smtp_config.host || '';
                        if(document.getElementById('smtp-port')) document.getElementById('smtp-port').value = d.smtp_config.port || 587;
                        if(document.getElementById('smtp-user')) document.getElementById('smtp-user').value = d.smtp_config.user || '';
                        if(document.getElementById('smtp-from-name')) document.getElementById('smtp-from-name').value = d.smtp_config.from_name || 'DDNetwork System';
                        if(document.getElementById('smtp-from-email')) document.getElementById('smtp-from-email').value = d.smtp_config.from_email || 'noreply@ddnet.my';
                    }
                }
            });
            db.collection("payment_methods").onSnapshot(snap => {
                const list = document.getElementById('gateway-list');
                if(!list) return;
                list.innerHTML = '';
                snap.forEach(doc => {
                    const gw = doc.data();
                    list.innerHTML += `<div class="gateway-card"><div style="display:flex; justify-content:space-between; align-items:center;"><strong style="color:var(--primary)">${gw.name}</strong><span class="badge ${gw.active?'badge-success':'badge-danger'}" style="${gw.active?'background:#ecfdf5;color:#059669':'background:#fef2f2;color:#dc2626'}">${gw.active?'Active':'Inactive'}</span></div><div class="text-sm text-muted" style="word-break:break-all;">${gw.link || 'No Link'}</div>${canEdit ? `<div style="display:flex; gap:8px; margin-top:8px;"><button class="btn btn-sm btn-secondary" onclick="editGateway('${doc.id}')"><i class="ri-pencil-line"></i></button><button class="btn btn-sm btn-secondary" onclick="toggleGatewayStatus('${doc.id}')"><i class="ri-refresh-line"></i></button><button class="btn btn-sm btn-danger" onclick="deleteGateway('${doc.id}')"><i class="ri-delete-bin-line"></i></button></div>` : ''}</div>`;
                });
            });
        }

        function switchConfigTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`tab-content-${tabName}`).classList.add('active');
        }

        async function saveSmtpConfig() {
            if(!hasPermission(PERMISSION_KEYS.MANAGE_EMAIL)) return showToast("Access Denied", "error");
            const config = {
                host: document.getElementById('smtp-host').value,
                port: parseInt(document.getElementById('smtp-port').value) || 587,
                user: document.getElementById('smtp-user').value,
                pass: document.getElementById('smtp-pass').value,
                from_name: document.getElementById('smtp-from-name').value,
                from_email: document.getElementById('smtp-from-email').value
            };
            try {
                await db.collection("config").doc("site_settings").update({ smtp_config: config });
                showToast("SMTP Configuration Saved", "success");
                logActivity("Updated SMTP Configuration");
            } catch(e) {
                showToast("Error saving config: " + e.message, "error");
            }
        }

        async function toggleMaintenance() { if(!isSuperAdmin()) return showToast("Access Denied", "error"); const isActive = document.getElementById('maint-toggle').checked; const data = { maintenance_active: isActive }; await db.collection("config").doc("site_settings").update(data); showToast(`Maintenance Mode ${isActive ? 'Enabled' : 'Disabled'}`, isActive?'warning':'success'); logActivity(`Toggled maintenance mode to ${isActive}`); }
        async function saveMaintMsg() { if(!isSuperAdmin()) return showToast("Access Denied", "error"); const data = { maintenance_message: document.getElementById('maint-msg').value }; await db.collection("config").doc("site_settings").update(data); showToast("Message Saved", "success"); }
        async function saveDisabledMenus() {
            if(!isSuperAdmin()) return showToast("Access Denied", "error");
            const checks = document.querySelectorAll('.menu-disable-check:checked');
            const disabledList = Array.from(checks).map(cb => cb.value);
            await db.collection("config").doc("site_settings").update({ disabled_menus: disabledList });
            showToast("Menu restrictions updated", "success");
        }
        async function sendMaintenanceWA() {
            if(!isSuperAdmin()) return;
            const msg = `Message from IT Support Team:\n\nWe are currently addressing reported portal issues and working to implement the necessary fixes.\n\n${currentMaintenanceConfig.message || 'portal under maintenance'}.\n\n> [Auto-generate from Dev/IT System]`;
            const snap = await db.collection("users").where("role", "in", ["admin", "mid_admin", "crew"]).get();
            if(snap.empty) return showToast("No crew found", "error");
            let content = `<p class="mb-4">Click button below to open WhatsApp with pre-filled message for each crew member.</p><div style="max-height:300px; overflow-y:auto; display:grid; grid-template-columns: 1fr; gap:10px;">`;
            snap.forEach(doc => {
                const u = doc.data();
                if(u.phone) {
                    const cleanPhone = formatWAPhone(u.phone);
                    if (cleanPhone) {
                        const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
                        content += `<div class="flex justify-between items-center p-2 border rounded" style="background:white;"><span><strong>${u.name}</strong> <small class="text-muted">(${u.jobTitle})</small></span><a href="${url}" target="_blank" class="btn btn-sm btn-success"><i class="ri-whatsapp-line"></i> Send</a></div>`;
                    }
                }
            });
            content += `</div>`;
            showModal("Send Maintenance Alert", content, `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`);
        }
        async function savePrice(key, elemId) { if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return showToast("Access Denied", "error"); const theVal = parseFloat(document.getElementById(elemId).value); if(!theVal) return showToast("Invalid price", "error"); const data = { [`prices.${key}`]:theVal }; await db.collection("config").doc("site_settings").update(data); showToast("Price Updated", "success"); }
        function addGateway() { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return showToast("Access Denied", "error"); 
            showModal("Add Payment Gateway", `<label>Gateway Name</label><input id="gw-name" class="mb-4"><label>Payment Link / URL</label><input id="gw-link" class="mb-4">`, `<button class="btn btn-primary" onclick="saveNewGateway()">Add</button>`); 
        }
        async function saveNewGateway() { 
            const name = document.getElementById('gw-name').value; 
            const link = document.getElementById('gw-link').value; 
            const data = { name, link, active: true }; 
            await db.collection("payment_methods").add(data); 
            closeModal(); 
            showToast("Gateway Added", "success"); 
            logActivity(`Added payment gateway: ${name}`); 
        }
        function editGateway(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return showToast("Access Denied", "error"); 
            db.collection("payment_methods").doc(docId).get().then(doc => { 
                const gw = doc.data(); 
                showModal("Edit Payment Gateway", `<label>Gateway Name</label><input id="e-gw-name" value="${gw.name}" class="mb-4"><label>Payment Link / URL</label><input id="e-gw-link" value="${gw.link}" class="mb-4">`, `<button class="btn btn-primary" onclick="saveEditedGateway('${docId}')">Save</button>`); 
            }); 
        }
        async function saveEditedGateway(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return showToast("Access Denied", "error"); 
            const name = document.getElementById('e-gw-name').value; 
            const link = document.getElementById('e-gw-link').value; 
            const data = { name, link }; 
            await db.collection("payment_methods").doc(docId).update(data); 
            closeModal(); 
            renderConfig(); 
            showToast("Gateway Updated", "success"); 
            logActivity(`Edited payment gateway: ${name}`); 
        }
        async function toggleGatewayStatus(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return showToast("Access Denied", "error"); 
            const docRef = await db.collection("payment_methods").doc(docId).get(); 
            const currentStatus = docRef.data().active; 
            const data = { active: !currentStatus }; 
            await db.collection("payment_methods").doc(docId).update(data); 
            renderConfig(); 
        }
        async function deleteGateway(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_CONFIG)) return showToast("Access Denied", "error"); 
            if(!confirm("Delete gateway?")) return; 
            await db.collection("payment_methods").doc(docId).delete(); 
            renderConfig(); 
        }

        // --- 9. PORTFOLIO ---
        function renderPortfolio() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:800;">Client Portfolio</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="openAddPortfolioModal()"><i class="ri-add-line"></i> Add Project</button>` : ''}
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>Projects (clients_portfolio)</h3></div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Thumbnail</th><th>Project Name</th><th>Website Link</th><th>Status</th><th>Actions</th></tr></thead><tbody id="portfolio-tbody"><tr><td colspan="5" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="portfolio-tbody-pagination"></div>
                    </div>
                </div>
            `;
            db.collection("clients_portfolio").orderBy("timestamp", "desc").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('portfolio-tbody', data);
            });
            window.customTableRenderers['portfolio-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="5" class="text-center text-muted">No portfolio projects found.</td></tr>';
                return data.map(p => {
                    const statusBadge = p.status ? `<span class="badge" style="background:#ecfdf5; color:var(--success); border:1px solid #a7f3d0">Active</span>` : `<span class="badge" style="background:#f3f4f6; color:var(--text-muted); border:1px solid var(--border-glass)">Inactive</span>`;
                    let actions = '';
                    if (canEdit) actions = `<button class="btn btn-sm btn-secondary" onclick="editPortfolio('${p.id}')"><i class="ri-pencil-line"></i></button><button class="btn ${p.status ? 'btn-danger' : 'btn-success'}" onclick="togglePortfolioStatus('${p.id}', ${!p.status})"><i class="${p.status ? 'ri-eye-off-line' : 'ri-eye-line'}"></i></button><button class="btn btn-sm btn-danger" onclick="deletePortfolio('${p.id}')"><i class="ri-delete-bin-line"></i></button>`;
                    return `<tr><td><img src="${p.img}" alt="thumb" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-glass);" onerror="this.src='https://placehold.co/50?text=No+Img'"></td><td><strong>${p.name}</strong></td><td><a href="${p.link}" target="_blank" class="btn btn-sm btn-secondary"><i class="ri-external-link-line"></i> Visit</a></td><td>${statusBadge}</td><td>${actions}</td></tr>`;
                }).join('');
            };
        }
        function openAddPortfolioModal() { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return showToast("Access Denied", "error");
            const initialId = generateDocIdFromName('');
            showModal("Add New Project", `<div class="mb-4"><label>Project Name</label><input type="text" id="p-name" placeholder="e.g. Clinic Azam" oninput="updateDocIdPreview()"><small style="color:var(--text-faint)">ID will be generated from name</small></div><div class="mb-4"><label>Generated ID (Auto)</label><input type="text" id="p-doc-id" readonly value="${initialId}" class="font-mono" style="color:var(--primary); background:#f9fafb;"></div><div class="mb-4"><label>Image URL</label><input type="text" id="p-img" placeholder="https://..."><small style="color:var(--text-faint)">Direct link to image file.</small></div><div class="mb-4"><label>Website Link</label><input type="text" id="p-link" placeholder="https://..."></div><div class="flex items-center gap-4"><label class="toggle-switch"><input type="checkbox" id="p-status" checked><span class="slider"></span></label><span style="font-size:0.9rem; color:var(--text-main);">Visible on Main Site</span></div>`, `<button class="btn btn-primary" onclick="saveNewPortfolio()">Create Project</button>`); 
        }
        async function saveNewPortfolio() { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return showToast("Access Denied", "error");
            const name = document.getElementById('p-name').value; const img = document.getElementById('p-img').value; const link = document.getElementById('p-link').value; const status = document.getElementById('p-status').checked; const customId = document.getElementById('p-doc-id').value;
            if(!name || !img || !link) return showToast("Please fill in all fields.", "error");
            const data = { name, img, link, status, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
            db.collection("clients_portfolio").doc(customId).set(data).then(() => { closeModal(); showToast("Project added successfully", "success"); logActivity(`Added portfolio project: ${name} (ID: ${customId})`); }).catch(err => { showToast("Error: " + err.message, "error"); }); 
        }
        function editPortfolio(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return showToast("Access Denied", "error");
            db.collection("clients_portfolio").doc(docId).get().then(doc => {
                const p = doc.data();
                showModal("Edit Project", `<div class="mb-4"><label>Project Name</label><input type="text" id="e-p-name" value="${p.name}"><small style="color:var(--text-faint)">Editing name does not change ID</small></div><div class="mb-4"><label>Image URL</label><input type="text" id="e-p-img" value="${p.img}"></div><div class="mb-4"><label>Website Link</label><input type="text" id="e-p-link" value="${p.link}"></div><div class="flex items-center gap-4"><label class="toggle-switch"><input type="checkbox" id="e-p-status" ${p.status ? 'checked' : ''}><span class="slider"></span></label><span style="font-size:0.9rem; color:var(--text-main);">Visible on Main Site</span></div>`, `<button class="btn btn-primary" onclick="updatePortfolio('${docId}')">Save Changes</button>`); 
            });
        }
        async function updatePortfolio(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return showToast("Access Denied", "error");
            const updates = { name: document.getElementById('e-p-name').value, img: document.getElementById('e-p-img').value, link: document.getElementById('e-p-link').value, status: document.getElementById('e-p-status').checked };
            db.collection("clients_portfolio").doc(docId).update(updates).then(() => { closeModal(); showToast("Project updated", "success"); logActivity(`Updated portfolio project: ${updates.name}`); }).catch(err => { showToast("Error updating: " + err.message, "error"); }); 
        }
        function togglePortfolioStatus(docId, newStatus) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return showToast("Access Denied", "error");
            const data = { status: newStatus }; const action = newStatus ? "Activated" : "Deactivated";
            db.collection("clients_portfolio").doc(docId).update(data).then(() => { showToast(`Project ${action}`, "info"); logActivity(`${action} portfolio project`); });
        }
        function deletePortfolio(docId) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PORTFOLIO)) return showToast("Access Denied", "error");
            if(!confirm("Are you sure you want to delete this project?")) return; 
            db.collection("clients_portfolio").doc(docId).delete().then(() => { showToast("Project deleted", "success"); logActivity(`Deleted portfolio project`); }).catch(err => { showToast("Error deleting: " + err.message, "error"); }); 
        }

        // --- 10. CUSTOMER REQUESTS ---
        function renderRequests() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canDelete = checkAccessOrActionAllowed(PERMISSION_KEYS.DELETE_REQUESTS);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:800;">Customer Requests</h2>
                    <input type="text" id="filter-req-search" placeholder="Search Client, Company..." style="width:250px;" onkeyup="TableEngine.setFilter('req-tbody', 'search', this.value)">
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table><thead><tr><th>Date</th><th>Client</th><th>Company</th><th>Type</th><th>Source</th><th>Summary</th><th>Status</th><th>Action</th></tr></thead><tbody id="req-tbody"><tr><td colspan="8" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="req-tbody-pagination"></div>
                    </div>
                </div>
            `;
            db.collection("customer_requests").orderBy("timestamp", "desc").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('req-tbody', data);
            });
            window.customTableRenderers['req-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="8" class="text-center text-muted">No requests found</td></tr>';
                return data.map(d => {
                    const type = d.type || 'General Request';
                    const source = d.source || '-';
                    const company = d.company || '-';
                    const summaryText = d.details ? d.details.substring(0, 40) + (d.details.length > 40 ? '...' : '') : '-';
                    const statusColor = d.status === 'Completed' ? 'var(--success)' : 'var(--warning)';
                    let badgeClass = 'badge-user';
                    if(type.includes('Website')) badgeClass = 'badge-website';
                    else if(type.includes('Content')) badgeClass = 'badge-content';
                    else if(type.includes('Upgrade')) badgeClass = 'badge-upgrade';
                    
                    let actions = `<button class="btn btn-sm btn-secondary" onclick="viewRequestDetails('${d.id}')">View</button>`;
                    if (canDelete) actions += `<button class="btn btn-sm btn-danger" onclick="deleteItem('request','${d.id}')"><i class="ri-delete-bin-line"></i></button>`;
                    
                    return `<tr>
                        <td style="white-space:nowrap;">${formatDateTime(d.timestamp)}</td>
                        <td><strong>${d.name}</strong><br><small style="color:var(--text-faint)">${d.phone || ''}</small></td>
                        <td>${company}</td>
                        <td><span class="badge ${badgeClass}">${type}</span></td>
                        <td><small>${source}</small></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${d.details}">${summaryText}</td>
                        <td><span class="badge" style="background:${statusColor}15; color:${statusColor}; border:1px solid ${statusColor}25">${d.status}</span></td>
                        <td>${actions}</td>
                    </tr>`;
                }).join('');
            };
        }
        function viewRequestDetails(id) {
            db.collection("customer_requests").doc(id).get().then(doc => {
                const d = doc.data();
                const modalBody = `
                    <div class="req-grid">
                        <div class="req-field req-full-width"><label>Company Name</label><div class="req-value font-bold">${d.company || '-'}</div></div>
                        <div class="req-field"><label>Request Type</label><div class="req-value"><span class="badge badge-website">${d.type || 'General'}</span></div></div>
                        <div class="req-field"><label>Source</label><div class="req-value">${d.source || '-'}</div></div>
                        <div class="req-field"><label>Client Name</label><div class="req-value">${d.name}</div></div>
                        <div class="req-field"><label>Email</label><div class="req-value"><a href="mailto:${d.email}" style="color:var(--primary);">${d.email}</a></div></div>
                        <div class="req-field"><label>Phone</label><div class="req-value">${d.phone || '-'}</div></div>
                        <div class="req-field req-full-width"><label>References / Links</label><div class="req-value">${d.references ? `<a href="${d.references}" target="_blank" class="btn btn-sm btn-info" style="display:inline-flex; align-items:center; gap:5px; margin-right:10px;"><i class="ri-external-link-line"></i> ${d.references}</a>` : '<span class="text-muted">None provided</span>'}</div></div>
                        <div class="req-field req-full-width"><label>Details / Message</label><textarea readonly rows="5" style="background:#f9fafb; font-family:var(--font-main);">${d.details || 'No details provided.'}</textarea></div>
                        <div class="req-field req-full-width" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border-glass);"><label>Update Status</label><select id="req-status-select"><option value="Pending" ${d.status==='Pending'?'selected':''}>Pending</option><option value="In Progress" ${d.status==='In Progress'?'selected':''}>In Progress</option><option value="Completed" ${d.status==='Completed'?'selected':''}>Completed</option><option value="Rejected" ${d.status==='Rejected'?'selected':''}>Rejected</option></select></div>
                    </div>
                `;
                showModal(`Request Details (${d.type || 'General'})`, modalBody, `<button class="btn btn-primary" onclick="updateRequestStatus('${id}', null, true)">Save Status</button>`);
            });
        }
        function updateRequestStatus(id, newStatus = null, fromModal = false) {
            const statusToSet = newStatus || document.getElementById('req-status-select').value;
            const data = { status: statusToSet };
            db.collection("customer_requests").doc(id).update(data).then(() => { if(fromModal) closeModal(); showToast("Request Status Updated", "success"); logActivity(`Updated request status to ${statusToSet}`); }).catch(err => { showToast("Error updating: " + err.message, "error"); });
        }
        function deleteItem(collection, id) {
            if(!hasPermission(PERMISSION_KEYS.DELETE_REQUESTS) && !hasPermission(PERMISSION_KEYS.DELETE_SUPPORT)) return showToast("Access Denied.", "error");
            if(!confirm("Delete this item permanently?")) return;
            db.collection(collection).doc(id).delete().then(() => { showToast("Item deleted", "success"); logActivity(`Deleted item from ${collection}`); });
        }

        // --- 11. PUBLIC PROMO CODES ---
        function renderPublicPromos() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEdit = checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS);
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 style="font-size:1.25rem; font-weight:800;">Public Promo Codes</h2>
                    ${canEdit ? `<button class="btn btn-primary" onclick="addPublicPromo()"><i class="ri-add-line"></i> Add Code</button>` : ''}
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>Active Codes (config/promo_codes)</h3></div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Code</th><th>Discount (%)</th><th>Action</th></tr></thead><tbody id="public-promos-tbody"><tr><td colspan="3" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="public-promos-tbody-pagination"></div>
                    </div>
                </div>
            `;
            db.collection("promo_codes").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('public-promos-tbody', data);
            });
            window.customTableRenderers['public-promos-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="3" class="text-center text-muted">No public promo codes found.</td></tr>';
                return data.map(d => {
                    const code = d.id; const discountPercent = (d.data.discount * 100) + '%'; let actions = '';
                    if (canEdit) actions = `<button class="btn btn-sm btn-danger" onclick="deletePublicPromo('${code}')"><i class="ri-delete-bin-line"></i> Delete</button>`;
                    return `<tr><td class="font-mono" style="color:var(--warning); font-weight:700;">${code}</td><td><span class="badge" style="background:#ecfdf5; color:var(--success); border:1px solid #a7f3d0">${discountPercent}</span></td><td>${actions}</td></tr>`;
                }).join('');
            };
        }
        function addPublicPromo() { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS)) return showToast("Access Denied", "error");
            showModal("Add Public Promo Code", `<div class="mb-4"><label>Promo Code (ID)</label><input type="text" id="pub-promo-code" placeholder="e.g. WELCOME10" style="text-transform:uppercase;"><small class="text-muted">Users will enter this exact code.</small></div><div class="mb-4"><label>Discount Percentage</label><input type="number" id="pub-promo-discount" placeholder="0.1 for 10%"><small class="text-muted">Decimal (e.g., 0.10 = 10%)</small></div>`, `<button class="btn btn-primary" onclick="savePublicPromo()">Create Code</button>`); 
        }
        async function savePublicPromo() { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS)) return showToast("Access Denied", "error");
            const code = document.getElementById('pub-promo-code').value.trim().toUpperCase(); const discount = parseFloat(document.getElementById('pub-promo-discount').value);
            if(!code || isNaN(discount)) return showToast("Invalid Input", "error");
            const data = { discount: discount };
            try { await db.collection("promo_codes").doc(code).set(data); closeModal(); showToast("Promo Code Created", "success"); logActivity(`Created public promo code: ${code}`); } catch(e) { showToast("Error: " + e.message, "error"); } 
        }
        async function deletePublicPromo(code) { 
            if(!checkAccessOrActionAllowed(PERMISSION_KEYS.EDIT_PROMOS)) return showToast("Access Denied", "error");
            if(!confirm(`Delete promo code ${code}?`)) return; 
            try { await db.collection("promo_codes").doc(code).delete(); showToast("Promo Code Deleted", "success"); logActivity(`Deleted public promo code: ${code}`); } catch(e) { showToast("Error deleting: " + e.message, "error"); } 
        }

        // --- 12. FINANCE OVERVIEW ---
        function renderFinanceOverview() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canManageFinance = canAccessFinanceTools(); const isMyView = !canManageFinance; 
            if(!canManageFinance && (!currentUser || !currentUser.uid)) {
                main.innerHTML = `<div class="access-denied-container"><div class="access-denied-title">Access Denied</div><div class="access-denied-desc">You are not logged in or do not have access.</div></div>`;
                return;
            }
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h2 style="font-size:1.5rem; font-weight:800;">Finance Department</h2></div>
                <div class="tabs-nav"><button class="tab-btn active" onclick="switchFinanceTab('commission')" id="tab-btn-commission">Commission Overview</button>${canManageFinance ? `<button class="tab-btn" onclick="switchFinanceTab('tools')" id="tab-btn-tools">Finance Tools</button>` : ''}</div>
                <div id="tab-content-commission" class="tab-content active">
                    <div class="stats-grid"><div class="stat-card"><div class="stat-icon" style="color:var(--success); background:#ecfdf5"><i class="ri-money-dollar-circle-line"></i></div><div class="stat-info"><div class="stat-val" id="comm-total-earnings">RM 0.00</div><div class="stat-label">${isMyView ? 'My Total Earnings' : 'Total Payouts'}</div></div></div></div>
                    <div class="table-container">
                        <div class="table-header" style="flex-direction:column; align-items:stretch; gap:1rem;"><h3>${isMyView ? 'My Commissions' : 'Commission Overview'}</h3>
                            <div style="background:#f9fafb; padding:1rem; border-radius:8px; border:1px solid var(--border-glass); display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px;">
                                <input type="text" id="filter-finance-search" placeholder="Search Ref / Name..." onkeyup="TableEngine.setFilter('comm-tbody', 'search', this.value)">
                                <select id="filter-finance-status" onchange="TableEngine.setFilter('comm-tbody', 'status', this.value)"><option value="">All Status</option><option value="paid">Paid</option><option value="unpaid">Unpaid</option></select>
                                <input type="date" id="filter-finance-start" placeholder="Start Date" onchange="TableEngine.setFilter('comm-tbody', 'startDate', this.value)">
                                <input type="date" id="filter-finance-end" placeholder="End Date" onchange="TableEngine.setFilter('comm-tbody', 'endDate', this.value)">
                                <input type="text" id="filter-finance-amount" placeholder="Min Amount (RM)" onkeyup="TableEngine.setFilter('comm-tbody', 'minAmount', this.value)">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table><thead><tr><th>Reference</th><th>Date</th>${!isMyView ? '<th>Crew Member</th>' : ''}<th>Status</th><th>Commission Amount</th><th>Paid Date</th><th>Paid By</th>${!isMyView ? '<th>Actions</th>' : ''}</tr></thead><tbody id="comm-tbody"><tr><td colspan="7" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                            <div id="comm-tbody-pagination"></div>
                        </div>
                    </div>
                </div>
                <div id="tab-content-tools" class="tab-content">
                    <div class="config-section"><div class="config-header flex justify-between"><h3>Global Commission Configuration (By Job Title)</h3><span class="badge badge-user">Finance Access</span></div><p class="text-muted text-sm mb-4">Set default percentage of Order Value assigned to each specific Job Title. SuperAdmins can override individual rates via Crew Management.</p>
                    <div id="job-rates-container" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:1rem;"></div>
                    <div class="mt-4 text-center">${canManageFinance ? `<button class="btn btn-primary" onclick="saveJobRates()">Update Global Defaults</button>` : ''}</div>
                </div>
            `;
            if(document.getElementById('tab-content-tools').classList.contains('active') && !isMyView) populateFinanceRatesUI();
            updateCommissionView(isMyView);
        }
        
        function populateFinanceRatesUI() {
            const container = document.getElementById('job-rates-container');
            if(!container) return;
            let html = '';
            for (const [job, rate] of Object.entries(DEFAULT_COMMISSION_RATES)) {
                const pct = (rate * 100).toFixed(1);
                html += `
                    <div style="background:white; border:1px solid var(--border-glass); padding:10px; border-radius:8px;">
                        <label style="font-size:0.8rem; font-weight:600; color:var(--text-muted); display:block; margin-bottom:4px;">${job}</label>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="number" step="0.1" id="rate-${job.replace(/\s+/g, '-')}" value="${pct}" style="flex:1;" ${!canAccessFinanceTools() ? 'readonly' : ''}>
                            <span style="font-size:0.8rem;">%</span>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        async function saveJobRates() {
            if(!canAccessFinanceTools()) return showToast("Access Denied", "error");
            const newRates = {};
            for(const job of Object.keys(DEFAULT_COMMISSION_RATES)) {
                const inputId = `rate-${job.replace(/\s+/g, '-')}`;
                const el = document.getElementById(inputId);
                if(el) {
                    const val = parseFloat(el.value) || 0;
                    newRates[job] = val / 100;
                }
            }
            DEFAULT_COMMISSION_RATES = newRates; 
            db.collection("config").doc("site_settings").update({ commission_rates: newRates }).then(() => { showToast("Global Commission Defaults Updated", "success"); logActivity(`Updated global commission rates`); }).catch(e => { console.error(e); showToast("Error saving rates", "error"); });
        }

        function switchFinanceTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-btn-${tabName}`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`tab-content-${tabName}`).classList.add('active');
            if(tabName === 'tools') { const isMyView = !canAccessFinanceTools(); if(!isMyView) populateFinanceRatesUI(); } else { updateCommissionView(!canAccessFinanceTools()); }
        }
        async function updateCommissionView(isMyView) {
            const tbody = document.getElementById('comm-tbody'); const totalEl = document.getElementById('comm-total-earnings');
            if(!tbody || !totalEl) return; 
            if (!currentUser || !currentUser.uid) { tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Authentication Error. Please login.</td></tr>`; return; }
            let query = db.collection("commission_overview").orderBy("orderDate", "desc");
            if (isMyView) query = query.where("crewId", "==", currentUser.uid);
            try {
                const snap = await query.get();
                if (snap.empty) { rawFinanceData = []; tbody.innerHTML = `<tr><td colspan="${isMyView ? 6 : 8}" class="text-center text-muted">No commissions found.</td></tr>`; totalEl.innerText = 'RM 0.00'; return; }
                rawFinanceData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.customTableRenderers['comm-tbody'] = function(data) {
                    const minAmt = document.getElementById('filter-finance-amount') ? parseFloat(document.getElementById('filter-finance-amount').value) : 0;
                    let filteredData = data;
                    if(minAmt > 0) filteredData = data.filter(d => d.amount >= minAmt);
                    if(filteredData.length === 0) return `<tr><td colspan="${isMyView ? 6 : 8}" class="text-center text-muted">No matching records found.</td></tr>`;
                    const sum = filteredData.reduce((acc, curr) => acc + (curr.amount||0), 0);
                    document.getElementById('comm-total-earnings').innerText = `RM ${sum.toFixed(2)}`;
                    return filteredData.map(d => {
                        const status = d.status || 'unpaid'; const isPaid = status === 'paid';
                        const statusBadge = isPaid ? `<span class="status-badge status-paid">Paid</span>` : `<span class="status-badge status-unpaid">Unpaid</span>`;
                        const orderDate = d.orderDate ? d.orderDate.toDate() : new Date();
                        const orderRef = d.orderId ? d.orderId.substring(0,6).toUpperCase() : 'N/A';
                        const paidDateDisplay = d.paidAt ? formatDateTime(d.paidAt) : '-';
                        const paidByDisplay = d.paidBy ? d.paidBy : '-';
                        let actionsHTML = '';
                        if(!isMyView && canAccessFinanceTools()) {
                            actionsHTML = `<button class="btn btn-sm ${isPaid?'btn-secondary':'btn-success'}" onclick="markCommissionPaid('${d.id}', '${d.crewId}')" title="${isPaid?'Mark Unpaid':'Mark Paid'}"><i class="${isPaid?'ri-arrow-go-back-line':'ri-checkbox-circle-line'}"></i> ${isPaid?'Undo':'Pay'}</button> <button class="btn btn-sm btn-info" onclick="waCrewCommission('${d.crewId}', 'RM ${d.amount.toFixed(2)}')"><i class="ri-whatsapp-line"></i></button>`;
                        }
                        const crewMemberCol = !isMyView ? `<td style="font-weight:600;">${d.crewName}</td>` : '';
                        const actionColHTML = (!isMyView) ? `<td>${actionsHTML}</td>` : '';
                        return `<tr><td class="font-mono text-sm">${orderRef}</td><td style="font-size:0.8rem;">${formatDateTime(orderDate)}</td>${crewMemberCol}<td>${statusBadge}</td><td style="font-weight:700;">RM ${d.amount.toFixed(2)}</td><td style="font-size:0.8rem;">${paidDateDisplay}</td><td style="font-size:0.8rem;">${paidByDisplay}</td>${actionColHTML}</tr>`;
                    }).join('');
                };
                TableEngine.updateData('comm-tbody', rawFinanceData);
            } catch (error) {
                console.error("Error loading commissions:", error);
                let errorMsg = "Error loading data."; if(error.code === 'permission-denied') errorMsg = "Permission Denied."; if(error.code === 'failed-precondition') errorMsg = "Database Index Missing.";
                tbody.innerHTML = `<tr><td colspan="${isMyView ? 6 : 8}" class="text-center text-danger">${errorMsg}</td></tr>`;
                showToast(errorMsg, "error");
            }
        }
        async function markCommissionPaid(docId, crewId) {
            if(!canAccessFinanceTools()) return showToast("Access Denied", "error");
            const docRef = db.collection("commission_overview").doc(docId);
            const docSnap = await docRef.get();
            if(!docSnap.exists) return;
            const currentStatus = docSnap.data().status || 'unpaid';
            const newStatus = currentStatus === 'unpaid' ? 'paid' : 'unpaid';
            const paidData = newStatus === 'paid' ? { status: newStatus, paidAt: firebase.firestore.FieldValue.serverTimestamp(), paidBy: userData.name } : { status: newStatus, paidAt: null, paidBy: null };
            try {
                await docRef.update(paidData);
                showToast(`Marked as ${newStatus}`, "success");
                logActivity(`Updated commission status to ${newStatus} for ${crewId}`);
                const isMyView = !canAccessFinanceTools();
                const snap = await db.collection("commission_overview").orderBy("orderDate", "desc").get();
                rawFinanceData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(isMyView) rawFinanceData = rawFinanceData.filter(d => d.crewId === currentUser.uid);
                TableEngine.updateData('comm-tbody', rawFinanceData);
            } catch(e) { showToast("Error updating status", "error"); }
        }
        async function waCrewCommission(crewId, amount) {
            if(!canAccessFinanceTools()) return showToast("Access Denied", "error");
            try {
                const crewSnap = await db.collection("users").doc(crewId).get();
                if(!crewSnap.exists) return showToast("Crew not found", "error");
                const crewData = crewSnap.data(); const phone = crewData.phone;
                const cleanPhone = formatWAPhone(phone);
                if(!cleanPhone) return showToast("Crew has invalid phone number", "error");
                const msg = `Hi ${crewData.name}, from DDNet-Finance.\n\nYour commission of *${amount}* has been processed.\n\nPlease check your bank account.\n\n\> [Auto-generated from DDNet System]`;
                const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
                const win = window.open(url, '_blank');
                if (!win || win.closed || typeof win.closed == 'undefined') window.location.href = url;
            } catch(e) { console.error(e); showToast("Error fetching crew details", "error"); }
        }

        // --- 13. APPROVAL TOOLS ---
        function renderApprovals() {
            setPageLoading(true);
            const main = document.getElementById('main');
            if(!main) return;
            if(!hasPermission(PERMISSION_KEYS.APPROVE_ACTIONS)) {
                main.innerHTML = `<div class="access-denied-container"><div class="access-denied-title">Access Denied</div><div class="access-denied-desc">You do not have permission to view this page.</div></div>`;
                return;
            }
            main.innerHTML = `
                <div class="flex justify-between items-center mb-4"><h2 style="font-size:1.5rem; font-weight:800; color: var(--warning);"><i class="ri-shield-check-line"></i> Approval Tools</h2></div>
                <div class="stats-grid"><div class="stat-card"><div class="stat-icon" style="color:var(--warning); background:#fffbeb"><i class="ri-time-line"></i></div><div class="stat-info"><div class="stat-val" id="count-pending">0</div><div class="stat-label">Pending Requests</div></div></div></div>
                <div class="table-container">
                    <div class="table-header"><h3>Pending Requests</h3></div>
                    <div class="table-responsive">
                        <table><thead><tr><th>Time</th><th>Requester</th><th>Action Requested</th><th>Target</th><th>Changes</th><th>Actions</th></tr></thead><tbody id="approvals-tbody"><tr><td colspan="6" class="text-center"><div class="loading-spinner"></div></td></tr></tbody></table>
                        <div id="approvals-tbody-pagination"></div>
                    </div>
                </div>
            `;
            db.collection("pending_edits").orderBy("timestamp", "desc").onSnapshot(snap => {
                const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                TableEngine.updateData('approvals-tbody', data);
                const counter = document.getElementById('count-pending'); if(counter) counter.innerText = data.filter(d=>d.status==='Pending').length;
            });
            window.customTableRenderers['approvals-tbody'] = function(data) {
                if(data.length === 0) return '<tr><td colspan="6" class="text-center text-muted">No pending requests</td></tr>';
                return data.map(r => {
                    const isPending = r.status === 'Pending'; const keyName = r.permissionKey ? r.permissionKey.replace('edit_', '').replace('delete_', '').replace('_', ' ').toUpperCase() : 'UNKNOWN';
                    let diffHTML = '<span class="text-muted text-sm">View...</span>';
                    if (isPending && r.payload && r.targetId) diffHTML = `<button class="btn btn-sm btn-secondary" onclick="showDiff('${r.id}')">View Diff</button>`;
                    else if (!r.targetId && r.payload) diffHTML = `<span class="badge badge-upgrade">New Item</span>`;
                    return `<tr><td style="white-space:nowrap;">${formatDateTime(r.timestamp)}</td><td><strong>${r.requesterName}</strong><br><small class="text-muted">${r.requesterEmail}</small></td><td><div class="badge badge-warning" style="background:#fffbeb; color:var(--warning); border:1px solid #fde68a; text-transform:none;">${keyName}</div></td><td style="font-size:0.8rem;">${r.targetCollection}/${r.targetId ? r.targetId.substring(0,6)+'...' : 'NEW'}</td><td>${diffHTML}</td><td>${isPending ? `<div class="flex gap-2"><button class="btn btn-sm btn-success" onclick="processApproval('${r.id}', 'Approved')">Approve</button><button class="btn btn-sm btn-danger" onclick="processApproval('${r.id}', 'Rejected')">Reject</button></div>` : `<small class="text-muted">Processed (${r.status})</small>`}</td></tr>`;
                }).join('');
            };
        }
        async function showDiff(requestId) {
            const reqDoc = await db.collection("pending_edits").doc(requestId).get();
            const r = reqDoc.data();
            let currentDocData = {};
            try { if(r.targetId) { const snap = await db.collection(r.targetCollection).doc(r.targetId).get(); if(snap.exists) currentDocData = snap.data(); } } catch(e) { console.error(e); }
            const payload = r.payload;
            const keysToCheck = new Set([...Object.keys(currentDocData), ...Object.keys(payload)]);
            let diffHTML = '';
            keysToCheck.forEach(key => {
                const oldVal = currentDocData[key]; const newVal = payload[key];
                if (typeof oldVal === 'object' && oldVal !== null) return; 
                const strOld = String(oldVal !== undefined ? oldVal : '-');
                const strNew = String(newVal !== undefined ? newVal : '-');
                if (strOld !== strNew) {
                    diffHTML += `<div class="diff-line"><div class="diff-label">${key}</div><div class="diff-val old">${strOld}</div><div class="diff-val new">${strNew}</div></div>`;
                }
            });
            if(!diffHTML) diffHTML = '<div class="text-center text-muted">No visible changes in simple fields (complex objects hidden).</div>';
            showModal("Before vs After Comparison", `<div class="diff-viewer"><div style="border-bottom:1px solid #e2e8f0; margin-bottom:8px; padding-bottom:4px; font-weight:700; color:var(--primary);">Target: ${r.targetCollection} / ${r.targetId}</div>${diffHTML}</div>`, `<button class="btn btn-primary" onclick="closeModal()">Close</button>`);
        }
        async function processApproval(requestId, action) {
            if(!confirm(`Are you sure you want to ${action} this request?`)) return;
            try {
                const requestRef = db.collection("pending_edits").doc(requestId);
                const requestSnap = await requestRef.get();
                if (!requestSnap.exists) return showToast("Request not found", "error");
                const r = requestSnap.data();
                await requestRef.update({ status: action, processedBy: userData.name, processedAt: firebase.firestore.FieldValue.serverTimestamp() });
                if (action === 'Approved') {
                    if (r.payload) {
                        if (r.targetId) await db.collection(r.targetCollection).doc(r.targetId).update(r.payload);
                        else await db.collection(r.targetCollection).add(r.payload); 
                        showToast("Changes Applied Successfully", "success");
                    } else showToast("Request Approved", "success");
                    logActivity(`Approved edit request by ${r.requesterName} on ${r.targetCollection}`);
                } else {
                    showToast("Request Rejected", "error");
                    logActivity(`Rejected edit request by ${r.requesterName}`);
                }
            } catch(e) {
                console.error(e);
                showToast("Error processing: " + e.message, "error");
            }
        }

        // --- 14. MY PROFILE ---
        function renderMyProfile() {
            setPageLoading(true);
            const main = document.getElementById('main');
            const canEditAccess = hasPermission(PERMISSION_KEYS.EDIT_ACCESS);
            
            main.innerHTML = `
                <div class="p-4" style="background:var(--bg-surface); border:1px solid var(--border-glass); border-radius:16px; max-width:600px; margin:0 auto;">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 style="font-size:1.25rem;">My Profile</h2>
                            <span class="badge badge-${userData.role==='super_admin'?'admin':(userData.role==='admin'?'admin':'crew')}">${userData.role==='super_admin'?'Super Admin':(userData.role==='admin'?'Admin':'Crew')}</span>
                        </div>
                        ${canEditAccess ? `<button class="btn btn-primary" onclick="openEditMyProfile()"><i class="ri-pencil-line"></i> Edit</button>` : ''}
                    </div>
                    
                    <div class="mb-4"><label class="text-muted">Name</label><input value="${userData.name}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Email</label><input value="${userData.email}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Crew ID</label><input value="${userData.crewId || 'N/A'}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Job Title</label><input value="${userData.jobTitle||'N/A'}" readonly></div>
                    <div class="mb-4"><label class="text-muted">Department</label><input value="${userData.department || 'N/A'}" readonly></div>
                    
                    ${canEditAccess ? '' : '<p class="text-center text-muted text-sm mt-4">Profile is read-only.</p>'}
                </div>
            `;
        }

        function openEditMyProfile() {
            if(!hasPermission(PERMISSION_KEYS.EDIT_ACCESS)) return showToast("Access Denied", "error");
            showModal("Edit My Profile", `
                <div class="mb-4"><label>Name</label><input id="my-name" value="${userData.name}"></div>
                <div class="mb-4"><label>Email</label><input id="my-email" value="${userData.email}" readonly></div>
                <div class="mb-4"><label>Phone</label><input id="my-phone" value="${userData.phone||''}"></div>
                <div class="mb-4"><label>Work Location</label><select id="my-work-loc"><option value="HQ" ${userData.workLocation==='HQ'?'selected':''}>HQ</option><option value="WFH" ${userData.workLocation==='WFH'?'selected':''}>WFH</option></select></div>
                <div class="mb-4"><label>Department</label><select id="my-dept">${DEPARTMENTS.map(d=>`<option value="${d}" ${userData.department===d?'selected':''}>${d}</option>`)}</select></div>
            `, `<button class="btn btn-primary" onclick="saveMyProfile()">Save</button>`);
        }

        async function saveMyProfile() {
            const updates = {
                name: document.getElementById('my-name').value,
                phone: document.getElementById('my-phone').value,
                workLocation: document.getElementById('my-work-loc').value,
                department: document.getElementById('my-dept').value
            };
            try {
                await db.collection("users").doc(currentUser.uid).update(updates);
                closeModal();
                showToast("Profile Updated", "success");
                logActivity(`Updated own profile`);
                renderMyProfile(); 
            } catch(e) {
                showToast("Error updating profile: " + e.message, "error");
            }
        }

        function filterTable(id, text) {
            const trs = document.querySelectorAll(`#${id} tr`);
            text = text.toLowerCase();
            trs.forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(text)?'':'none');
        }

        function notifyVoucherExpiryAdmin(voucherCode, expiryDate, customerName) {
            const msg = `Hi Admin Team,\n\nA customers voucher (${voucherCode}) will expire on ${expiryDate}.\nCustomer: ${customerName}\n\nPlease follow up with them and try to close the sale.\n\nThank you.\n\n> [Auto-generated from DDNet System]`;
            const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            const win = window.open(url, '_blank');
            if (!win || win.closed || typeof win.closed == 'undefined') window.location.href = url;
        }

        function notifyVoucherExpiryClient(phone, name, expiryDate) {
            const cleanPhone = phone ? phone.replace(/[^0-9]/g, '').replace(/^0/, '60') : '';
            if(!cleanPhone) return showToast("Client has no valid phone number", "error");
            const msg = `Hi ${name},\n\nWe noticed your voucher will expire on ${expiryDate}. Dont miss outuse it soon! If you need any assistance, were happy to help.\n\nThank you,\n> [Auto-generated from DDNet System]`;
            const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
            const win = window.open(url, '_blank');
            if (!win || win.closed || typeof win.closed == 'undefined') window.location.href = url;
        }
</script>
    <!-- FRESHCHAT WIDGET START -->
<script
src='//fw-cdn.com/15645616/6855906.js'
chat='true'>
</script>
<!-- FRESHCHAT WIDGET END -->
</body>
</html>
