<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal - Klinik Pergigian Azam</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- VARIABLES (Professional Medical Palette) --- */
        :root {
            /* Primary Brand Colors */
            --primary: #0284c7; --primary-dark: #0369a1; --primary-light: #e0f2fe; 
            --secondary: #14b8a6; 
            
            /* Status Colors */
            --success: #10b981; --success-bg: #dcfce7;
            --warning: #f59e0b; --warning-bg: #fef3c7;
            --danger: #ef4444; --danger-bg: #fee2e2;
            --info: #3b82f6; --info-bg: #dbeafe;
            --wa-color: #25D366; --wa-bg: #dcfce7;
            
            /* Backgrounds & Surfaces */
            --bg-body: #f8fafc; --bg-sidebar: #ffffff; --bg-card: #ffffff;
            
            /* Text Colors */
            --text-main: #0f172a; --text-muted: #64748b; --border-light: #e2e8f0;
            
            /* Dimensions */
            --sidebar-width: 280px; --header-height: 70px; --radius: 12px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- BASE RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        
        h1, h2, h3, h4, h5 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; color: var(--text-main); letter-spacing: -0.02em; }
        button { cursor: pointer; border: none; font-family: inherit; transition: var(--transition); }
        input, select, textarea { font-family: inherit; }

        /* --- COMPONENTS --- */
        .invoice-link { color: var(--primary); text-decoration: underline; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .invoice-link:hover { opacity: 0.8; }

        /* --- SEARCH INPUT --- */
        .search-container { position: relative; width: 100%; max-width: 300px; }
        .search-input { width: 100%; padding: 10px 10px 10px 36px; border: 1px solid var(--border-light); border-radius: var(--radius); font-size: 0.85rem; background: #f8fafc; transition: var(--transition); color: var(--text-main); }
        .search-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.85rem; }

        /* --- CUSTOM PATIENT SEARCH COMPONENT --- */
        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-select-header { position: relative; }
        .custom-select-input {
            width: 100%;
            padding: 14px 36px 14px 16px;
            background: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: var(--transition);
            color: var(--text-main);
            cursor: text;
        }
        .custom-select-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1); }
        .clear-selection {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            display: none;
            z-index: 2;
        }
        .clear-selection:hover { color: var(--danger); }
        .options-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            margin-top: 5px;
            display: none;
            list-style: none;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        .options-list::-webkit-scrollbar { width: 6px; }
        .options-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .options-list.show { display: block; }
        .options-list li {
            padding: 12px 16px;
            font-size: 0.9rem;
            color: var(--text-main);
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .options-list li:last-child { border-bottom: none; }
        .options-list li:hover { background-color: var(--primary-light); color: var(--primary-dark); }
        .options-list li .sub-text { display: block; font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .no-option { padding: 12px; text-align: center; color: var(--text-muted); font-style: italic; font-size: 0.85rem; background: #f8fafc; }

        /* --- LOGIN & LOGO --- */
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: 0.5s; padding: 20px; }
        #login-screen.hidden { opacity: 0; pointer-events: none; }
        .login-card { background: rgba(255,255,255, 0.95); backdrop-filter: blur(20px); padding: 40px; border-radius: 24px; width: 100%; max-width: 420px; box-shadow: var(--shadow-lg); text-align: center; animation: floatUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); border:1px solid rgba(255,255,255,0.8); }
        @keyframes floatUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .logo-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow-sm); }
        .logo-large { width: 80px; height: 80px; object-fit: cover; border-radius: 20px; border: 4px solid white; box-shadow: var(--shadow-md); margin-bottom: 1rem; }
        
        .form-input { width: 100%; padding: 14px 16px; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: var(--radius); font-size: 0.95rem; transition: var(--transition); color: var(--text-main); }
        .form-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(2, 132, 199, 0.1); }
        .form-input:disabled { background: #f1f5f9; color: var(--text-muted); }
        
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-weight: 600; font-size: 1rem; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3); display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(2, 132, 199, 0.4); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border-light); display: flex; flex-direction: column; position: relative; z-index: 50; transition: transform 0.3s ease; }
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 24px; font-size: 1.1rem; font-weight: 800; color: var(--primary-dark); border-bottom: 1px solid #f1f5f9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nav-menu { flex: 1; padding: 20px 16px; list-style: none; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; padding: 12px 16px; margin-bottom: 4px; color: var(--text-muted); font-weight: 500; border-radius: var(--radius); cursor: pointer; transition: var(--transition); font-size: 0.9rem; white-space: nowrap; }
        .nav-item i { width: 26px; font-size: 1.1rem; margin-right: 12px; text-align: center; color: var(--primary); transition: color 0.2s; }
        .nav-item:hover { background: #f0f9ff; color: var(--primary-dark); }
        .nav-item:hover i { color: var(--primary-dark); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding-left: 12px; }
        .sidebar-footer { padding: 16px; border-top: 1px solid #f1f5f9; }
        .user-pill { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 12px; background: #f8fafc; cursor: pointer; border: 1px solid transparent; transition: var(--transition); }
        .user-pill:hover { border-color: var(--border-light); background: white; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }

        /* --- MAIN WRAPPER --- */
        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }
        
        /* --- HEADER --- */
        header { height: var(--header-height); background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-light); display: grid; grid-template-columns: auto 1fr auto; align-items: center; padding: 0 20px; position: sticky; top: 0; z-index: 40; width: 100%; }
        
        .mobile-menu-btn { display: none; background: none; font-size: 1.2rem; color: var(--text-main); padding: 8px; border-radius: 8px; transition: background 0.2s; }
        .mobile-menu-btn:hover { background: #f1f5f9; }

        .header-title { display: flex; flex-direction: column; justify-content: center; }
        .header-title h2 { font-size: 1.1rem; line-height: 1.2; }
        .header-title p { font-size: 0.75rem; color: var(--text-muted); display: none; }

        .header-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .live-clock-container { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border-light); box-shadow: var(--shadow-sm); }
        .live-time { font-family: 'Plus Jakarta Sans', sans-serif; font-variant-numeric: tabular-nums; font-weight: 800; font-size: 1.1rem; color: var(--primary); line-height: 1; }
        .live-date-header { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; margin-top: 2px; }

        .header-right { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }

        /* --- CONTENT AREA --- */
        .content-area { flex: 1; padding: 24px; overflow-y: auto; overflow-x: hidden; }

        /* --- CARDS & TABLES --- */
        .section-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); padding: 24px; margin-bottom: 24px; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .table-header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .table-header-actions { display: flex; justify-content: space-between; align-items: center; gap: 10px; width: 100%; }
        .table-header h3 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border-light); width: 100%; -webkit-overflow-scrolling: touch; background: white; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
        th { text-align: left; padding: 14px 16px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); background: #f8fafc; font-weight: 700; white-space: nowrap; border-bottom: 1px solid var(--border-light); }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; color: var(--text-main); vertical-align: middle; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fcfcfc; }

        .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; letter-spacing: 0.03em; }
        .badge-pending { background: var(--warning-bg); color: #b45309; }
        .badge-confirmed { background: var(--info-bg); color: #1d4ed8; }
        .badge-completed { background: var(--success-bg); color: #15803d; }
        .badge-cancelled { background: var(--danger-bg); color: #b91c1c; }
        .badge-info { background: var(--info-bg); color: #1e40af; }

        .btn-sm { padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border-light); background: white; color: var(--text-main); display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; transition: var(--transition); }
        .btn-sm:hover { background: #f8fafc; border-color: #cbd5e1; transform: translateY(-1px); }
        .btn-sm:active { transform: translateY(0); }
        .btn-bill { background: var(--primary); color: white; border: none; }
        .btn-bill:hover { background: var(--primary-dark); }
        .btn-delete { color: var(--danger); border-color: #fee2e2; background: #fff; }
        .btn-delete:hover { background: var(--danger-bg); }
        .btn-wa { color: var(--wa-color); border-color: #dcfce7; background: #fff; }
        .btn-wa:hover { background: var(--wa-bg); }
        
        /* --- DASHBOARD STATS --- */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { display: flex; justify-content: space-between; align-items: center; padding: 24px; position: relative; overflow: hidden; }
        .stat-card::before { content:''; position: absolute; top:0; left:0; width:4px; height:100%; background: var(--primary); opacity: 0.5; }
        .stat-card h3 { font-size: 2rem; margin-bottom: 5px; color: var(--text-main); }
        .stat-card p { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; opacity: 0.9; }

        /* --- RECEIPT --- */
        #view-bill-detail { background: #f1f5f9; padding: 20px; max-width: 100%; overflow-y: auto; display: none; }
        #view-bill-detail.active { display: block; }
        
        .receipt-paper { background: #ffffff; max-width: 900px; margin: 0 auto; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); position: relative; border-top: 8px solid var(--primary); }
        .receipt-input { background: transparent; border: none; border-bottom: 1px dashed transparent; padding: 2px 4px; border-radius: 2px; font-family: inherit; font-size: inherit; font-weight: inherit; color: inherit; width: 100%; transition: all 0.2s; }
        .receipt-input:hover { border-bottom-color: #cbd5e1; background: #f8fafc; }
        .receipt-input:focus { background: #fff; border-bottom: 2px solid var(--primary); outline: none; }
        .rp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border-light); }
        .rp-brand { display: flex; align-items: center; gap: 20px; }
        .rp-logo { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .rp-brand-info h1 { color: var(--primary-dark); font-size: 22px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: -0.5px; }
        .rp-brand-info p { color: var(--text-muted); font-size: 13px; line-height: 1.5; max-width: 300px; }
        .rp-title { text-align: right; }
        .rp-title h2 { font-size: 32px; color: var(--text-main); font-weight: 800; letter-spacing: -1px; margin-bottom: 5px; }
        .rp-meta-row { display: flex; justify-content: flex-end; align-items: center; gap: 15px; font-size: 14px; color: var(--text-muted); }
        .rp-meta-item { display: flex; flex-direction: column; align-items: flex-end; }
        .rp-meta-item span:first-child { font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: 600; }
        .rp-meta-item span:last-child { font-weight: 600; color: var(--text-main); }
        .rp-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .rp-info-block h4 { font-size: 12px; text-transform: uppercase; color: var(--primary); margin-bottom: 12px; letter-spacing: 0.05em; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; display: inline-block; }
        .rp-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .rp-label { color: var(--text-muted); }
        .rp-val { font-weight: 600; color: var(--text-main); text-align: right; }
        .rp-table-wrapper { margin-bottom: 30px; }
        .rp-table { width: 100%; border-collapse: collapse; }
        .rp-table th { text-align: left; padding: 12px 10px; font-size: 11px; text-transform: uppercase; color: #64748b; background: #f8fafc; font-weight: 700; border-bottom: 2px solid var(--border-light); }
        .rp-table td { padding: 16px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 14px; }
        .rp-col-right { text-align: right; }
        .rp-col-center { text-align: center; }
        .rp-item-name { font-weight: 500; color: var(--text-main); }
        .rp-price { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; }
        .rp-summary-row { display: flex; justify-content: flex-end; margin-bottom: 30px; }
        .rp-summary-card { width: 320px; background: #fff; border: 1px solid var(--border-light); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .rp-sum-line { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: var(--text-muted); }
        .rp-sum-total { border-top: 2px solid var(--border-light); margin-top: 10px; padding-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .rp-sum-total span:first-child { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .rp-sum-total span:last-child { font-size: 24px; font-weight: 800; color: var(--primary); }
        .rp-footer { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 40px; padding-top: 20px; border-top: 1px dashed var(--border-light); font-size: 12px; color: var(--text-muted); }
        .rp-terms { width: 70%; line-height: 1.6; }
        .rp-qr-box { text-align: center; width: 140px; flex-shrink: 0; }
        .rp-qr-box img { width: 120px; height: 120px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 8px; }
        .paid-stamp { position: absolute; top: 120px; right: 40px; border: 4px solid var(--success); color: var(--success); text-transform: uppercase; padding: 5px 15px; font-weight: 800; font-size: 32px; border-radius: 8px; text-align: center; opacity: 0.15; transform: rotate(-15deg); z-index: 10; pointer-events: none; mix-blend-mode: multiply; }
        .paid-stamp.visible { opacity: 0.9; }
        .receipt-actions { margin-top: 30px; padding-bottom: 60px; display: flex; justify-content: space-between; align-items: center; }

        /* --- PRINT STYLES (UPDATED FOR CLINIC DETAILS) --- */
        @media print {
            body { background: white; height: auto; overflow: visible; display: block; margin: 0; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .sidebar, header, .mobile-menu-btn, .no-print, .view-section:not(#view-bill-detail) { display: none !important; }
            #toast { display: none !important; }
            .main-wrapper, .content-area { overflow: visible; height: auto; display: block; padding: 0; margin: 0; }
            
            #view-bill-detail { display: block !important; padding: 0; background: white; width: 100%; position: static; top: 0; left: 0; overflow: visible; }
            
            .receipt-paper { box-shadow: none; border: none; margin: 0; padding: 30px 40px; max-width: 100%; width: 100%; page-break-inside: avoid; border-top: 8px solid var(--primary); }
            .receipt-input { border: none !important; padding: 0 !important; width: auto; display: inline; background: transparent !important; }
            .paid-stamp { -webkit-print-color-adjust: exact; print-color-adjust: exact; opacity: 0.8; border-color: var(--success) !important; color: var(--success) !important; }
            
            /* Force Clinic Details to be visible and legible */
            .rp-header, .rp-brand, .rp-brand-info { display: block !important; visibility: visible !important; width: 100%; page-break-inside: avoid; }
            .rp-brand-info p { color: #000 !important; font-size: 12px; } /* Black text for better print contrast */
            .rp-brand-info h1 { color: #000 !important; } /* Black text for header */
            .rp-logo { display: block !important; }
            
            @page { size: A4 portrait; margin: 10mm; }
        }

        /* --- UI ELEMENTS --- */
        .spinner-container { width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px 0; min-height: 150px; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(2, 132, 199, 0.1); border-left-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 10px; color: var(--text-muted); font-size: 0.85rem; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; width: 100%; max-width: 550px; border-radius: 20px; box-shadow: var(--shadow-lg); overflow: hidden; transform: scale(0.95); transition: 0.3s; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 10px; }

        .sales-summary { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary) 0%, #0369a1 100%); color: white; padding: 30px; border-radius: 20px; box-shadow: var(--shadow-md); }
        .sales-big-number { font-size: 2.5rem; font-weight: 800; line-height: 1; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: #1e293b; color: white; padding: 14px 28px; border-radius: 30px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 200; box-shadow: 0 10px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.9rem; width: max-content; max-width: 90%; pointer-events: none; opacity: 0; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- BOOKING --- */
        .booking-container { display: grid; gap: 20px; height: auto; grid-template-columns: 300px 280px 1fr; }
        .booking-panel { background: white; border: 1px solid var(--border-light); border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; height: 100%; max-height: 700px; box-shadow: var(--shadow-sm); }
        .calendar-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .calendar-header button { background: white; border: 1px solid #e2e8f0; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: 0.2s; cursor: pointer; }
        .calendar-header button:hover { color: var(--primary); border-color: var(--primary); }
        .month-label { font-weight: 700; font-size: 0.95rem; }
        .calendar-grid { padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .cal-day-name { font-size: 0.65rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .cal-day:hover:not(.disabled):not(.empty) { background: var(--primary-light); color: var(--primary); }
        .cal-day.active { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(2, 132, 199, 0.2); }
        .cal-day.today { border: 2px solid var(--primary); color: var(--primary); font-weight: 700; }
        .cal-day.today.active { border-color: white; }
        .cal-day.disabled { color: #cbd5e1; cursor: not-allowed; }
        .cal-day.empty { cursor: default; }
        .slots-header { padding: 15px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .slots-header h4 { font-size: 0.9rem; margin-bottom: 2px; }
        .slots-header span { font-size: 0.75rem; color: var(--text-muted); }
        .slots-list { padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .slot-item { padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.85rem; cursor: pointer; position: relative; background: white; transition: 0.2s; }
        .slot-item:hover:not(.booked):not(.blocked) { border-color: var(--primary); color: var(--primary); }
        .slot-item.selected { background: var(--primary); color: white; border-color: var(--primary-dark); }
        .slot-item.booked { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; text-decoration: line-through; border-color: transparent; }
        .slot-item.blocked { background: #fee2e2; color: #ef4444; cursor: not-allowed; border: 1px solid #fecaca; opacity: 0.8; }
        .form-panel { padding: 20px; overflow-y: auto; }
        .live-summary { background: var(--primary-light); border: 1px solid var(--secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        .live-summary h5 { font-size: 0.75rem; text-transform: uppercase; color: var(--primary-dark); margin-bottom: 8px; letter-spacing: 0.05em; }
        .live-summary-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; }

        .slot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .slot-btn { padding: 10px; text-align: center; border: 2px solid #e2e8f0; border-radius: 12px; background: white; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 70px; transition: 0.2s; }
        .slot-btn:hover:not(.booked):not(.blocked) { border-color: var(--primary); color: var(--primary); }
        .slot-btn.blocked { border-color: #fca5a5; color: #ef4444; background: #fee2e2; }
        .slot-btn.booked { border-color: var(--primary); background: var(--info-bg); color: var(--primary-dark); cursor: not-allowed; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .booking-container { grid-template-columns: 1fr 1fr; }
            .booking-panel:last-child { grid-column: span 2; }
        }

        @media (max-width: 768px) {
            :root { --header-height: 60px; }
            body { position: relative; }
            .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; transform: translateX(-100%); z-index: 1050; box-shadow: var(--shadow-lg); }
            .sidebar.mobile-open { transform: translateX(0); }
            .sidebar-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1040; opacity: 0; pointer-events: none; transition: 0.3s; }
            .sidebar-backdrop.active { opacity: 1; pointer-events: auto; }
            .mobile-menu-btn { display: block; }
            .header-center { display: none; }
            .header-title p { display: block; }
            header { padding: 0 15px; grid-template-columns: auto 1fr auto; }
            .content-area { padding: 15px; }
            .dashboard-stats { grid-template-columns: 1fr 1fr; }
            .stat-card { padding: 20px; }
            .stat-card h3 { font-size: 1.5rem; }
            .booking-container { grid-template-columns: 1fr; height: auto; display: flex; flex-direction: column; }
            .booking-panel { height: auto; max-height: none; }
            .booking-panel:nth-child(1) { height: 350px; }
            .booking-panel:nth-child(2) { height: 250px; }
            .modal-content { max-width: 100%; height: 100%; border-radius: 0; max-height: 100vh; }
            
            .receipt-paper { padding: 20px; border-top: none; }
            .rp-header { flex-direction: column; align-items: center; text-align: center; gap: 20px; }
            .rp-brand-info { text-align: center; }
            .rp-brand-info p { margin: 0 auto; }
            .rp-title { text-align: center; margin-bottom: 20px; }
            .rp-meta-row { justify-content: center; }
            .rp-info-grid { grid-template-columns: 1fr; gap: 20px; }
            .rp-summary-row { justify-content: center; }
            .rp-summary-card { width: 100%; }
            .rp-footer { flex-direction: column; align-items: center; gap: 20px; text-align: center; }
            .receipt-actions { flex-direction: column; gap: 10px; }
            .receipt-actions button { width: 100%; }
        }

        @media (max-width: 480px) {
            .dashboard-stats { grid-template-columns: 1fr; }
            .section-card { padding: 15px; }
            .table-header { flex-direction: column; align-items: flex-start; }
            .table-header-actions { flex-direction: column; align-items: stretch; width: 100%; }
            .search-container { max-width: 100%; }
        }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-large">
            <h2 style="margin-top: 10px; margin-bottom: 5px; color: var(--primary-dark);">Klinik Azam</h2>
            <p style="margin-bottom: 30px; color: var(--text-muted); font-weight: 500;">Cawangan (SP Saujana)</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="text-align:left; margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Username</label>
                    <input type="text" id="username" class="form-input" placeholder="staff_username" required>
                </div>
                <div style="text-align:left; margin-bottom:25px;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Password</label>
                    <input type="password" id="password" class="form-input" placeholder="password" required>
                </div>
                <button type="submit" class="btn-primary">Sign In <i class="fa-solid fa-arrow-right"></i></button>
                <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 15px;"></p>
            </form>
        </div>
    </div>

    <!-- MOBILE SIDEBAR BACKDROP -->
    <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleMobileMenu()"></div>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="brand">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-img" style="margin-right:10px;">
            Klinik Pergigian Azam <br> SP Saujana
        </div>
        <ul class="nav-menu">
            <li class="nav-item" onclick="navigateTo('dashboard')"><i class="fa-solid fa-chart-pie"></i> Dashboard</li>
            <li class="nav-item" onclick="navigateTo('appointments')"><i class="fa-regular fa-calendar-check"></i> Appointments</li>
            <li class="nav-item" onclick="navigateTo('booking')"><i class="fa-solid fa-calendar-plus"></i> New Booking</li>
            <li class="nav-item" onclick="navigateTo('billing')"><i class="fa-solid fa-file-invoice-dollar"></i> Patient Billing</li>
            <li class="nav-item" onclick="navigateTo('reports')"><i class="fa-solid fa-chart-line"></i> Reports</li>
            <li class="nav-item" onclick="navigateTo('staff')"><i class="fa-solid fa-users-cog"></i> Staff Management</li>
            <li class="nav-item" onclick="navigateTo('patients')"><i class="fa-solid fa-user-doctor"></i> Patients</li>
            <li class="nav-item" onclick="navigateTo('services')"><i class="fa-solid fa-notes-medical"></i> Services</li>
            <li class="nav-item" onclick="navigateTo('slots')"><i class="fa-regular fa-clock"></i> Slot Management</li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-pill" onclick="openProfile()">
                <div class="avatar" id="userAvatar">DA</div>
                <div style="overflow:hidden;">
                    <div style="font-weight:700; font-size:0.85rem;" id="userNameDisplay">Dr. Amalina</div>
                    <div style="font-size:0.7rem; color:var(--text-muted); text-overflow:ellipsis; overflow:hidden; white-space:nowrap;" id="userRoleDisplay">Admin</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-wrapper">
        <header>
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()"><i class="fa-solid fa-bars"></i></button>
                <div class="header-title">
                    <h2 id="pageTitle">Dashboard</h2>
                    <p style="color:var(--text-muted); font-weight:500;" id="currentFullDate">Loading...</p>
                </div>
            </div>
            
            <div class="header-center">
                <div class="live-clock-container">
                    <i class="fa-regular fa-clock" style="color: var(--primary); font-size:1.1rem;"></i>
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <span id="liveClock" class="live-time">00:00:00</span>
                        <span id="liveDate" class="live-date-header">Loading Date</span>
                    </div>
                </div>
            </div>

            <div class="header-right">
                <button onclick="logout()" class="btn-sm" style="color: var(--danger); border-color: #fee2e2; padding: 8px 12px;"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </header>

        <div class="content-area">
            
            <!-- DASHBOARD -->
            <section id="view-dashboard" class="view-section active">
                <div class="dashboard-stats">
                    <div class="section-card stat-card">
                        <div><h3 style="margin-bottom:5px;" id="d-stat-today">0</h3><p>Today's Appts</p></div>
                        <div class="stat-icon" style="background:var(--primary-light); color:var(--primary);"><i class="fa-regular fa-calendar"></i></div>
                    </div>
                    <div class="section-card stat-card">
                        <div><h3 style="margin-bottom:5px;" id="d-stat-sales">RM 0</h3><p>Today's Sales</p></div>
                        <div class="stat-icon" style="background:var(--success-bg); color:var(--success);"><i class="fa-solid fa-coins"></i></div>
                    </div>
                    <div class="section-card stat-card">
                        <div><h3 style="margin-bottom:5px;" id="d-stat-history">0</h3><p>Total Patients</p></div>
                        <div class="stat-icon" style="background:var(--warning-bg); color:var(--warning);"><i class="fa-solid fa-users"></i></div>
                    </div>
                </div>
                <div class="section-card">
                    <div class="table-header"><h3><i class="fa-solid fa-clock" style="color:var(--primary); margin-right:8px;"></i>Today's Schedule</h3></div>
                    <div class="table-responsive"><table id="dashboard-table"><thead><tr><th>Time</th><th>Patient</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- APPOINTMENTS -->
            <section id="view-appointments" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3>Upcoming Schedule</h3>
                        <div class="search-container">
                            <i class="fa-solid fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search name, date, service..." oninput="handleSearch('appointments', this.value)">
                        </div>
                    </div>
                    <div class="table-responsive"><table id="today-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Phone</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
                <div class="section-card">
                    <div class="table-header">
                        <h3>Patient History (Completed)</h3>
                        <div class="search-container">
                            <i class="fa-solid fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search history..." oninput="handleSearch('history', this.value)">
                        </div>
                    </div>
                    <div class="table-responsive"><table id="history-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Service</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
                <div class="section-card" style="border-left: 4px solid var(--danger);">
                    <div class="table-header">
                        <h3 style="color:var(--danger);"><i class="fa-solid fa-ban" style="margin-right:8px;"></i> Cancelled</h3>
                        <button class="btn-sm" id="toggleCancelledBtn" onclick="toggleCancelledTable()">Show Cancelled</button>
                    </div>
                    <div id="cancelled-container" style="display:none;">
                        <div class="table-responsive"><table id="cancelled-table"><thead><tr><th>Date</th><th>Time</th><th>Patient</th><th>Service</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </section>

            <!-- PATIENT BILLING LIST -->
            <section id="view-billing" class="view-section">
                <div class="sales-summary">
                    <div>
                        <p style="opacity:0.9; font-weight:600; margin-bottom:5px; font-size:0.9rem;">Total Billed (Selected Period)</p>
                        <div class="sales-big-number">RM <span id="billing-total-amount">0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <i class="fa-solid fa-file-invoice-dollar" style="font-size:3rem; opacity:0.2;"></i>
                    </div>
                </div>

                <div class="section-card">
                    <div class="table-header">
                        <h3>Billing Filter</h3>
                        <div class="table-header-actions" style="flex-wrap: wrap; gap: 10px;">
                            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                                <div>
                                    <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); display:block;">From</label>
                                    <input type="date" id="billing-start" class="form-input" style="padding: 10px;" onchange="renderBilling()">
                                </div>
                                <div>
                                    <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); display:block;">To</label>
                                    <input type="date" id="billing-end" class="form-input" style="padding: 10px;" onchange="renderBilling()">
                                </div>
                            </div>
                            <!-- FUNCTIONAL BUTTON FIXED -->
                            <button class="btn-primary" style="width:auto; white-space:nowrap; padding: 10px 20px;" onclick="exportBillingData()"><i class="fa-solid fa-download"></i> Download CSV</button>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="table-header">
                        <h3>Patient Bills</h3>
                        <div class="search-container">
                            <i class="fa-solid fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Search invoice, patient..." oninput="handleSearch('billing', this.value)">
                        </div>
                    </div>
                    <div class="table-responsive"><table id="billing-table"><thead><tr><th>Invoice #</th><th>Date</th><th>Patient</th><th>Phone</th><th>Items</th><th>Total (RM)</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- NEW PROFESSIONAL RECEIPT DESIGN -->
            <section id="view-bill-detail" class="view-section">
                <div class="no-print" style="margin-bottom: 20px;">
                    <button class="btn-sm" onclick="navigateTo('billing')"><i class="fa-solid fa-arrow-left"></i> Back to Billing List</button>
                </div>

                <div class="receipt-paper">
                    
                    <!-- PAID STAMP (Hidden by default, shown via JS) -->
                    <div id="rp-stamp" class="paid-stamp">PAID</div>

                    <!-- HEADER -->
                    <header class="rp-header">
                        <div class="rp-brand">
                            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Clinic Logo" class="rp-logo">
                            <div class="rp-brand-info">
                                <h1>Klinik Pergigian Azam</h1>
                                <p>21, Jalan PKS (A), Pusat Komersial Saujana<br>08000 Sungai Petani, Kedah</p>
                                <p style="color:var(--primary-dark); font-weight:600; margin-top:4px;">Tel: 04-123 4567</p>
                            </div>
                        </div>
                        <div class="rp-title">
                            <h2>RECEIPT</h2>
                            <div class="rp-meta-row">
                                <div class="rp-meta-item">
                                    <span>Invoice No</span>
                                    <span id="receiptNo">KPA-00000000-000</span>
                                </div>
                                <div class="rp-meta-item">
                                    <span>Date</span>
                                    <span id="receiptDate">--/--/----</span>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- INFO GRID -->
                    <div class="rp-info-grid">
                        <div class="rp-info-block">
                            <h4>Patient Details</h4>
                            <div class="rp-row">
                                <span class="rp-label">Name</span>
                                <span class="rp-val"><input type="text" id="r-patient-name" class="receipt-input" value="Patient Name"></span>
                            </div>
                            <div class="rp-row">
                                <span class="rp-label">Phone</span>
                                <span class="rp-val"><input type="text" id="r-patient-phone" class="receipt-input" value="012-3456789"></span>
                            </div>
                            <div class="rp-row">
                                <span class="rp-label">IC No.</span>
                                <span class="rp-val"><input type="text" id="r-patient-ic" class="receipt-input" value="000000-00-0000"></span>
                            </div>
                        </div>

                        <div class="rp-info-block">
                            <h4>Payment Details</h4>
                            <div class="rp-row">
                                <span class="rp-label">Appt Time</span>
                                <span class="rp-val" id="receiptTime">--:--</span>
                            </div>
                            <div class="rp-row">
                                <span class="rp-label">Method</span>
                                <span class="rp-val" id="r-payment-method">Cash</span>
                            </div>
                            <div class="rp-row">
                                <span class="rp-label">Status</span>
                                <span class="badge badge-completed">PAID</span>
                            </div>
                        </div>
                    </div>

                    <!-- ITEMS TABLE -->
                    <div class="rp-table-wrapper">
                        <table class="rp-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Description</th>
                                    <th class="rp-col-center" style="width: 80px;">Qty</th>
                                    <th class="rp-col-right" style="width: 120px;">Unit Price</th>
                                    <th class="rp-col-right" style="width: 120px;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="r-items-body">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>

                    <!-- TOTAL SUMMARY CARD -->
                    <div class="rp-summary-row">
                        <div class="rp-summary-card">
                            <div class="rp-sum-line">
                                <span>Subtotal</span>
                                <span id="r-subtotal">RM 0.00</span>
                            </div>
                            <div class="rp-sum-line">
                                <span>Tax (0%)</span>
                                <span>RM 0.00</span>
                            </div>
                            <div class="rp-sum-total">
                                <span>TOTAL PAID</span>
                                <span id="r-total">RM 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <footer class="rp-footer">
                        <div class="rp-terms">
                            <p><strong>Terms & Conditions:</strong></p>
                            <p>1. Please present this receipt for warranty claims.<br>2. Payment is non-refundable once service is rendered.<br>3. This is a computer generated document. No signature required.<br>4. Thank you for choosing Klinik Pergigian Azam!</p>
                        </div>
                        <div class="rp-qr-box">
                            <img id="r-qr-img" src="" alt="WhatsApp QR">
                            <p style="font-size: 11px;">Scan to Contact Us</p>
                        </div>
                    </footer>

                    <div class="receipt-actions no-print">
                        <button class="btn-sm" style="background: var(--warning); color: white; border: none;" onclick="updatePatientFromReceipt()"><i class="fa-solid fa-pen-to-square"></i> Update Patient Info</button>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-sm" onclick="openEditInvoiceFromPage()"><i class="fa-solid fa-pen"></i> Edit Items</button>
                            <button class="btn-primary" style="width: auto; padding: 10px 24px;" onclick="window.print()"><i class="fa-solid fa-print"></i> Print Receipt</button>
                        </div>
                    </div>

                </div>
            </section>

            <!-- REPORTS -->
            <section id="view-reports" class="view-section">
                <div class="section-card" style="border: 1px solid var(--primary); background: #f0f9ff;">
                    <div class="table-header">
                        <h3><i class="fa-solid fa-file-export" style="color:var(--primary); margin-right:8px;"></i> Data Export</h3>
                    </div>
                    <div class="table-header-actions" style="flex-wrap: wrap; gap: 10px;">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <div>
                                <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); display:block;">From</label>
                                <input type="date" id="export-start" class="form-input" style="padding: 10px;">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); display:block;">To</label>
                                <input type="date" id="export-end" class="form-input" style="padding: 10px;">
                            </div>
                        </div>
                        <!-- FUNCTIONAL BUTTON FIXED -->
                        <button class="btn-primary" style="width:auto; white-space:nowrap; padding: 10px 20px;" onclick="exportData()"><i class="fa-solid fa-download"></i> Download CSV</button>
                    </div>
                </div>

                <div class="sales-summary">
                    <div>
                        <p style="opacity:0.9; font-weight:600; margin-bottom:5px; font-size:0.9rem;">Total Sales for <span id="report-date-label">Today</span></p>
                        <div class="sales-big-number">RM <span id="report-total-amount">0.00</span></div>
                    </div>
                    <div style="text-align:right;">
                        <i class="fa-solid fa-chart-pie" style="font-size:3rem; opacity:0.2;"></i>
                    </div>
                </div>
                <div class="section-card">
                    <div class="table-header">
                        <h3>Transaction Details</h3>
                        <div class="table-header-actions">
                            <input type="date" id="report-date-picker" class="form-input" style="width:auto; padding: 8px 12px;" onchange="updateReports()">
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search patient..." oninput="handleSearch('reports', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="report-table"><thead><tr><th>Time</th><th>Patient</th><th>Items</th><th>Total</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- BOOKING -->
            <section id="view-booking" class="view-section">
                <div class="section-card">
                    <div class="table-header" style="margin-bottom:0;">
                        <h3><i class="fa-solid fa-calendar-plus" style="color:var(--primary); margin-right:8px;"></i>New Appointment</h3>
                        <button class="btn-sm" onclick="resetBookingForm()">Reset</button>
                    </div>
                    
                    <form id="newBookingForm" onsubmit="saveNewBooking(event)" style="margin-top:20px;">
                        <div class="booking-container">
                            <!-- 1. CALENDAR -->
                            <div class="booking-panel">
                                <div class="calendar-header">
                                    <button type="button" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                                    <span class="month-label" id="cal-month-year">January 2024</span>
                                    <button type="button" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                                </div>
                                <div class="calendar-grid">
                                    <div class="cal-day-name">Su</div><div class="cal-day-name">Mo</div><div class="cal-day-name">Tu</div><div class="cal-day-name">We</div><div class="cal-day-name">Th</div><div class="cal-day-name">Fr</div><div class="cal-day-name">Sa</div>
                                </div>
                                <div class="calendar-grid" id="calendar-days" style="margin-top:0;"></div>
                            </div>

                            <!-- 2. SLOTS -->
                            <div class="booking-panel">
                                <div class="slots-header">
                                    <h4 id="slot-date-display">Select a Date</h4>
                                    <span id="slot-sub-display">Available times will appear here</span>
                                </div>
                                <div class="slots-list" id="booking-slots-list">
                                    <div style="text-align:center; color:var(--text-muted); margin-top:30px; font-size:0.85rem;">
                                        <i class="fa-regular fa-calendar" style="font-size:1.5rem; margin-bottom:8px; opacity:0.3;"></i><br>
                                        Select date from calendar
                                    </div>
                                </div>
                            </div>

                            <!-- 3. FORM -->
                            <div class="booking-panel">
                                <div class="form-panel">
                                    <div class="live-summary">
                                        <h5>Booking Summary</h5>
                                        <div class="live-summary-row"><span>Date:</span> <span class="live-summary-val" id="summary-date">-</span></div>
                                        <div class="live-summary-row"><span>Time:</span> <span class="live-summary-val" id="summary-time">-</span></div>
                                        <div class="live-summary-row"><span>Service:</span> <span class="live-summary-val" id="summary-service">-</span></div>
                                    </div>

                                    <h4 style="margin-bottom:15px; color:var(--primary); font-size:1rem;">Patient Selection</h4>
                                    
                                    <!-- Patient Toggle -->
                                    <div style="display:flex; gap: 20px; margin-bottom: 15px; background: #f1f5f9; padding: 10px; border-radius: 8px;">
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:600; color: var(--primary);">
                                            <input type="radio" name="patType" value="new" onchange="togglePatientType()"> New Patient
                                        </label>
                                        <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-weight:600; color: var(--primary);">
                                            <input type="radio" name="patType" value="old" checked onchange="togglePatientType()"> Existing Patient
                                        </label>
                                    </div>

                                    <!-- Mode: New Patient -->
                                    <div id="new-pat-inputs" style="display:none;">
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-bottom:4px; display:block;">Full Name</label>
                                            <input type="text" id="bk-name" class="form-input" placeholder="Full Name">
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-bottom:4px; display:block;">Phone Number</label>
                                            <input type="tel" id="bk-phone" class="form-input" placeholder="012-3456789">
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-bottom:4px; display:block;">IC Number</label>
                                            <input type="text" id="bk-ic" class="form-input" placeholder="Optional">
                                        </div>
                                    </div>

                                    <!-- Mode: Existing Patient (Default) -->
                                    <div id="old-pat-inputs">
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-bottom:4px; display:block;">Select Patient</label>
                                            
                                            <!-- CUSTOM SEARCHABLE DROPDOWN -->
                                            <div class="custom-select-wrapper">
                                                <div class="custom-select-header">
                                                    <input type="text" id="bk-pat-search" class="custom-select-input" placeholder="Search Name or Phone..." autocomplete="off">
                                                    <i class="fa-solid fa-circle-xmark clear-selection" id="clear-pat-search" onclick="clearPatientSelection()"></i>
                                                </div>
                                                <ul id="bk-pat-list" class="options-list"></ul>
                                                <!-- Hidden input for value storage -->
                                                <input type="hidden" id="bk-pat-select">
                                            </div>
                                        </div>
                                        <!-- Read-only review fields for existing patient -->
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-bottom:4px; display:block;">Phone (Review)</label>
                                            <input type="text" id="bk-review-phone" class="form-input" disabled placeholder="Auto-filled">
                                        </div>
                                        <div style="margin-bottom:12px;">
                                            <label style="font-size:0.7rem; font-weight:700; color:var(--text-muted); margin-bottom:4px; display:block;">IC (Review)</label>
                                            <input type="text" id="bk-review-ic" class="form-input" disabled placeholder="Auto-filled">
                                        </div>
                                    </div>

                                    <h4 style="margin:20px 0 15px; color:var(--primary); font-size:1rem;">Service</h4>
                                    <div style="margin-bottom:15px;">
                                        <select id="bk-service" class="form-input" onchange="checkBookingFormComplete()">
                                            <option value="" disabled selected>-- Choose Service --</option>
                                        </select>
                                    </div>

                                    <div style="margin-top:15px;">
                                        <button type="submit" class="btn-primary" id="confirm-booking-btn" disabled>Add New Appointment</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <!-- STAFF MANAGEMENT -->
            <section id="view-staff" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3><i class="fa-solid fa-users-cog" style="color:var(--primary); margin-right:8px;"></i> Staff Management</h3>
                        <div class="table-header-actions">
                            <button class="btn-sm" onclick="openEditStaff(null)"><i class="fa-solid fa-user-plus"></i> Add Staff</button>
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search staff..." oninput="handleSearch('staff', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="staff-table"><thead><tr><th>Name</th><th>Role</th><th>ID</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- PATIENTS -->
            <section id="view-patients" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3>Patient Directory</h3>
                        <div class="table-header-actions">
                            <button class="btn-sm" onclick="openEditPatient(null)"><i class="fa-solid fa-user-plus"></i> Add Patient</button>
                            <div class="search-container">
                                <i class="fa-solid fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search name, phone, IC..." oninput="handleSearch('patients', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="patients-table"><thead><tr><th>Name</th><th>Phone</th><th>IC No.</th><th>Visits</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- SERVICES -->
            <section id="view-services" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3>Clinic Services & Pricing</h3>
                        <div class="table-header-actions">
                            <button class="btn-sm" onclick="openEditService(null)"><i class="fa-solid fa-plus"></i> Add Service</button>
                        </div>
                    </div>
                    <div class="table-responsive"><table id="services-table"><thead><tr><th>Service</th><th>Price</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- SLOTS -->
            <section id="view-slots" class="view-section">
                <div class="section-card">
                    <div class="table-header">
                        <h3>Manage Availability</h3>
                        <button class="btn-sm" onclick="toggleClinicStatus()" id="clinicStatusBtn"><i class="fa-solid fa-toggle-on"></i> Set as Closed</button>
                    </div>
                    <div class="table-header-actions" style="margin-bottom:10px;">
                        <input type="date" id="slotDate" class="form-input" style="width:auto;" onchange="renderSlots()">
                    </div>
                    <p style="font-size:0.75rem; color:var(--text-muted); margin-bottom:10px;">
                        <span style="font-weight:700; color:var(--primary);">Blue</span> = Booked | 
                        <span style="font-weight:700; color:var(--danger);">Red</span> = Break | 
                        <span style="font-weight:700; color:var(--text-muted);">White</span> = Available
                    </p>
                    <div class="slot-grid" id="slotGrid"></div>
                </div>
            </section>

        </div>
    </div>

    <!-- MODALS -->
    <!-- 1. Delete Approval Modal -->
    <div class="modal-overlay" id="pinModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3><i class="fa-solid fa-shield-halved" style="color:var(--warning);"></i> Admin Approval</h3>
                <button onclick="closeModal('pinModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:15px; color:var(--text-muted); font-size:0.9rem;">This action requires Admin permission. Please enter PIN.</p>
                <input type="password" id="adminPinInput" class="form-input" placeholder="PIN (1234)">
                <p id="pinError" style="color:var(--danger); font-size:0.8rem; margin-top:10px;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('pinModal')">Cancel</button>
                <button class="btn-sm btn-delete" onclick="confirmDeleteAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 2. Edit Appointment Modal -->
    <div class="modal-overlay" id="editApptModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Appointment</h3><button onclick="closeModal('editApptModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-appt-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Date</label><input type="date" id="edit-appt-date" class="form-input" onchange="updateEditTimeOptions()"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Time</label><select id="edit-appt-time" class="form-input"></select></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Service</label><select id="edit-appt-service" class="form-input"></select></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editApptModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="saveApptEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 3. Edit Service Modal -->
    <div class="modal-overlay" id="editServiceModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="service-modal-title">Add Service</h3><button onclick="closeModal('editServiceModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-service-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Service Name</label><input type="text" id="edit-service-name" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Price (RM)</label><input type="number" id="edit-service-price" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editServiceModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="saveServiceEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 4. Staff Edit Modal -->
    <div class="modal-overlay" id="editStaffModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Manage Staff</h3><button onclick="closeModal('editStaffModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-staff-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Staff Name</label><input type="text" id="edit-staff-name" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Role</label><select id="edit-staff-role" class="form-input">
                    <option value="Dentist">Dentist</option>
                    <option value="Nurse">Nurse</option>
                    <option value="Assistant">Assistant</option>
                    <option value="Admin">Admin</option>
                </select></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Username</label><input type="text" id="edit-staff-u" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editStaffModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="saveStaffEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 5. Patient Details & Manual History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Patient Details</h3>
                <button onclick="closeModal('historyModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #e2e8f0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-muted);">Name</span><span style="font-weight:700;" id="hist-p-name">-</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-muted);">ID</span><span style="font-weight:600;" id="hist-p-id">-</span></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-muted);">Phone</span><span style="font-weight:600;" id="hist-p-phone">-</span></div>
                </div>

                <!-- Manual History Entry Section (NEW FEATURE) -->
                <div style="margin-bottom:20px; border-top:1px dashed #e2e8f0; padding-top:15px;">
                    <h4 style="font-size:0.9rem; margin-bottom:10px; color:var(--primary);"><i class="fa-solid fa-clock-rotate-left"></i> Add Past Visit (Manual Entry)</h4>
                    <div style="display:grid; gap:10px;">
                        <input type="date" id="hist-date" class="form-input" style="padding:8px;">
                        <select id="hist-service" class="form-input" style="padding:8px;">
                            <option value="" disabled selected>Select Service</option>
                        </select>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="hist-qty" class="form-input" placeholder="Qty" value="1" style="width:60px; padding:8px;">
                            <input type="number" id="hist-price" class="form-input" placeholder="Price (RM)" style="padding:8px;">
                        </div>
                        <button class="btn-sm btn-bill" onclick="saveManualHistory()" style="width:100%; justify-content:center;">Add to History</button>
                    </div>
                </div>

                <h5 style="margin-bottom:10px;">Visit History</h5>
                <div class="table-responsive" style="border:none;"><table style="font-size:0.85rem;"><thead><tr><th>Date</th><th>Service</th><th>Amount</th></tr></thead><tbody id="historyListBody"></tbody></table></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('historyModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 6. PROFILE MODAL -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Profile</h3>
                <button onclick="closeModal('profileModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <div style="text-align: center;">
                    <div class="avatar" style="width: 60px; height: 60px; font-size: 1.2rem; margin: 0 auto 10px;" id="profile-avatar">DA</div>
                    <h4 id="profile-name">Dr. Amalina</h4>
                    <p style="color: var(--text-muted);" id="profile-role">Admin</p>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 12px;">
                    <p style="font-size: 0.85rem; margin-bottom: 5px;"><strong>Username:</strong> <span id="profile-u">amalina</span></p>
                    <p style="font-size: 0.85rem;"><strong>Employee ID:</strong> #EMP001</p>
                </div>
                <div>
                    <h5 style="margin-bottom: 10px; color: var(--primary);">Organization</h5>
                    <div style="font-size:0.9rem;">
                        <div style="padding:10px; background:white; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:5px;">
                            <i class="fa-solid fa-hospital" style="color:var(--primary); margin-right:8px;"></i> <strong>Klinik Pergigian Azam</strong>
                        </div>
                        <div style="padding-left:15px; border-left:2px dashed #cbd5e1; margin-left:10px;">
                            <div style="padding:8px; background:white; border:1px solid #e2e8f0; border-radius:6px; margin-top:5px;">
                                <strong>Dr. Amalina</strong> <span style="font-size:0.75rem; color:var(--text-muted);">Admin</span>
                            </div>
                            <div style="padding:8px; background:white; border:1px solid #e2e8f0; border-radius:6px; margin-top:5px;">
                                <strong>Dr. Ahmad</strong> <span style="font-size:0.75rem; color:var(--text-muted);">Dentist</span>
                            </div>
                            <div style="padding:8px; background:white; border:1px solid #e2e8f0; border-radius:6px; margin-top:5px;">
                                <strong>Staff Team</strong> <span style="font-size:0.75rem; color:var(--text-muted);">Nurses & Assistants</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('profileModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 7. EDIT INVOICE MODAL -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa-solid fa-file-invoice-dollar"></i> Edit Invoice</h3>
                <button onclick="closeModal('invoiceModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div style="background:#f8fafc; padding:12px; border-radius:10px; margin-bottom:12px; border:1px solid #e2e8f0; font-size:0.85rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-muted);">Patient</span><span style="font-weight:700;" id="bill-p-name">-</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;"><span style="color:var(--text-muted);">Date</span><span style="font-weight:600;" id="bill-date">-</span></div>
                    <div style="display:flex; justify-content:space-between;"><span style="color:var(--text-muted);">Phone</span><span style="font-weight:600;" id="bill-phone">-</span></div>
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:5px;">Payment Method</label>
                    <select id="bill-payment-method" class="form-input">
                        <option value="CASH">Cash</option>
                        <option value="QR">QR Code (DuitNow/TouchNGo)</option>
                        <option value="BANK TRANSFER">Bank Transfer</option>
                    </select>
                </div>

                <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-size:0.8rem; font-weight:700;">Services</label>
                    <button class="btn-sm" onclick="addInvoiceItem()" style="font-size:0.75rem; padding:6px 10px;">+ Add</button>
                </div>
                <div class="table-responsive" style="border:none; margin-bottom:15px;"><table class="invoice-table" style="font-size:0.85rem;"><thead><tr><th style="width:40%">Item</th><th style="width:20%; text-align:right">Qty</th><th style="width:20%; text-align:right">Price</th><th style="width:20%; text-align:right">Total</th><th></th></tr></thead><tbody id="bill-items-body"></tbody></table></div>
                <div style="text-align:right; padding-top:15px; border-top:2px solid #e2e8f0;">
                    <span style="color:var(--text-muted); font-size:0.85rem;">Grand Total</span>
                    <div style="font-size:1.5rem; font-weight:800; color:var(--primary); margin-top:5px;">RM <span id="bill-grand-total">0.00</span></div>
                </div>
            </div>
            <div class="modal-footer no-print">
                <button class="btn-sm" onclick="closeModal('invoiceModal')">Cancel</button>
                <button class="btn-sm btn-bill" onclick="saveAndPrintInvoice()">Save & Refresh</button>
            </div>
        </div>
    </div>

    <!-- 8. EDIT PATIENT MODAL -->
    <div class="modal-overlay" id="editPatientModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="patient-modal-title">Add Patient</h3><button onclick="closeModal('editPatientModal')"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-patient-id">
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Full Name</label><input type="text" id="edit-patient-name" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">Phone</label><input type="tel" id="edit-patient-phone" class="form-input"></div>
                <div style="margin-bottom:15px;"><label style="font-size:0.8rem; font-weight:700;">IC</label><input type="text" id="edit-patient-ic" class="form-input"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('editPatientModal')">Cancel</button>
                <button class="btn-primary" style="width:auto; padding:10px 20px;" onclick="savePatientEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 9. CONFIRM CANCEL MODAL -->
    <div class="modal-overlay" id="confirmCancelModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="color: var(--danger);">Cancel Appointment?</h3>
                <button onclick="closeModal('confirmCancelModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Are you sure you want to cancel this appointment? This action cannot be undone.</p>
                <input type="hidden" id="cancel-appt-id">
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('confirmCancelModal')">No, Keep It</button>
                <button class="btn-sm btn-delete" onclick="executeCancel()">Yes, Cancel It</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast">
        <i class="fa-solid fa-circle-check" style="color:#4ade80;"></i> 
        <span id="toastMsg">Action Successful</span>
    </div>
    
    <!-- OPENWIDGET SCRIPT -->
    <script>
      window.__ow = window.__ow || {};
      window.__ow.organizationId = "5f28e53d-8b59-4e4b-881a-befc6c4b6d45";
      window.__ow.integration_name = "manual_settings";
      window.__ow.product_name = "openwidget";   
      ;(function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[OpenWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.openwidget.com/openwidget.js",t.head.appendChild(n)}};!n.__ow.asyncInit&&e.init(),n.OpenWidget=n.OpenWidget||e}(window,document,[].slice))
    </script>
    <noscript>You need to <a href="https://www.openwidget.com/enable-javascript" rel="noopener nofollow">enable JavaScript</a> to use communication tool powered by <a href="https://www.openwidget.com/" rel="noopener nofollow" target="_blank">OpenWidget</a></noscript>
    <!-- End of OpenWidget code -->

    <script>
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://qdqkhakhpvqodixecjdl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkcWtoYWtocHZxb2RpeGVjamRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDY2NzQsImV4cCI6MjA4NTk4MjY3NH0.r8sfbz70szeKvv_vrMn1JboYsGs6KMAxZyoSbmDYvhc';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let patients = []; 
        let services = [];
        let staff = [];
        let appointments = [];
        let slotExceptions = []; 

        const SESSION_KEY = 'clinicUser';
        const todayStr = new Date().toISOString().split('T')[0];
        
        const todayObj = new Date();
        const tomorrowObj = new Date(todayObj);
        tomorrowObj.setDate(tomorrowObj.getDate() + 1);
        const minBookingDate = tomorrowObj.toISOString().split('T')[0];

        let currentCalDate = new Date();
        let selectedBookingDate = null;
        let selectedBookingTime = null;
        let currentBillAppt = null;
        let deleteTarget = null;
        let historyPatientId = null; // For Manual History

        const defaultSlots = ["09:00 AM", "09:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM", "02:00 PM", "02:30 PM", "03:00 PM", "03:30 PM", "04:00 PM", "04:30 PM", "05:00 PM", "05:30 PM"];
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const storedUser = localStorage.getItem(SESSION_KEY);
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                setupUserUI(currentUser);
                document.getElementById('login-screen').classList.add('hidden');
                setTimeout(() => document.getElementById('login-screen').style.display = 'none', 500);
                startLiveClock();
                await refreshData(); 
                navigateTo('dashboard');
            }
            
            window.onmousemove = resetInactivityTimer;
            window.onkeypress = resetInactivityTimer;
            window.onclick = resetInactivityTimer;
            window.onscroll = resetInactivityTimer;
        });

        // --- SMART ID GENERATOR ---
        async function generateSmartId(table, prefix) {
            const { data, error } = await db
                .from(table)
                .select('id')
                .order('id', { ascending: false })
                .limit(1)
                .single();
            
            let nextNum = 1;
            if (data && data.id) {
                const parts = data.id.split('-');
                const lastNum = parseInt(parts[parts.length - 1]);
                if (!isNaN(lastNum)) {
                    nextNum = lastNum + 1;
                }
            }
            
            const numStr = String(nextNum).padStart(4, '0');
            return `${prefix}-${numStr}`;
        }

        // --- NEW SMART INVOICE ID GENERATOR ---
        async function generateInvoiceId(dateStr) {
            const [year, month, day] = dateStr.split('-');
            const prefix = `KPA-${year}${month}-`;

            const { data, error } = await db
                .from('klinikazam_appointments')
                .select('invoice_id')
                .like('invoice_id', `${prefix}%`)
                .order('invoice_id', { ascending: false })
                .limit(1)
                .single();

            let nextNum = 1;
            
            if (data && data.invoice_id) {
                const parts = data.invoice_id.split('-');
                const lastNum = parseInt(parts[2]);
                if (!isNaN(lastNum)) {
                    nextNum = lastNum + 1;
                }
            }

            const numStr = String(nextNum).padStart(4, '0');
            return `${prefix}${numStr}`;
        }

        // --- SUPABASE DATA FETCHING (Using Table Prefixes) ---
        async function refreshData() {
            // 1. Fetch Patients
            const { data: pData, error: pError } = await db.from('klinikazam_patients').select('*').order('name', { ascending: true });
            if(!pError) patients = pData;

            // 2. Fetch Services
            const { data: sData, error: sError } = await db.from('klinikazam_services').select('*');
            if(!sError) services = sData;

            // 3. Fetch Staff
            const { data: stData, error: stError } = await db.from('klinikazam_staff').select('*');
            if(!stError) staff = stData;

            // 4. Fetch Appointments
            const { data: aData, error: aError } = await db.from('klinikazam_appointments').select('*').order('date', { ascending: true });
            if(!aError) appointments = aData;

            // 5. Fetch Slot Exceptions
            const { data: eData, error: eError } = await db.from('klinikazam_slots').select('*');
            if(!eError) slotExceptions = eData;

            const currentViewId = document.querySelector('.view-section.active')?.id.replace('view-', '');
            
            if(currentViewId === 'dashboard') renderDashboard();
            if(currentViewId === 'patients') renderPatients();
            if(currentViewId === 'services') renderServices();
            if(currentViewId === 'staff') renderStaff();
            if(currentViewId === 'slots') renderSlots();
            if(currentViewId === 'billing') renderBilling();
            if(currentViewId === 'reports') updateReports();
            if(currentViewId === 'appointments') renderAppointments();
            if(currentViewId === 'booking') {
                resetBookingForm(); 
                renderCalendar(currentCalDate);
                initCustomPatientSearch(); 
            }
            
            populateServiceDropdowns();
        }

        // --- AUTHENTICATION ---
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            const { data, error } = await db
                .from('klinikazam_staff')
                .select('*')
                .eq('username', u)
                .eq('password', p) 
                .single();

            if (data) {
                currentUser = data;
                localStorage.setItem(SESSION_KEY, JSON.stringify(data));
                setupUserUI(data);
                document.getElementById('login-screen').classList.add('hidden');
                setTimeout(() => document.getElementById('login-screen').style.display = 'none', 500);
                startLiveClock();
                await refreshData();
                navigateTo('dashboard');
                resetInactivityTimer();
                loginError.innerText = "";
            } else {
                loginError.innerText = "Invalid credentials";
            }
        }

        function logout() {
            localStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        // --- NAVIGATION & UI ---
        function navigateTo(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[onclick="navigateTo('${viewId}')"]`);
            if(navItem) navItem.classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            const titles = { 
                'dashboard':'Dashboard', 'appointments':'Appointments', 'booking':'New Booking', 
                'billing':'Patient Billing', 'reports':'Sales Reports', 'staff':'Staff Management', 
                'patients':'Patients', 'services':'Services', 'slots':'Slot Management', 
                'bill-detail':'Bill Details' 
            };
            document.getElementById('pageTitle').innerText = titles[viewId] || 'Clinic Portal';

            if(document.getElementById('sidebar').classList.contains('mobile-open')) toggleMobileMenu();

            if(viewId === 'dashboard') renderDashboard();
            if(viewId === 'appointments') renderAppointments();
            if(viewId === 'billing') {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(),1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                document.getElementById('billing-start').value = getLocalDateStr(firstDay);
                document.getElementById('billing-end').value = getLocalDateStr(lastDay);
                renderBilling();
            }
            if(viewId === 'reports') {
                document.getElementById('report-date-picker').value = todayStr;
                updateReports();
            }
            if(viewId === 'staff') renderStaff();
            if(viewId === 'patients') renderPatients();
            if(viewId === 'services') renderServices();
            if(viewId === 'slots') {
                document.getElementById('slotDate').value = minBookingDate; 
                renderSlots();
            }
            if(viewId === 'booking') {
                resetBookingForm();
                currentCalDate = new Date(minBookingDate);
                renderCalendar(currentCalDate);
                initCustomPatientSearch();
            }
        }

        function setupUserUI(user) {
            document.getElementById('userNameDisplay').innerText = user.name;
            document.getElementById('userRoleDisplay').innerText = user.role;
            document.getElementById('userAvatar').innerText = user.initials || user.name.substring(0,2).toUpperCase();
            
            document.getElementById('profile-name').innerText = user.name;
            document.getElementById('profile-role').innerText = user.role;
            document.getElementById('profile-u').innerText = user.username;
            document.getElementById('profile-avatar').innerText = user.initials || user.name.substring(0,2).toUpperCase();
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            sidebar.classList.toggle('mobile-open');
            backdrop.classList.toggle('active');
        }

        function startLiveClock() {
            setInterval(() => {
                const now = new Date();
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                document.getElementById('liveClock').innerText = `${hours}:${minutes}:${seconds} ${ampm}`;
                document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                document.getElementById('currentFullDate').innerText = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }, 1000);
        }

        function resetInactivityTimer() {
            clearTimeout(window.inactivityTimer);
            window.inactivityTimer = setTimeout(() => logout(), 30 * 60 * 1000);
        }

        function getLocalDateStr(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(dateStr) {
            if(!dateStr) return '-';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard() {
            const todaysAppts = appointments.filter(a => a.date === todayStr && a.status !== 'Cancelled');
            document.getElementById('d-stat-today').innerText = todaysAppts.length;
            document.getElementById('d-stat-history').innerText = patients.length;
            
            const todaySales = calculateTotalForDate(todayStr);
            document.getElementById('d-stat-sales').innerText = 'RM ' + todaySales.toLocaleString();

            const tbody = document.querySelector('#dashboard-table tbody');
            tbody.innerHTML = '';
            todaysAppts.forEach(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const sId = a.items && a.items[0] ? a.items[0].id : null;
                const sName = sId ? (services.find(s => s.id === sId)?.name || "Service") : "Unknown";
                
                tbody.innerHTML += `
                <tr>
                    <td style="font-weight:700;">${a.time}</td>
                    <td>${pName}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        ${a.status !== 'Completed' ? `<a href="#" class="btn-sm btn-wa" onclick="sendWhatsapp('${pName}', '${a.date}', '${a.time}', '${p ? p.phone : ''}')"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
                        <button class="btn-sm" onclick="openEditAppt('${a.id}')"><i class="fa-solid fa-pen"></i></button> 
                        ${a.status === 'Completed' ? `<button class="btn-sm btn-bill" onclick="viewBillDetail('${a.id}')"><i class="fa-solid fa-file-invoice"></i></button>` : `<button class="btn-sm btn-bill" onclick="createCashbill('${a.id}')"><i class="fa-solid fa-file-invoice-dollar"></i> Bill</button>`}
                        <button class="btn-sm btn-delete" onclick="requestDelete('appointment', '${a.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function calculateTotalForDate(dateStr) {
            let total = 0;
            const dayAppts = appointments.filter(a => a.date === dateStr && a.status === 'Completed');
            dayAppts.forEach(a => {
                if(a.items) {
                    a.items.forEach(i => { total += (i.price * i.qty); });
                }
            });
            return total;
        }

        // --- APPOINTMENTS LOGIC ---
        function renderAppointments() {
            const queryAppt = document.querySelector('#view-appointments .search-input')?.value.toLowerCase() || '';
            
            const schedule = appointments.filter(a => a.status !== 'Cancelled' && a.status !== 'Completed').sort((a,b) => new Date(a.date) - new Date(b.date));
            
            let filteredSchedule = schedule;
            if(queryAppt) {
                filteredSchedule = schedule.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ').toLowerCase() : '';
                    return pName.includes(queryAppt) || sName.includes(queryAppt) || a.date.includes(queryAppt);
                });
            }

            const tBody = document.querySelector('#today-table tbody');
            tBody.innerHTML = '';
            filteredSchedule.forEach(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const pPhone = p ? p.phone : '-';
                const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ') : "Unknown";
                
                tBody.innerHTML += `
                <tr>
                    <td>${formatDateDisplay(a.date)}</td>
                    <td style="font-weight:700; color:var(--primary);">${a.time}</td>
                    <td>${pName}</td>
                    <td>${pPhone}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-${a.status.toLowerCase()}">${a.status}</span></td>
                    <td>
                        <a href="#" class="btn-sm btn-wa" onclick="sendWhatsapp('${pName}', '${a.date}', '${a.time}', '${pPhone}')"><i class="fa-brands fa-whatsapp"></i></a>
                        <button class="btn-sm" onclick="openEditAppt('${a.id}')"><i class="fa-solid fa-pen"></i></button> 
                        <button class="btn-sm btn-bill" onclick="createCashbill('${a.id}')"><i class="fa-solid fa-file-invoice-dollar"></i> Bill</button>
                        <button class="btn-sm btn-delete" onclick="openCancelConfirm('${a.id}')"><i class="fa-solid fa-ban"></i> Cancel</button>
                    </td>
                </tr>`;
            });

            const history = appointments.filter(a => a.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date));
            const hBody = document.querySelector('#history-table tbody');
            hBody.innerHTML = '';
            history.forEach(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ') : "Unknown";
                const invDisplay = a.invoice_id || `INV-${a.id}`;
                hBody.innerHTML += `
                <tr>
                    <td>${formatDateDisplay(a.date)}</td>
                    <td style="font-weight:600;">${a.time}</td>
                    <td>${pName}</td>
                    <td>${sName}</td>
                    <td><span class="badge badge-completed">Completed</span></td>
                    <td>
                        <span class="invoice-link" onclick="viewBillDetail('${a.id}')">[${invDisplay}]</span>
                    </td>
                </tr>`;
            });
            
            const cancelled = appointments.filter(a => a.status === 'Cancelled');
            const cBody = document.querySelector('#cancelled-table tbody');
            cBody.innerHTML = '';
            cancelled.forEach(a => {
                const p = patients.find(p => p.id === a.patient_id);
                const pName = p ? p.name : 'Unknown';
                const sName = a.items ? a.items.map(i => services.find(s=>s.id===i.id)?.name).join(', ') : "Unknown";
                cBody.innerHTML += `<tr><td>${formatDateDisplay(a.date)}</td><td style="font-weight:600; color:var(--danger);">${a.time}</td><td>${pName}</td><td>${sName}</td><td><button class="btn-sm btn-delete" onclick="requestDelete('appointment', '${a.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        // --- BILLING LOGIC ---
        function renderBilling() {
            const start = document.getElementById('billing-start').value;
            const end = document.getElementById('billing-end').value;
            const query = document.querySelector('#view-billing .search-input')?.value.toLowerCase() || '';

            const tbody = document.querySelector('#billing-table tbody');
            const totalDisplay = document.getElementById('billing-total-amount');

            if(!start || !end) return;

            let filteredAppts = appointments.filter(a => 
                a.status === 'Completed' && 
                a.date >= start && 
                a.date <= end
            );

            if(query) {
                filteredAppts = filteredAppts.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const invId = a.invoice_id ? a.invoice_id.toLowerCase() : `inv-${a.id}`;
                    return pName.includes(query) || invId.includes(query);
                });
            }
            
            let total = 0;
            filteredAppts.forEach(a => {
                if(a.items) {
                    a.items.forEach(i => { total += (i.price * i.qty); });
                }
            });

            totalDisplay.innerText = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            tbody.innerHTML = '';
            if(filteredAppts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No bills found in this period.</td></tr>';
            } else {
                filteredAppts.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name : 'Unknown';
                    const pPhone = p ? p.phone : '-';
                    const displayId = a.invoice_id || `INV-${a.id}`;
                    
                    let itemsStr = a.items.map(i => {
                        const s = services.find(sv => sv.id === i.id);
                        return `${s ? s.name : 'Unknown'} (x${i.qty})`;
                    }).join(', ');
                    
                    let apptTotal = a.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                    tbody.innerHTML += `
                    <tr>
                        <td><span class="invoice-link" onclick="viewBillDetail('${a.id}')">${displayId}</span></td>
                        <td>${formatDateDisplay(a.date)}</td>
                        <td>${pName}</td>
                        <td>${pPhone}</td>
                        <td><small>${itemsStr}</small></td>
                        <td style="font-weight:700; color:var(--primary);">RM ${apptTotal}</td>
                        <td><span class="badge badge-completed">Billed</span></td>
                        <td>
                            <button class="btn-sm btn-bill" onclick="viewBillDetail('${a.id}')"><i class="fa-solid fa-eye"></i> View</button>
                        </td>
                    </tr>`;
                });
            }
        }

        // --- CSV EXPORT LOGIC ---
        function exportData() {
            const start = document.getElementById('export-start').value;
            const end = document.getElementById('export-end').value;
            
            let data = appointments.filter(a => 
                a.status === 'Completed' && 
                a.date >= start && 
                a.date <= end
            ).map(a => {
                const p = patients.find(pt => pt.id === a.patient_id);
                return {
                    Date: a.date,
                    Time: a.time,
                    Patient: p ? p.name : 'Unknown',
                    Phone: p ? p.phone : '-',
                    Invoice: a.invoice_id || '-',
                    Total: a.items.reduce((sum, i) => sum + (i.price * i.qty), 0)
                };
            });

            if(data.length === 0) {
                showToast("No data to export.");
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," 
                + Object.keys(data[0]).join(",") + "\n" 
                + data.map(e => Object.values(e).join(",")).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `report_${start}_to_${end}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Report Downloaded");
        }

        function exportBillingData() {
            const start = document.getElementById('billing-start').value;
            const end = document.getElementById('billing-end').value;
            
            // Same logic as exportData, can be customized if needed
            exportData();
        }

        // --- RECEIPT VIEW ---
        async function viewBillDetail(id) {
            const a = appointments.find(x => x.id === id);
            if(!a) return;

            currentBillAppt = a;
            const p = patients.find(pt => pt.id === a.patient_id);

            if (!a.invoice_id && a.status === 'Completed') {
                const newId = await generateInvoiceId(a.date);
                const { error } = await db.from('klinikazam_appointments').update({ invoice_id: newId }).eq('id', a.id);
                if(!error) {
                    a.invoice_id = newId;
                    showToast("Invoice ID Generated");
                }
            }

            document.getElementById('receiptNo').innerText = a.invoice_id || 'Pending Generation';
            document.getElementById('receiptDate').innerText = formatDateDisplay(a.date);
            document.getElementById('receiptTime').innerText = a.time;

            document.getElementById('r-patient-name').value = p ? p.name : 'Unknown';
            document.getElementById('r-patient-phone').value = p ? p.phone : '-';
            document.getElementById('r-patient-ic').value = p ? p.ic : '-';

            document.getElementById('r-payment-method').innerText = a.payment_method || 'CASH';

            const tbody = document.getElementById('r-items-body');
            tbody.innerHTML = '';
            let total = 0;

            if(a.items) {
                a.items.forEach((item, index) => {
                    const s = services.find(s => s.id === item.id);
                    const name = s ? s.name : 'Unknown Service';
                    const lineTotal = item.price * item.qty;
                    total += lineTotal;

                    tbody.innerHTML += `
                        <tr>
                            <td style="color:var(--text-muted); font-size: 0.8rem;">${index + 1}</td>
                            <td><div class="rp-item-name">${name}</div></td>
                            <td class="rp-col-center">${item.qty}</td>
                            <td class="rp-col-right"><span class="rp-price">RM ${item.price.toFixed(2)}</span></td>
                            <td class="rp-col-right"><span class="rp-price">RM ${lineTotal.toFixed(2)}</span></td>
                        </tr>
                    `;
                });
            }

            document.getElementById('r-subtotal').innerText = `RM ${total.toFixed(2)}`;
            document.getElementById('r-total').innerText = `RM ${total.toFixed(2)}`;

            const clinicPhone = "60123456789";
            const msg = encodeURIComponent(`Hi Klinik Azam, I have a question regarding receipt ${a.invoice_id}`);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://wa.me/${clinicPhone}?text=${msg}`;
            document.getElementById('r-qr-img').src = qrUrl;

            const stamp = document.getElementById('rp-stamp');
            if(a.status === 'Completed') {
                stamp.classList.add('visible');
            } else {
                stamp.classList.remove('visible');
            }

            navigateTo('bill-detail');
        }

        async function updatePatientFromReceipt() {
            if(!currentBillAppt) return;
            const newName = document.getElementById('r-patient-name').value;
            const newPhone = document.getElementById('r-patient-phone').value;
            const newIC = document.getElementById('r-patient-ic').value;

            const { error } = await db.from('klinikazam_patients')
                .update({ name: newName, phone: newPhone, ic: newIC })
                .eq('id', currentBillAppt.patient_id);
            
            if(!error) {
                showToast("Patient Information Updated");
                await refreshData(); 
            }
        }

        function openEditInvoiceFromPage() {
            openInvoice(currentBillAppt.id);
        }

        // --- REPORTS ---
        function updateReports() {
            const dateVal = document.getElementById('report-date-picker').value;
            const query = document.querySelector('#view-reports .search-input')?.value.toLowerCase() || '';
            const tbody = document.querySelector('#report-table tbody');
            const totalDisplay = document.getElementById('report-total-amount');
            
            const total = calculateTotalForDate(dateVal);
            totalDisplay.innerText = total.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            
            let dayAppts = appointments.filter(a => a.date === dateVal && a.status === 'Completed').sort((a,b) => new Date(a.time) - new Date(b.time));
            if(query) {
                dayAppts = dayAppts.filter(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name.toLowerCase() : '';
                    const sName = a.items ? a.items.map(i => services.find(sv => sv.id === i.id)?.name).join(', ').toLowerCase() : '';
                    return pName.includes(query) || sName.includes(query);
                });
            }
            tbody.innerHTML = '';
            if(dayAppts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No completed transactions for this date.</td></tr>';
            } else {
                dayAppts.forEach(a => {
                    const p = patients.find(pt => pt.id === a.patient_id);
                    const pName = p ? p.name : 'Unknown';
                    let itemsStr = a.items ? a.items.map(i => {
                        const s = services.find(sv => sv.id === i.id);
                        return `${s ? s.name : "Unknown"} (x${i.qty})`;
                    }).join(', ') : '';
                    let apptTotal = a.items ? a.items.reduce((sum, i) => sum + (i.price * i.qty), 0) : 0;
                    tbody.innerHTML += `<tr><td style="font-weight:600;">${a.time}</td><td>${pName}</td><td><small>${itemsStr}</small></td><td style="font-weight:700; color:var(--success);">RM ${apptTotal}</td></tr>`;
                });
            }
        }

        // --- CALENDAR & BOOKING (Portal Side) ---
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('cal-month-year').innerText = `${monthNames[month]} ${year}`;
            const grid = document.getElementById('calendar-days');
            grid.innerHTML = '';
            for(let i=0; i<startingDay; i++) {
                const el = document.createElement('div');
                el.className = 'cal-day empty';
                grid.appendChild(el);
            }
            for(let i=1; i<=daysInMonth; i++) {
                const dayDate = new Date(year, month, i);
                const dateStr = getLocalDateStr(dayDate);
                const el = document.createElement('div');
                let classes = 'cal-day';
                
                if(dateStr < minBookingDate) classes += ' disabled';
                
                if(dateStr === getLocalDateStr(new Date())) classes += ' today'; 
                if(selectedBookingDate === dateStr) classes += ' active';
                el.className = classes;
                el.innerText = i;
                
                const isClosed = slotExceptions.some(e => e.date === dateStr && e.type === 'closed');
                const apptCount = appointments.filter(a => a.date === dateStr && a.status !== 'Cancelled').length;
                const isFull = apptCount >= defaultSlots.length;

                if(isClosed || isFull || dateStr < minBookingDate) classes += ' disabled';
                el.className = classes;
                
                if(!classes.includes('disabled')) {
                    el.onclick = () => selectDate(dateStr);
                }
                grid.appendChild(el);
            }
        }

        function changeMonth(delta) {
            const year = currentCalDate.getFullYear();
            const month = currentCalDate.getMonth();
            currentCalDate = new Date(year, month + delta,1);
            renderCalendar(currentCalDate);
        }

        async function selectDate(dateStr) {
            if(dateStr < minBookingDate) {
                showToast("Booking must be at least 1 day in advance.");
                return;
            }

            selectedBookingDate = dateStr;
            selectedBookingTime = null;
            renderCalendar(currentCalDate);
            await renderBookingSlots(dateStr);
            const displayDate = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'long' });
            document.getElementById('slot-date-display').innerText = displayDate;
            document.getElementById('slot-sub-display').innerText = "Select a time slot";
            document.getElementById('summary-date').innerText = formatDateDisplay(dateStr);
            checkBookingFormComplete();
        }

        async function renderBookingSlots(dateStr) {
            const list = document.getElementById('booking-slots-list');
            list.innerHTML = '';
            
            const bookedTimes = appointments.filter(a => a.date === dateStr && a.status !== 'Cancelled' && a.status !== 'Completed').map(a => a.time);
            const blocked = slotExceptions.filter(e => e.date === dateStr && e.type === 'blocked').map(e => e.time);

            defaultSlots.forEach(time => {
                const isBooked = bookedTimes.includes(time);
                const isBlocked = blocked.includes(time);
                const btn = document.createElement('div');
                let className = 'slot-item';
                if(isBooked) {
                    className += ' booked';
                    btn.innerHTML = `${time} <small>Booked</small>`;
                } else if (isBlocked) {
                    className += ' blocked';
                    btn.innerHTML = `${time} <small>Break</small>`;
                } else {
                    btn.innerHTML = time;
                    btn.onclick = () => selectTime(time, btn);
                }
                btn.className = className;
                list.appendChild(btn);
            });
        }

        function selectTime(time, el) {
            selectedBookingTime = time;
            document.querySelectorAll('.slot-item').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('slot-sub-display').innerText = `Selected: ${time}`;
            document.getElementById('summary-time').innerText = time;
            checkBookingFormComplete();
        }

        // --- CUSTOM PATIENT SEARCH DROPDOWN ---
        function initCustomPatientSearch() {
            const searchInput = document.getElementById('bk-pat-search');
            const list = document.getElementById('bk-pat-list');
            const clearBtn = document.getElementById('clear-pat-search');
            
            const sortedPatients = [...patients].sort((a, b) => a.name.localeCompare(b.name));

            function renderList(filterText = '') {
                list.innerHTML = '';
                const lowerFilter = filterText.toLowerCase();
                const filtered = sortedPatients.filter(p => 
                    p.name.toLowerCase().includes(lowerFilter) || 
                    (p.phone && p.phone.includes(lowerFilter))
                );
                
                if (filtered.length === 0) {
                    list.innerHTML = '<li class="no-option">No patients found</li>';
                } else {
                    filtered.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `<div>${p.name}</div><span class="sub-text">${p.phone || 'No Phone'}</span>`;
                        li.onclick = () => selectPatient(p);
                        list.appendChild(li);
                    });
                }
            }

            searchInput.addEventListener('focus', () => {
                renderList(searchInput.value);
                list.classList.add('show');
            });

            searchInput.addEventListener('input', (e) => {
                renderList(e.target.value);
                document.getElementById('bk-pat-select').value = ''; 
                document.getElementById('bk-review-phone').value = '';
                document.getElementById('bk-review-ic').value = '';
                clearBtn.style.display = 'block';
                checkBookingFormComplete();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-select-wrapper')) {
                    list.classList.remove('show');
                }
            });

            clearBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                clearPatientSelection();
                searchInput.focus();
            });
        }

        function selectPatient(p) {
            const searchInput = document.getElementById('bk-pat-search');
            const clearBtn = document.getElementById('clear-pat-search');
            
            searchInput.value = p.name; 
            document.getElementById('bk-pat-select').value = p.id; 
            document.getElementById('bk-review-phone').value = p.phone;
            document.getElementById('bk-review-ic').value = p.ic || '-';
            document.getElementById('bk-pat-list').classList.remove('show'); 
            
            clearBtn.style.display = 'block';
            
            checkBookingFormComplete();
        }

        function clearPatientSelection() {
            const searchInput = document.getElementById('bk-pat-search');
            const clearBtn = document.getElementById('clear-pat-search');
            
            searchInput.value = '';
            document.getElementById('bk-pat-select').value = ''; 
            document.getElementById('bk-review-phone').value = '';
            document.getElementById('bk-review-ic').value = '';
            
            clearBtn.style.display = 'none'; 
            checkBookingFormComplete();
        }

        // --- SAVING BOOKING (Uses Smart ID) ---
        async function saveNewBooking(e) {
            e.preventDefault();
            const isNew = document.querySelector('input[name="patType"]:checked').value === 'new';
            let patientId;

            if(!selectedBookingDate || !selectedBookingTime) {
                showToast("Please select Date and Time.");
                return;
            }
            const sId = parseInt(document.getElementById('bk-service').value);
            const srv = services.find(s=>s.id === sId);
            const sPrice = srv ? srv.price : 0;

            if(isNew) {
                const name = document.getElementById('bk-name').value;
                const phone = document.getElementById('bk-phone').value;
                const ic = document.getElementById('bk-ic').value;

                let existing = patients.find(p => p.phone === phone);
                if(!existing) {
                    const smartId = await generateSmartId('klinikazam_patients', 'PAT');
                    const newPat = { id: smartId, name, phone, ic: ic || '-' };
                    const { data, error } = await db.from('klinikazam_patients').insert([newPat]).select();
                    if(error) { showToast("Error creating patient"); return; }
                    patientId = data[0].id;
                } else {
                    showToast("Patient exists. Using existing ID.");
                    patientId = existing.id;
                }
            } else {
                const pidRaw = document.getElementById('bk-pat-select').value;
                if (!pidRaw) { showToast("Please select a valid patient from the list."); return; }
                patientId = pidRaw;
            }

            if(patientId) {
                const smartId = await generateSmartId('klinikazam_appointments', 'APT');
                const newAppt = {
                    id: smartId,
                    patient_id: patientId,
                    date: selectedBookingDate,
                    time: selectedBookingTime,
                    items: [{ id: sId, qty:1, price: sPrice }],
                    status: 'Pending',
                    payment_method: 'CASH',
                    invoice_id: null
                };

                const { error } = await db.from('klinikazam_appointments').insert([newAppt]);
                if(error) {
                    showToast("Error booking.");
                } else {
                    showToast("Booking Confirmed");
                    await refreshData(); 
                    renderAppointments();
                    renderDashboard();
                    resetBookingForm();
                }
            }
        }

        function resetBookingForm() {
            selectedBookingDate = null; selectedBookingTime = null; currentCalDate = new Date(minBookingDate);
            document.getElementById('newBookingForm').reset();
            document.querySelector('input[name="patType"][value="new"]').checked = true;
            togglePatientType();
            clearPatientSelection();
            document.getElementById('confirm-booking-btn').disabled = true;
            document.getElementById('slot-date-display').innerText = "Select a Date";
            document.getElementById('booking-slots-list').innerHTML = `<div style="text-align:center; color:var(--text-muted); margin-top:30px; font-size:0.85rem;"><i class="fa-regular fa-calendar" style="font-size:1.5rem; margin-bottom:8px; opacity:0.3;"></i><br>Select date from calendar</div>`;
            document.getElementById('summary-date').innerText = "-"; document.getElementById('summary-time').innerText = "-";
            renderCalendar(currentCalDate);
            initCustomPatientSearch(); 
        }

        function togglePatientType() {
            const isNew = document.querySelector('input[name="patType"]:checked').value === 'new';
            document.getElementById('new-pat-inputs').style.display = isNew ? 'block' : 'none';
            document.getElementById('old-pat-inputs').style.display = isNew ? 'none' : 'block';
            checkBookingFormComplete();
        }

        function checkBookingFormComplete() {
            const btn = document.getElementById('confirm-booking-btn');
            const service = document.getElementById('bk-service').value;
            if (!selectedBookingDate || !selectedBookingTime || !service) { btn.disabled = true; return; }

            const isNew = document.querySelector('input[name="patType"]:checked').value === 'new';
            let isPatientValid = false;
            if (isNew) {
                const name = document.getElementById('bk-name').value;
                const phone = document.getElementById('bk-phone').value;
                isPatientValid = (name.length > 0 && phone.length > 0);
            } else {
                const pid = document.getElementById('bk-pat-select').value;
                isPatientValid = (pid !== "" && pid !== null && pid !== "undefined");
            }
            btn.disabled = !isPatientValid;
        }

        // --- EDITING APPOINTMENTS ---
        async function openEditAppt(id) {
            const a = appointments.find(x => x.id === id);
            document.getElementById('edit-appt-id').value = id;
            document.getElementById('edit-appt-date').value = a.date;
            await updateEditTimeOptions();
            const srvSelect = document.getElementById('edit-appt-service');
            srvSelect.innerHTML = '';
            services.forEach(s => srvSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            if(a.items && a.items[0]) srvSelect.value = a.items[0].id;
            showModal('editApptModal');
        }

        async function updateEditTimeOptions() {
            const dateVal = document.getElementById('edit-appt-date').value;
            const timeSelect = document.getElementById('edit-appt-time');
            if(!dateVal || dateVal < minBookingDate) {
                timeSelect.innerHTML = '<option value="">Select Valid Future Date</option>'; timeSelect.disabled = true; return;
            }
            timeSelect.disabled = false;
            timeSelect.innerHTML = '<option value="">Select Time</option>';
            
            const bookedTimes = appointments.filter(a => a.date === dateVal && a.status !== 'Cancelled').map(a => a.time);
            const blockedTimes = slotExceptions.filter(e => e.date === dateVal && e.type === 'blocked').map(e => e.time);
            const available = defaultSlots.filter(t => !bookedTimes.includes(t) && !blockedTimes.includes(t));

            if(available.length === 0) {
                const opt = document.createElement('option'); opt.text = "No slots available"; opt.disabled = true; timeSelect.add(opt); timeSelect.disabled = true; 
            } else {
                available.forEach(t => {
                    const opt = document.createElement('option'); opt.value = t; opt.text = t; timeSelect.add(opt);
                });
            }
        }

        async function saveApptEdit() {
            const id = document.getElementById('edit-appt-id').value; 
            const dateVal = document.getElementById('edit-appt-date').value;
            const timeVal = document.getElementById('edit-appt-time').value;
            
            if(dateVal < minBookingDate) { showToast("Cannot book today or past dates."); return; }

            const conflict = appointments.find(a => a.date === dateVal && a.time === timeVal && a.status !== 'Cancelled' && a.status !== 'Completed' && a.id !== id);
            if(conflict) { showToast("Time slot conflict."); return; }

            const sId = parseInt(document.getElementById('edit-appt-service').value);
            const sPrice = services.find(s=>s.id === sId).price;
            
            const { error } = await db.from('klinikazam_appointments').update({
                date: dateVal, time: timeVal, items: [{id: sId, qty:1, price: sPrice}]
            }).eq('id', id);

            if(!error) {
                await refreshData();
                renderAppointments();
                renderDashboard();
                closeModal('editApptModal');
                showToast("Updated");
            }
        }

        // --- INVOICE EDITING ---
        let invoiceItems = [];
        function openInvoice(id) {
            const a = appointments.find(x => x.id === id);
            const p = patients.find(pt => pt.id === a.patient_id);
            currentBillAppt = a;
            document.getElementById('bill-p-name').innerText = p ? p.name : 'Unknown';
            document.getElementById('bill-date').innerText = formatDateDisplay(a.date);
            document.getElementById('bill-phone').innerText = p ? p.phone : '-';
            document.getElementById('bill-payment-method').value = a.payment_method || 'CASH';
            
            if(a.items && a.items.length >0) {
                invoiceItems = JSON.parse(JSON.stringify(a.items));
            } else {
                invoiceItems = [{ id: services[0].id, qty:1, price: services[0].price }];
            }
            renderInvoiceRows();
            showModal('invoiceModal');
        }

        function addInvoiceItem() { invoiceItems.push({ id: services[0].id, qty:1, price: services[0].price }); renderInvoiceRows(); }
        function removeInvoiceItem(idx) { invoiceItems.splice(idx, 1); renderInvoiceRows(); }
        function updateInvoiceItem(idx, field, value) {
            if(field === 'id') {
                const s = services.find(x => x.id == value);
                invoiceItems[idx].price = s.price;
                invoiceItems[idx].id = s.id;
            } else {
                invoiceItems[idx][field] = value;
            }
            renderInvoiceRows();
        }

        function renderInvoiceRows() {
            const tbody = document.getElementById('bill-items-body');
            tbody.innerHTML = '';
            let total = 0;
            invoiceItems.forEach((item, idx) => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                let options = '';
                services.forEach(s => options += `<option value="${s.id}" ${s.id == item.id ? 'selected' : ''}>${s.name}</option>`);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><select class="form-input" style="padding:6px;" onchange="updateInvoiceItem(${idx}, 'id', this.value)">${options}</select></td><td><input type="number" value="${item.qty}" min="1" style="width:100%; text-align:center; border:1px solid #e2e8f0; border-radius:4px;" onchange="updateInvoiceItem(${idx}, 'qty', this.value)"></td><td style="text-align:right;">RM ${item.price}</td><td style="text-align:right; font-weight:700;">RM ${lineTotal}</td><td><button onclick="removeInvoiceItem(${idx})" style="color:var(--danger); background:none;"><i class="fa-solid fa-times"></i></button></td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('bill-grand-total').innerText = total.toFixed(2);
        }

        async function saveAndPrintInvoice() {
            if(!currentBillAppt.invoice_id) {
                currentBillAppt.invoice_id = await generateInvoiceId(currentBillAppt.date);
            }

            currentBillAppt.items = invoiceItems;
            currentBillAppt.payment_method = document.getElementById('bill-payment-method').value;
            currentBillAppt.status = 'Completed';
            
            const { error } = await db.from('klinikazam_appointments').update({
                items: currentBillAppt.items,
                payment_method: currentBillAppt.payment_method,
                status: 'Completed',
                invoice_id: currentBillAppt.invoice_id
            }).eq('id', currentBillAppt.id);

            if(!error) {
                closeModal('invoiceModal');
                await refreshData(); 
                viewBillDetail(currentBillAppt.id);
                showToast("Saved & Ready to Print");
            }
        }

        async function createCashbill(id) {
            const a = appointments.find(x => x.id === id);
            if(a.invoice_id) {
                showToast("Invoice already exists. Opening details.");
                viewBillDetail(id);
                return;
            }

            const invId = await generateInvoiceId(a.date);
            
            const { error } = await db.from('klinikazam_appointments').update({
                status: 'Completed',
                payment_method: 'CASH',
                invoice_id: invId
            }).eq('id', id);

            if(!error) {
                await refreshData(); 
                showToast("Cashbill Created Successfully");
                renderAppointments();
                renderDashboard();
                viewBillDetail(id);
            }
        }

        // --- PATIENTS CRUD ---
        async function renderPatients() {
            const tbody = document.querySelector('#patients-table tbody');
            tbody.innerHTML = '';
            const query = document.querySelector('#view-patients .search-input')?.value.toLowerCase() || '';
            
            const visitCounts = {};
            appointments.forEach(a => {
                if(a.status === 'Completed') {
                    visitCounts[a.patient_id] = (visitCounts[a.patient_id] || 0) + 1;
                }
            });

            let filtered = patients.filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.phone.includes(query) || 
                p.id.includes(query)
            );

            filtered.forEach(p => {
                const count = visitCounts[p.id] || 0;
                tbody.innerHTML += `
                <tr>
                    <td style="font-weight:600;">${p.name}</td>
                    <td>${p.phone}</td>
                    <td>${p.ic}</td>
                    <td>${count}</td>
                    <td>
                        <button class="btn-sm" onclick="openHistory('${p.id}')"><i class="fa-solid fa-clock-rotate-left"></i></button> 
                        <button class="btn-sm" onclick="openEditPatient('${p.id}')"><i class="fa-solid fa-pen"></i></button> 
                        <button class="btn-sm btn-delete" onclick="requestDelete('patient', '${p.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function openEditPatient(id) {
            if(!id) {
                document.getElementById('patient-modal-title').innerText = "Add Patient";
                document.getElementById('edit-patient-id').value = '';
                document.getElementById('edit-patient-name').value = '';
                document.getElementById('edit-patient-phone').value = '';
                document.getElementById('edit-patient-ic').value = '';
            } else {
                const p = patients.find(x => x.id === id);
                document.getElementById('patient-modal-title').innerText = "Edit Patient";
                document.getElementById('edit-patient-id').value = id;
                document.getElementById('edit-patient-name').value = p.name;
                document.getElementById('edit-patient-phone').value = p.phone;
                document.getElementById('edit-patient-ic').value = p.ic;
            }
            showModal('editPatientModal');
        }

        async function savePatientEdit() {
            const idInput = document.getElementById('edit-patient-id').value;
            let id = idInput ? idInput : null;
            const name = document.getElementById('edit-patient-name').value;
            const phone = document.getElementById('edit-patient-phone').value;
            const ic = document.getElementById('edit-patient-ic').value;

            let error = null;
            if(id) {
                const res = await db.from('klinikazam_patients').update({ name, phone, ic }).eq('id', id);
                error = res.error;
            } else {
                id = await generateSmartId('klinikazam_patients', 'PAT');
                const newPat = { id, name, phone, ic: ic || '-' };
                const res = await db.from('klinikazam_patients').insert([newPat]);
                error = res.error;
            }

            if(!error) {
                await refreshData(); 
                renderPatients();
                closeModal('editPatientModal');
                showToast(id ? "Patient Updated" : "Patient Added");
            } else {
                showToast("Error saving data");
            }
        }

        // --- MANUAL PATIENT HISTORY (OLD DATA) ---
        function openHistory(patientId) {
            historyPatientId = patientId;
            const p = patients.find(x => x.id === patientId);
            document.getElementById('hist-p-name').innerText = p.name;
            document.getElementById('hist-p-id').innerText = p.id;
            document.getElementById('hist-p-phone').innerText = p.phone;
            
            // Set default date to today
            document.getElementById('hist-date').value = todayStr;

            // Populate History List
            const history = appointments.filter(a => a.patient_id === patientId && a.status === 'Completed').sort((a,b) => new Date(b.date) - new Date(a.date));
            const tbody = document.getElementById('historyListBody');
            tbody.innerHTML = '';
            if(history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No history found.</td></tr>';
            } else {
                history.forEach(a => {
                    const s = services.find(x => x.id === (a.items && a.items[0] ? a.items[0].id : null));
                    const invId = a.invoice_id || `INV-${a.id}`;
                    tbody.innerHTML += `<tr><td>${a.date}</td><td>${s ? s.name : 'Unknown'}</td><td>${invId}</td></tr>`;
                });
            }
            showModal('historyModal');
        }

        async function saveManualHistory() {
            if(!historyPatientId) return;
            const date = document.getElementById('hist-date').value;
            const sId = parseInt(document.getElementById('hist-service').value);
            const qty = parseInt(document.getElementById('hist-qty').value) || 1;
            const price = parseFloat(document.getElementById('hist-price').value) || 0;
            
            if(!date || !sId) {
                showToast("Please select Date and Service.");
                return;
            }

            const smartId = await generateSmartId('klinikazam_appointments', 'APT');
            // Create a manual invoice ID based on date to separate from normal flow
            const manualInvId = `OLD-${date.replace(/-/g,'')}`;

            const newAppt = {
                id: smartId,
                patient_id: historyPatientId,
                date: date,
                time: "12:00 PM", // Default for manual entry
                items: [{ id: sId, qty: qty, price: price }],
                status: 'Completed',
                payment_method: 'CASH',
                invoice_id: manualInvId
            };

            const { error } = await db.from('klinikazam_appointments').insert([newAppt]);
            if(!error) {
                showToast("Old data added successfully");
                openHistory(historyPatientId);
                await refreshData();
            } else {
                showToast("Error saving history");
            }
        }

        // --- STAFF CRUD ---
        async function renderStaff() {
            const tbody = document.querySelector('#staff-table tbody');
            tbody.innerHTML = '';
            const query = document.querySelector('#view-staff .search-input')?.value.toLowerCase() || '';
            
            let filtered = staff.filter(s => 
                s.name.toLowerCase().includes(query) || 
                s.role.toLowerCase().includes(query) ||
                s.username.toLowerCase().includes(query)
            );

            filtered.forEach(s => {
                tbody.innerHTML += `<tr><td style="font-weight:600;">${s.name}</td><td><span class="badge badge-info">${s.role}</span></td><td>${s.id}</td><td><button class="btn-sm" onclick="openEditStaff('${s.id}')"><i class="fa-solid fa-pen"></i></button> <button class="btn-sm btn-delete" onclick="requestDelete('staff', '${s.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function openEditStaff(id) {
            if(!id) {
                document.getElementById('edit-staff-id').value = '';
                document.getElementById('edit-staff-name').value = '';
                document.getElementById('edit-staff-role').value = 'Dentist';
                document.getElementById('edit-staff-u').value = '';
            } else {
                const s = staff.find(x => x.id === id);
                document.getElementById('edit-staff-id').value = id;
                document.getElementById('edit-staff-name').value = s.name;
                document.getElementById('edit-staff-role').value = s.role;
                document.getElementById('edit-staff-u').value = s.username;
            }
            showModal('editStaffModal');
        }

        async function saveStaffEdit() {
            const idInput = document.getElementById('edit-staff-id').value;
            let id = idInput ? idInput : null;
            const name = document.getElementById('edit-staff-name').value;
            const role = document.getElementById('edit-staff-role').value;
            const u = document.getElementById('edit-staff-u').value;
            
            let error = null;
            if(id) {
                const res = await db.from('klinikazam_staff').update({ name, role, username: u }).eq('id', id);
                error = res.error;
            } else {
                id = await generateSmartId('klinikazam_staff', 'STF');
                const newStaff = { id, name, role, username: u, password: '1234', initials: name.substring(0,2).toUpperCase() };
                const res = await db.from('klinikazam_staff').insert([newStaff]);
                error = res.error;
            }

            if(!error) {
                await refreshData(); 
                renderStaff();
                closeModal('editStaffModal');
                showToast(id ? "Staff Updated" : "Staff Added");
            }
        }

        // --- SERVICES CRUD ---
        async function renderServices() {
            const tbody = document.querySelector('#services-table tbody');
            tbody.innerHTML = '';
            services.forEach(s => {
                tbody.innerHTML += `<tr><td>${s.name}</td><td style="font-weight:700;">RM ${s.price}</td><td><button class="btn-sm" onclick="openEditService('${s.id}')"><i class="fa-solid fa-pen"></i></button> <button class="btn-sm btn-delete" onclick="requestDelete('service', '${s.id}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }

        function openEditService(id) {
            if(!id) {
                document.getElementById('service-modal-title').innerText = "Add Service";
                document.getElementById('edit-service-id').value = '';
                document.getElementById('edit-service-name').value = '';
                document.getElementById('edit-service-price').value = '';
            } else {
                const s = services.find(x => x.id === id);
                document.getElementById('service-modal-title').innerText = "Edit Service";
                document.getElementById('edit-service-id').value = id;
                document.getElementById('edit-service-name').value = s.name;
                document.getElementById('edit-service-price').value = s.price;
            }
            showModal('editServiceModal');
        }

        async function saveServiceEdit() {
            const idInput = document.getElementById('edit-service-id').value;
            const id = idInput ? parseInt(idInput) : null;
            const name = document.getElementById('edit-service-name').value;
            const price = parseFloat(document.getElementById('edit-service-price').value);

            let error = null;
            if(id) {
                const res = await db.from('klinikazam_services').update({ name, price }).eq('id', id);
                error = res.error;
            } else {
                const newSvc = { id: Date.now(), name, price };
                const res = await db.from('klinikazam_services').insert([newSvc]);
                error = res.error;
            }

            if(!error) {
                await refreshData(); 
                renderServices();
                closeModal('editServiceModal');
                showToast(id ? "Service Updated" : "Service Added");
            }
        }

        // --- SLOT MANAGEMENT ---
        async function renderSlots() {
            const dateVal = document.getElementById('slotDate').value;
            const grid = document.getElementById('slotGrid');
            const btn = document.getElementById('clinicStatusBtn');
            grid.innerHTML = `<div style="grid-column: 1/-1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 150px;"><div class="spinner"></div></div>`;

            const isClosed = slotExceptions.some(e => e.date === dateVal && e.type === 'closed');
            
            grid.innerHTML = '';
            if(isClosed) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:20px; color:var(--text-muted); background:#fff; border-radius:12px; font-weight:600;">Clinic Closed</div>';
                btn.innerHTML = '<i class="fa-solid fa-toggle-off"></i> Open Clinic';
                return;
            } else {
                btn.innerHTML = '<i class="fa-solid fa-toggle-on"></i> Set as Closed';
            }

            const blocked = slotExceptions.filter(e => e.date === dateVal && e.type === 'blocked').map(e => e.time);
            const bookedAppts = appointments.filter(a => a.date === dateVal && a.status !== 'Cancelled' && a.status !== 'Completed');
            
            defaultSlots.forEach(time => {
                const isBlocked = blocked.includes(time);
                const booking = bookedAppts.find(a => a.time === time);
                const p = booking ? patients.find(pt => pt.id === booking.patient_id) : null;
                const btnDiv = document.createElement('div');
                let className = 'slot-btn';
                
                if (booking) {
                    className += ' booked';
                    btnDiv.innerHTML = `${time}<br><small>${p ? p.name : 'Unknown'}</small>`;
                } else if (isBlocked) {
                    className += ' blocked';
                    btnDiv.innerHTML = `${time}<br><small>Break</small>`;
                    btnDiv.onclick = () => toggleSlot(dateVal, time, btnDiv);
                } else {
                    btnDiv.innerHTML = time;
                    btnDiv.onclick = () => toggleSlot(dateVal, time, btnDiv);
                }
                btnDiv.className = className;
                grid.appendChild(btnDiv);
            });
        }

        async function toggleSlot(date, time, el) {
            const idx = slotExceptions.findIndex(e => e.date === date && e.time === time && e.type === 'blocked');
            if(idx === -1) {
                const { error } = await db.from('klinikazam_slots').insert([{ id: Date.now(), date, time, type: 'blocked' }]);
                if(!error) { await refreshData(); }
            } else {
                const { error } = await db.from('klinikazam_slots').delete().eq('id', slotExceptions[idx].id);
                if(!error) { await refreshData(); }
            }
            renderSlots(); 
        }

        async function toggleClinicStatus() {
            const date = document.getElementById('slotDate').value;
            const idx = slotExceptions.findIndex(e => e.date === date && e.type === 'closed');
            
            if(idx === -1) { 
                const { error } = await db.from('klinikazam_slots').insert([{ id: Date.now(), date, type: 'closed' }]);
                if(!error) await refreshData();
            } else { 
                const { error } = await db.from('klinikazam_slots').delete().eq('id', slotExceptions[idx].id);
                if(!error) await refreshData();
            }
            renderSlots();
        }

        // --- DELETE & HELPERS ---
        function requestDelete(type, id) {
            deleteTarget = { type, id };
            document.getElementById('adminPinInput').value = ''; 
            document.getElementById('pinError').innerText = '';
            showModal('pinModal');
        }

        async function confirmDeleteAction() {
            const pin = document.getElementById('adminPinInput').value;
            if (currentUser.role === 'Admin' || pin === '1234') {
                let error = null;
                
                if (deleteTarget.type === 'appointment') {
                    const res = await db.from('klinikazam_appointments').delete().eq('id', deleteTarget.id);
                    error = res.error;
                }
                else if (deleteTarget.type === 'service') {
                    const res = await db.from('klinikazam_services').delete().eq('id', deleteTarget.id);
                    error = res.error;
                }
                else if (deleteTarget.type === 'staff') {
                    const res = await db.from('klinikazam_staff').delete().eq('id', deleteTarget.id);
                    error = res.error;
                }
                else if (deleteTarget.type === 'patient') {
                    const res = await db.from('klinikazam_patients').delete().eq('id', deleteTarget.id);
                    error = res.error;
                }

                if(!error) {
                    closeModal('pinModal');
                    await refreshData(); 
                    showToast("Deleted Successfully");
                } else {
                    document.getElementById('pinError').innerText = "Database Error";
                }
            } else {
                document.getElementById('pinError').innerText = "Wrong PIN";
            }
        }

        function sendWhatsapp(name, date, time, phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            if(cleanPhone.startsWith('0')) cleanPhone = '60' + cleanPhone.substring(1);
            const displayDate = formatDateDisplay(date);
            
            const message = `Assalamualaikum dan Salam Sejahtera 

Kami dari Azam Dental SP Saujana ingin mengingatkan ${name} mengenai temujanji anda:

 Tarikh & Masa: ${displayDate} pada ${time}

Sila hadir 510 minit lebih awal...`;

            const encodedMsg = encodeURIComponent(message);
            const url = `https://wa.me/${cleanPhone}?text=${encodedMsg}`;
            window.open(url, '_blank');
        }

        function populateServiceDropdowns() {
            const sSelects = ['bk-service', 'edit-appt-service', 'hist-service'];
            sSelects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '<option value="" disabled selected>-- Choose Service --</option>';
                    services.forEach(s => el.innerHTML += `<option value="${s.id}">${s.name} (RM ${s.price})</option>`);
                }
            });
        }

        // --- MODALS & TOASTS ---
        function showModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        function showToast(msg) {
            const t = document.getElementById('toast'); 
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('hide');
            t.classList.add('show');
            setTimeout(() => {
                t.classList.remove('show');
                t.classList.add('hide');
            }, 3000);
        }

        function openCancelConfirm(id) {
            document.getElementById('cancel-appt-id').value = id;
            showModal('confirmCancelModal');
        }

        async function executeCancel() {
            const id = document.getElementById('cancel-appt-id').value;
            const { error } = await db.from('klinikazam_appointments').update({ status: 'Cancelled' }).eq('id', id);
            if(!error) {
                await refreshData(); 
                closeModal('confirmCancelModal');
                showToast("Appointment Cancelled");
            }
        }

        function openProfile() {
            showModal('profileModal');
        }
        
        function toggleCancelledTable() {
            const container = document.getElementById('cancelled-container');
            const btn = document.getElementById('toggleCancelledBtn');
            if(container.style.display === 'none') {
                container.style.display = 'block';
                btn.innerText = "Hide Cancelled";
            } else {
                container.style.display = 'none';
                btn.innerText = "Show Cancelled";
            }
        }
        
    </script>
</body>
</html>
