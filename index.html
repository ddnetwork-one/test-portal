<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Portal - Klinik Pergigian Azam SP Saujana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <style>
    * { font-family: 'Inter', sans-serif; }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Sidebar transition */
    .sidebar { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .sidebar.closed { transform: translateX(-100%); }
    
    /* Toast animations */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    .toast-enter { animation: slideIn 0.3s ease forwards; }
    .toast-exit { animation: slideOut 0.3s ease forwards; }
    
    /* Loading spinner */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }
    
    /* Print styles */
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; }
      .no-print { display: none !important; }
      @page { margin: 10mm; }
    }
    
    /* Focus styles */
    input:focus, select:focus, textarea:focus, button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 31, 63, 0.2);
    }
    
    /* Status badges */
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-confirmed { background: #dbeafe; color: #1e40af; }
    .badge-completed { background: #d1fae5; color: #065f46; }
    .badge-cancelled { background: #fee2e2; color: #991b1b; }
    .badge-ok { background: #d1fae5; color: #065f46; }
    .badge-low { background: #fef3c7; color: #92400e; }
    .badge-expired { background: #fee2e2; color: #991b1b; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: {
              DEFAULT: '#001f3f',
              dark: '#00163a',
              light: '#003366'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="text-center">
      <svg class="spinner w-10 h-10 text-navy mx-auto" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      <p class="mt-3 text-gray-600 font-medium">Loading...</p>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 w-full max-w-md" data-aos="fade-up">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-navy tracking-tight">Klinik Pergigian Azam</h1>
        <p class="text-gray-500 text-sm mt-1">SP Saujana</p>
        <p class="text-navy font-semibold mt-4">Staff Portal Login</p>
      </div>
      
      <form id="login-form" class="space-y-5">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Username</label>
          <input type="text" id="login-username" required
            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy transition-colors"
            placeholder="Enter username">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Password</label>
          <div class="relative">
            <input type="password" id="login-password" required
              class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy transition-colors pr-12"
              placeholder="Enter password">
            <button type="button" onclick="togglePasswordVisibility()" 
              class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
              <svg id="eye-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
        </div>
        
        <button type="submit" 
          class="w-full bg-navy hover:bg-navy-dark text-white font-medium py-3 px-6 rounded-lg transition-all shadow-sm hover:shadow disabled:opacity-60">
          Sign In
        </button>
      </form>
      
      <p id="login-error" class="text-red-600 text-sm text-center mt-4 hidden"></p>
    </div>
  </div>

  <!-- Main App -->
  <div id="main-app" class="hidden">
    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="lg:hidden fixed top-4 left-4 z-40 bg-white p-2 rounded-lg shadow-md border border-gray-100 no-print">
      <svg class="w-6 h-6 text-navy" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/>
      </svg>
    </button>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="lg:hidden fixed inset-0 bg-black/50 z-40 hidden no-print"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar closed lg:translate-x-0 fixed left-0 top-0 h-full w-72 bg-white border-r border-gray-100 z-50 flex flex-col no-print">
      <div class="p-6 border-b border-gray-100">
        <h1 class="text-xl font-bold text-navy tracking-tight">Klinik Pergigian Azam</h1>
        <p class="text-gray-500 text-sm">SP Saujana</p>
      </div>
      
      <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
        <button onclick="showModule('dashboard')" data-menu="dashboard"
          class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"/>
          </svg>
          <span class="font-medium">Dashboard</span>
        </button>
        
        <button onclick="showModule('appointments')" data-menu="appointments"
          class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/>
          </svg>
          <span class="font-medium">Appointments</span>
        </button>
        
        <button onclick="showModule('patients')" data-menu="patients"
          class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/>
          </svg>
          <span class="font-medium">Patients</span>
        </button>
        
        <button onclick="showModule('billing')" data-menu="billing"
          class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/>
          </svg>
          <span class="font-medium">Billing</span>
        </button>
        
        <button onclick="showModule('certificates')" data-menu="certificates"
          class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z"/>
          </svg>
          <span class="font-medium">Certificates</span>
        </button>
        
        <button onclick="showModule('inventory')" data-menu="inventory"
          class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/>
          </svg>
          <span class="font-medium">Inventory</span>
        </button>
        
        <div id="staff-menu-item" class="hidden">
          <button onclick="showModule('staff')" data-menu="staff"
            class="menu-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/>
            </svg>
            <span class="font-medium">Staff Management</span>
          </button>
        </div>
      </nav>
      
      <div class="p-4 border-t border-gray-100">
        <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"/>
          </svg>
          <span class="font-medium">Sign Out</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="lg:ml-72 min-h-screen">
      <!-- Top Bar -->
      <header class="bg-white border-b border-gray-100 px-4 lg:px-8 py-4 sticky top-0 z-30 no-print">
        <div class="flex items-center justify-between">
          <div class="lg:hidden w-10"></div>
          <div class="hidden lg:block">
            <h2 id="page-title" class="text-lg font-semibold text-navy">Dashboard</h2>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-gray-600 text-sm">Hi, <span id="user-name" class="font-medium text-navy"></span></span>
            <span id="user-role-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-navy text-white"></span>
          </div>
        </div>
      </header>

      <!-- Content Area -->
      <main class="p-4 lg:p-8">
        <!-- Dashboard Module -->
        <section id="module-dashboard" class="module">
          <!-- Stats Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" data-aos="fade-up">
            <div class="bg-white rounded-xl border border-gray-100 p-6 hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">Today's Appointments</p>
                  <p id="stat-today-appt" class="text-2xl font-bold text-navy mt-1">0</p>
                </div>
                <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/>
                  </svg>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl border border-gray-100 p-6 hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">Pending Confirmation</p>
                  <p id="stat-pending" class="text-2xl font-bold text-amber-600 mt-1">0</p>
                </div>
                <div class="w-12 h-12 bg-amber-50 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl border border-gray-100 p-6 hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">Low Stock Items</p>
                  <p id="stat-low-stock" class="text-2xl font-bold text-red-600 mt-1">0</p>
                </div>
                <div class="w-12 h-12 bg-red-50 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                  </svg>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl border border-gray-100 p-6 hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-gray-500 text-sm">Outstanding Payments</p>
                  <p id="stat-outstanding" class="text-2xl font-bold text-navy mt-1">RM 0</p>
                </div>
                <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Quick Confirm Section -->
          <div class="bg-white rounded-xl border border-gray-100 p-6" data-aos="fade-up" data-aos-delay="100">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-navy">Quick Confirm Pending Appointments</h3>
              <button onclick="bulkConfirmAppointments()" id="bulk-confirm-btn"
                class="bg-teal-700 hover:bg-teal-800 text-white font-medium px-5 py-2.5 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                Confirm Selected
              </button>
            </div>
            
            <div id="pending-list" class="space-y-3">
              <p class="text-gray-500 text-center py-8">No pending appointments</p>
            </div>
          </div>
        </section>

        <!-- Appointments Module -->
        <section id="module-appointments" class="module hidden">
          <!-- Tabs -->
          <div class="flex flex-wrap gap-2 mb-6" data-aos="fade-up">
            <button onclick="filterAppointments('today')" data-tab="today" 
              class="appt-tab px-5 py-2.5 rounded-lg font-medium text-sm bg-navy text-white">Today</button>
            <button onclick="filterAppointments('pending')" data-tab="pending"
              class="appt-tab px-5 py-2.5 rounded-lg font-medium text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Pending</button>
            <button onclick="filterAppointments('upcoming')" data-tab="upcoming"
              class="appt-tab px-5 py-2.5 rounded-lg font-medium text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Upcoming</button>
            <button onclick="filterAppointments('completed')" data-tab="completed"
              class="appt-tab px-5 py-2.5 rounded-lg font-medium text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Completed</button>
            <button onclick="filterAppointments('cancelled')" data-tab="cancelled"
              class="appt-tab px-5 py-2.5 rounded-lg font-medium text-sm bg-gray-100 text-gray-600 hover:bg-gray-200">Cancelled</button>
          </div>
          
          <!-- Action Bar -->
          <div class="flex flex-wrap gap-3 mb-6" data-aos="fade-up" data-aos-delay="50">
            <button onclick="openAppointmentModal()" class="bg-navy hover:bg-navy-dark text-white font-medium px-5 py-2.5 rounded-lg transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              New Appointment
            </button>
          </div>
          
          <!-- Appointments Table -->
          <div class="bg-white rounded-xl border border-gray-100 overflow-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Time</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Patient</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Service</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Status</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Reminders</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="appointments-table-body" class="divide-y divide-gray-100">
                  <tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No appointments found</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Patients Module -->
        <section id="module-patients" class="module hidden">
          <!-- Search Bar -->
          <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6" data-aos="fade-up">
            <div class="flex flex-col sm:flex-row gap-4">
              <div class="flex-1">
                <input type="text" id="patient-search" placeholder="Search by phone or name..."
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy transition-colors"
                  oninput="searchPatients(this.value)">
              </div>
              <button onclick="openPatientModal()" class="bg-navy hover:bg-navy-dark text-white font-medium px-5 py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Patient
              </button>
            </div>
          </div>
          
          <!-- Patient List -->
          <div id="patient-list" class="bg-white rounded-xl border border-gray-100 overflow-hidden" data-aos="fade-up" data-aos-delay="50">
            <div class="p-12 text-center text-gray-500">Search for patients above</div>
          </div>
          
          <!-- Patient Profile (hidden by default) -->
          <div id="patient-profile" class="hidden">
            <!-- Will be populated dynamically -->
          </div>
        </section>

        <!-- Billing Module -->
        <section id="module-billing" class="module hidden">
          <div class="flex flex-wrap gap-3 mb-6" data-aos="fade-up">
            <button onclick="openBillModal()" class="bg-navy hover:bg-navy-dark text-white font-medium px-5 py-2.5 rounded-lg transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Create New Bill
            </button>
          </div>
          
          <!-- Bills Table -->
          <div class="bg-white rounded-xl border border-gray-100 overflow-hidden" data-aos="fade-up" data-aos-delay="50">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Invoice No.</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Date</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Patient</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Total</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Balance</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Status</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="bills-table-body" class="divide-y divide-gray-100">
                  <tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">No bills found</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Certificates Module -->
        <section id="module-certificates" class="module hidden">
          <div class="flex flex-wrap gap-3 mb-6" data-aos="fade-up">
            <button onclick="openMCModal()" class="bg-navy hover:bg-navy-dark text-white font-medium px-5 py-2.5 rounded-lg transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Issue Medical Certificate
            </button>
          </div>
          
          <!-- MCs Table -->
          <div class="bg-white rounded-xl border border-gray-100 overflow-hidden" data-aos="fade-up" data-aos-delay="50">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">MC No.</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Date Issued</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Patient</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Diagnosis</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Rest Days</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="mc-table-body" class="divide-y divide-gray-100">
                  <tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No certificates found</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Inventory Module -->
        <section id="module-inventory" class="module hidden">
          <!-- Alerts Banner -->
          <div id="inventory-alerts" class="hidden mb-6" data-aos="fade-up">
            <!-- Will be populated with alerts -->
          </div>
          
          <div class="flex flex-wrap gap-3 mb-6" data-aos="fade-up" data-aos-delay="50">
            <button onclick="openInventoryModal()" class="bg-navy hover:bg-navy-dark text-white font-medium px-5 py-2.5 rounded-lg transition-colors flex items-center gap-2 admin-only">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add Item
            </button>
            <select id="inventory-category-filter" onchange="filterInventory()" 
              class="px-4 py-2.5 border border-gray-200 rounded-lg focus:border-navy">
              <option value="">All Categories</option>
            </select>
          </div>
          
          <!-- Inventory Table -->
          <div class="bg-white rounded-xl border border-gray-100 overflow-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Name</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Category</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Quantity</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Min Level</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Status</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="inventory-table-body" class="divide-y divide-gray-100">
                  <tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No inventory items found</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Staff Module -->
        <section id="module-staff" class="module hidden">
          <div class="flex flex-wrap gap-3 mb-6" data-aos="fade-up">
            <button onclick="openStaffModal()" class="bg-navy hover:bg-navy-dark text-white font-medium px-5 py-2.5 rounded-lg transition-colors flex items-center gap-2 superadmin-only">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add Staff
            </button>
          </div>
          
          <!-- Staff Table -->
          <div class="bg-white rounded-xl border border-gray-100 overflow-hidden" data-aos="fade-up" data-aos-delay="50">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-100">
                  <tr>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Username</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Name</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Role</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Status</th>
                    <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="staff-table-body" class="divide-y divide-gray-100">
                  <tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">No staff found</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modals Container -->
  <div id="modal-container"></div>

  <!-- Print Templates (hidden) -->
  <div id="print-templates" class="hidden">
    <!-- Bill Print Template -->
    <div id="bill-print-template" class="print-area bg-white p-8" style="width: 210mm; min-height: 297mm;">
      <!-- Will be populated dynamically -->
    </div>
    
    <!-- MC Print Template -->
    <div id="mc-print-template" class="print-area bg-white p-8" style="width: 210mm; min-height: 297mm;">
      <!-- Will be populated dynamically -->
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      doc, 
      getDoc, 
      getDocs, 
      setDoc, 
      updateDoc, 
      deleteDoc,
      query, 
      where, 
      orderBy, 
      limit,
      writeBatch,
      Timestamp,
      addDoc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBkH-3VaTJHVHSCROb2rIf5H03yZa3GYOo",
      authDomain: "ddcloudnetwork.firebaseapp.com",
      projectId: "ddcloudnetwork",
      storageBucket: "ddcloudnetwork.firebasestorage.app",
      messagingSenderId: "692579973408",
      appId: "1:692579973408:web:027492492ddf57dbf3bf45",
      measurementId: "G-58N4W6Y5CN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collection names
    const COLLECTIONS = {
      STAFF: 'klinikazam_staff',
      PATIENTS: 'klinikazam_patients',
      APPOINTMENTS: 'klinikazam_appointments',
      SERVICES: 'klinikazam_services',
      CASHBILLS: 'klinikazam_cashbills',
      MC: 'klinikazam_medicalcertificates',
      INVENTORY: 'klinikazam_inventory'
    };

    // Global State
    let currentUser = null;
    let appointmentsData = [];
    let patientsData = [];
    let servicesData = [];
    let inventoryData = [];
    let billsData = [];
    let mcData = [];
    let selectedPendingAppts = new Set();

    // Initialize AOS
    AOS.init({ duration: 300, once: true });

    // Utility Functions
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-teal-700' : type === 'error' ? 'bg-red-600' : 'bg-navy';
      toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg toast-enter flex items-center gap-3`;
      toast.innerHTML = `
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${type === 'success' 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
            : type === 'error'
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'}
        </svg>
        <span class="font-medium">${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showLoading(show = true) {
      const overlay = document.getElementById('loading-overlay');
      overlay.classList.toggle('hidden', !show);
      overlay.classList.toggle('flex', show);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-MY', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatTime(timeStr) {
      if (!timeStr) return '-';
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${minutes} ${ampm}`;
    }

    function formatCurrency(amount) {
      return 'RM ' + (amount || 0).toFixed(2);
    }

    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    function generateInvoiceNumber() {
      const today = getTodayDate().replace(/-/g, '');
      const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return `AZM-${today}-${random}`;
    }

    function generateMCNumber() {
      const year = new Date().getFullYear();
      const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
      return `MC-AZM-${year}-${random}`;
    }

    function getStatusBadgeClass(status) {
      switch(status?.toLowerCase()) {
        case 'pending': return 'badge-pending';
        case 'confirmed': return 'badge-confirmed';
        case 'completed': return 'badge-completed';
        case 'cancelled': return 'badge-cancelled';
        default: return 'bg-gray-100 text-gray-600';
      }
    }

    function getInventoryStatus(qty, minLevel, expiryDate) {
      if (expiryDate && new Date(expiryDate) < new Date()) {
        return { status: 'Expired', class: 'badge-expired' };
      }
      if (qty <= 0 || qty <= minLevel) {
        return { status: 'Low Stock', class: 'badge-low' };
      }
      return { status: 'OK', class: 'badge-ok' };
    }

    // Password visibility toggle
    window.togglePasswordVisibility = function() {
      const input = document.getElementById('login-password');
      const icon = document.getElementById('eye-icon');
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88"/>
        `;
      } else {
        input.type = 'password';
        icon.innerHTML = `
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        `;
      }
    };

    // Login Handler
    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      
      if (!username || !password) {
        errorEl.textContent = 'Please enter username and password';
        errorEl.classList.remove('hidden');
        return;
      }

      showLoading(true);
      errorEl.classList.add('hidden');

      try {
        const staffDoc = await getDoc(doc(db, COLLECTIONS.STAFF, username));
        
        if (!staffDoc.exists()) {
          throw new Error('Invalid username or password');
        }

        const staffData = staffDoc.data();
        
        if (staffData.password !== password) {
          throw new Error('Invalid username or password');
        }

        if (!staffData.active) {
          throw new Error('Account is deactivated. Please contact administrator.');
        }

        currentUser = {
          uid: username,
          username: username,
          name: staffData.name,
          role: staffData.role
        };

        localStorage.setItem('clinicUser', JSON.stringify(currentUser));
        localStorage.setItem('clinicLoggedIn', 'true');
        
        initializeApp();
        showToast('Welcome back, ' + staffData.name);
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
      } finally {
        showLoading(false);
      }
    }

    // Logout Handler
    window.logout = function() {
      localStorage.removeItem('clinicUser');
      localStorage.removeItem('clinicLoggedIn');
      currentUser = null;
      location.reload();
    };

    // Initialize Application
    function initializeApp() {
      const loginScreen = document.getElementById('login-screen');
      const mainApp = document.getElementById('main-app');

      if (currentUser) {
        loginScreen.classList.add('hidden');
        mainApp.classList.remove('hidden');

        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-role-badge').textContent = currentUser.role;

        // Show staff menu for SuperAdmin only
        if (currentUser.role === 'SuperAdmin') {
          document.getElementById('staff-menu-item').classList.remove('hidden');
        }

        // Apply role-based visibility
        applyRolePermissions();
        
        // Show dashboard
        showModule('dashboard');
        
        // Load initial data
        loadDashboardData();
        loadServices();
      }
    }

    function applyRolePermissions() {
      const role = currentUser.role;
      
      // SuperAdmin only elements
      document.querySelectorAll('.superadmin-only').forEach(el => {
        el.style.display = role === 'SuperAdmin' ? '' : 'none';
      });

      // Admin and above
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = ['SuperAdmin', 'Admin'].includes(role) ? '' : 'none';
      });
    }

    // Show Module
    window.showModule = function(moduleName) {
      document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
      document.getElementById(`module-${moduleName}`).classList.remove('hidden');

      document.querySelectorAll('.menu-btn').forEach(btn => {
        btn.classList.remove('bg-navy', 'text-white');
        btn.classList.add('text-gray-600');
      });
      
      const activeBtn = document.querySelector(`[data-menu="${moduleName}"]`);
      if (activeBtn) {
        activeBtn.classList.add('bg-navy', 'text-white');
        activeBtn.classList.remove('text-gray-600');
      }

      const titles = {
        dashboard: 'Dashboard',
        appointments: 'Appointments',
        patients: 'Patients',
        billing: 'Billing',
        certificates: 'Medical Certificates',
        inventory: 'Inventory',
        staff: 'Staff Management'
      };
      document.getElementById('page-title').textContent = titles[moduleName] || moduleName;

      // Load module data
      switch(moduleName) {
        case 'dashboard': loadDashboardData(); break;
        case 'appointments': loadAppointments(); break;
        case 'patients': /* Loaded on search */ break;
        case 'billing': loadBills(); break;
        case 'certificates': loadMCs(); break;
        case 'inventory': loadInventory(); break;
        case 'staff': loadStaff(); break;
      }

      // Close mobile sidebar
      closeSidebar();
    };

    // Mobile sidebar
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      document.getElementById('sidebar').classList.remove('closed');
      document.getElementById('sidebar-overlay').classList.remove('hidden');
    });

    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

    function closeSidebar() {
      document.getElementById('sidebar').classList.add('closed');
      document.getElementById('sidebar-overlay').classList.add('hidden');
    }

    // Dashboard Data
    async function loadDashboardData() {
      try {
        const today = getTodayDate();
        
        // Load appointments
        const apptQuery = query(collection(db, COLLECTIONS.APPOINTMENTS), orderBy('date'), orderBy('time'));
        const apptSnapshot = await getDocs(apptQuery);
        appointmentsData = apptSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Today's appointments
        const todayAppts = appointmentsData.filter(a => a.date === today);
        document.getElementById('stat-today-appt').textContent = todayAppts.length;

        // Pending appointments
        const pendingAppts = appointmentsData.filter(a => a.status === 'Pending' && a.date >= today);
        document.getElementById('stat-pending').textContent = pendingAppts.length;

        // Load inventory for low stock
        const invQuery = query(collection(db, COLLECTIONS.INVENTORY), where('deletedAt', '==', null));
        const invSnapshot = await getDocs(invQuery);
        inventoryData = invSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const lowStock = inventoryData.filter(i => i.currentQuantity <= i.minStockLevel);
        document.getElementById('stat-low-stock').textContent = lowStock.length;

        // Load bills for outstanding
        const billsQuery = query(collection(db, COLLECTIONS.CASHBILLS));
        const billsSnapshot = await getDocs(billsQuery);
        billsData = billsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const outstanding = billsData.filter(b => b.balance > 0).reduce((sum, b) => sum + b.balance, 0);
        document.getElementById('stat-outstanding').textContent = formatCurrency(outstanding);

        // Render pending list
        renderPendingList(pendingAppts);

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showToast('Error loading dashboard data', 'error');
      }
    }

    function renderPendingList(pendingAppts) {
      const container = document.getElementById('pending-list');
      
      if (pendingAppts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">No pending appointments</p>';
        return;
      }

      container.innerHTML = pendingAppts.map(appt => `
        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
          <input type="checkbox" 
            class="w-5 h-5 rounded border-gray-300 text-navy focus:ring-navy/30"
            data-appt-id="${appt.id}"
            onchange="togglePendingSelection('${appt.id}')">
          <div class="flex-1">
            <p class="font-medium text-navy">${appt.patientName || 'Unknown Patient'}</p>
            <p class="text-sm text-gray-500">${formatDate(appt.date)} at ${formatTime(appt.time)}</p>
          </div>
          <span class="text-sm text-gray-600">${appt.serviceName || '-'}</span>
        </div>
      `).join('');
    }

    window.togglePendingSelection = function(apptId) {
      if (selectedPendingAppts.has(apptId)) {
        selectedPendingAppts.delete(apptId);
      } else {
        selectedPendingAppts.add(apptId);
      }
      
      const btn = document.getElementById('bulk-confirm-btn');
      btn.disabled = selectedPendingAppts.size === 0;
    };

    window.bulkConfirmAppointments = async function() {
      if (selectedPendingAppts.size === 0) return;

      showLoading(true);
      const batch = writeBatch(db);

      selectedPendingAppts.forEach(apptId => {
        const apptRef = doc(db, COLLECTIONS.APPOINTMENTS, apptId);
        batch.update(apptRef, { status: 'Confirmed' });
      });

      try {
        await batch.commit();
        showToast(`${selectedPendingAppts.size} appointment(s) confirmed successfully`);
        selectedPendingAppts.clear();
        loadDashboardData();
      } catch (error) {
        console.error('Error confirming appointments:', error);
        showToast('Error confirming appointments', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Load Services
    async function loadServices() {
      try {
        const servicesQuery = query(collection(db, COLLECTIONS.SERVICES));
        const snapshot = await getDocs(servicesQuery);
        servicesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error loading services:', error);
      }
    }

    // Appointments
    let currentApptFilter = 'today';

    window.filterAppointments = function(filter) {
      currentApptFilter = filter;
      
      document.querySelectorAll('.appt-tab').forEach(tab => {
        tab.classList.remove('bg-navy', 'text-white');
        tab.classList.add('bg-gray-100', 'text-gray-600');
      });
      
      const activeTab = document.querySelector(`[data-tab="${filter}"]`);
      if (activeTab) {
        activeTab.classList.add('bg-navy', 'text-white');
        activeTab.classList.remove('bg-gray-100', 'text-gray-600');
      }

      loadAppointments();
    };

    async function loadAppointments() {
      const tbody = document.getElementById('appointments-table-body');
      const today = getTodayDate();

      let filtered = [];
      
      switch(currentApptFilter) {
        case 'today':
          filtered = appointmentsData.filter(a => a.date === today);
          break;
        case 'pending':
          filtered = appointmentsData.filter(a => a.status === 'Pending');
          break;
        case 'upcoming':
          filtered = appointmentsData.filter(a => a.date > today && a.status !== 'Cancelled' && a.status !== 'Completed');
          break;
        case 'completed':
          filtered = appointmentsData.filter(a => a.status === 'Completed');
          break;
        case 'cancelled':
          filtered = appointmentsData.filter(a => a.status === 'Cancelled');
          break;
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No appointments found</td></tr>';
        return;
      }

      // Load patient names
      for (let appt of filtered) {
        if (appt.patientPhone && !appt.patientName) {
          const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, appt.patientPhone));
          if (patientDoc.exists()) {
            appt.patientName = patientDoc.data().name;
          }
        }
      }

      tbody.innerHTML = filtered.map(appt => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4">
            <span class="font-medium text-navy">${formatTime(appt.time)}</span>
            <span class="text-gray-500 text-sm ml-2">${formatDate(appt.date)}</span>
          </td>
          <td class="px-6 py-4">
            <button onclick="viewPatientProfile('${appt.patientPhone}')" class="text-navy hover:text-navy-dark font-medium">
              ${appt.patientName || 'Unknown'}
            </button>
            <p class="text-sm text-gray-500">${appt.patientPhone || '-'}</p>
          </td>
          <td class="px-6 py-4 text-gray-600">${appt.serviceName || '-'}</td>
          <td class="px-6 py-4">
            <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(appt.status)}">${appt.status || 'Pending'}</span>
          </td>
          <td class="px-6 py-4">
            <div class="flex gap-1">
              <button onclick="sendWhatsApp('${appt.patientPhone}', '${appt.patientName}', '${appt.date}', '${appt.time}', '24h')"
                class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="24h reminder">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                </svg>
              </button>
              <button onclick="sendWhatsApp('${appt.patientPhone}', '${appt.patientName}', '${appt.date}', '${appt.time}', '2h')"
                class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="2h reminder">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </button>
              <button onclick="sendWhatsApp('${appt.patientPhone}', '${appt.patientName}', '${appt.date}', '${appt.time}', '30min')"
                class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="30min reminder">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </button>
            </div>
          </td>
          <td class="px-6 py-4">
            <div class="flex gap-2">
              ${appt.status === 'Pending' ? `
                <button onclick="confirmAppointment('${appt.id}')" class="px-3 py-1.5 text-sm bg-teal-700 hover:bg-teal-800 text-white rounded-lg transition-colors">Confirm</button>
              ` : ''}
              ${['Pending', 'Confirmed'].includes(appt.status) ? `
                <button onclick="openAppointmentModal('${appt.id}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">Edit</button>
                <button onclick="openBillModal('${appt.patientPhone}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">Bill</button>
                <button onclick="openMCModal('${appt.patientPhone}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">MC</button>
              ` : ''}
              ${['SuperAdmin', 'Admin'].includes(currentUser.role) && appt.status !== 'Cancelled' ? `
                <button onclick="cancelAppointment('${appt.id}')" class="px-3 py-1.5 text-sm border border-red-200 text-red-600 hover:bg-red-50 rounded-lg transition-colors">Cancel</button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    window.confirmAppointment = async function(apptId) {
      if (!confirm('Confirm this appointment?')) return;
      
      showLoading(true);
      try {
        await updateDoc(doc(db, COLLECTIONS.APPOINTMENTS, apptId), { status: 'Confirmed' });
        showToast('Appointment confirmed');
        await loadAppointments();
        await loadDashboardData();
      } catch (error) {
        console.error('Error confirming:', error);
        showToast('Error confirming appointment', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.cancelAppointment = async function(apptId) {
      if (!confirm('Cancel this appointment?')) return;
      
      showLoading(true);
      try {
        await updateDoc(doc(db, COLLECTIONS.APPOINTMENTS, apptId), { status: 'Cancelled' });
        showToast('Appointment cancelled');
        await loadAppointments();
        await loadDashboardData();
      } catch (error) {
        console.error('Error cancelling:', error);
        showToast('Error cancelling appointment', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.sendWhatsApp = function(phone, name, date, time, type) {
      if (!phone) {
        showToast('No phone number available', 'error');
        return;
      }

      const cleanPhone = phone.replace(/\D/g, '');
      const formattedDate = formatDate(date);
      const formattedTime = formatTime(time);

      let message = '';
      switch(type) {
        case '24h':
          message = `Salam ${name}, ini Klinik Pergigian Azam SP Saujana. Peringatan: Temujanji anda esok pada ${formattedDate} ${formattedTime}. Sila hadir tepat masa. Jika ada sebarang perubahan, sila hubungi kami seawal mungkin. Terima kasih.`;
          break;
        case '2h':
          message = `Salam ${name}, temujanji anda di Klinik Pergigian Azam akan bermula dalam 2 jam lagi pada ${formattedTime}. Kami menantikan kedatangan anda. Terima kasih.`;
          break;
        case '30min':
          message = `Salam ${name}, temujanji anda akan bermula dalam 30 minit lagi. Sila pastikan anda tiba awal sedikit. Terima kasih atas kerjasama anda.`;
          break;
      }

      window.open(`https://wa.me/6${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');
    };

    // Appointment Modal
    window.openAppointmentModal = async function(apptId = null) {
      let appt = null;
      if (apptId) {
        appt = appointmentsData.find(a => a.id === apptId);
      }

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">${appt ? 'Edit Appointment' : 'New Appointment'}</h3>
            </div>
            <form id="appointment-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Patient Phone</label>
                <input type="tel" id="appt-patient-phone" required value="${appt?.patientPhone || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy"
                  placeholder="01XXXXXXXX">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Date</label>
                <input type="date" id="appt-date" required value="${appt?.date || getTodayDate()}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Time</label>
                <input type="time" id="appt-time" required value="${appt?.time || '09:00'}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Service</label>
                <select id="appt-service" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                  <option value="">Select service</option>
                  ${servicesData.map(s => `<option value="${s.name}" ${appt?.serviceName === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Notes</label>
                <textarea id="appt-notes" rows="2"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy resize-none">${appt?.notes || ''}</textarea>
              </div>
              <input type="hidden" id="appt-id" value="${apptId || ''}">
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="saveAppointment()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.saveAppointment = async function() {
      const phone = document.getElementById('appt-patient-phone').value.trim();
      const date = document.getElementById('appt-date').value;
      const time = document.getElementById('appt-time').value;
      const service = document.getElementById('appt-service').value;
      const notes = document.getElementById('appt-notes').value;
      const apptId = document.getElementById('appt-id').value;

      if (!phone || !date || !time) {
        showToast('Please fill in required fields', 'error');
        return;
      }

      showLoading(true);

      try {
        // Get or create patient
        let patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, phone));
        let patientName = '';
        
        if (patientDoc.exists()) {
          patientName = patientDoc.data().name;
        }

        const apptData = {
          patientPhone: phone,
          patientName: patientName,
          date,
          time,
          serviceName: service,
          notes,
          status: 'Pending',
          createdBy: currentUser.username,
          updatedAt: Timestamp.now()
        };

        if (apptId) {
          await updateDoc(doc(db, COLLECTIONS.APPOINTMENTS, apptId), apptData);
          showToast('Appointment updated');
        } else {
          apptData.createdAt = Timestamp.now();
          await addDoc(collection(db, COLLECTIONS.APPOINTMENTS), apptData);
          showToast('Appointment created');
        }

        closeModal();
        await loadAppointments();
        await loadDashboardData();
      } catch (error) {
        console.error('Error saving appointment:', error);
        showToast('Error saving appointment', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Patients
    window.searchPatients = async function(query) {
      if (query.length < 3) {
        document.getElementById('patient-list').innerHTML = '<div class="p-12 text-center text-gray-500">Enter at least 3 characters to search</div>';
        return;
      }

      showLoading(true);
      
      try {
        const phoneQuery = query(collection(db, COLLECTIONS.PATIENTS));
        const snapshot = await getDocs(phoneQuery);
        
        patientsData = snapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(p => 
            p.id.includes(query) || 
            (p.name && p.name.toLowerCase().includes(query.toLowerCase()))
          );

        renderPatientList();
      } catch (error) {
        console.error('Error searching patients:', error);
        showToast('Error searching patients', 'error');
      } finally {
        showLoading(false);
      }
    };

    function renderPatientList() {
      const container = document.getElementById('patient-list');
      
      if (patientsData.length === 0) {
        container.innerHTML = '<div class="p-12 text-center text-gray-500">No patients found</div>';
        return;
      }

      container.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-100">
              <tr>
                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Phone</th>
                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Name</th>
                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">IC Number</th>
                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
              ${patientsData.map(p => `
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 font-medium text-navy">${p.id}</td>
                  <td class="px-6 py-4 text-gray-600">${p.name || '-'}</td>
                  <td class="px-6 py-4 text-gray-600">${p.icNumber || '-'}</td>
                  <td class="px-6 py-4">
                    <button onclick="viewPatientProfile('${p.id}')" class="text-navy hover:text-navy-dark font-medium">View</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    window.viewPatientProfile = async function(phone) {
      if (!phone) return;

      showLoading(true);

      try {
        const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, phone));
        if (!patientDoc.exists()) {
          showToast('Patient not found', 'error');
          showLoading(false);
          return;
        }

        const patient = patientDoc.data();
        
        // Get patient's appointments
        const apptQuery = query(collection(db, COLLECTIONS.APPOINTMENTS), where('patientPhone', '==', phone));
        const apptSnapshot = await getDocs(apptQuery);
        const patientAppts = apptSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Get patient's bills
        const billsQuery = query(collection(db, COLLECTIONS.CASHBILLS), where('patientPhone', '==', phone));
        const billsSnapshot = await getDocs(billsQuery);
        const patientBills = billsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const totalBalance = patientBills.reduce((sum, b) => sum + (b.balance || 0), 0);

        // Show patient profile
        document.getElementById('patient-list').classList.add('hidden');
        const profileContainer = document.getElementById('patient-profile');
        profileContainer.classList.remove('hidden');

        profileContainer.innerHTML = `
          <div data-aos="fade-up">
            <button onclick="backToPatientList()" class="mb-6 flex items-center gap-2 text-gray-600 hover:text-navy transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
              </svg>
              Back to Patient List
            </button>

            <div class="grid lg:grid-cols-3 gap-6">
              <!-- Patient Info -->
              <div class="lg:col-span-1">
                <div class="bg-white rounded-xl border border-gray-100 p-6">
                  <div class="flex items-start justify-between mb-4">
                    <h3 class="text-lg font-semibold text-navy">Patient Info</h3>
                    <button onclick="openPatientModal('${phone}')" class="text-navy hover:text-navy-dark">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10"/>
                      </svg>
                    </button>
                  </div>
                  <div class="space-y-3">
                    <div>
                      <p class="text-sm text-gray-500">Name</p>
                      <p class="font-medium text-navy">${patient.name || '-'}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">Phone</p>
                      <p class="font-medium text-navy">${phone}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">IC Number</p>
                      <p class="font-medium text-navy">${patient.icNumber || '-'}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">Address</p>
                      <p class="font-medium text-navy">${patient.address || '-'}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">Total Visits</p>
                      <p class="font-medium text-navy">${patientAppts.filter(a => a.status === 'Completed').length}</p>
                    </div>
                  </div>
                </div>

                <!-- Outstanding Balance -->
                <div class="bg-white rounded-xl border border-gray-100 p-6 mt-6">
                  <h3 class="text-lg font-semibold text-navy mb-4">Outstanding Balance</h3>
                  <p class="text-3xl font-bold ${totalBalance > 0 ? 'text-red-600' : 'text-teal-700'}">${formatCurrency(totalBalance)}</p>
                </div>

                <!-- Internal Notes -->
                <div class="bg-white rounded-xl border border-gray-100 p-6 mt-6">
                  <h3 class="text-lg font-semibold text-navy mb-4">Internal Notes</h3>
                  <div class="space-y-2 mb-4">
                    ${(patient.internalNotes || []).slice(-5).map(note => `
                      <div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-600">${note}</div>
                    `).join('') || '<p class="text-gray-500">No notes</p>'}
                  </div>
                  <div class="flex gap-2">
                    <input type="text" id="new-internal-note" placeholder="Add note..."
                      class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:border-navy">
                    <button onclick="addInternalNote('${phone}')" class="px-4 py-2 bg-navy text-white rounded-lg text-sm">Add</button>
                  </div>
                </div>
              </div>

              <!-- Appointment History -->
              <div class="lg:col-span-2">
                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden">
                  <div class="p-6 border-b border-gray-100">
                    <h3 class="text-lg font-semibold text-navy">Appointment History</h3>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Date</th>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Service</th>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Status</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-100">
                        ${patientAppts.slice(0, 10).map(a => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-6 py-3 text-sm">${formatDate(a.date)} ${formatTime(a.time)}</td>
                            <td class="px-6 py-3 text-sm">${a.serviceName || '-'}</td>
                            <td class="px-6 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusBadgeClass(a.status)}">${a.status}</span></td>
                          </tr>
                        `).join('') || '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-500">No appointments</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Bills -->
                <div class="bg-white rounded-xl border border-gray-100 overflow-hidden mt-6">
                  <div class="p-6 border-b border-gray-100">
                    <h3 class="text-lg font-semibold text-navy">Bills</h3>
                  </div>
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead class="bg-gray-50">
                        <tr>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Invoice</th>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Date</th>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Total</th>
                          <th class="text-left px-6 py-3 text-sm font-semibold text-gray-600">Balance</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-100">
                        ${patientBills.slice(0, 10).map(b => `
                          <tr class="hover:bg-gray-50">
                            <td class="px-6 py-3 text-sm font-medium text-navy">${b.invoiceNumber}</td>
                            <td class="px-6 py-3 text-sm">${formatDate(b.date)}</td>
                            <td class="px-6 py-3 text-sm">${formatCurrency(b.total)}</td>
                            <td class="px-6 py-3 text-sm ${b.balance > 0 ? 'text-red-600 font-medium' : 'text-teal-700'}">${formatCurrency(b.balance)}</td>
                          </tr>
                        `).join('') || '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">No bills</td></tr>'}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

      } catch (error) {
        console.error('Error loading patient:', error);
        showToast('Error loading patient profile', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.backToPatientList = function() {
      document.getElementById('patient-profile').classList.add('hidden');
      document.getElementById('patient-list').classList.remove('hidden');
    };

    window.addInternalNote = async function(phone) {
      const noteInput = document.getElementById('new-internal-note');
      const note = noteInput.value.trim();
      
      if (!note) return;

      showLoading(true);

      try {
        const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, phone));
        const existingNotes = patientDoc.data()?.internalNotes || [];
        
        await updateDoc(doc(db, COLLECTIONS.PATIENTS, phone), {
          internalNotes: [...existingNotes, `${new Date().toLocaleDateString()}: ${note}`]
        });

        showToast('Note added');
        viewPatientProfile(phone);
      } catch (error) {
        console.error('Error adding note:', error);
        showToast('Error adding note', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Patient Modal
    window.openPatientModal = async function(phone = null) {
      let patient = null;
      if (phone) {
        const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, phone));
        if (patientDoc.exists()) {
          patient = { id: patientDoc.id, ...patientDoc.data() };
        }
      }

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">${patient ? 'Edit Patient' : 'Add Patient'}</h3>
            </div>
            <form id="patient-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Phone Number</label>
                <input type="tel" id="patient-phone" required value="${patient?.id || ''}" ${patient ? 'readonly' : ''}
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy ${patient ? 'bg-gray-50' : ''}"
                  placeholder="01XXXXXXXX">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Name</label>
                <input type="text" id="patient-name" required value="${patient?.name || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">IC Number</label>
                <input type="text" id="patient-ic" value="${patient?.icNumber || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Address</label>
                <textarea id="patient-address" rows="2"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy resize-none">${patient?.address || ''}</textarea>
              </div>
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="savePatient()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.savePatient = async function() {
      const phone = document.getElementById('patient-phone').value.trim();
      const name = document.getElementById('patient-name').value.trim();
      const ic = document.getElementById('patient-ic').value.trim();
      const address = document.getElementById('patient-address').value.trim();

      if (!phone || !name) {
        showToast('Phone and name are required', 'error');
        return;
      }

      showLoading(true);

      try {
        await setDoc(doc(db, COLLECTIONS.PATIENTS, phone), {
          name,
          icNumber: ic,
          address,
          internalNotes: [],
          updatedAt: Timestamp.now()
        }, { merge: true });

        showToast('Patient saved');
        closeModal();
        searchPatients(phone);
      } catch (error) {
        console.error('Error saving patient:', error);
        showToast('Error saving patient', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Bills
    async function loadBills() {
      const tbody = document.getElementById('bills-table-body');

      try {
        const billsQuery = query(collection(db, COLLECTIONS.CASHBILLS), orderBy('date', 'desc'));
        const snapshot = await getDocs(billsQuery);
        billsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (billsData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">No bills found</td></tr>';
          return;
        }

        // Load patient names
        for (let bill of billsData) {
          if (bill.patientPhone && !bill.patientName) {
            const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, bill.patientPhone));
            if (patientDoc.exists()) {
              bill.patientName = patientDoc.data().name;
            }
          }
        }

        tbody.innerHTML = billsData.map(b => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-medium text-navy">${b.invoiceNumber}</td>
            <td class="px-6 py-4 text-gray-600">${formatDate(b.date)}</td>
            <td class="px-6 py-4">
              <button onclick="viewPatientProfile('${b.patientPhone}')" class="text-navy hover:text-navy-dark font-medium">
                ${b.patientName || b.patientPhone}
              </button>
            </td>
            <td class="px-6 py-4 font-medium">${formatCurrency(b.total)}</td>
            <td class="px-6 py-4 font-medium ${b.balance > 0 ? 'text-red-600' : 'text-teal-700'}">${formatCurrency(b.balance)}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${b.balance > 0 ? 'badge-pending' : 'badge-completed'}">
                ${b.balance > 0 ? 'Outstanding' : 'Paid'}
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                <button onclick="printBill('${b.id}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">Print</button>
                ${b.balance > 0 ? `<button onclick="recordPayment('${b.id}')" class="px-3 py-1.5 text-sm bg-teal-700 text-white rounded-lg hover:bg-teal-800 transition-colors">Payment</button>` : ''}
              </div>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading bills:', error);
        showToast('Error loading bills', 'error');
      }
    }

    // Bill Modal
    window.openBillModal = async function(patientPhone = null) {
      let services = servicesData;
      if (services.length === 0) {
        await loadServices();
        services = servicesData;
      }

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">Create New Bill</h3>
            </div>
            <form id="bill-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Patient Phone</label>
                <input type="tel" id="bill-patient-phone" required value="${patientPhone || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy"
                  placeholder="01XXXXXXXX">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Services</label>
                <div id="bill-services-list" class="space-y-2">
                  <div class="bill-service-row flex gap-2 items-center">
                    <select class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:border-navy bill-service-select">
                      <option value="">Select service</option>
                      ${services.map(s => `<option value="${s.name}" data-price="${s.price || 0}">${s.name} - ${formatCurrency(s.price || 0)}</option>`).join('')}
                    </select>
                    <input type="number" min="1" value="1" class="w-20 px-3 py-3 border border-gray-200 rounded-lg bill-service-qty">
                    <button type="button" onclick="removeBillService(this)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <button type="button" onclick="addBillService()" class="mt-2 text-sm text-navy hover:text-navy-dark font-medium flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                  </svg>
                  Add Service
                </button>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Total</label>
                  <input type="text" id="bill-total" readonly value="RM 0.00"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 font-medium">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Paid Amount</label>
                  <input type="number" id="bill-paid" min="0" step="0.01" value="0"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy"
                    oninput="calculateBalance()">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Balance</label>
                <input type="text" id="bill-balance" readonly value="RM 0.00"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50 font-medium">
              </div>
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="saveBill()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save & Print</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.addBillService = function() {
      const services = servicesData;
      const row = document.createElement('div');
      row.className = 'bill-service-row flex gap-2 items-center';
      row.innerHTML = `
        <select class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:border-navy bill-service-select" onchange="calculateTotal()">
          <option value="">Select service</option>
          ${services.map(s => `<option value="${s.name}" data-price="${s.price || 0}">${s.name} - ${formatCurrency(s.price || 0)}</option>`).join('')}
        </select>
        <input type="number" min="1" value="1" class="w-20 px-3 py-3 border border-gray-200 rounded-lg bill-service-qty" onchange="calculateTotal()">
        <button type="button" onclick="removeBillService(this)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
      `;
      document.getElementById('bill-services-list').appendChild(row);
    };

    window.removeBillService = function(btn) {
      const rows = document.querySelectorAll('.bill-service-row');
      if (rows.length > 1) {
        btn.closest('.bill-service-row').remove();
        calculateTotal();
      }
    };

    window.calculateTotal = function() {
      let total = 0;
      document.querySelectorAll('.bill-service-row').forEach(row => {
        const select = row.querySelector('.bill-service-select');
        const qty = parseInt(row.querySelector('.bill-service-qty').value) || 0;
        const price = parseFloat(select.selectedOptions[0]?.dataset.price) || 0;
        total += price * qty;
      });
      document.getElementById('bill-total').value = formatCurrency(total);
      calculateBalance();
    };

    window.calculateBalance = function() {
      const total = parseFloat(document.getElementById('bill-total').value.replace('RM ', '')) || 0;
      const paid = parseFloat(document.getElementById('bill-paid').value) || 0;
      const balance = total - paid;
      document.getElementById('bill-balance').value = formatCurrency(balance);
    };

    window.saveBill = async function() {
      const phone = document.getElementById('bill-patient-phone').value.trim();
      const paid = parseFloat(document.getElementById('bill-paid').value) || 0;
      
      if (!phone) {
        showToast('Patient phone is required', 'error');
        return;
      }

      // Collect services
      const services = [];
      let total = 0;
      document.querySelectorAll('.bill-service-row').forEach(row => {
        const select = row.querySelector('.bill-service-select');
        const qty = parseInt(row.querySelector('.bill-service-qty').value) || 0;
        const price = parseFloat(select.selectedOptions[0]?.dataset.price) || 0;
        const name = select.value;
        if (name && qty > 0) {
          services.push({ name, qty, price, subtotal: price * qty });
          total += price * qty;
        }
      });

      if (services.length === 0) {
        showToast('Please add at least one service', 'error');
        return;
      }

      showLoading(true);

      try {
        const balance = total - paid;
        const invoiceNumber = generateInvoiceNumber();

        const billData = {
          invoiceNumber,
          patientPhone: phone,
          date: getTodayDate(),
          services,
          total,
          paidAmount: paid,
          balance,
          payments: paid > 0 ? [{ amount: paid, date: getTodayDate(), method: 'Cash' }] : [],
          status: balance > 0 ? 'Partial' : 'Paid',
          issuedBy: currentUser.username,
          createdAt: Timestamp.now()
        };

        const docRef = await addDoc(collection(db, COLLECTIONS.CASHBILLS), billData);
        billData.id = docRef.id;

        showToast('Bill created successfully');
        closeModal();
        
        // Print the bill
        printBillFromData(billData);
        
        await loadBills();
        await loadDashboardData();
      } catch (error) {
        console.error('Error saving bill:', error);
        showToast('Error saving bill', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.recordPayment = async function(billId) {
      const bill = billsData.find(b => b.id === billId);
      if (!bill) return;

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">Record Payment</h3>
              <p class="text-sm text-gray-500 mt-1">Invoice: ${bill.invoiceNumber}</p>
              <p class="text-sm text-gray-500">Outstanding: ${formatCurrency(bill.balance)}</p>
            </div>
            <form id="payment-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Amount</label>
                <input type="number" id="payment-amount" min="0" max="${bill.balance}" step="0.01"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy"
                  placeholder="Enter payment amount">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Method</label>
                <select id="payment-method" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                  <option value="Cash">Cash</option>
                  <option value="Card">Card</option>
                  <option value="FPX">FPX Online Banking</option>
                  <option value="TouchNGo">Touch 'n Go</option>
                </select>
              </div>
              <input type="hidden" id="payment-bill-id" value="${billId}">
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="savePayment()" class="px-5 py-2.5 bg-teal-700 hover:bg-teal-800 text-white rounded-lg transition-colors">Save Payment</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.savePayment = async function() {
      const billId = document.getElementById('payment-bill-id').value;
      const amount = parseFloat(document.getElementById('payment-amount').value) || 0;
      const method = document.getElementById('payment-method').value;

      if (amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
      }

      showLoading(true);

      try {
        const bill = billsData.find(b => b.id === billId);
        const newPaid = bill.paidAmount + amount;
        const newBalance = bill.total - newPaid;
        const newPayments = [...(bill.payments || []), { amount, date: getTodayDate(), method }];

        await updateDoc(doc(db, COLLECTIONS.CASHBILLS, billId), {
          paidAmount: newPaid,
          balance: newBalance,
          payments: newPayments,
          status: newBalance > 0 ? 'Partial' : 'Paid'
        });

        showToast('Payment recorded');
        closeModal();
        await loadBills();
        await loadDashboardData();
      } catch (error) {
        console.error('Error saving payment:', error);
        showToast('Error saving payment', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Print Bill
    window.printBill = async function(billId) {
      const bill = billsData.find(b => b.id === billId);
      if (!bill) return;

      // Load patient data
      const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, bill.patientPhone));
      const patient = patientDoc.exists() ? patientDoc.data() : {};

      const billData = {
        ...bill,
        patientName: patient.name || bill.patientPhone,
        patientIC: patient.icNumber || '-'
      };

      printBillFromData(billData);
    };

    function printBillFromData(bill) {
      const printTemplate = document.getElementById('bill-print-template');
      printTemplate.innerHTML = `
        <div class="max-w-2xl mx-auto">
          <!-- Header -->
          <div class="text-center border-b-2 border-navy pb-6 mb-6">
            <h1 class="text-2xl font-bold text-navy">Klinik Pergigian Azam</h1>
            <p class="text-gray-600">SP Saujana</p>
            <p class="text-sm text-gray-500 mt-2">No. 123, Jalan Saujana 1, Taman Saujana, 40000 Shah Alam, Selangor</p>
            <p class="text-sm text-gray-500">Tel: 03-1234567</p>
          </div>

          <!-- Invoice Info -->
          <div class="flex justify-between mb-6">
            <div>
              <p class="text-sm text-gray-500">Invoice No.</p>
              <p class="font-semibold text-navy">${bill.invoiceNumber}</p>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-500">Date</p>
              <p class="font-semibold text-navy">${formatDate(bill.date)}</p>
            </div>
          </div>

          <!-- Patient Info -->
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-500">Patient</p>
            <p class="font-semibold text-navy">${bill.patientName}</p>
            <p class="text-sm text-gray-600">${bill.patientIC}</p>
          </div>

          <!-- Services Table -->
          <table class="w-full mb-6">
            <thead>
              <tr class="border-b border-navy">
                <th class="text-left py-2 text-navy">Description</th>
                <th class="text-center py-2 text-navy">Qty</th>
                <th class="text-right py-2 text-navy">Price</th>
                <th class="text-right py-2 text-navy">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              ${(bill.services || []).map(s => `
                <tr class="border-b border-gray-200">
                  <td class="py-3">${s.name}</td>
                  <td class="text-center py-3">${s.qty}</td>
                  <td class="text-right py-3">${formatCurrency(s.price)}</td>
                  <td class="text-right py-3">${formatCurrency(s.subtotal)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <!-- Totals -->
          <div class="flex justify-end mb-8">
            <div class="w-64">
              <div class="flex justify-between py-2 border-b">
                <span class="text-gray-600">Subtotal</span>
                <span>${formatCurrency(bill.total)}</span>
              </div>
              <div class="flex justify-between py-2 border-b">
                <span class="text-gray-600">Paid</span>
                <span>${formatCurrency(bill.paidAmount)}</span>
              </div>
              <div class="flex justify-between py-2 text-lg font-bold text-navy">
                <span>Balance Due</span>
                <span>${formatCurrency(bill.balance)}</span>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="border-t border-gray-200 pt-6 mt-8">
            <div class="flex justify-between">
              <div>
                <p class="text-sm text-gray-500">Issued by</p>
                <p class="font-medium">${bill.issuedBy}</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-500">Received by</p>
                <p class="mt-8 border-t border-gray-300 pt-1 text-sm">Signature</p>
              </div>
            </div>
          </div>
        </div>
      `;

      printTemplate.classList.remove('hidden');
      window.print();
      printTemplate.classList.add('hidden');
    }

    // Medical Certificates
    async function loadMCs() {
      const tbody = document.getElementById('mc-table-body');

      try {
        const mcQuery = query(collection(db, COLLECTIONS.MC), orderBy('dateIssued', 'desc'));
        const snapshot = await getDocs(mcQuery);
        mcData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (mcData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No certificates found</td></tr>';
          return;
        }

        // Load patient names
        for (let mc of mcData) {
          if (mc.patientPhone && !mc.patientName) {
            const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, mc.patientPhone));
            if (patientDoc.exists()) {
              mc.patientName = patientDoc.data().name;
            }
          }
        }

        tbody.innerHTML = mcData.map(m => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-medium text-navy">${m.mcNumber}</td>
            <td class="px-6 py-4 text-gray-600">${formatDate(m.dateIssued)}</td>
            <td class="px-6 py-4">
              <button onclick="viewPatientProfile('${m.patientPhone}')" class="text-navy hover:text-navy-dark font-medium">
                ${m.patientName || m.patientPhone}
              </button>
            </td>
            <td class="px-6 py-4 text-gray-600">${m.diagnosis || '-'}</td>
            <td class="px-6 py-4 text-gray-600">${m.restDays} day(s)</td>
            <td class="px-6 py-4">
              <button onclick="printMC('${m.id}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">Print</button>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading MCs:', error);
        showToast('Error loading certificates', 'error');
      }
    }

    // MC Modal
    window.openMCModal = async function(patientPhone = null) {
      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">Issue Medical Certificate</h3>
            </div>
            <form id="mc-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Patient Phone</label>
                <input type="tel" id="mc-patient-phone" required value="${patientPhone || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Diagnosis</label>
                <textarea id="mc-diagnosis" rows="2" required
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy resize-none"></textarea>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Rest Days</label>
                <input type="number" id="mc-rest-days" min="1" value="1"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">From Date</label>
                  <input type="date" id="mc-from-date" required value="${getTodayDate()}"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">To Date</label>
                  <input type="date" id="mc-to-date" required
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                </div>
              </div>
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="saveMC()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save & Print</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
      
      // Set default to date
      const today = new Date();
      today.setDate(today.getDate() + 1);
      document.getElementById('mc-to-date').value = today.toISOString().split('T')[0];
    };

    window.saveMC = async function() {
      const phone = document.getElementById('mc-patient-phone').value.trim();
      const diagnosis = document.getElementById('mc-diagnosis').value.trim();
      const restDays = parseInt(document.getElementById('mc-rest-days').value) || 1;
      const fromDate = document.getElementById('mc-from-date').value;
      const toDate = document.getElementById('mc-to-date').value;

      if (!phone || !diagnosis || !fromDate || !toDate) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      showLoading(true);

      try {
        // Get patient data
        const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, phone));
        const patient = patientDoc.exists() ? patientDoc.data() : {};

        const mcNumber = generateMCNumber();
        const siriNo = Math.floor(Math.random() * 100000).toString().padStart(5, '0');

        const mcData = {
          mcNumber,
          siriNo,
          patientPhone: phone,
          patientName: patient.name || phone,
          diagnosis,
          restDays,
          fromDate,
          toDate,
          issuedBy: currentUser.username,
          dateIssued: getTodayDate(),
          createdAt: Timestamp.now()
        };

        const docRef = await addDoc(collection(db, COLLECTIONS.MC), mcData);
        mcData.id = docRef.id;

        showToast('Medical certificate issued');
        closeModal();
        
        printMCFromData(mcData);
        
        await loadMCs();
      } catch (error) {
        console.error('Error saving MC:', error);
        showToast('Error saving certificate', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Print MC
    window.printMC = async function(mcId) {
      const mc = mcData.find(m => m.id === mcId);
      if (!mc) return;

      // Load patient data
      const patientDoc = await getDoc(doc(db, COLLECTIONS.PATIENTS, mc.patientPhone));
      const patient = patientDoc.exists() ? patientDoc.data() : {};

      const mcData = {
        ...mc,
        patientName: patient.name || mc.patientPhone,
        patientIC: patient.icNumber || '-'
      };

      printMCFromData(mcData);
    };

    function printMCFromData(mc) {
      const printTemplate = document.getElementById('mc-print-template');
      printTemplate.innerHTML = `
        <div class="max-w-2xl mx-auto">
          <!-- Header -->
          <div class="text-center border-b-2 border-navy pb-6 mb-6">
            <h1 class="text-2xl font-bold text-navy">Klinik Pergigian Azam</h1>
            <p class="text-gray-600">SP Saujana</p>
            <p class="text-sm text-gray-500 mt-2">No. 123, Jalan Saujana 1, Taman Saujana, 40000 Shah Alam, Selangor</p>
            <p class="text-sm text-gray-500">Tel: 03-1234567</p>
          </div>

          <!-- Title -->
          <div class="text-center mb-8">
            <h2 class="text-xl font-bold text-navy border-2 border-navy inline-block px-8 py-2">MEDICAL CERTIFICATE</h2>
          </div>

          <!-- MC Info -->
          <div class="mb-6">
            <div class="flex justify-between mb-4">
              <div>
                <p class="text-sm text-gray-500">MC No.</p>
                <p class="font-semibold text-navy">${mc.mcNumber}</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-500">Siri No.</p>
                <p class="font-semibold text-navy">${mc.siriNo}</p>
              </div>
            </div>
            <div class="text-right">
              <p class="text-sm text-gray-500">Date Issued</p>
              <p class="font-semibold text-navy">${formatDate(mc.dateIssued)}</p>
            </div>
          </div>

          <!-- Content -->
          <div class="space-y-4 mb-8">
            <p class="text-gray-700">This is to certify that:</p>
            
            <div class="p-4 bg-gray-50 rounded-lg">
              <p class="text-lg font-semibold text-navy">${mc.patientName}</p>
              <p class="text-sm text-gray-600">IC: ${mc.patientIC}</p>
            </div>

            <p class="text-gray-700">has been examined and found to be suffering from:</p>
            
            <div class="p-4 bg-gray-50 rounded-lg">
              <p class="font-medium text-navy">${mc.diagnosis}</p>
            </div>

            <p class="text-gray-700">and is advised to rest for <strong class="text-navy">${mc.restDays} day(s)</strong></p>
            <p class="text-gray-700">from <strong class="text-navy">${formatDate(mc.fromDate)}</strong> to <strong class="text-navy">${formatDate(mc.toDate)}</strong>.</p>
          </div>

          <!-- Signature -->
          <div class="border-t border-gray-200 pt-8 mt-8">
            <div class="flex justify-end">
              <div class="text-center">
                <p class="text-sm text-gray-500 mb-12">Authorized Signature</p>
                <p class="border-t border-gray-300 pt-1 text-sm">${mc.issuedBy}</p>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="mt-8 text-xs text-gray-400 text-center">
            <p>This certificate is computer-generated and valid without signature.</p>
          </div>
        </div>
      `;

      printTemplate.classList.remove('hidden');
      window.print();
      printTemplate.classList.add('hidden');
    }

    // Inventory
    async function loadInventory() {
      const tbody = document.getElementById('inventory-table-body');

      try {
        const invQuery = query(collection(db, COLLECTIONS.INVENTORY));
        const snapshot = await getDocs(invQuery);
        inventoryData = snapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(i => !i.deletedAt);

        // Populate category filter
        const categories = [...new Set(inventoryData.map(i => i.category).filter(Boolean))];
        const categoryFilter = document.getElementById('inventory-category-filter');
        categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
          categories.map(c => `<option value="${c}">${c}</option>`).join('');

        renderInventoryTable();

        // Show alerts
        const lowStock = inventoryData.filter(i => i.currentQuantity <= i.minStockLevel);
        const expired = inventoryData.filter(i => i.expiryDate && new Date(i.expiryDate) < new Date());

        const alertsContainer = document.getElementById('inventory-alerts');
        if (lowStock.length > 0 || expired.length > 0) {
          alertsContainer.classList.remove('hidden');
          alertsContainer.innerHTML = `
            <div class="bg-white rounded-xl border border-gray-100 p-4">
              <div class="flex items-center gap-3 mb-3">
                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h4 class="font-semibold text-navy">Inventory Alerts</h4>
              </div>
              ${lowStock.length > 0 ? `<p class="text-sm text-amber-700 mb-2">${lowStock.length} item(s) below minimum stock level</p>` : ''}
              ${expired.length > 0 ? `<p class="text-sm text-red-600">${expired.length} item(s) expired</p>` : ''}
            </div>
          `;
        } else {
          alertsContainer.classList.add('hidden');
        }

      } catch (error) {
        console.error('Error loading inventory:', error);
        showToast('Error loading inventory', 'error');
      }
    }

    function renderInventoryTable(filtered = null) {
      const data = filtered || inventoryData;
      const tbody = document.getElementById('inventory-table-body');

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">No inventory items found</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(i => {
        const status = getInventoryStatus(i.currentQuantity, i.minStockLevel, i.expiryDate);
        return `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-medium text-navy">${i.name}</td>
            <td class="px-6 py-4 text-gray-600">${i.category || '-'}</td>
            <td class="px-6 py-4 text-gray-600">${i.currentQuantity} ${i.unit || ''}</td>
            <td class="px-6 py-4 text-gray-600">${i.minStockLevel} ${i.unit || ''}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${status.class}">${status.status}</span>
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                <button onclick="openInventoryModal('${i.id}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors admin-only">Edit</button>
                <button onclick="recordUsage('${i.id}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">Usage</button>
                ${['SuperAdmin', 'Admin'].includes(currentUser.role) ? `
                  <button onclick="deleteInventoryItem('${i.id}')" class="px-3 py-1.5 text-sm border border-red-200 text-red-600 hover:bg-red-50 rounded-lg transition-colors">Delete</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.filterInventory = function() {
      const category = document.getElementById('inventory-category-filter').value;
      const filtered = category 
        ? inventoryData.filter(i => i.category === category)
        : inventoryData;
      renderInventoryTable(filtered);
    };

    // Inventory Modal
    window.openInventoryModal = async function(itemId = null) {
      let item = null;
      if (itemId) {
        item = inventoryData.find(i => i.id === itemId);
      }

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-lg" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">${item ? 'Edit Item' : 'Add Item'}</h3>
            </div>
            <form id="inventory-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Name</label>
                <input type="text" id="inv-name" required value="${item?.name || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Category</label>
                  <input type="text" id="inv-category" value="${item?.category || ''}"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Unit</label>
                  <input type="text" id="inv-unit" value="${item?.unit || ''}"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy" placeholder="pcs, ml, etc">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Quantity</label>
                  <input type="number" id="inv-qty" min="0" value="${item?.currentQuantity || 0}"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Min Stock Level</label>
                  <input type="number" id="inv-min" min="0" value="${item?.minStockLevel || 0}"
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Expiry Date</label>
                <input type="date" id="inv-expiry" value="${item?.expiryDate || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Location</label>
                <input type="text" id="inv-location" value="${item?.location || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <input type="hidden" id="inv-id" value="${itemId || ''}">
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="saveInventory()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.saveInventory = async function() {
      const id = document.getElementById('inv-id').value;
      const name = document.getElementById('inv-name').value.trim();
      const category = document.getElementById('inv-category').value.trim();
      const unit = document.getElementById('inv-unit').value.trim();
      const qty = parseInt(document.getElementById('inv-qty').value) || 0;
      const minLevel = parseInt(document.getElementById('inv-min').value) || 0;
      const expiry = document.getElementById('inv-expiry').value;
      const location = document.getElementById('inv-location').value.trim();

      if (!name) {
        showToast('Name is required', 'error');
        return;
      }

      showLoading(true);

      try {
        const data = {
          name,
          category,
          unit,
          currentQuantity: qty,
          minStockLevel: minLevel,
          expiryDate: expiry || null,
          location,
          lastUpdated: Timestamp.now()
        };

        if (id) {
          await updateDoc(doc(db, COLLECTIONS.INVENTORY, id), data);
          showToast('Item updated');
        } else {
          data.createdAt = Timestamp.now();
          await addDoc(collection(db, COLLECTIONS.INVENTORY), data);
          showToast('Item added');
        }

        closeModal();
        await loadInventory();
      } catch (error) {
        console.error('Error saving inventory:', error);
        showToast('Error saving item', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.deleteInventoryItem = async function(itemId) {
      if (!confirm('Delete this item?')) return;

      showLoading(true);

      try {
        await updateDoc(doc(db, COLLECTIONS.INVENTORY, itemId), {
          deletedAt: Timestamp.now()
        });
        showToast('Item deleted');
        await loadInventory();
      } catch (error) {
        console.error('Error deleting item:', error);
        showToast('Error deleting item', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.recordUsage = function(itemId) {
      const item = inventoryData.find(i => i.id === itemId);
      if (!item) return;

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">Record Usage</h3>
              <p class="text-sm text-gray-500 mt-1">${item.name} (Current: ${item.currentQuantity} ${item.unit || ''})</p>
            </div>
            <form id="usage-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Quantity Used</label>
                <input type="number" id="usage-qty" min="1" max="${item.currentQuantity}" required
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Notes</label>
                <input type="text" id="usage-notes" 
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy" placeholder="Optional">
              </div>
              <input type="hidden" id="usage-item-id" value="${itemId}">
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="saveUsage()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.saveUsage = async function() {
      const itemId = document.getElementById('usage-item-id').value;
      const qty = parseInt(document.getElementById('usage-qty').value) || 0;
      const notes = document.getElementById('usage-notes').value.trim();

      if (qty <= 0) {
        showToast('Please enter a valid quantity', 'error');
        return;
      }

      showLoading(true);

      try {
        const item = inventoryData.find(i => i.id === itemId);
        const newQty = Math.max(0, item.currentQuantity - qty);

        await updateDoc(doc(db, COLLECTIONS.INVENTORY, itemId), {
          currentQuantity: newQty,
          lastUpdated: Timestamp.now()
        });

        showToast('Usage recorded');
        closeModal();
        await loadInventory();
      } catch (error) {
        console.error('Error recording usage:', error);
        showToast('Error recording usage', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Staff Management
    async function loadStaff() {
      const tbody = document.getElementById('staff-table-body');

      try {
        const staffQuery = query(collection(db, COLLECTIONS.STAFF));
        const snapshot = await getDocs(staffQuery);
        const staffData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (staffData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">No staff found</td></tr>';
          return;
        }

        tbody.innerHTML = staffData.map(s => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 font-medium text-navy">${s.id}</td>
            <td class="px-6 py-4 text-gray-600">${s.name}</td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${s.role === 'SuperAdmin' ? 'bg-navy text-white' : s.role === 'Admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}">
                ${s.role}
              </span>
            </td>
            <td class="px-6 py-4">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${s.active ? 'badge-completed' : 'badge-cancelled'}">
                ${s.active ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-2">
                <button onclick="openStaffModal('${s.id}')" class="px-3 py-1.5 text-sm border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors">Edit</button>
                ${s.id !== currentUser.username && currentUser.role === 'SuperAdmin' ? `
                  <button onclick="toggleStaffStatus('${s.id}', ${!s.active})" class="px-3 py-1.5 text-sm ${s.active ? 'border-red-200 text-red-600 hover:bg-red-50' : 'border-teal-200 text-teal-700 hover:bg-teal-50'} rounded-lg transition-colors">
                    ${s.active ? 'Deactivate' : 'Activate'}
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading staff:', error);
        showToast('Error loading staff', 'error');
      }
    }

    window.openStaffModal = async function(staffId = null) {
      let staff = null;
      if (staffId) {
        const staffDoc = await getDoc(doc(db, COLLECTIONS.STAFF, staffId));
        if (staffDoc.exists()) {
          staff = { id: staffDoc.id, ...staffDoc.data() };
        }
      }

      const modalHtml = `
        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
          <div class="bg-white rounded-2xl w-full max-w-md" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-gray-100">
              <h3 class="text-lg font-semibold text-navy">${staff ? 'Edit Staff' : 'Add Staff'}</h3>
            </div>
            <form id="staff-form" class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Username</label>
                <input type="text" id="staff-username" required value="${staff?.id || ''}" ${staff ? 'readonly' : ''}
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy ${staff ? 'bg-gray-50' : ''}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Name</label>
                <input type="text" id="staff-name" required value="${staff?.name || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Password</label>
                <input type="text" id="staff-password" ${staff ? '' : 'required'} value="${staff?.password || ''}"
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy"
                  placeholder="${staff ? 'Leave blank to keep current' : ''}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1.5">Role</label>
                <select id="staff-role" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:border-navy">
                  <option value="Staff" ${staff?.role === 'Staff' ? 'selected' : ''}>Staff</option>
                  <option value="Admin" ${staff?.role === 'Admin' ? 'selected' : ''}>Admin</option>
                  ${currentUser.role === 'SuperAdmin' ? `<option value="SuperAdmin" ${staff?.role === 'SuperAdmin' ? 'selected' : ''}>SuperAdmin</option>` : ''}
                </select>
              </div>
              <input type="hidden" id="staff-id" value="${staffId || ''}">
            </form>
            <div class="p-6 border-t border-gray-100 flex gap-3 justify-end">
              <button onclick="closeModal()" class="px-5 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">Cancel</button>
              <button onclick="saveStaff()" class="px-5 py-2.5 bg-navy hover:bg-navy-dark text-white rounded-lg transition-colors">Save</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-container').innerHTML = modalHtml;
    };

    window.saveStaff = async function() {
      const id = document.getElementById('staff-id').value;
      const username = document.getElementById('staff-username').value.trim();
      const name = document.getElementById('staff-name').value.trim();
      let password = document.getElementById('staff-password').value;
      const role = document.getElementById('staff-role').value;

      if (!username || !name || (!id && !password)) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      showLoading(true);

      try {
        const data = {
          name,
          role,
          active: true
        };

        if (password) {
          data.password = password;
        }

        await setDoc(doc(db, COLLECTIONS.STAFF, username), data, { merge: true });

        showToast(id ? 'Staff updated' : 'Staff added');
        closeModal();
        await loadStaff();
      } catch (error) {
        console.error('Error saving staff:', error);
        showToast('Error saving staff', 'error');
      } finally {
        showLoading(false);
      }
    };

    window.toggleStaffStatus = async function(staffId, activate) {
      if (!confirm(activate ? 'Activate this account?' : 'Deactivate this account?')) return;

      showLoading(true);

      try {
        await updateDoc(doc(db, COLLECTIONS.STAFF, staffId), { active: activate });
        showToast(`Account ${activate ? 'activated' : 'deactivated'}`);
        await loadStaff();
      } catch (error) {
        console.error('Error toggling status:', error);
        showToast('Error updating status', 'error');
      } finally {
        showLoading(false);
      }
    };

    // Modal Close
    window.closeModal = function(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('modal-container').innerHTML = '';
    };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      // Check for saved session
      const savedUser = localStorage.getItem('clinicUser');
      const loggedIn = localStorage.getItem('clinicLoggedIn');

      if (savedUser && loggedIn === 'true') {
        currentUser = JSON.parse(savedUser);
        initializeApp();
      }

      // Login form handler
      document.getElementById('login-form').addEventListener('submit', handleLogin);
    });
  </script>
</body>
</html>
