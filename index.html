<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Staff Portal - Klinik Pergigian Azam SP Saujana</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #1e3a5f;
            --primary-dark: #112d4d;
            --primary-light: #3c6e9c;
            --accent: #f1f5f9;
            --accent-dark: #e2e8f0;
            --text: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --success-bg: #dcfce7;
            --warning: #f59e0b;
            --warning-bg: #fef3c7;
            --danger: #ef4444;
            --danger-bg: #fee2e2;
            --info: #3b82f6;
            --info-bg: #dbeafe;
            --wa-color: #25D366;
            --wa-bg: #dcfce7;
            
            --bg-body: #f8fafc;
            --bg-sidebar: #1e3a5f;
            --bg-card: #ffffff;
            --border-light: #e2e8f0;
            
            --sidebar-width: 260px;
            --header-height: 64px;
            --radius: 10px;
            --radius-lg: 14px;
            
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(30, 58, 95, 0.08);
            --shadow-lg: 0 12px 32px rgba(30, 58, 95, 0.12);
            
            --transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'DM Sans', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text); 
            min-height: 100vh;
        }
        
        h1, h2, h3, h4, h5, h6 { 
            font-family: 'DM Serif Display', serif; 
            font-weight: 400;
            color: var(--text); 
            letter-spacing: -0.01em; 
        }
        
        button { cursor: pointer; border: none; font-family: inherit; transition: var(--transition); }
        input, select, textarea { font-family: 'DM Sans', sans-serif; }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); transition: opacity 0.3s, visibility 0.3s;
        }
        .loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .spinner { width: 44px; height: 44px; border: 3px solid var(--accent); border-left-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Login Screen */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(145deg, #e0f2fe 0%, #f8fafc 50%, #e2e8f0 100%);
            z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;
            transition: opacity 0.5s, visibility 0.5s;
        }
        #login-screen.hidden { opacity: 0; visibility: hidden; }
        
        .login-card {
            background: rgba(255,255,255, 0.95); backdrop-filter: blur(20px);
            padding: 48px 40px; border-radius: 20px; width: 100%; max-width: 400px;
            box-shadow: var(--shadow-lg); text-align: center;
            border: 1px solid rgba(255,255,255,0.8);
            animation: slideUp 0.6s ease;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .logo-large { 
            width: 72px; height: 72px; object-fit: cover; border-radius: 16px; 
            border: 3px solid white; box-shadow: var(--shadow-md); margin-bottom: 20px; 
        }
        
        .form-input {
            width: 100%; padding: 14px 16px; background: #f8fafc; border: 2px solid var(--border-light);
            border-radius: var(--radius); font-size: 0.95rem; transition: var(--transition); color: var(--text);
        }
        .form-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(30, 58, 95, 0.1); }
        
        .btn-primary {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; font-weight: 600; font-size: 1rem; border-radius: var(--radius);
            box-shadow: 0 4px 14px rgba(30, 58, 95, 0.25);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30, 58, 95, 0.35); }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width); background: var(--bg-sidebar); 
            display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0;
            z-index: 100; transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex; align-items: center; gap: 12px;
        }
        .sidebar-logo { width: 40px; height: 40px; border-radius: 10px; object-fit: cover; }
        .sidebar-title { color: white; font-size: 1rem; line-height: 1.3; }
        .sidebar-subtitle { color: rgba(255,255,255,0.5); font-size: 0.75rem; font-family: 'DM Sans', sans-serif; }
        
        .nav-menu { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 4px;
            color: rgba(255,255,255,0.65); font-size: 0.9rem; font-weight: 500; border-radius: var(--radius);
            cursor: pointer; transition: var(--transition); border-left: 3px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.06); color: white; }
        .nav-item.active { 
            background: rgba(255,255,255,0.1); color: white; 
            border-left-color: white; font-weight: 600; 
        }
        
        .sidebar-footer { padding: 16px; border-top: 1px solid rgba(255,255,255,0.08); }
        .user-pill {
            display: flex; align-items: center; gap: 12px; padding: 10px 12px;
            border-radius: var(--radius); background: rgba(255,255,255,0.05);
            cursor: pointer; transition: var(--transition);
        }
        .user-pill:hover { background: rgba(255,255,255,0.1); }
        .user-avatar { 
            width: 38px; height: 38px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;
        }
        .user-info { flex: 1; min-width: 0; }
        .user-name { color: white; font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { color: rgba(255,255,255,0.5); font-size: 0.75rem; }

        /* Main Content */
        .main-content { 
            flex: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column; 
            min-height: 100vh; transition: margin-left 0.3s ease;
        }
        
        /* Header */
        .header {
            height: var(--header-height); background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-light); display: flex; align-items: center;
            justify-content: space-between; padding: 0 24px; position: sticky; top: 0; z-index: 50;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-title { font-size: 1.25rem; }
        
        .header-center {
            display: flex; align-items: center; gap: 10px; background: var(--accent);
            padding: 8px 20px; border-radius: 50px; border: 1px solid var(--border-light);
        }
        .live-time { font-weight: 700; font-size: 1.1rem; color: var(--primary); font-variant-numeric: tabular-nums; }
        .live-date { font-size: 0.75rem; color: var(--text-muted); }
        
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        .btn-icon {
            width: 40px; height: 40px; border-radius: var(--radius); display: flex;
            align-items: center; justify-content: center; background: white; border: 1px solid var(--border-light);
            color: var(--text-muted); transition: var(--transition);
        }
        .btn-icon:hover { background: var(--accent); color: var(--primary); border-color: var(--primary); }
        .btn-icon.danger:hover { background: var(--danger-bg); color: var(--danger); border-color: var(--danger); }
        
        .btn-sm {
            padding: 8px 14px; border-radius: var(--radius); font-size: 0.85rem; font-weight: 600;
            background: white; border: 1px solid var(--border-light); color: var(--text);
            display: inline-flex; align-items: center; gap: 6px; transition: var(--transition);
        }
        .btn-sm:hover { background: var(--accent); border-color: var(--primary); }
        .btn-sm.primary { background: var(--primary); color: white; border: none; }
        .btn-sm.primary:hover { background: var(--primary-dark); }
        .btn-sm.danger { color: var(--danger); border-color: var(--danger-bg); }
        .btn-sm.danger:hover { background: var(--danger-bg); }
        .btn-sm.success { color: var(--success); border-color: var(--success-bg); }
        .btn-sm.success:hover { background: var(--success-bg); }

        /* Content Area */
        .content-area { flex: 1; padding: 24px; overflow-y: auto; }

        /* Cards */
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg); border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm); padding: 24px; margin-bottom: 24px;
        }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px;
            border: 1px solid var(--border-light); position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: linear-gradient(180deg, var(--primary), var(--primary-light));
        }
        .stat-value { font-size: 2rem; margin-bottom: 4px; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
        .stat-icon {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            width: 48px; height: 48px; border-radius: 12px; display: flex;
            align-items: center; justify-content: center; font-size: 1.25rem;
        }

        /* Tables */
        .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border-light); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { 
            text-align: left; padding: 12px 16px; font-size: 0.75rem; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--text-muted); background: var(--accent); font-weight: 700;
            border-bottom: 1px solid var(--border-light);
        }
        td { 
            padding: 14px 16px; border-bottom: 1px solid var(--accent-dark); font-size: 0.9rem; 
            vertical-align: middle;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--accent); }

        /* Badges */
        .badge {
            padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.03em; display: inline-block;
        }
        .badge-pending { background: var(--warning-bg); color: #b45309; }
        .badge-confirmed { background: var(--info-bg); color: #1d4ed8; }
        .badge-completed { background: var(--success-bg); color: #15803d; }
        .badge-cancelled { background: var(--danger-bg); color: #b91c1c; }
        .badge-info { background: var(--info-bg); color: #1e40af; }

        /* Search */
        .search-wrapper { position: relative; width: 100%; max-width: 280px; }
        .search-input {
            width: 100%; padding: 10px 12px 10px 38px; border: 1px solid var(--border-light);
            border-radius: var(--radius); font-size: 0.85rem; background: var(--accent);
            transition: var(--transition);
        }
        .search-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        /* Pagination */
        .pagination-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light); gap: 12px;
        }
        .pagination-info { font-size: 0.85rem; color: var(--text-muted); }
        .pagination-controls { display: flex; align-items: center; gap: 8px; }
        .pagination-btn {
            width: 32px; height: 32px; border-radius: 8px; background: white;
            border: 1px solid var(--border-light); display: flex; align-items: center; justify-content: center;
            color: var(--text); transition: var(--transition);
        }
        .pagination-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-select { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border-light); font-size: 0.85rem; }

        /* View Sections */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px);
            z-index: 200; display: flex; justify-content: center; align-items: center; padding: 20px;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content {
            background: white; width: 100%; max-width: 500px; border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg); transform: scale(0.95); transition: 0.3s;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--accent-dark); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; background: var(--accent); border-top: 1px solid var(--accent-dark); display: flex; justify-content: flex-end; gap: 10px; }

        /* Toast */
        #toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--primary-dark); color: white; padding: 14px 28px; border-radius: 50px;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 300;
            box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 10px; font-weight: 500;
            opacity: 0; pointer-events: none;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Mobile */
        .mobile-menu-btn { display: none; }
        .sidebar-backdrop { display: none; }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); z-index: 200; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-backdrop {
                display: block; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
                z-index: 190; opacity: 0; visibility: hidden; transition: 0.3s;
            }
            .sidebar-backdrop.active { opacity: 1; visibility: visible; }
            .main-content { margin-left: 0; }
            .mobile-menu-btn { display: flex; }
            .header-center { display: none; }
        }

        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr; }
            .card { padding: 16px; }
            .content-area { padding: 16px; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="logo-large">
            <h2 style="margin-top: 10px; margin-bottom: 4px; font-size: 1.5rem;">Klinik Pergigian Azam</h2>
            <p style="color: var(--text-muted); margin-bottom: 32px; font-weight: 500;">Cawangan SP Saujana - Staff Portal</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div style="text-align: left; margin-bottom: 16px;">
                    <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 6px;">Username or Email</label>
                    <input type="text" id="loginUsername" class="form-input" placeholder="Enter username or email" required>
                </div>
                <div style="text-align: left; margin-bottom: 24px;">
                    <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 6px;">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn-primary">Sign In</button>
                <p id="loginError" style="color: var(--danger); font-size: 0.85rem; margin-top: 16px;"></p>
            </form>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="app-container" style="display: none;">
        
        <!-- Sidebar Backdrop (Mobile) -->
        <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://raw.githubusercontent.com/ddnetwork-ent/clinic-azam-dental/main/IMG_2260.JPG" alt="Logo" class="sidebar-logo">
                <div>
                    <div class="sidebar-title">Klinik Pergigian</div>
                    <div class="sidebar-subtitle">Azam SP Saujana</div>
                </div>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item active" data-page="dashboard" onclick="navigateTo('dashboard')">
                    <i data-lucide="layout-dashboard" style="width: 20px; height: 20px;"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="appointments" onclick="navigateTo('appointments')">
                    <i data-lucide="calendar-check" style="width: 20px; height: 20px;"></i>
                    <span>Appointments</span>
                </div>
                <div class="nav-item" data-page="booking" onclick="navigateTo('booking')">
                    <i data-lucide="calendar-plus" style="width: 20px; height: 20px;"></i>
                    <span>New Booking</span>
                </div>
                <div class="nav-item" data-page="cashbill" onclick="navigateTo('cashbill')">
                    <i data-lucide="receipt" style="width: 20px; height: 20px;"></i>
                    <span>Cash Bill</span>
                </div>
                <div class="nav-item" data-page="reports" onclick="navigateTo('reports')">
                    <i data-lucide="bar-chart-3" style="width: 20px; height: 20px;"></i>
                    <span>Reports</span>
                </div>
                <div class="nav-item" data-page="patients" onclick="navigateTo('patients')">
                    <i data-lucide="users" style="width: 20px; height: 20px;"></i>
                    <span>Patients</span>
                </div>
                <div class="nav-item" data-page="services" onclick="navigateTo('services')">
                    <i data-lucide="stethoscope" style="width: 20px; height: 20px;"></i>
                    <span>Services</span>
                </div>
                <div class="nav-item" data-page="staff" onclick="navigateTo('staff')" id="nav-staff" style="display: none;">
                    <i data-lucide="user-cog" style="width: 20px; height: 20px;"></i>
                    <span>Staff Management</span>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-pill" onclick="openProfileModal()">
                    <div class="user-avatar" id="sidebarAvatar">DA</div>
                    <div class="user-info">
                        <div class="user-name" id="sidebarName">Staff</div>
                        <div class="user-role" id="sidebarRole">Role</div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="btn-icon mobile-menu-btn" onclick="toggleSidebar()">
                        <i data-lucide="menu" style="width: 20px; height: 20px;"></i>
                    </button>
                    <h2 class="header-title" id="pageTitle">Dashboard</h2>
                </div>
                
                <div class="header-center">
                    <i data-lucide="clock" style="width: 18px; height: 18px; color: var(--primary);"></i>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span class="live-time" id="liveTime">00:00:00</span>
                        <span class="live-date" id="liveDate">Loading</span>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="btn-icon danger" onclick="handleLogout()" title="Logout">
                        <i data-lucide="log-out" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                
                <!-- Dashboard -->
                <section id="view-dashboard" class="view-section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 class="stat-value" id="stat-today">0</h3>
                            <p class="stat-label">Today's Appointments</p>
                            <div class="stat-icon" style="background: var(--info-bg); color: var(--info);">
                                <i data-lucide="calendar-check" style="width: 24px; height: 24px;"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-value" id="stat-sales">RM 0</h3>
                            <p class="stat-label">Today's Sales</p>
                            <div class="stat-icon" style="background: var(--success-bg); color: var(--success);">
                                <i data-lucide="coins" style="width: 24px; height: 24px;"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-value" id="stat-patients">0</h3>
                            <p class="stat-label">Total Patients</p>
                            <div class="stat-icon" style="background: var(--warning-bg); color: var(--warning);">
                                <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3 class="stat-value" id="stat-pending">0</h3>
                            <p class="stat-label">Pending Confirmations</p>
                            <div class="stat-icon" style="background: #fef3c7; color: #d97706;">
                                <i data-lucide="clock" style="width: 24px; height: 24px;"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="calendar" style="width: 20px; height: 20px; color: var(--primary);"></i>
                                Today's Schedule
                            </h3>
                            <span style="font-size: 0.85rem; color: var(--text-muted);" id="todayDate"></span>
                        </div>
                        <div class="table-responsive">
                            <table id="dashboardTable">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Patient</th>
                                        <th>Service</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Appointments -->
                <section id="view-appointments" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Upcoming Appointments</h3>
                            <div class="search-wrapper">
                                <i data-lucide="search" class="search-icon" style="width: 16px; height: 16px;"></i>
                                <input type="text" class="search-input" placeholder="Search appointments..." id="searchAppointments" oninput="renderAppointments()">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="appointmentsTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Patient</th>
                                        <th>Phone</th>
                                        <th>Service</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination-bar" id="pagination-appointments"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Completed History</h3>
                        </div>
                        <div class="table-responsive">
                            <table id="historyTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>Service</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination-bar" id="pagination-history"></div>
                    </div>
                </section>

                <!-- Booking -->
                <section id="view-booking" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">New Appointment</h3>
                            <button class="btn-sm" onclick="resetBookingForm()">
                                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i> Reset
                            </button>
                        </div>
                        <form id="bookingForm" onsubmit="submitBooking(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Select Date</label>
                                <input type="date" id="bookingDate" class="form-input" required onchange="loadAvailableSlots()">
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Select Time</label>
                                <select id="bookingTime" class="form-input" required>
                                    <option value="">Select date first</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Patient Type</label>
                                <div style="display: flex; gap: 12px;">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="radio" name="patientType" value="existing" checked onchange="togglePatientForm()"> 
                                        <span style="font-weight: 500;">Existing</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="radio" name="patientType" value="new" onchange="togglePatientForm()">
                                        <span style="font-weight: 500;">New Patient</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Service</label>
                                <select id="bookingService" class="form-input" required></select>
                            </div>
                            
                            <!-- Existing Patient -->
                            <div id="existingPatientFields" style="grid-column: span 2;">
                                <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Select Patient</label>
                                <select id="bookingPatient" class="form-input" required>
                                    <option value="">Loading patients...</option>
                                </select>
                            </div>
                            
                            <!-- New Patient -->
                            <div id="newPatientFields" style="grid-column: span 2; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Full Name</label>
                                        <input type="text" id="newPatientName" class="form-input" placeholder="Enter full name">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Phone Number</label>
                                        <input type="tel" id="newPatientPhone" class="form-input" placeholder="01X-XXXXXXX">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="grid-column: span 2; margin-top: 16px;">
                                <button type="submit" class="btn-sm primary" style="width: 100%; justify-content: center; padding: 14px;">
                                    <i data-lucide="check" style="width: 18px; height: 18px;"></i> Confirm Booking
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Cash Bill -->
                <section id="view-cashbill" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Completed Bills</h3>
                            <button class="btn-sm primary" onclick="showNewBillForm()">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i> New Bill
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="cashbillTable">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>Total</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination-bar" id="pagination-cashbill"></div>
                    </div>
                </section>

                <!-- Reports -->
                <section id="view-reports" class="view-section">
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card" style="grid-column: span 2;">
                            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Total Revenue (Selected Period)</h3>
                            <h2 style="font-size: 2.5rem; color: var(--primary);">RM <span id="reportTotal">0.00</span></h2>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Billing Report</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="date" id="reportStart" class="form-input" style="padding: 10px;" onchange="renderReports()">
                                <span style="color: var(--text-muted);">to</span>
                                <input type="date" id="reportEnd" class="form-input" style="padding: 10px;" onchange="renderReports()">
                                <button class="btn-sm" onclick="exportReport()">
                                    <i data-lucide="download" style="width: 16px; height: 16px;"></i> Export CSV
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="reportTable">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Date</th>
                                        <th>Patient</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Patients -->
                <section id="view-patients" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Patient Directory</h3>
                            <div style="display: flex; gap: 12px;">
                                <div class="search-wrapper">
                                    <i data-lucide="search" class="search-icon" style="width: 16px; height: 16px;"></i>
                                    <input type="text" class="search-input" placeholder="Search patients..." id="searchPatients" oninput="renderPatients()">
                                </div>
                                <button class="btn-sm primary" onclick="openPatientModal()">
                                    <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i> Add Patient
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="patientsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Phone</th>
                                        <th>IC</th>
                                        <th>Visits</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination-bar" id="pagination-patients"></div>
                    </div>
                </section>

                <!-- Services -->
                <section id="view-services" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Service & Pricing</h3>
                            <button class="btn-sm primary" onclick="openServiceModal()">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i> Add Service
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="servicesTable">
                                <thead>
                                    <tr>
                                        <th>Service Name</th>
                                        <th>Price (RM)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Staff -->
                <section id="view-staff" class="view-section">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Staff Management</h3>
                            <button class="btn-sm primary" onclick="openStaffModal()">
                                <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i> Add Staff
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="staffTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Role</th>
                                        <th>Email</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Patient Modal -->
    <div class="modal-overlay" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="patientModalTitle">Add Patient</h3>
                <button class="btn-icon" onclick="closeModal('patientModal')" style="width: 32px; height: 32px;">
                    <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
            <form id="patientForm" onsubmit="savePatient(event)">
                <div class="modal-body">
                    <input type="hidden" id="patientId">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Full Name</label>
                        <input type="text" id="patientName" class="form-input" required>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Phone</label>
                        <input type="tel" id="patientPhone" class="form-input" required>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">IC (Optional)</label>
                        <input type="text" id="patientIC" class="form-input">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sm" onclick="closeModal('patientModal')">Cancel</button>
                    <button type="submit" class="btn-sm primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Service Modal -->
    <div class="modal-overlay" id="serviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="serviceModalTitle">Add Service</h3>
                <button class="btn-icon" onclick="closeModal('serviceModal')" style="width: 32px; height: 32px;">
                    <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
            <form id="serviceForm" onsubmit="saveService(event)">
                <div class="modal-body">
                    <input type="hidden" id="serviceId">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Service Name</label>
                        <input type="text" id="serviceName" class="form-input" required>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Price (RM)</label>
                        <input type="number" id="servicePrice" class="form-input" step="0.01" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sm" onclick="closeModal('serviceModal')">Cancel</button>
                    <button type="submit" class="btn-sm primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Staff Modal -->
    <div class="modal-overlay" id="staffModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="staffModalTitle">Add Staff</h3>
                <button class="btn-icon" onclick="closeModal('staffModal')" style="width: 32px; height: 32px;">
                    <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
            <form id="staffForm" onsubmit="saveStaff(event)">
                <div class="modal-body">
                    <input type="hidden" id="staffId">
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Full Name</label>
                        <input type="text" id="staffName" class="form-input" required>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Email</label>
                        <input type="email" id="staffEmail" class="form-input" required>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Role</label>
                        <select id="staffRole" class="form-input" required>
                            <option value="Staff">Staff</option>
                            <option value="Admin">Admin</option>
                            <option value="SuperAdmin">SuperAdmin</option>
                        </select>
                    </div>
                    <div id="staffPasswordField">
                        <label style="font-size: 0.8rem; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 8px;">Password</label>
                        <input type="password" id="staffPassword" class="form-input" placeholder="Minimum 6 characters">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sm" onclick="closeModal('staffModal')">Cancel</button>
                    <button type="submit" class="btn-sm primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>My Profile</h3>
                <button class="btn-icon" onclick="closeModal('profileModal')" style="width: 32px; height: 32px;">
                    <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div class="user-avatar" style="width: 80px; height: 80px; font-size: 1.8rem; margin: 0 auto 20px;" id="profileAvatar">DA</div>
                <h3 style="margin-bottom: 4px;" id="profileName">Staff Name</h3>
                <span class="badge badge-info" id="profileRole">Role</span>
                <div style="margin-top: 20px; padding: 16px; background: var(--accent); border-radius: var(--radius); text-align: left;">
                    <div style="margin-bottom: 12px;">
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Email</span>
                        <div style="font-weight: 600;" id="profileEmail">-</div>
                    </div>
                    <div>
                        <span style="font-size: 0.75rem; color: var(--text-muted);">Staff ID</span>
                        <div style="font-weight: 600;" id="profileId">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-sm" onclick="closeModal('profileModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">
        <i data-lucide="check-circle" style="width: 18px; height: 18px; color: var(--success);"></i>
        <span id="toastMessage">Action completed</span>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBkH-3VaTJHVHSCROb2rIf5H03yZa3GYOo",
            authDomain: "ddcloudnetwork.firebaseapp.com",
            projectId: "ddcloudnetwork",
            storageBucket: "ddcloudnetwork.firebasestorage.app",
            messagingSenderId: "692579973408",
            appId: "1:692579973408:web:027492492ddf57dbf3bf45",
            measurementId: "G-58N4W6Y5CN"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let patients = [];
        let services = [];
        let staff = [];
        let appointments = [];

        const todayStr = new Date().toISOString().split('T')[0];
        const timeSlots = ["09:00", "09:30", "10:00", "10:30", "11:00", "11:30", "14:00", "14:30", "15:00", "15:30", "16:00", "16:30", "17:00"];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            startClock();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const q = await db.collection('klinikazam_staff').where('email', '==', user.email).get();
                    if (!q.empty) {
                        currentUser = { id: q.docs[0].id, ...q.docs[0].data(), uid: user.uid };
                        setupUI();
                        await loadAllData();
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('app-container').style.display = 'flex';
                    } else {
                        showToast("Staff record not found");
                        auth.signOut();
                    }
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-container').style.display = 'none';
                }
            });
        });

        // ==================== CLOCK ====================
        function startClock() {
            setInterval(() => {
                const now = new Date();
                let hours = now.getHours();
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                document.getElementById('liveTime').textContent = `${hours}:${minutes}:${seconds} ${ampm}`;
                document.getElementById('liveDate').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }, 1000);
        }

        // ==================== AUTH ====================
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            let email = username;
            if (!username.includes('@')) {
                const q = await db.collection('klinikazam_staff').where('username', '==', username).limit(1).get();
                if (q.empty) { errorEl.textContent = "User not found"; return; }
                email = q.docs[0].data().email;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorEl.textContent = "";
            } catch (err) {
                errorEl.textContent = err.code === 'auth/wrong-password' ? "Invalid password" : "Login failed";
            }
        }

        function handleLogout() {
            auth.signOut();
        }

        // ==================== UI SETUP ====================
        function setupUI() {
            document.getElementById('sidebarName').textContent = currentUser.name;
            document.getElementById('sidebarRole').textContent = currentUser.role;
            document.getElementById('sidebarAvatar').textContent = currentUser.name.substring(0, 2).toUpperCase();
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileRole').textContent = currentUser.role;
            document.getElementById('profileEmail').textContent = currentUser.email || '-';
            document.getElementById('profileId').textContent = currentUser.id;
            document.getElementById('profileAvatar').textContent = currentUser.name.substring(0, 2).toUpperCase();
            
            const navStaff = document.getElementById('nav-staff');
            navStaff.style.display = (currentUser.role === 'Admin' || currentUser.role === 'SuperAdmin') ? 'flex' : 'none';
            
            document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarBackdrop').classList.toggle('active');
        }

        // ==================== NAVIGATION ====================
        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
            
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${page}`).classList.add('active');
            
            const titles = {
                dashboard: 'Dashboard', appointments: 'Appointments', booking: 'New Booking',
                cashbill: 'Cash Bill', reports: 'Reports', patients: 'Patients',
                services: 'Services', staff: 'Staff Management'
            };
            document.getElementById('pageTitle').textContent = titles[page] || 'Dashboard';
            
            if (document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
            
            // Render content
            if (page === 'dashboard') renderDashboard();
            if (page === 'appointments') renderAppointments();
            if (page === 'booking') populateBookingForm();
            if (page === 'cashbill') renderCashbill();
            if (page === 'reports') { initReportDates(); renderReports(); }
            if (page === 'patients') renderPatients();
            if (page === 'services') renderServices();
            if (page === 'staff') renderStaff();
            
            lucide.createIcons();
        }

        // ==================== DATA LOADING ====================
        async function loadAllData() {
            const [pSnap, sSnap, stSnap, aSnap] = await Promise.all([
                db.collection('klinikazam_patients').get(),
                db.collection('klinikazam_services').get(),
                db.collection('klinikazam_staff').get(),
                db.collection('klinikazam_appointments').orderBy('date', 'desc').get()
            ]);
            
            patients = pSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            services = sSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            staff = stSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            appointments = aSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            renderDashboard();
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const todayAppts = appointments.filter(a => a.date === todayStr && a.status !== 'Cancelled');
            const pending = appointments.filter(a => a.status === 'Pending').length;
            
            document.getElementById('stat-today').textContent = todayAppts.length;
            document.getElementById('stat-patients').textContent = patients.length;
            document.getElementById('stat-pending').textContent = pending;
            
            let totalSales = 0;
            appointments.filter(a => a.date === todayStr && a.status === 'Completed').forEach(a => {
                if (a.items) a.items.forEach(i => { totalSales += (i.price * i.qty); });
            });
            document.getElementById('stat-sales').textContent = `RM ${totalSales.toLocaleString()}`;
            
            const tbody = document.querySelector('#dashboardTable tbody');
            tbody.innerHTML = '';
            
            todayAppts.sort((a, b) => (a.time || '').localeCompare(b.time || '')).forEach(a => {
                const patient = patients.find(p => p.id === a.patient_id);
                const serviceName = getServiceName(a);
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: 600;">${a.time || '-'}</td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td>${serviceName}</td>
                        <td><span class="badge badge-${a.status?.toLowerCase() || 'pending'}">${a.status || 'Pending'}</span></td>
                        <td>
                            <button class="btn-sm success" onclick="openInvoice('${a.id}')" title="Bill">
                                <i data-lucide="receipt" style="width: 14px; height: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        // ==================== APPOINTMENTS ====================
        function renderAppointments() {
            const search = document.getElementById('searchAppointments')?.value?.toLowerCase() || '';
            
            // Upcoming
            const upcoming = appointments.filter(a => 
                !['Completed', 'Cancelled'].includes(a.status) &&
                (search === '' || 
                    (patients.find(p => p.id === a.patient_id)?.name || '').toLowerCase().includes(search))
            ).slice(0, 20);
            
            const upBody = document.querySelector('#appointmentsTable tbody');
            upBody.innerHTML = '';
            upcoming.forEach(a => {
                const patient = patients.find(p => p.id === a.patient_id);
                upBody.innerHTML += `
                    <tr>
                        <td>${a.date}</td>
                        <td style="font-weight: 600; color: var(--primary);">${a.time || '-'}</td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td>${patient ? patient.phone : '-'}</td>
                        <td>${getServiceName(a)}</td>
                        <td><span class="badge badge-${a.status?.toLowerCase() || 'pending'}">${a.status || 'Pending'}</span></td>
                        <td>
                            <button class="btn-sm success" onclick="openInvoice('${a.id}')">
                                <i data-lucide="receipt" style="width: 14px; height: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            // History
            const history = appointments.filter(a => a.status === 'Completed').slice(0, 20);
            const histBody = document.querySelector('#historyTable tbody');
            histBody.innerHTML = '';
            history.forEach(a => {
                const patient = patients.find(p => p.id === a.patient_id);
                const total = (a.items || []).reduce((sum, i) => sum + (i.price * i.qty), 0);
                histBody.innerHTML += `
                    <tr>
                        <td>${a.date}</td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td>${getServiceName(a)}</td>
                        <td style="font-weight: 600;">RM ${total.toFixed(2)}</td>
                        <td>
                            <button class="btn-sm" onclick="viewInvoice('${a.id}')">
                                <i data-lucide="eye" style="width: 14px; height: 14px;"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        // ==================== BOOKING ====================
        function populateBookingForm() {
            const patientSelect = document.getElementById('bookingPatient');
            const serviceSelect = document.getElementById('bookingService');
            const dateInput = document.getElementById('bookingDate');
            
            patientSelect.innerHTML = '<option value="">Select patient...</option>';
            patients.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                patientSelect.innerHTML += `<option value="${p.id}">${p.name} (${p.phone || 'No phone'})</option>`;
            });
            
            serviceSelect.innerHTML = '<option value="">Select service...</option>';
            services.forEach(s => {
                serviceSelect.innerHTML += `<option value="${s.id}">${s.name} - RM ${s.price}</option>`;
            });
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.min = tomorrow.toISOString().split('T')[0];
        }

        function togglePatientForm() {
            const isNew = document.querySelector('input[name="patientType"]:checked').value === 'new';
            document.getElementById('existingPatientFields').style.display = isNew ? 'none' : 'block';
            document.getElementById('newPatientFields').style.display = isNew ? 'block' : 'none';
        }

        async function loadAvailableSlots() {
            const date = document.getElementById('bookingDate').value;
            const timeSelect = document.getElementById('bookingTime');
            timeSelect.innerHTML = '<option value="">Loading...</option>';
            
            if (!date) return;
            
            const booked = appointments.filter(a => a.date === date && !['Cancelled', 'Completed'].includes(a.status)).map(a => a.time);
            const available = timeSlots.filter(t => !booked.includes(t));
            
            timeSelect.innerHTML = available.length === 0 
                ? '<option value="">No slots available</option>'
                : '<option value="">Select time...</option>' + available.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        async function submitBooking(e) {
            e.preventDefault();
            const isNew = document.querySelector('input[name="patientType"]:checked').value === 'new';
            let patientId;
            
            if (isNew) {
                const name = document.getElementById('newPatientName').value;
                const phone = document.getElementById('newPatientPhone').value;
                
                const newPatient = { name, phone, ic: '-', createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                const ref = await db.collection('klinikazam_patients').add(newPatient);
                patientId = ref.id;
                patients.push({ id: patientId, ...newPatient });
            } else {
                patientId = document.getElementById('bookingPatient').value;
            }
            
            const serviceId = document.getElementById('bookingService').value;
            const service = services.find(s => s.id === serviceId);
            
            const appointment = {
                patient_id: patientId,
                date: document.getElementById('bookingDate').value,
                time: document.getElementById('bookingTime').value,
                service_id: serviceId,
                items: [{ id: serviceId, name: service?.name, qty: 1, price: service?.price || 0 }],
                status: 'Pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('klinikazam_appointments').add(appointment);
            appointments.unshift({ id: 'new', ...appointment });
            
            showToast('Appointment booked successfully');
            resetBookingForm();
            navigateTo('appointments');
        }

        function resetBookingForm() {
            document.getElementById('bookingForm').reset();
            document.getElementById('bookingTime').innerHTML = '<option value="">Select date first</option>';
            togglePatientForm();
        }

        // ==================== CASHBILL ====================
        function renderCashbill() {
            const completed = appointments.filter(a => a.status === 'Completed').slice(0, 20);
            const tbody = document.querySelector('#cashbillTable tbody');
            tbody.innerHTML = '';
            
            completed.forEach(a => {
                const patient = patients.find(p => p.id === a.patient_id);
                const total = (a.items || []).reduce((sum, i) => sum + (i.price * i.qty), 0);
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: 600; color: var(--primary);">${a.invoice_id || a.id.substring(0, 8)}</td>
                        <td>${a.date}</td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td style="font-weight: 600;">RM ${total.toFixed(2)}</td>
                        <td><span class="badge badge-info">${a.payment_method || 'Cash'}</span></td>
                        <td>
                            <button class="btn-sm" onclick="viewInvoice('${a.id}')">
                                <i data-lucide="eye" style="width: 14px; height: 14px;"></i> View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        function showNewBillForm() {
            navigateTo('booking');
        }

        function openInvoice(id) {
            showToast('Opening invoice editor...');
            // Open invoice modal logic here
        }

        function viewInvoice(id) {
            showToast('Loading invoice details...');
            // View invoice logic here
        }

        // ==================== REPORTS ====================
        function initReportDates() {
            const now = new Date();
            const first = new Date(now.getFullYear(), now.getMonth(), 1);
            const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            document.getElementById('reportStart').value = first.toISOString().split('T')[0];
            document.getElementById('reportEnd').value = last.toISOString().split('T')[0];
        }

        function renderReports() {
            const start = document.getElementById('reportStart').value;
            const end = document.getElementById('reportEnd').value;
            
            const filtered = appointments.filter(a => 
                a.status === 'Completed' && a.date >= start && a.date <= end
            );
            
            let total = 0;
            const tbody = document.querySelector('#reportTable tbody');
            tbody.innerHTML = '';
            
            filtered.forEach(a => {
                const patient = patients.find(p => p.id === a.patient_id);
                const apptTotal = (a.items || []).reduce((sum, i) => sum + (i.price * i.qty), 0);
                total += apptTotal;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${a.invoice_id || a.id.substring(0, 8)}</td>
                        <td>${a.date}</td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td>${(a.items || []).map(i => i.name).join(', ')}</td>
                        <td style="font-weight: 600;">RM ${apptTotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            document.getElementById('reportTotal').textContent = total.toLocaleString(undefined, { minimumFractionDigits: 2 });
        }

        function exportReport() {
            const start = document.getElementById('reportStart').value;
            const end = document.getElementById('reportEnd').value;
            const filtered = appointments.filter(a => 
                a.status === 'Completed' && a.date >= start && a.date <= end
            );
            
            const data = filtered.map(a => {
                const patient = patients.find(p => p.id === a.patient_id);
                return {
                    Date: a.date,
                    Invoice: a.invoice_id || a.id,
                    Patient: patient?.name || 'Unknown',
                    Total: (a.items || []).reduce((sum, i) => sum + (i.price * i.qty), 0)
                };
            });
            
            const csv = 'data:text/csv;charset=utf-8,' + 
                Object.keys(data[0] || {}).join(',') + '\n' +
                data.map(r => Object.values(r).join(',')).join('\n');
            
            const link = document.createElement('a');
            link.href = encodeURI(csv);
            link.download = `report_${start}_to_${end}.csv`;
            link.click();
            showToast('Report exported');
        }

        // ==================== PATIENTS ====================
        function renderPatients() {
            const search = document.getElementById('searchPatients')?.value?.toLowerCase() || '';
            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(search) || 
                (p.phone || '').includes(search)
            ).slice(0, 20);
            
            const tbody = document.querySelector('#patientsTable tbody');
            tbody.innerHTML = '';
            
            filtered.forEach(p => {
                const visits = appointments.filter(a => a.patient_id === p.id && a.status === 'Completed').length;
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: 600;">${p.name}</td>
                        <td>${p.phone || '-'}</td>
                        <td>${p.ic || '-'}</td>
                        <td>${visits}</td>
                        <td>
                            <button class="btn-sm" onclick="openPatientModal('${p.id}')">
                                <i data-lucide="pencil" style="width: 14px; height: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        function openPatientModal(id = null) {
            const modal = document.getElementById('patientModal');
            const title = document.getElementById('patientModalTitle');
            
            if (id) {
                const patient = patients.find(p => p.id === id);
                title.textContent = 'Edit Patient';
                document.getElementById('patientId').value = id;
                document.getElementById('patientName').value = patient?.name || '';
                document.getElementById('patientPhone').value = patient?.phone || '';
                document.getElementById('patientIC').value = patient?.ic || '';
            } else {
                title.textContent = 'Add Patient';
                document.getElementById('patientForm').reset();
                document.getElementById('patientId').value = '';
            }
            
            modal.classList.add('open');
        }

        async function savePatient(e) {
            e.preventDefault();
            const id = document.getElementById('patientId').value;
            const data = {
                name: document.getElementById('patientName').value,
                phone: document.getElementById('patientPhone').value,
                ic: document.getElementById('patientIC').value
            };
            
            if (id) {
                await db.collection('klinikazam_patients').doc(id).update(data);
                const idx = patients.findIndex(p => p.id === id);
                patients[idx] = { ...patients[idx], ...data };
            } else {
                const ref = await db.collection('klinikazam_patients').add(data);
                patients.push({ id: ref.id, ...data });
            }
            
            closeModal('patientModal');
            renderPatients();
            showToast('Patient saved');
        }

        // ==================== SERVICES ====================
        function renderServices() {
            const tbody = document.querySelector('#servicesTable tbody');
            tbody.innerHTML = '';
            
            services.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: 600;">${s.name}</td>
                        <td style="font-weight: 600; color: var(--primary);">RM ${parseFloat(s.price).toFixed(2)}</td>
                        <td>
                            <button class="btn-sm" onclick="openServiceModal('${s.id}')">
                                <i data-lucide="pencil" style="width: 14px; height: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        function openServiceModal(id = null) {
            const modal = document.getElementById('serviceModal');
            const title = document.getElementById('serviceModalTitle');
            
            if (id) {
                const service = services.find(s => s.id === id);
                title.textContent = 'Edit Service';
                document.getElementById('serviceId').value = id;
                document.getElementById('serviceName').value = service?.name || '';
                document.getElementById('servicePrice').value = service?.price || '';
            } else {
                title.textContent = 'Add Service';
                document.getElementById('serviceForm').reset();
                document.getElementById('serviceId').value = '';
            }
            
            modal.classList.add('open');
        }

        async function saveService(e) {
            e.preventDefault();
            const id = document.getElementById('serviceId').value;
            const data = {
                name: document.getElementById('serviceName').value,
                price: parseFloat(document.getElementById('servicePrice').value)
            };
            
            if (id) {
                await db.collection('klinikazam_services').doc(id).update(data);
                const idx = services.findIndex(s => s.id === id);
                services[idx] = { ...services[idx], ...data };
            } else {
                const ref = await db.collection('klinikazam_services').add(data);
                services.push({ id: ref.id, ...data });
            }
            
            closeModal('serviceModal');
            renderServices();
            showToast('Service saved');
        }

        // ==================== STAFF ====================
        function renderStaff() {
            const tbody = document.querySelector('#staffTable tbody');
            tbody.innerHTML = '';
            
            staff.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight: 600;">${s.name}</td>
                        <td><span class="badge badge-info">${s.role}</span></td>
                        <td>${s.email || '-'}</td>
                        <td>
                            <button class="btn-sm" onclick="openStaffModal('${s.id}')">
                                <i data-lucide="pencil" style="width: 14px; height: 14px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            lucide.createIcons();
        }

        function openStaffModal(id = null) {
            const modal = document.getElementById('staffModal');
            const title = document.getElementById('staffModalTitle');
            const pwField = document.getElementById('staffPasswordField');
            
            if (id) {
                const s = staff.find(x => x.id === id);
                title.textContent = 'Edit Staff';
                document.getElementById('staffId').value = id;
                document.getElementById('staffName').value = s?.name || '';
                document.getElementById('staffEmail').value = s?.email || '';
                document.getElementById('staffRole').value = s?.role || 'Staff';
                document.getElementById('staffPassword').value = '';
                pwField.style.display = 'none';
            } else {
                title.textContent = 'Add Staff';
                document.getElementById('staffForm').reset();
                document.getElementById('staffId').value = '';
                pwField.style.display = 'block';
            }
            
            modal.classList.add('open');
        }

        async function saveStaff(e) {
            e.preventDefault();
            const id = document.getElementById('staffId').value;
            const data = {
                name: document.getElementById('staffName').value,
                email: document.getElementById('staffEmail').value,
                role: document.getElementById('staffRole').value
            };
            
            if (id) {
                await db.collection('klinikazam_staff').doc(id).update(data);
                const idx = staff.findIndex(s => s.id === id);
                staff[idx] = { ...staff[idx], ...data };
            } else {
                const password = document.getElementById('staffPassword').value;
                if (password.length < 6) {
                    showToast('Password must be at least 6 characters');
                    return;
                }
                
                try {
                    const userRef = await auth.createUserWithEmailAndPassword(data.email, password);
                    await db.collection('klinikazam_staff').doc(userRef.user.uid).set(data);
                    staff.push({ id: userRef.user.uid, ...data });
                } catch (err) {
                    showToast(err.message);
                    return;
                }
            }
            
            closeModal('staffModal');
            renderStaff();
            showToast('Staff saved');
        }

        // ==================== HELPERS ====================
        function getServiceName(appointment) {
            if (appointment.items && appointment.items.length > 0) {
                return appointment.items[0].name || 'Service';
            }
            if (appointment.service_id) {
                const s = services.find(x => x.id === appointment.service_id);
                return s?.name || 'Service';
            }
            return 'Service';
        }

        function openProfileModal() {
            document.getElementById('profileModal').classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
